---
title: "Shock Analysis Tidy"
author: "Richard Cottrell"
date: "27 December 2017"
output: html_document
---

###LIBRARIES

```{r}
library(party)
library(randomForest)
library(splitstackshape)
library(plyr) # manipulation of data formatting
library(dplyr) # maniuplation of data formatting
library(sp) #spatial tool
library(spatial)
library(classInt)
#library(rworldmap) #if not using ggplot
library(RColorBrewer) #Color Brew Palettes
library(mapproj)
library(sf)#shapefile reading
library(ggalt)
library(ggplot2) #plotting
library(ggforce)
library(rgdal) 
library(ggmap)#creating ggmaps
library(devtools)
library(ggpubr) #for using the ggarrange function (displaying composite ggplots)
library(tidyr)#switching from wide to long format
library(zoo)# moving average functions 
library(countrycode) #adding countrycodes to data
library(colorspace) #adding colour palettes for plots
library(mgcv) #gams
library(car) # linear models
library(ggrepel) #ggrepel labels on point chart
# library(fANCOVA) #loess span fit function 
# library(forecast)
# library(earlywarnings)
# library(Kendall)
library(png)
library(grid) 
# library(readr)
# library(plot3D)
# library(circlize)
library(data.table)
library(purrr)


```

## IMPORT RAW PRODUCTION DATA 

```{r}

#CROP PRODUCTION DATA

cropsfull<-read.csv("Production_Crops_E_All_Data_(Norm).csv")
names(cropsfull)
crops<-cropsfull[,c(2, 4, 6, 8:11)]
head(crops)
rm(cropsfull)

#Assign country codes
crops$Codes<-countrycode(crops$Country, "country.name", "iso3c", warn=T)
summary(crops)

crops<-crops[!is.na(crops$Codes),]
summary(crops)

#select only totals and Production quantity
crops<-crops[grep("Total",crops$Item),]
crops<-crops[crops$Element=="Production",]
summary(crops)

table(crops$Country) #check that continents and no code countries have zero for value

#remove NA values from values column
crops<-crops[!is.na(crops$Value),]
summary(crops)

write.csv(crops, file = "croptotals.csv", row.names = F)

crops<-read.csv("croptotals.csv", header = T)

names(crops)
levels(crops$Country)

#create aggregate production for crops
years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(crops$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(crops$Value, crops$Country==levels(crops$Country)[i]& crops$Year==years[j]))))
  }
}

##Country and Year columns
Country<-rep(levels(crops$Country), 1, each=length(years))
Year<-rep(years, length(levels(crops$Country)))

##New data frame 
aggcrops<-cbind.data.frame(Country, Year, Total)


pdf(file="Crops - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(aggcrops$Country))){
  values<-subset(aggcrops$Total, aggcrops$Country==levels(aggcrops$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggcrops$Country)[i], pch=20, cex=0.75)
  }
dev.off()


#aggregate remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 36 countries removed for crops
# crops<- crops[crops$Country!="Armenia",]
# crops<- crops[crops$Country!="Azerbaijan",]
# crops<- crops[crops$Country!="Belarus",]
# crops<- crops[crops$Country!="Belgium",]
# crops<- crops[crops$Country!="Bosnia and Herzegovina",]
# crops<- crops[crops$Country!="Croatia",]
# crops<- crops[crops$Country!="Czech Republic",]
# crops<- crops[crops$Country!="Czechoslovakia",]
# crops<- crops[crops$Country!="Eritrea",]
# crops<- crops[crops$Country!="Estonia",]
# crops<- crops[crops$Country!="Ethiopia",]
# crops<- crops[crops$Country!="Ethiopia PDR",]
# crops<- crops[crops$Country!="Georgia",]
# crops<- crops[crops$Country!="Kazakhstan",]
# crops<- crops[crops$Country!="Kyrgyzstan",]
# crops<- crops[crops$Country!="Latvia",]
# crops<- crops[crops$Country!="Lithuania",]
# crops<- crops[crops$Country!="Luxembourg",]
# crops<- crops[crops$Country!="Micronesia (Federated States of)",]
# crops<- crops[crops$Country!="Montenegro",]
# crops<- crops[crops$Country!="Occupied Palestinian Territory",]
# crops<- crops[crops$Country!="Republic of Moldova",]
# crops<- crops[crops$Country!="Russian Federation",]
# crops<- crops[crops$Country!="Saint Pierre and Miquelon",]
# crops<- crops[crops$Country!="Serbia",]
# crops<- crops[crops$Country!="Slovakia",]
# crops<- crops[crops$Country!="Slovenia",]
# crops<- crops[crops$Country!="South Sudan",]
# crops<- crops[crops$Country!="Sudan",]
# crops<- crops[crops$Country!="Sudan (former)",]
# crops<- crops[crops$Country!="Tajikistan",]
# crops<- crops[crops$Country!="The former Yugoslav Republic of Macedonia",]
# crops<- crops[crops$Country!="Turkmenistan",]
# crops<- crops[crops$Country!="Ukraine",]
# crops<- crops[crops$Country!="USSR",]
# crops<- crops[crops$Country!="Uzbekistan",]

#INclude Soviet, Yugoslav, Sudanese as former states

#USSR
levels(crops$Country)[levels(crops$Country)=="Armenia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Azerbaijan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Belarus"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Estonia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Georgia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Kazakhstan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Latvia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Lithuania"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Republic of Moldova"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Russian Federation"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Tajikistan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Turkmenistan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Ukraine"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="USSR"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Uzbekistan"] <- "Former USSR"


#Yugoslav states
levels(crops$Country)[levels(crops$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="The former Yugoslav Republic of Macedonia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Yugoslav SFR"] <- "Former Yugoslav SFR"



#Former Czechslovakia
levels(crops$Country)[levels(crops$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(crops$Country)[levels(crops$Country)=="Czech Republic"] <- "Former Czechoslovakia"
levels(crops$Country)[levels(crops$Country)=="Slovakia"] <- "Former Czechoslovakia"


#Former Sudan
levels(crops$Country)[levels(crops$Country)=="Sudan"] <- "Former Sudan"
levels(crops$Country)[levels(crops$Country)=="South Sudan"] <- "Former Sudan"
levels(crops$Country)[levels(crops$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(crops$Country)[levels(crops$Country)=="Eritrea"] <- "Former Ethiopia"
levels(crops$Country)[levels(crops$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(crops$Country)[levels(crops$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(crops$Country)[levels(crops$Country)=="Luxembourg"] <-"Belgium"

#remove partial data stes 
crops<- crops[crops$Country!="Occupied Palestinian Territory",]
crops<- crops[crops$Country!="Micronesia (Federated States of)",]
crops<- crops[crops$Country!="China",]


crops <- crops[crops$Year!=2014,]
crops<- crops[,c(1:7)]


write.csv(crops, file="Crop Production 1961-2013.csv", row.names = FALSE)





##LIVESTOCK DATA

livestockfull<-read.csv("Production_LivestockPrimary_E_All_Data_(Norm).csv")
names(livestockfull)
livestock<-livestockfull[,c(2, 4, 6, 8:11)]
head(livestock)
rm(livestockfull)

#add country codes
livestock$Codes<-countrycode(livestock$Country, "country.name", "iso3c", warn=T)
summary(livestock)

livestock<-livestock[!is.na(livestock$Codes),]
summary(livestock)

#only use total production
#levels(livestock$Item)[levels(livestock$Item)=="Meat indigenous, total"] <- "Meat indigenous, Total"

#reduce to totals and production
livestock<-livestock[grep("Total",livestock$Item),]
livestock<-livestock[livestock$Element=="Production",]

table(livestock$Country)
summary(livestock)

write.csv(livestock, file = "livestocktotals.csv", row.names = F)

livestock<-read.csv("livestocktotals.csv", header = T)

#aggregate production
names(livestock)

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(livestock$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(livestock$Value, livestock$Country==levels(livestock$Country)[i]& livestock$Year==years[j]))))
  }
}

##Country and Year columns
Country<-rep(levels(livestock$Country), 1, each=length(years))
Year<-rep(years, length(levels(livestock$Country)))

##New data frame 
agglivestock<-cbind.data.frame(Country, Year, Total)


pdf(file="Livestock - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(agglivestock$Country))){
  values<-subset(agglivestock$Total, agglivestock$Country==levels(agglivestock$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agglivestock$Country)[i], pch=20, cex=0.75)
  }
dev.off()


#remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 32 removed for livestock
# livestock<- livestock[livestock$Country!="Armenia",]
# livestock<- livestock[livestock$Country!="Azerbaijan",]
# livestock<- livestock[livestock$Country!="Belarus",]
# livestock<- livestock[livestock$Country!="Belgium",]
# livestock<- livestock[livestock$Country!="Bosnia and Herzegovina",]
# livestock<- livestock[livestock$Country!="Croatia",]
# livestock<- livestock[livestock$Country!="Czech Republic",]
# livestock<- livestock[livestock$Country!="Czechoslovakia",]
# livestock<- livestock[livestock$Country!="Eritrea",]
# livestock<- livestock[livestock$Country!="Estonia",]
# livestock<- livestock[livestock$Country!="Ethiopia",]
# livestock<- livestock[livestock$Country!="Ethiopia PDR",]
# livestock<- livestock[livestock$Country!="Georgia",]
# livestock<- livestock[livestock$Country!="Kazakhstan",]
# livestock<- livestock[livestock$Country!="Kyrgyzstan",]
# livestock<- livestock[livestock$Country!="Latvia",]
# livestock<- livestock[livestock$Country!="Lithuania",]
# livestock<- livestock[livestock$Country!="Luxembourg",]
# livestock<- livestock[livestock$Country!="Micronesia (Federated States of)",]
# livestock<- livestock[livestock$Country!="Montenegro",]
# livestock<- livestock[livestock$Country!="Occupied Palestinian Territory",]
# livestock<- livestock[livestock$Country!="Republic of Moldova",]
# livestock<- livestock[livestock$Country!="Russian Federation",]
# livestock<- livestock[livestock$Country!="Serbia",]
# livestock<- livestock[livestock$Country!="Slovakia",]
# livestock<- livestock[livestock$Country!="Slovenia",]
# livestock<- livestock[livestock$Country!="South Sudan",]
# livestock<- livestock[livestock$Country!="Tajikistan",]
# livestock<- livestock[livestock$Country!="The former Yugoslav Republic of Macedonia",]
# livestock<- livestock[livestock$Country!="Turkmenistan",]
# livestock<- livestock[livestock$Country!="Ukraine",]
# livestock<- livestock[livestock$Country!="USSR",]
# livestock<- livestock[livestock$Country!="Uzbekistan",]


#INclude Soviet, Yugoslav, Sudanese as former states

#USSR
levels(livestock$Country)[levels(livestock$Country)=="Armenia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Azerbaijan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Belarus"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Estonia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Georgia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Kazakhstan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Latvia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Lithuania"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Republic of Moldova"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Russian Federation"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Tajikistan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Turkmenistan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Ukraine"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="USSR"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(livestock$Country)[levels(livestock$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="The former Yugoslav Republic of Macedonia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Yugoslav SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(livestock$Country)[levels(livestock$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(livestock$Country)[levels(livestock$Country)=="Czech Republic"] <- "Former Czechoslovakia"
levels(livestock$Country)[levels(livestock$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(livestock$Country)[levels(livestock$Country)=="Sudan"] <- "Former Sudan"
levels(livestock$Country)[levels(livestock$Country)=="South Sudan"] <- "Former Sudan"
levels(livestock$Country)[levels(livestock$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(livestock$Country)[levels(livestock$Country)=="Eritrea"] <- "Former Ethiopia"
levels(livestock$Country)[levels(livestock$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(livestock$Country)[levels(livestock$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(livestock$Country)[levels(livestock$Country)=="Luxembourg"] <-"Belgium"

#remove partial data stes 
livestock<- livestock[livestock$Country!="Occupied Palestinian Territory",]
livestock<- livestock[livestock$Country!="Micronesia (Federated States of)",]
livestock<- livestock[livestock$Country!="China",]

livestock <- livestock[livestock$Year!=2014,]
livestock <- livestock[, c(1:7)]

write.csv(livestock, file="Livestock Production 1961-2013.csv", row.names = FALSE)





##MARINE FISHERIES DATA

fisheries<-read.csv("Adjusted Fisheries landings.csv")
summary(fisheries)
levels(fisheries$CountryName)

#replace space in country name strings
for (i in 1:length(levels(fisheries$CountryName))){
  levels(fisheries$CountryName)[i]<-trimws(levels(fisheries$CountryName)[i], which="right")
}
levels(fisheries$CountryName)

#replace space in taxon name
for (i in 1:length(levels(fisheries$TaxonName))){
  levels(fisheries$TaxonName)[i]<-trimws(levels(fisheries$TaxonName)[i], which="right")
}
levels(fisheries$TaxonName)

#replace space in common name
for (i in 1:length(levels(fisheries$CommonName))){
  levels(fisheries$CommonName)[i]<-trimws(levels(fisheries$CommonName)[i], which="right")
}
levels(fisheries$CommonName)

#replace space in functional name
for (i in 1:length(levels(fisheries$FunctionalName))){
  levels(fisheries$FunctionalName)[i]<-trimws(levels(fisheries$FunctionalName)[i], which="right")
}
levels(fisheries$FunctionalName)


##replace space in ISSCAAPName
for (i in 1:length(levels(fisheries$ISSCAAPName))){
  levels(fisheries$ISSCAAPName)[i]<-trimws(levels(fisheries$ISSCAAPName)[i], which="right")
}
levels(fisheries$ISSCAAPName)

names(fisheries)
summary(fisheries)

#total landings
fisheries$Value <- fisheries$LSFT + fisheries$SSFT +fisheries$IUUT

#codes 
fisheries$Codes <- countrycode(fisheries$CountryName, origin = "country.name", destination = "iso3c", warn = T)


#Change a few of the names to correct the codes
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Amer Samoa"] <- "American Samoa"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Br Ind Oc Tr"] <- "British Indian Ocean Territory"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Br Virgin Is"] <- "British Virgin Islands"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Channel Is"] <- "Channel Islands"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Dominican Rp"] <- "Dominican Republic"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Fr Guiana"] <- "French Guiana"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Fr Polynesia"] <- "French Polynesia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="NethAntilles"] <- "Netherlands Antilles"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="St Pier Mq"] <- "Saint Pierre and Miquelon"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Untd Arab Em"] <- "United Arab Emirates"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="US Virgin Is"] <- "United States Virgin Islands"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="UK"] <- "United Kingdom"

#remove previous codes and repeat
fisheries <- fisheries[,(1:14)]
fisheries$Codes <- countrycode(fisheries$CountryName, origin = "country.name", destination = "iso3c", warn = T)

fisheries <- fisheries[!is.na(fisheries$Codes),]

write.csv(fisheries, file="fisheries - Watson adjusted landings 1950-2014 new.csv", row.names = F)

fisheries <- read.csv("fisheries - Watson adjusted landings 1950-2014 new.csv", header=T)



#aggregate production
names(fisheries)

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(fisheries$CountryName))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(fisheries$Value, fisheries$CountryName==levels(fisheries$CountryName)[i]& fisheries$Year==years[j]))))
  }
}

##Country and Year columns
Country<-rep(levels(fisheries$CountryName), 1, each=length(years))
Year<-rep(years, length(levels(fisheries$CountryName)))

##New data frame 
aggmarinefisheries<-cbind.data.frame(Country, Year, Total)


pdf(file="Marine fisheries - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(aggmarinefisheries$Country))){
  values<-subset(aggmarinefisheries$Total, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Landings (tonnes)", main=levels(aggmarinefisheries$Country)[i], pch=20, cex=0.75)
  }
dev.off()


# #remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 18 countries removed for marine fisheries
# 
# fisheries <- fisheries[fisheries$CountryName!="Bosnia Herzg",]
# fisheries <- fisheries[fisheries$CountryName!="Croatia",]
# fisheries <- fisheries[fisheries$CountryName!="Estonia",]
# fisheries <- fisheries[fisheries$CountryName!="Ethiopia",]
# fisheries <- fisheries[fisheries$CountryName!="Former USSR",]
# fisheries <- fisheries[fisheries$CountryName!="Georgia",]
# fisheries <- fisheries[fisheries$CountryName!="Gibraltar",]
# fisheries <- fisheries[fisheries$CountryName!="Latvia",]
# fisheries <- fisheries[fisheries$CountryName!="Lithuania",]
# fisheries <- fisheries[fisheries$CountryName!="Monaco",]
# fisheries <- fisheries[fisheries$CountryName!="Montenegro",]
# fisheries <- fisheries[fisheries$CountryName!="Norfolk I.",]
# fisheries <- fisheries[fisheries$CountryName!="Russian Fed",]
# fisheries <- fisheries[fisheries$CountryName!="Serbia",]
# fisheries <- fisheries[fisheries$CountryName!="Slovenia",]
# fisheries <- fisheries[fisheries$CountryName!="Timor Leste",]
# fisheries <- fisheries[fisheries$CountryName!="Tuvalu",]
# fisheries <- fisheries[fisheries$CountryName!="Ukraine",]
# fisheries <- fisheries[fisheries$CountryName!="Yugoslavia",]


#USSR
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Armenia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Azerbaijan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Belarus"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Estonia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Georgia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Kazakhstan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Kyrgyzstan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Latvia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Lithuania"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Republic of Moldova"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Russian Fed"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Tajikistan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Turkmenistan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Ukraine"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Former USSR"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Bosnia Herzg"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Croatia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Montenegro"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Serbia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Slovenia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="The former Yugoslav Republic of Macedonia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Yugoslavia"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Czech Republic"] <- "Former Czechoslovakia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Sudan"] <- "Former Sudan"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="South Sudan"] <- "Former Sudan"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Eritrea"] <- "Former Ethiopia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Ethiopia"] <- "Former Ethiopia"

levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Luxembourg"] <-"Belgium"

#remove partial data stes 
fisheries <- fisheries[fisheries$CountryName!="Occupied Palestinian Territory",]
fisheries <- fisheries[fisheries$CountryName!="British Indian Ocean Territory",]
fisheries <- fisheries[fisheries$CountryName!="Micronesia (Federated States of)",]
fisheries <- fisheries[fisheries$CountryName!="Gibraltar",]
fisheries <- fisheries[fisheries$CountryName!="Norfolk I.",]
fisheries <- fisheries[fisheries$CountryName!="Monaco",]
fisheries <- fisheries[fisheries$CountryName!="Tuvalu",]

fisheries <-fisheries[!fisheries$Year<1961,]
fisheries <-fisheries[fisheries$Year!=2014,]
levels(fisheries$CountryName)

fisheries <- fisheries[,c(1:14)]


write.csv(fisheries, file="Marine fisheries Production 1950-2014.csv", row.names = FALSE)



#INLAND FISHERIES DATA

freshfish<-read.csv("freshwater fisheries - landing 1950 - 2013.csv")
summary(freshfish)

names(freshfish)
names(freshfish)[names(freshfish)=="Country..Country."]<-"Country"
names(freshfish)[names(freshfish)=="Species..ASFIS.species."]<-"Species"
names(freshfish)[names(freshfish)=="Fishing.area..FAO.major.fishing.area."]<-"Fishing.area"
names(freshfish)[names(freshfish)=="Measure..Measure."]<-"Measure"
names(freshfish)


freshfish1<-freshfish%>%
  gather(Year, Value, -c(Country, Species, Fishing.area, Measure))
head(freshfish1)

#Sort years out (remove Xs)
freshfish1$Year<-gsub('X','',freshfish1$Year)
head(freshfish1) #looks good
freshfish1$Year <- as.factor(freshfish1$Year)

#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information
freshfish1$Value
freshfish1$Value[freshfish1$Value=="0 0"] <- 0.5
freshfish1$Value[freshfish1$Value=="-"] <- 0

#exclude unavailable data
freshfish1 <- freshfish1[freshfish1$Value!="...",]
freshfish1 <- freshfish1[freshfish1$Value!="",]

#Use estimates as data
freshfish1$Value <- gsub(' F', '', freshfish1$Value)
head(freshfish1)
freshfish1$Value <- as.numeric(freshfish1$Value)

freshfish1$Codes <- countrycode(freshfish1$Country, origin = "country.name", destination = "iso3c", warn=T)

#get rid of strange levels in variables
freshfish1 <- freshfish1[freshfish1$Country!="FAO. 2017. Fishery and Aquaculture Statistics. Global capture production 1950-2015 (FishstatJ). In: FAO Fisheries and Aquaculture Department [online]. Rome. Updated 2017. www.fao.org/fishery/statistics/software/fishstatj/en",]
freshfish1 <- freshfish1[freshfish1$Country!="Totals - Quantity (number)" ,]
freshfish1 <- freshfish1[freshfish1$Country!="Totals - Quantity (tonnes)" ,]

freshfish1 <- freshfish1[freshfish1$Measure!="",]

write.csv(freshfish1, "freshwater fisheries landings 1950 - 2015 tidy.csv", row.names = F)

freshfish <- read.csv("freshwater fisheries landings 1950 - 2015 tidy.csv", header = T)

#aggregate production

  years<-seq(1961, 2013, by=1)
  Total<-c()
  for (i in 1:length(levels(freshfish$Country))){
    for (j in 1:length(years)){
      Total<-c(Total, sum(as.numeric(subset(freshfish$Value, freshfish$Country==levels(freshfish$Country)[i]& freshfish$Year==years[j]))))
    }
  }
  
  ##Country and Year columns
  Country<-rep(levels(freshfish$Country), 1, each=length(years))
  Year<-rep(years, length(levels(freshfish$Country)))
  
  ##New data frame 
  aggfreshfisheries<-cbind.data.frame(Country, Year, Total)
  
  pdf(file="Inland fisheries - check print out.pdf", paper = "a4r")
  for (i in 1:length(levels(aggfreshfisheries$Country))){
    values<-subset(aggfreshfisheries$Total, aggfreshfisheries$Country==levels(aggfreshfisheries$Country)[i])
    plot(years, values, xlab="Year", ylab="Total Landings (tonnes)", main=levels(aggfreshfisheries$Country)[i], pch=20, cex=0.75)
    }
  dev.off()


#remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 44 countries removed for inland fisheries

# freshfish <- freshfish[freshfish$Country!="Armenia",]
# freshfish <- freshfish[freshfish$Country!="Aruba",]
# freshfish <- freshfish[freshfish$Country!="Azerbaijan",]
# freshfish <- freshfish[freshfish$Country!="Bahrain",]
# freshfish <- freshfish[freshfish$Country!="Belarus",]
# freshfish <- freshfish[freshfish$Country!="Belgium",]
# freshfish <- freshfish[freshfish$Country!="Bermuda",]
# freshfish <- freshfish[freshfish$Country!="Bosnia and Herzegovina",]
# freshfish <- freshfish[freshfish$Country!="Croatia",]
# freshfish <- freshfish[freshfish$Country!="Czechia",]
# freshfish <- freshfish[freshfish$Country!="Cyprus",]
# freshfish <- freshfish[freshfish$Country!="Czechia",]
# freshfish <- freshfish[freshfish$Country!="Czechoslovakia",]
# freshfish <- freshfish[freshfish$Country!="Eritrea",]
# freshfish <- freshfish[freshfish$Country!="Estonia",]
# freshfish <- freshfish[freshfish$Country!="Grenada",]
# freshfish <- freshfish[freshfish$Country!="Iceland",]
# freshfish <- freshfish[freshfish$Country!="Kazakhstan",]
# freshfish <- freshfish[freshfish$Country!="Kiribati",]
# freshfish <- freshfish[freshfish$Country!="Kyrgyzstan",]
# freshfish <- freshfish[freshfish$Country!="Latvia",]
# freshfish <- freshfish[freshfish$Country!="Libya",]
# freshfish <- freshfish[freshfish$Country!="Liechtenstein",]
# freshfish <- freshfish[freshfish$Country!="Lithuania",]
# freshfish <- freshfish[freshfish$Country!="Macedonia, Fmr Yug Rp of",]
# freshfish <- freshfish[freshfish$Country!="Micronesia, Fed.States of",]
# freshfish <- freshfish[freshfish$Country!="Moldova, Republic of",]
# freshfish <- freshfish[freshfish$Country!="Montenegro",]
# freshfish <- freshfish[freshfish$Country!="Palestine, Occupied Tr.",]
# freshfish <- freshfish[freshfish$Country!="Puerto Rico",]
# freshfish <- freshfish[freshfish$Country!="Russian Federation",]
# freshfish <- freshfish[freshfish$Country!="Saint Helena",]
# freshfish <- freshfish[freshfish$Country!="Serbia",]
# freshfish <- freshfish[freshfish$Country!="Serbia and Montenegro",]
# freshfish <- freshfish[freshfish$Country!="Slovakia",]
# freshfish <- freshfish[freshfish$Country!="Slovenia",]
# freshfish <- freshfish[freshfish$Country!="South Sudan",]
# freshfish <- freshfish[freshfish$Country!="Sudan",]
# freshfish <- freshfish[freshfish$Country!="Tajikistan",]
# freshfish <- freshfish[freshfish$Country!="Tonga",]
# freshfish <- freshfish[freshfish$Country!="Turkmenistan",]
# freshfish <- freshfish[freshfish$Country!="Ukraine",]
# freshfish <- freshfish[freshfish$Country!="Un. Sov. Soc. Rep.",]
# freshfish <- freshfish[freshfish$Country!="Uruguay",]
# freshfish <- freshfish[freshfish$Country!="Uzbekistan",]
# freshfish <- freshfish[freshfish$Country!="Yemen",]
# freshfish <- freshfish[freshfish$Country!="Yugoslavia SFR",]
  
#USSR
levels(freshfish$Country)[levels(freshfish$Country)=="Armenia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Azerbaijan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Belarus"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Estonia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Georgia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Kazakhstan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Latvia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Lithuania"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Moldova, Republic of"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Russian Federation"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Tajikistan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Turkmenistan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Ukraine"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Un. Sov. Soc. Rep."] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(freshfish$Country)[levels(freshfish$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Macedonia, Fmr Yug Rp of"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Yugoslavia SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(freshfish$Country)[levels(freshfish$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(freshfish$Country)[levels(freshfish$Country)=="Czechia"] <- "Former Czechoslovakia"
levels(freshfish$Country)[levels(freshfish$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(freshfish$Country)[levels(freshfish$Country)=="Sudan"] <- "Former Sudan"
levels(freshfish$Country)[levels(freshfish$Country)=="South Sudan"] <- "Former Sudan"
levels(freshfish$Country)[levels(freshfish$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(freshfish$Country)[levels(freshfish$Country)=="Eritrea"] <- "Former Ethiopia"
levels(freshfish$Country)[levels(freshfish$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(freshfish$Country)[levels(freshfish$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(freshfish$Country)[levels(freshfish$Country)=="Luxembourg"] <-"Belgium"

levels(freshfish$Country)[levels(freshfish$Country)=="Côte d'Ivoire"]<-"Cote d'Ivoire"
freshfish <- freshfish[freshfish$Country!="Saint Helena",]
freshfish <- freshfish[freshfish$Country!="French Southern Terr",]
freshfish <- freshfish[freshfish$Country!="Grenada",]
freshfish <- freshfish[freshfish$Country!="Iceland",]
freshfish <- freshfish[freshfish$Country!="Micronesia, Fed.States of",]
freshfish <- freshfish[freshfish$Country!="Norfolk Island",]
freshfish <- freshfish[freshfish$Country!="Palestine, Occupied Tr.",]
freshfish <- freshfish[freshfish$Country!="Puerto Rico",]
freshfish <- freshfish[freshfish$Country!="Tonga",]
freshfish <- freshfish[freshfish$Country!="Uruguay",]
freshfish <- freshfish[freshfish$Country!="Yemen",]
freshfish <- freshfish[freshfish$Country!="Channel Islands",]

freshfish <- freshfish[!freshfish$Year<1961,]
freshfish <- freshfish[!freshfish$Year>2013,]
freshfish <- freshfish[, c(1:6)]

write.csv(freshfish, file="Inland fisheries Production 1950-2014.csv", row.names = FALSE)



# AQUACULTURE PRODUCTION DATA

aquaculture<-read.csv("aquaculture 1950-2015 unfixed .csv")
levels(aquaculture$Land.Area)
summary(aquaculture)

#CHANGE column names  
names(aquaculture)
names(aquaculture)[names(aquaculture)=="Land.Area"]<-"Country"
names(aquaculture)[names(aquaculture)=="Ocean.Area"]<-"Waters"
inland<-aquaculture[aquaculture$Waters=="Inland waters",]
marine<-aquaculture[aquaculture$Waters=="Marine areas",]
  

#inland production

summary(inland)
inland$Codes<-countrycode(inland$Country, "country.name", "iso3c", warn=T)
inland$Codes[inland$Country=="RÃ©union"] <- "REU"
inland$Codes[inland$Country=="Serbia and Montenegro"] <- "BIH"

inland <- inland[!is.na(inland$Codes),]
summary(inland)

levels(inland$Country)
levels(inland$Waters)
levels(inland$Environment)
levels(inland$Species)

#only use fish crustaceans and molluscs

inland <- inland[inland$Species!="Aquatic plants",]
inland <- inland[inland$Species!="Miscellaneous aquatic animal products",]
inland <- inland[inland$Species!="Miscellaneous aquatic animals",]

write.csv(inland, "inland aquaculture 1950 -2015 tidy.csv", row.names = F)

inland <- read.csv("inland aquaculture 1950 -2015 tidy.csv", header=T)

#aggregate production

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(inland$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(inland$value, inland$Country==levels(inland$Country)[i] & inland$year==years[j]))))
  }
}


##Country and Year columns
Country<-rep(levels(inland$Country), 1, each=length(years))
Year<-rep(years, length(levels(inland$Country)))

##New data frame 
agginlandaqua<-cbind.data.frame(Country, Year, Total)

pdf(file="Inland aquaculture - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(agginlandaqua$Country))){
  values<-subset(agginlandaqua$Total, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agginlandaqua$Country)[i], pch=20, cex=0.75)
  }
dev.off()


# #remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 26 countries removed for inland aquaculture
# 
# inland <- inland[inland$Country!="Armenia",]
# inland <- inland[inland$Country!="Azerbaijan",]
# inland <- inland[inland$Country!="Belarus",]
# inland <- inland[inland$Country!="Bosnia and Herzegovina",]
# inland <- inland[inland$Country!="Botswana",]
# inland <- inland[inland$Country!="Croatia",]
# inland <- inland[inland$Country!="Czechia",]
# inland <- inland[inland$Country!="Czechoslovakia",]
# inland <- inland[inland$Country!="Estonia",]
# inland <- inland[inland$Country!="Ethiopia",]
# inland <- inland[inland$Country!="Georgia",]
# inland <- inland[inland$Country!="Kazakhstan",]
# inland <- inland[inland$Country!="Kyrgyzstan",]
# inland <- inland[inland$Country!="Latvia",]
# inland <- inland[inland$Country!="Lithuania",]
# inland <- inland[inland$Country!="Macedonia, Fmr Yug Rp of",]
# inland <- inland[inland$Country!="Moldova, Republic of",]
# inland <- inland[inland$Country!="Montenegro",]
# inland <- inland[inland$Country!="Palestine, Occupied Tr.",]
# inland <- inland[inland$Country!="Russian Federation",]
# inland <- inland[inland$Country!="Slovakia",]
# inland <- inland[inland$Country!="Slovenia",]
# inland <- inland[inland$Country!="Solomon Islands",]
# inland <- inland[inland$Country!="Tajikistan",]
# inland <- inland[inland$Country!="Timor???Leste",]
# inland <- inland[inland$Country!="Turkmenistan",]
# inland <- inland[inland$Country!="Ukraine",]
# inland <- inland[inland$Country!="Uzbekistan",]
# inland <- inland[inland$Country!="Yugoslavia SFR",]

#Former USSR
levels(inland$Country)[levels(inland$Country)=="Armenia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Azerbaijan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Belarus"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Estonia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Georgia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Kazakhstan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Latvia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Lithuania"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Moldova, Republic of"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Russian Federation"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Tajikistan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Turkmenistan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Ukraine"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Un. Sov. Soc. Rep."] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(inland$Country)[levels(inland$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Macedonia, Fmr Yug Rp of"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Yugoslavia SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(inland$Country)[levels(inland$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(inland$Country)[levels(inland$Country)=="Czechia"] <- "Former Czechoslovakia"
levels(inland$Country)[levels(inland$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(inland$Country)[levels(inland$Country)=="Sudan"] <- "Former Sudan"
levels(inland$Country)[levels(inland$Country)=="South Sudan"] <- "Former Sudan"
levels(inland$Country)[levels(inland$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(inland$Country)[levels(inland$Country)=="Eritrea"] <- "Former Ethiopia"
levels(inland$Country)[levels(inland$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(inland$Country)[levels(inland$Country)=="Ethiopia"] <- "Former Ethiopia"

levels(inland$Country)[levels(inland$Country)=="Luxembourg"] <-"Belgium"

inland <- inland[inland$Country!="Botswana",]
inland <- inland[inland$Country!="Micronesia, Fed.States of",]
inland <- inland[inland$Country!="Palestine, Occupied Tr.",]
inland <- inland[inland$Country!="Tuvalu",]
inland <- inland[inland$Country!="Solomon Islands",]
inland <- inland[inland$Country!="Marshall Islands",]
inland <- inland[inland$Country!="Timor???Leste",]
inland <- inland[inland$Country!="Ghana",]
inland <- inland[inland$Country!="Aruba",]
inland <- inland[inland$Country!="Bonaire/S.Eustatius/Saba",]
inland <- inland[inland$Country!="Falkland Is.(Malvinas)",]
inland <- inland[inland$Country!="Gambia",]
inland <- inland[inland$Country!="Nauru",]
inland <- inland[inland$Country!="Netherlands Antilles",]
inland <- inland[inland$Country!="Saint Kitts and Nevis",]
inland <- inland[inland$Country!="Turks and Caicos Is.",]
inland <- inland[inland$Country!="United Arab Emirates",]
inland <- inland[inland$Country!="Yemen",]

inland <- inland[!inland$year<1961,]
inland <- inland[!inland$year>2013,]
inland <- inland[,c(1:8)]


write.csv(inland, file="Inland aquaculture Production 1950-2014.csv", row.names = FALSE)

##marine production 

marine$Codes <- countrycode(marine$Country, origin = "country.name", destination = "iso3c", warn=T)
marine$Codes[marine$Country=="RÃ©union"] <- "REU"
marine$Codes[marine$Country=="Serbia and Montenegro"] <- "BIH"
marine <- marine[!is.na(marine$Codes),]

summary(marine)

write.csv(marine, "Marine aquaculture production 1950 -2013 tidy.csv", row.names = F)

marine <- read.csv("Marine aquaculture production 1950 -2013 tidy.csv", header=TRUE)

##aggregate production

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(marine$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(marine$value, marine$Country==levels(marine$Country)[i] & marine$year==years[j]))))
  }
}


Country<-rep(levels(marine$Country), 1, each=length(years))
Year<-rep(years, length(levels(marine$Country)))
aggmarineaqua<-cbind.data.frame(Country, Year, Total)



pdf(file="Marine aquaculture - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(aggmarineaqua$Country))){
  values<-subset(aggmarineaqua$Total, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggmarineaqua$Country)[i], pch=20, cex=0.75)
  }
dev.off()

#remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 10 countries removed for marine aquaculture


# marine <- marine[marine$Country!="Bosnia and Herzegovina",]
# marine <- marine[marine$Country!="Eritrea",]
# marine <- marine[marine$Country!="Estonia",]
# marine <- marine[marine$Country!="Georgia",]
# marine <- marine[marine$Country!="Ghana",] #zeroes for whole time series
# marine <- marine[marine$Country!="Marshall Islands",]
# marine <- marine[marine$Country!="Micronesia, Fed.States of",]
# marine <- marine[marine$Country!="Montenegro",]
# marine <- marine[marine$Country!="Palestine, Occupied Tr.",]
# marine <- marine[marine$Country!="Russian Federation",]
# marine <- marine[marine$Country!="Tuvalu",]
# marine <- marine[marine$Country!="Ukraine",]
# marine <- marine[marine$Country!="Yugoslavia SFR",]

#USSR

levels(marine$Country)[levels(marine$Country)=="Armenia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Azerbaijan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Belarus"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Estonia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Georgia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Kazakhstan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Latvia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Lithuania"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Moldova, Republic of"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Russian Federation"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Tajikistan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Turkmenistan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Ukraine"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Un. Sov. Soc. Rep."] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(marine$Country)[levels(marine$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Macedonia, Fmr Yug Rp of"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Yugoslavia SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(marine$Country)[levels(marine$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(marine$Country)[levels(marine$Country)=="Czechia"] <- "Former Czechoslovakia"
levels(marine$Country)[levels(marine$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(marine$Country)[levels(marine$Country)=="Sudan"] <- "Former Sudan"
levels(marine$Country)[levels(marine$Country)=="South Sudan"] <- "Former Sudan"
levels(marine$Country)[levels(marine$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(marine$Country)[levels(marine$Country)=="Eritrea"] <- "Former Ethiopia"
levels(marine$Country)[levels(marine$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(marine$Country)[levels(marine$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(marine$Country)[levels(marine$Country)=="Luxembourg"] <-"Belgium"

marine <- marine[marine$Country!="Botswana",]
marine <- marine[marine$Country!="Micronesia, Fed.States of",]
marine <- marine[marine$Country!="Palestine, Occupied Tr.",]
marine <- marine[marine$Country!="Tuvalu",]
marine <- marine[marine$Country!="Solomon Islands",]
marine <- marine[marine$Country!="Marshall Islands",]
marine <- marine[marine$Country!="Timor???Leste",]
marine <- marine[marine$Country!="Ghana",]
marine <- marine[marine$Country!="Aruba",]
marine <- marine[marine$Country!="Bonaire/S.Eustatius/Saba",]
marine <- marine[marine$Country!="Falkland Is.(Malvinas)",]
marine <- marine[marine$Country!="Gambia",]
marine <- marine[marine$Country!="Nauru",]
marine <- marine[marine$Country!="Netherlands Antilles",]
marine <- marine[marine$Country!="Saint Kitts and Nevis",]
marine <- marine[marine$Country!="Turks and Caicos Is.",]
marine <- marine[marine$Country!="United Arab Emirates",]
marine <- marine[marine$Country!="Yemen",]

marine <- marine[!marine$year<1961,]
marine <- marine[!marine$year>2013,]

marine <- marine[,c(1:8)]

write.csv(marine, "Marine aquaculture production 1950 -2015.csv", row.names=F)


ls
```
## AGGREGATE PRODUCTION DATA 

```{r}
crops<-read.csv("Crop Production 1961-2013.csv", header=T)
aggcrops <- stats::aggregate(crops$Value~crops$Year+crops$Country, FUN=sum, drop=FALSE)
names(aggcrops)[names(aggcrops)=="crops$Year"] <- "Year"
names(aggcrops)[names(aggcrops)=="crops$Country"] <- "Country"
names(aggcrops)[names(aggcrops)=="crops$Value"] <- "Value"


livestock <- read.csv("Livestock Production 1961-2013.csv", header=T)
agglivestock <- stats::aggregate(livestock$Value~livestock$Year+livestock$Country, FUN=sum, drop=FALSE)
names(agglivestock)[names(agglivestock)=="livestock$Year"] <- "Year"
names(agglivestock)[names(agglivestock)=="livestock$Country"] <- "Country"
names(agglivestock)[names(agglivestock)=="livestock$Value"] <- "Value"

marinefisheries <- read.csv("Marine fisheries Production 1950-2014.csv", header = T)
aggmarinefisheries <-aggregate(marinefisheries$Value~marinefisheries$Year+marinefisheries$Country, FUN=sum, drop=FALSE)
names(aggmarinefisheries)[names(aggmarinefisheries)=="marinefisheries$Year"] <- "Year"
names(aggmarinefisheries)[names(aggmarinefisheries)=="marinefisheries$Country"] <- "Country"
names(aggmarinefisheries)[names(aggmarinefisheries)=="marinefisheries$Value"] <- "Value"

inlandfisheries<- read.csv("Inland fisheries Production 1950-2014.csv", header = T)
agginlandfisheries <-aggregate(inlandfisheries$Value~inlandfisheries$Year+inlandfisheries$Country, FUN=sum, drop=FALSE)
names(agginlandfisheries)[names(agginlandfisheries)=="inlandfisheries$Year"] <- "Year"
names(agginlandfisheries)[names(agginlandfisheries)=="inlandfisheries$Country"] <- "Country"
names(agginlandfisheries)[names(agginlandfisheries)=="inlandfisheries$Value"] <- "Value"

inlandaqua<- read.csv("Inland aquaculture Production 1950-2014.csv", header=T)
agginlandaqua <- aggregate(inlandaqua$value~inlandaqua$year+inlandaqua$Country, FUN=sum, drop=FALSE)
names(agginlandaqua)[names(agginlandaqua)=="inlandaqua$year"] <- "Year"
names(agginlandaqua)[names(agginlandaqua)=="inlandaqua$Country"] <- "Country"
names(agginlandaqua)[names(agginlandaqua)=="inlandaqua$value"] <- "Value"

marineaqua <- read.csv("Marine aquaculture production 1950 -2015.csv", header=T)
aggmarineaqua <- aggregate(marineaqua$value~marineaqua$year+marineaqua$Country, FUN=sum, drop=FALSE)
names(aggmarineaqua)[names(aggmarineaqua)=="marineaqua$year"] <- "Year"
names(aggmarineaqua)[names(aggmarineaqua)=="marineaqua$Country"] <- "Country"
names(aggmarineaqua)[names(aggmarineaqua)=="marineaqua$value"] <- "Value"

#Number of countries per sector
length(levels(aggcrops$Country)) #188
length(levels(agglivestock$Country)) #191
length(levels(agginlandfisheries$Country)) #196
length(levels(agginlandaqua$Country)) #160
length(levels(aggmarinefisheries$Country)) #174
length(levels(aggmarineaqua$Country)) #125



#aggregate inland and marine production for both aquaculture and fisheries
#fisheries
aggmarinefisheries2<-aggmarinefisheries
names(aggmarinefisheries2)[names(aggmarinefisheries2)=="Value"]<-"Marine"
aggmarinefisheries2$Codes <-countrycode(aggmarinefisheries2$Country, origin = "country.name", destination="iso3c", warn=T)
aggmarinefisheries2$Codes[aggmarinefisheries2$Country=="Former Yugoslav SFR"]<-"BIH"

agginlandfisheries2<-agginlandfisheries
names(agginlandfisheries2)[names(agginlandfisheries2)=="Value"]<-"Inland"
agginlandfisheries2$Codes<-countrycode(agginlandfisheries2$Country, origin = "country.name", destination = "iso3c", warn=T)
agginlandfisheries2$Codes[agginlandfisheries2$Country=="Former Yugoslav SFR"]<-"BIH"


aggfisheries <- plyr::join(x=agginlandfisheries2, y=aggmarinefisheries2, by=c("Codes", "Year"), type="full")
aggfisheries$Marine[is.na(aggfisheries$Marine)]<-0
aggfisheries$Inland[is.na(aggfisheries$Inland)]<-0
aggfisheries$Value<-aggfisheries$Inland+aggfisheries$Marine

write.csv(aggfisheries,file = "aggfisheries.csv", row.names=F)
aggfisheries <- read.csv("aggfisheries.csv", header=T)

levels(aggfisheries$Country)

#aquaculture
aggmarineaqua2<-aggmarineaqua
names(aggmarineaqua2)[names(aggmarineaqua2)=="Value"]<-"Marine"
aggmarineaqua2$Codes <-countrycode(aggmarineaqua2$Country, origin="country.name", destination="iso3c", warn=T)
aggmarineaqua2$Codes[aggmarineaqua2$Country=="Former Yugoslav SFR"]<-"BIH"
aggmarineaqua2$Codes[aggmarineaqua2$Country=="RÃ©union"]<-"REU"

agginlandaqua2<-agginlandaqua
names(agginlandaqua2)[names(agginlandaqua2)=="Value"]<-"Inland"
agginlandaqua2$Codes <-countrycode(agginlandaqua2$Country, origin="country.name", destination="iso3c", warn=T)
agginlandaqua2$Codes[agginlandaqua2$Country=="Former Yugoslav SFR"]<-"BIH"
agginlandaqua2$Codes[agginlandaqua2$Country=="RÃ©union"]<-"REU"

aggaqua <- plyr::join(x=agginlandaqua2, y=aggmarineaqua2, by=c("Codes", "Year"), type="full")
aggaqua$Marine[is.na(aggaqua$Marine)]<-0
aggaqua$Inland[is.na(aggaqua$Inland)]<-0
aggaqua$Value<-aggaqua$Inland+aggaqua$Marine

write.csv(aggaqua,file = "aggaqua.csv", row.names=F)
aggaqua <- read.csv("aggaqua.csv", header=T)

##no of countries producing in each sector by year

years<-seq(1961, 2013, by=1)


zeroes <- function(x){
  length(x[x>0])
  
}

(CropsN<-as.numeric(tapply(aggcrops$Value, aggcrops$Year, FUN = zeroes)))
CropsN<-cbind.data.frame(years, CropsN)
names(CropsN)[names(CropsN)=="years"]<-"Year"

LivestockN <- as.numeric(tapply(agglivestock$Value, agglivestock$Year, FUN= zeroes))
LivestockN<-cbind.data.frame(years, LivestockN)
names(LivestockN)[names(LivestockN)=="years"] <- "Year"

FisheriesN <- as.numeric(tapply(aggfisheries$Value, aggfisheries$Year, FUN=zeroes))
FisheriesN<-cbind.data.frame(years, FisheriesN)
names(FisheriesN)[names(FisheriesN)=="years"] <- "Year"


AquacultureN <- as.numeric(tapply(aggaqua$Value, aggaqua$Year, FUN = zeroes))
(AquacultureN <-cbind.data.frame(years, AquacultureN))
names(AquacultureN)[names(AquacultureN)=="years"] <- "Year"



```

#ADD GEOGRAPHICAL REGIONS TO AGGREGATED PRODUCTION DATA

```{r}

#subregions

N_Africa <- c("Algeria", "Egypt", "Libya", "Morocco", "Sudan", "Tunisia")
E_Africa <- c("Burundi", "Comoros", "Djibouti", "Eritrea", "Ethiopia", "Kenya", "Madagascar", "Malawi", "Mauritius", "Mozambique", "Rwanda", "Seychelles", "Somalia", "South Sudan", "Uganda","Tanzania", "Zambia", "Zimbabwe","United Republic of Tanzania" , "Tanzania, United Rep. of", "Zanzibar")
M_Africa <- c("Angola", "Cameroon", "Central African Republic", "Chad", "Congo", "Dem. Rep. Congo", "Equatorial Guinea", "Gabon", "Sao Tome and Principe", "St Helena", "Congo, Dem. Rep. of the", "Democratic Republic of the Congo" )
S_Africa <- c("Botswana", "Lesotho", "Namibia", "South Africa", "Swaziland")
W_Africa <- c("Benin", "Burkina Faso", "Cabo Verde", "Côte d'Ivoire", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Liberia", "Mali", "Mauritania", "Niger", "Nigeria", "Senegal", "Sierra Leone", "Togo")

#Asia

E_Asia <- c("China, mainland", "China, Hong Kong SAR", "China, Macao SAR",  "N. Korea", "Japan", "Mongolia", "Republic of Korea","Democratic People's Republic of Korea", "Korea, Dem. People's Rep", "Northern Mariana Is.")
SE_Asia <- c("Brunei Darussalam", "Cambodia", "Indonesia", "Lao People's Democratic Republic", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Timor-Leste", "Viet Nam")
S_Asia <- c("Afghanistan", "Bangladesh", "Bhutan", "India", "Iran (Islamic Republic of)", "Maldives", "Nepal", "Pakistan", "Sri Lanka")
W_Asia <- c("Armenia", "Bahrain", "Cyprus", "Iraq", "Israel", "Jordan", "Kuwait", "Lebanon", "Oman", "Palestine", "Qatar", "Saudi Arabia","Syrian Arab Republic", "Turkey", "United Arab Emirates" , "Yemen")

#Latin America/Caribbean

Caribbean <- c("Antigua and Barbuda", "Anguilla", "Aruba", "Bahamas", "Barbados", "British Virgin Islands",  "Cuba", "Cayman Islands", "Dominica", "Dominican Republic", "Grenada", "Guadeloupe", "Haiti", "Jamaica", "Martinique", "Mayotte", "Montserrat", "Netherlands Antilles", "Puerto Rico", "Saint Kitts and Nevis", "Saint Lucia", "St. Vin.&Gren.", "Trinidad and Tobago", "Turks and Caicos Is.", "US Virgin Islands", "Saint Vincent and the Grenadines", "Saint Vincent/Grenadines")

C_America <- c("Belize", "Costa Rica", "El Salvador", "Guatemala", "Honduras", "Mexico", "Nicaragua", "Panama")
S_America <- c("Argentina", "Bolivia (Plurinational State of)", "Brazil", "Chile", "Colombia", "Ecuador", "French Guiana", "Guyana", "Paraguay", "Peru", "Suriname", "Uruguay", "Venezuela","Venezuela (Bolivarian Republic of)", "Venezuela, Boliv Rep of", "Falkland Islands (Malvinas)")

#Oceania
Aus_NZ <- c("Australia", "New Zealand")
Melanesia <- c("Fiji",  "New Caledonia", "Papua New Guinea", "Solomon Islands", "Vanuatu", "Fiji, Republic of" )
Micronesia <- c("Guam", "Kiribati", "Marshall Islands", "Micronesia (Federated States of)", "Nauru", "Palau")
Polynesia <- c("American Samoa", "Cook Islands", "French Polynesia", "Niue", "Samoa", "Tokelau", "Tonga", "Tuvalu", "Wallis and Futuna Islands", "Pitcairn Islands")

#North AMerica
N_America <- c("Bermuda", "United States of America", "Canada", "Greenland", "St. Pierre and Miquelon")

#Europe
E_Europe <- c("Bulgaria", "Former Czechoslovakia", "Hungary", "Poland", "Romania", "Ukraine", "Former USSR")
N_Europe <- c("Denmark", "Finland", "Iceland", "Ireland", "Norway", "Sweden", "United Kingdom", "Faroe Islands", "Isle of Man" )
S_Europe <- c("Albania", "Andorra", "Croatia", "Greece", "Italy", "Malta", "Portugal", "Spain",  "Former Yugoslav SFR", "San Marino")
W_Europe <- c("Austria", "Belgium", "France", "Germany", "Luxembourg", "Netherlands", "Switzerland" )


N_Africa_codes <- countrycode(N_Africa, origin = "country.name", destination="iso3c", warn=T)
E_Africa_codes <- countrycode(E_Africa, origin = "country.name", destination="iso3c", warn=T )
M_Africa_codes <-  countrycode(M_Africa, origin = "country.name", destination="iso3c", warn=T) 
S_Africa_codes <- countrycode(S_Africa, origin = "country.name", destination="iso3c", warn=T)
W_Africa_codes <- countrycode(W_Africa, origin = "country.name", destination="iso3c", warn=T)

E_Asia_codes <-  countrycode(E_Asia, origin = "country.name", destination="iso3c", warn=T)
SE_Asia_codes <- countrycode(SE_Asia, origin = "country.name", destination="iso3c", warn=T)
S_Asia_codes <- countrycode(S_Asia, origin = "country.name", destination="iso3c", warn=T)
W_Asia_codes <-  countrycode(W_Asia, origin = "country.name", destination="iso3c", warn=T)

Caribbean_codes <- countrycode(Caribbean, origin = "country.name", destination="iso3c", warn=T)
Caribbean_codes[22] <- "VIN"
C_America_codes <- countrycode(C_America, origin = "country.name", destination="iso3c", warn=T)
S_America_codes <- countrycode(S_America, origin = "country.name", destination="iso3c", warn=T)
N_America_codes <- countrycode(N_America, origin = "country.name", destination="iso3c", warn=T)


Aus_NZ_codes <- countrycode(Aus_NZ, origin = "country.name", destination="iso3c", warn=T)
Melanesia_codes <- countrycode(Melanesia, origin = "country.name", destination="iso3c", warn=T) 
Micronesia_codes <- countrycode(Micronesia, origin = "country.name", destination="iso3c", warn=T)
Polynesia_codes <- countrycode(Polynesia, origin = "country.name", destination="iso3c", warn=T) 

E_Europe_codes <- countrycode(E_Europe, origin = "country.name", destination="iso3c", warn=T)
N_Europe_codes <-  countrycode(N_Europe, origin = "country.name", destination="iso3c", warn=T)
S_Europe_codes <- countrycode(S_Europe, origin = "country.name", destination="iso3c", warn=T)
S_Europe_codes[9] <- "BIH"
W_Europe_codes <- countrycode(W_Europe, origin = "country.name", destination="iso3c", warn=T)



#Main continents for crops
aggcrops <- aggcrops %>% 
  mutate(Code = countrycode(Country, origin="country.name", destination= "iso3c", warn=T)) %>% 
  mutate(Code = case_when(Country == "Former Yugoslav SFR" ~ "BIH",
                          T ~ Code)) %>% 
  mutate(Continent = case_when(Code %in% N_America_codes ~ "North America",
                               Code %in% C_America_codes ~ "Central America",
                               Code %in% Caribbean_codes ~ "Caribbean",
                               Code %in% S_America_codes ~ "South America",
                               Code %in% N_Europe_codes ~ "Northern Europe",
                               Code %in% W_Europe_codes ~ "Western Europe",
                               Code %in% S_Europe_codes ~ "Southern Europe",
                               Code %in% E_Europe_codes ~ "Eastern Europe",
                               Code %in% N_Africa_codes ~ "North Africa",
                               Code %in% W_Africa_codes ~ "West Africa",
                               Code %in% M_Africa_codes ~ "Central Africa",
                               Code %in% S_Africa_codes ~ "Southern Africa",
                               Code %in% E_Africa_codes ~ "East Africa",
                               Code %in% W_Asia_codes ~ "Western Asia",
                               Code %in% S_Asia_codes ~ "South Asia",
                               Code %in% SE_Asia_codes ~ "SE Asia",
                               Code %in% E_Asia_codes ~ "East Asia",
                               Code %in% Aus_NZ_codes ~ "Australia/NZ",
                               Code %in% Melanesia_codes ~ "Melanesia",
                               Code %in% Micronesia_codes ~ "Micronesia",
                               Code %in% Polynesia_codes ~ "Polynesia",
                               Code == "TWN" ~ "East Asia",
                               Code =="LIE" ~ "Western Europe",
                               Code == "REU" ~ "East Africa",
                               Code == "ESH" ~ "West Africa", 
                               Country == "Former Yugoslav SFR" ~ "Southern Europe"))



agglivestock <- agglivestock %>% 
  mutate(Code = countrycode(Country, origin="country.name", destination= "iso3c", warn=T)) %>% 
  mutate(Code = case_when(Country == "Former Yugoslav SFR" ~ "BIH",
                          T ~ Code)) %>% 
  mutate(Continent = case_when(Code %in% N_America_codes ~ "North America",
                               Code %in% C_America_codes ~ "Central America",
                               Code %in% Caribbean_codes ~ "Caribbean",
                               Code %in% S_America_codes ~ "South America",
                               Code %in% N_Europe_codes ~ "Northern Europe",
                               Code %in% W_Europe_codes ~ "Western Europe",
                               Code %in% S_Europe_codes ~ "Southern Europe",
                               Code %in% E_Europe_codes ~ "Eastern Europe",
                               Code %in% N_Africa_codes ~ "North Africa",
                               Code %in% W_Africa_codes ~ "West Africa",
                               Code %in% M_Africa_codes ~ "Central Africa",
                               Code %in% S_Africa_codes ~ "Southern Africa",
                               Code %in% E_Africa_codes ~ "East Africa",
                               Code %in% W_Asia_codes ~ "Western Asia",
                               Code %in% S_Asia_codes ~ "South Asia",
                               Code %in% SE_Asia_codes ~ "SE Asia",
                               Code %in% E_Asia_codes ~ "East Asia",
                               Code %in% Aus_NZ_codes ~ "Australia/NZ",
                               Code %in% Melanesia_codes ~ "Melanesia",
                               Code %in% Micronesia_codes ~ "Micronesia",
                               Code %in% Polynesia_codes ~ "Polynesia",
                               Code == "TWN" ~ "East Asia",
                               Code =="LIE" ~ "Western Europe",
                               Code == "REU" ~ "East Africa",
                               Code == "ESH" ~ "West Africa", 
                               Country == "Former Yugoslav SFR" ~ "Southern Europe"))



aggfisheries <- aggfisheries %>% 
  mutate(Code = countrycode(Country, origin="country.name", destination= "iso3c", warn=T)) %>% 
  mutate(Code = case_when(Country == "Former Yugoslav SFR" ~ "BIH",
                          T ~ Code)) %>% 
  mutate(Continent = case_when(Code %in% N_America_codes ~ "North America",
                               Code %in% C_America_codes ~ "Central America",
                               Code %in% Caribbean_codes ~ "Caribbean",
                               Code %in% S_America_codes ~ "South America",
                               Code %in% N_Europe_codes ~ "Northern Europe",
                               Code %in% W_Europe_codes ~ "Western Europe",
                               Code %in% S_Europe_codes ~ "Southern Europe",
                               Code %in% E_Europe_codes ~ "Eastern Europe",
                               Code %in% N_Africa_codes ~ "North Africa",
                               Code %in% W_Africa_codes ~ "West Africa",
                               Code %in% M_Africa_codes ~ "Central Africa",
                               Code %in% S_Africa_codes ~ "Southern Africa",
                               Code %in% E_Africa_codes ~ "East Africa",
                               Code %in% W_Asia_codes ~ "Western Asia",
                               Code %in% S_Asia_codes ~ "South Asia",
                               Code %in% SE_Asia_codes ~ "SE Asia",
                               Code %in% E_Asia_codes ~ "East Asia",
                               Code %in% Aus_NZ_codes ~ "Australia/NZ",
                               Code %in% Melanesia_codes ~ "Melanesia",
                               Code %in% Micronesia_codes ~ "Micronesia",
                               Code %in% Polynesia_codes ~ "Polynesia",
                               Code == "TWN" ~ "East Asia",
                               Code =="LIE" ~ "Western Europe",
                               Code == "REU" ~ "East Africa",
                               Code == "ESH" ~ "West Africa", 
                               Country == "Former Yugoslav SFR" ~ "Southern Europe"))




aggaqua <-  aggaqua %>% 
  mutate(Continent = case_when(Codes %in% N_America_codes ~ "North America",
                               Codes %in% C_America_codes ~ "Central America",
                               Codes %in% Caribbean_codes ~ "Caribbean",
                               Codes %in% S_America_codes ~ "South America",
                               Codes %in% N_Europe_codes ~ "Northern Europe",
                               Codes %in% W_Europe_codes ~ "Western Europe",
                               Codes %in% S_Europe_codes ~ "Southern Europe",
                               Codes %in% E_Europe_codes ~ "Eastern Europe",
                               Codes %in% N_Africa_codes ~ "North Africa",
                               Codes %in% W_Africa_codes ~ "West Africa",
                               Codes %in% M_Africa_codes ~ "Central Africa",
                               Codes %in% S_Africa_codes ~ "Southern Africa",
                               Codes %in% E_Africa_codes ~ "East Africa",
                               Codes %in% W_Asia_codes ~ "Western Asia",
                               Codes %in% S_Asia_codes ~ "South Asia",
                               Codes %in% SE_Asia_codes ~ "SE Asia",
                               Codes %in% E_Asia_codes ~ "East Asia",
                               Codes %in% Aus_NZ_codes ~ "Australia/NZ",
                               Codes %in% Melanesia_codes ~ "Melanesia",
                               Codes %in% Micronesia_codes ~ "Micronesia",
                               Codes %in% Polynesia_codes ~ "Polynesia",
                               Codes == "TWN" ~ "East Asia",
                               Codes =="LIE" ~ "Western Europe",
                               Codes == "REU" ~ "East Africa",
                               Codes == "ESH" ~ "West Africa", 
                               Country == "Former Yugoslav SFR" ~ "Southern Europe"))

rm(marinefisheries, marineaqua, inlandaqua, inlandfisheries, agginlandaqua, agginlandaqua2, agginlandfisheries, agginlandfisheries2, aggmarineaqua, aggmarineaqua2, aggmarinefisheries, aggmarinefisheries2)


```

#SENSITIVITY ANALYSES NEEDED FOR FURTHER ANALYSES

#Supplementary Figure 5 - SENSITIVITY ANALYSES - Cooks Distance 

```{r}
#Crops

D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(D, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsNormal"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsSpan"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsDuration"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsAv"












#Livestock

D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockNormal"



D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockSpan"



D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockDuration"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockAv"






#Fisheries

D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesNormal"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesSpan"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesDuration"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesAv"









# #Marine fisheries
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     Valscountry<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=aggmarinefisheries)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Marine fisheries"
# 
# 
# #Inland fisheries
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     Valscountry<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=agginlandfisheries)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Inland fisheries"





#Aquaculture
D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureNormal"






D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureSpan"






D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureDuration"






D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureAv"





# #Marine aquaculture
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     Valscountry<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=aggmarineaqua)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Marine aquaculture"
# 
# 
# #Inland aquaculture
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     Valscountry<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=agginlandaqua)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Inland aquaculture"

Cooks<-rep(Shocks.df$D,16)
Sector<-rep(c("Crops", "Livestock", "Fisheries", "Aquaculture"),1, each=80)
Change<-rep(c("Selected Model", "Span=0.3","3 year baseline", "Average=Mean" ), 4, each=20)
Shock.freq<- c(Shocks.df$CropsNormal, Shocks.df$CropsSpan, Shocks.df$CropsDuration, Shocks.df$CropsAv, Shocks.df$LivestockNormal, Shocks.df$LivestockSpan, Shocks.df$LivestockDuration, Shocks.df$LivestockAv, Shocks.df$FisheriesNormal, Shocks.df$FisheriesSpan, Shocks.df$FisheriesDuration, Shocks.df$FisheriesAv, Shocks.df$AquacultureNormal, Shocks.df$AquacultureSpan, Shocks.df$AquacultureDuration, Shocks.df$AquacultureAv)

Sens.Anal<-cbind.data.frame(Cooks, Sector, Change, Shock.freq)
Sens.Anal$Change<-factor(Sens.Anal$Change, levels(Sens.Anal$Change)[c(3,4,1,2)])

#Plot sensitivity analysis
p1<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Crops",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Crops", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

p2<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Livestock",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Livestock", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

p3<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Fisheries",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Fisheries", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

p4<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Aquaculture",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Aquaculture", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

# p2<-ggplot(data=Shocks.df, aes(x=D, y=CropsSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="No. of shocks detected")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p3<-ggplot(data=Shocks.df, aes(x=D, y=CropsDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="No. of shocks detected")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p4<-ggplot(data=Shocks.df, aes(x=D, y=CropsAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="No. of shocks detected")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# cropplot<-ggarrange(p1,p2,p3,p4, ncol=1, nrow = 4, align = "h")
# 
# 
# 
# 
# 
# p5<-ggplot(data=Shocks.df, aes(x=D, y=LivestockNormal))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "Livestock")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p6<-ggplot(data=Shocks.df, aes(x=D, y=LivestockSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p7<-ggplot(data=Shocks.df, aes(x=D, y=LivestockDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p8<-ggplot(data=Shocks.df, aes(x=D, y=LivestockAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# livestockplots<-ggarrange(p5, p6, p7, p8, ncol=1, nrow = 4, align="h")
# 
# 
# p9<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesNormal))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "Fisheries")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p10<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p11<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p12<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# fishplots<- ggarrange(p9, p10, p11, p12, nrow=4, ncol=1, align = "h")
# 
# 
# 
# p13<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureNormal))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "Aquaculture")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p14<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p15<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p16<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# aquaplots<- ggarrange(p13, p14, p15, p16, nrow=4, ncol=1, align = "h")
# 
# toprow<-ggarrange(p1,p5,p9,p13, nrow=1,ncol = 4, align="v")
# toprow<-annotate_figure(toprow, left =text_grob("Selected Model", vjust = 0.5, color="black"))
# 
# secondrow<-ggarrange(p2,p6,p10,p14, nrow=1,ncol = 4, align="v")
# secondrow<-annotate_figure(secondrow, left =text_grob("Model span=0.3", vjust = 0.5, color="black"))
# 
# thirdrow<-ggarrange(p3,p7,p11,p15, nrow=1,ncol = 4, align="v")
# thirdrow<-annotate_figure(thirdrow, left =text_grob("Baseline = 3 yrs", vjust = 0.5, color="black"))
# 
# bottomrow<-ggarrange(p4,p8,p12,p16, nrow=1,ncol = 4, align="v")
# bottomrow<-annotate_figure(bottomrow, left =text_grob("Average = Mean", vjust = 0.5, color="black"))
# 
grid<-ggarrange(p1, p2, p3, p4, ncol=2, nrow = 2, align = "hv")

ggsave(filename = "Cooksdistance sensitivity.tiff", dpi = 600, device="tiff", width = 10, height=7)

# 
# p3<-ggplot(data=Shocks.df, aes(x=D, y=`Marine fisheries`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Marine fisheries")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p4<-ggplot(data=Shocks.df, aes(x=D, y=`Inland fisheries`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Inland fisheries")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p5<-ggplot(data=Shocks.df, aes(x=D, y=`Marine aquaculture`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Marine aquaculture")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p6<-ggplot(data=Shocks.df, aes(x=D, y=`Inland aquaculture`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Inland aquaculture")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")





ggsave("Sensitivity Analyses.tiff", device = "tiff", dpi = 600, width=140, height = 100, units="mm", scale=1.5)


```

# Supplementary Figure 4 - SENSITIVITY ANALYSES AROUND OTHER PARAMETERS 

Parameters checked = 

- mean or median time span for shock to drop from
- duration of previous average (3,5,7,9 years)
- LOESS span (0, 0.25, 0.33, 0.5, 0.66, 0.75, 1, 1.5, 2)

```{r}
# AICC FUNCTION FOR LOESS MODELS
aicc.loess <- function(x) {
    # compute AIC_C for a LOESS fit, from:
    #
    # Hurvich, C.M., Simonoff, J.S., and Tsai, C. L. 1998. Smoothing
    # parameter selection in nonparametric regression using an improved
    # Akaike Information Criterion. Journal of the Royal Statistical
    # Society B 60: 271-293.
    #
    # @param fit        loess fit
    # @return           'aicc' value
    stopifnot(inherits(x, 'loess'))
    # parameters
    n <- x$n
    trace <- x$trace.hat
    sigma2 <- sum(resid(fit) ^ 2) / (n - 1)
    return(log(sigma2) + 1 + (2 * (trace + 1)) / (n - trace - 2))
}

## METHOD WITH MANUAL ALTERATIONS TO MODEL SPAN

shocks <- data.frame() 

years <- seq(1961,2013,by=1)
span <-c(0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8)

for (s in 1:length(span)){
  #CROPS
  #3 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
  
   #Identify the Shock
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
  

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
        PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   
  
  #5 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


#7 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k])) # ,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  # 9 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #3 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   

#5 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   


#7 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   

# 9 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   












#LIVESTOCK

#3 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #3 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }








#FISHERIES

#3 year median
  
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year median
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year median
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year median
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #3 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }



# #MARINE FISHERIES
# 
# #3 year median
#   
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# #INLAND FISHERIES
# 
# 
# #3 year median
#     for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6], values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }



  
  
  
  
  
  
#AQUACULTURE

#3 year median
    for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  #5 year median
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #7 year median
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  # 9 year median
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #3 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  #5 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #7 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  # 9 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k], values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }









# #INLAND AQUACULTURE
# 
# #3 year median
#     for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6], values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# 
# 
# 
# 
# 
# 
# #MARINE AQUACULTURE
# 
# #3 year median
#     for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6], values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
}

shocks<-shocks[shocks$AbsMagnitude>0,]
summary(shocks)

shocks$Span <- as.factor(shocks$Span)
# levels(shocks$Span)[levels(shocks$Span)=="0.333333333333333" ] <-"0.33"
# levels(shocks$Span)[levels(shocks$Span)=="0.666666666666667" ] <-"0.67"


#Rank fit of span by country, and subsector so largest values get highest rank (using alpha for ggplot) 
shocks2 <- shocks %>%
  group_by(Sector, Country) %>%
  mutate(Rank=rank(desc(Fit), ties.method="min"))

shocks2 <- shocks2[,c(11, 1:10)]
shocks2 <- shocks2[order(shocks2$Country, shocks2$Sector, shocks2$Span),]

shocks2 <-as.data.frame(shocks2)

# #Need to scale ranks for each country-subsector combination to make comparable
# 
# Scaled <- c()
# 
# for (i in 1:length(levels(shocks2$Country))){
#   for (k in 1:length(levels(shocks2$SubSector))){
#     Ranks <- shocks2$Rank[shocks2$Country==levels(shocks2$Country)[i] & shocks2$SubSector==levels(shocks2$SubSector)[k]]
#     Scaled <- c(Scaled, ((Ranks-min(Ranks))/(max(Ranks)-min(Ranks))))
#   }
# }
# 
# shocks2 <- cbind.data.frame(Scaled, shocks2)


shocksovertime <-data.frame(table(shocks2$Year, shocks2$BaseComp, shocks2$Average, shocks2$Span))
names(shocksovertime)[names(shocksovertime)=="Var1"] <-"Year"
names(shocksovertime)[names(shocksovertime)=="Var2"] <-"Duration"
names(shocksovertime)[names(shocksovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(shocksovertime)[names(shocksovertime)=="Var4"] <-"Span"


shocksovertime$Freq <- as.numeric(shocksovertime$Freq)
shocksovertime$Year <- as.numeric(levels(shocksovertime$Year))[shocksovertime$Year]

#cbbPalette <- c("#000000",  "#009E73", "#0072B2", "#D55E00") #colorblind palette

#plot for all lines 
ggplot(data = shocksovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line(alpha=0.3)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency")

#ggsave("Sensitivity analysis - all ensemble lines with aqua.pdf", device = pdf, dpi=600, width=7, height=5)

#ggsave(filename = "Sensitivity analysis - all ensemble lines wo aqua.pdf", device = pdf, dpi=600, width=7, height=5)

#PLOT WITH CONFIDENCE INTERVALS

#minimum and maximum of all ensembles
mins <- tapply(shocksovertime$Freq, INDEX = shocksovertime$Year, FUN = min)
maxs <- tapply(shocksovertime$Freq, INDEX = shocksovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(shocks$Year, interaction(shocks$Average, shocks$Span, shocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = median))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]

#which model minimises the Sum of squares

SSResids <- function(x){
  model <- lm(x~av.shocks$Freq)
  SSR <-sum(residuals(model)^2)
  return(SSR)
}


order(tapply(X = shocksovertime$Freq, INDEX= interaction(shocksovertime$Duration, shocksovertime$Average,shocksovertime$Span), FUN = SSResids))

(tapply(X = shocksovertime$Freq, INDEX= interaction(shocksovertime$Duration, shocksovertime$Average,shocksovertime$Span), FUN = SSResids))[35]
                  
av.shocks$actual <-shocksovertime$Freq[shocksovertime$Span==0.6 & shocksovertime$Average=="Median"& shocksovertime$Duration==7] 

TotalN<-(CropsN$CropsN+LivestockN$LivestockN+FisheriesN$FisheriesN+AquacultureN$AquacultureN)

av.shocks$N<-TotalN[4:53]
av.shocks$Rate<-av.shocks$actual/av.shocks$N
av.shocks$min.Rate<-av.shocks$mins/av.shocks$N
av.shocks$max.Rate<-av.shocks$maxs/av.shocks$N

#all sectors model selection plot - FREQUENCY ONLY
FreqShocks<-ggplot(data=av.shocks, aes(x=Year, y=Freq))+
  geom_ribbon(aes(ymin=mins, ymax=maxs), fill="grey")+
  geom_line(colour="grey10", size=0.5, linetype=2)+
  geom_line(aes(y=actual), colour="Red")+
  theme_bw()+
  theme(panel.background = element_blank(),
        panel.grid = element_blank())+
  labs(x=bquote(bold(Year)), y=bquote(bold(Shock~frequency)))


#ggsave(filename = "Sensitivity analysis - total freq with confidence.tiff", device = "tiff", dpi=600, width=6, height=4)

#ggsave(filename = "Sensitivity analysis - total freq with confidence wo aqua.tiff", device = "tiff", dpi=600, width=6, height=4)

RateShocks<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=min.Rate, ymax=max.Rate), fill="grey")+
  geom_line(aes(y=Rate), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits = c(0,0.05))+
  theme(panel.background = element_blank(),
        panel.grid = element_blank())+
  labs(x=bquote(bold(Year)), y=bquote(bold(Shock~rate)))

ggsave(filename = "Sensitivity analysis - total rate with confidence.tiff", device = "tiff", dpi=600, width=6, height=4)

#ggsave(filename = "Sensitivity analysis - total rate with confidence wo aquaculture.tiff", device = "tiff", dpi=600, width=6, height=4)


```

#Conduct analyses with 7 year median/ LOESS span =0.6

#Crop analysis
```{r}

#CROP SHOCKS

years<-seq(1961, 2013, by=1)
shocks<-data.frame()


pdf(file="LOESS Shock Analysis 2 - crops.pdf")
for (i in 1:length(levels(aggcrops$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggcrops$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Crops"
      Country<-levels(aggcrops$Country)[i]
      Region <- aggcrops$Continent[aggcrops$Country==levels(aggcrops$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)


```

#livestock analysis

```{r}
#LIVESTOCK SHOCKS

pdf(file="LOESS Shock Analysis 2 - livestock.pdf")
for (i in 1:length(levels(agglivestock$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agglivestock$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Livestock"
      Country<-levels(agglivestock$Country)[i]
      Region <- agglivestock$Continent[agglivestock$Country==levels(agglivestock$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector,  Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)


 
```

#fisheries analysis

```{r}
#FISHERIES SHOCKS

pdf(file="LOESS Shock Analysis 2 - fisheries.pdf")
for (i in 1:length(levels(aggfisheries$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggfisheries$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Fisheries"
      Country<-levels(aggfisheries$Country)[i]
      Region <- aggfisheries$Continent[aggfisheries$Country==levels(aggfisheries$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)


```

#aquaculture analysis

```{r}
#TOTAL AQUACULTURE SHOCKS

pdf(file="LOESS Shock Analysis 2 - aquaculture.pdf")
for (i in 1:length(levels(aggaqua$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggaqua$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Aquaculture"
      Country<-levels(aggaqua$Country)[i]
      Region <- aggaqua$Continent[aggaqua$Country==levels(aggaqua$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector,  Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)

shocks<-shocks[shocks$AbsMagnitude>0,]

shocks$Codes <- countrycode(shocks$Country, origin = "country.name", destination = "iso3c", warn=T )
shocks$Codes[shocks$Country=="Réunion"] <- "REU"
shocks$Codes[shocks$Country=="Former Yugoslav SFR"] <- "BIH"

write.csv(x= shocks, file = "Shocks.write.copy.csv", row.names = F)
```


##Sector wise symbols

```{r}
cropimg<-readPNG("crops.png")
cropimg<-rasterGrob(cropimg, interpolate = T)

cowimg<-readPNG("cow.png")
cowimg<-rasterGrob(cowimg, interpolate = T)

fishingimg<-readPNG("fishingboat.png")
fishingimg<-rasterGrob(fishingimg, interpolate = T)

# fishimg<-readPNG("tuna1.png")
# fishimg<-rasterGrob(fishimg, interpolate = T)

aquaimg<-readPNG("Aquapen.png")
aquaimg<-rasterGrob(aquaimg, interpolate = T)

```


#Import shocks with drivers and tidy
```{r}

#Original clean up
# shockdrivers <- read.csv("shocksanddrivers2.csv", header=T)
# shockdrivers <- shockdrivers[,1:11]
# names(shockdrivers)[11]<-"Category"
# shockdrivers$Country<-as.character(shockdrivers$Country)
# shockdrivers$Region<-as.character(shockdrivers$Region)
# 
# #shockdrivers<-shockdrivers[shockdrivers$Country!="Haiti",]
# #Replacements<-countrycode(shockdrivers$Country[shockdrivers$Region=="East Asia and Pacific"], origin = "country.name", destination = "continent", warn = T)
# 
# #shockdrivers$Region[shockdrivers$Region=="East Asia and Pacific"]<-Replacements
# shockdrivers$Region[shockdrivers$Region=="Asia"]<-"East Asia"
# shockdrivers$Region[shockdrivers$Country=="Iran (Islamic Republic of)"]<-"MENA"
# shockdrivers$Region[shockdrivers$Country=="Syrian Arab Republic" ]<-"MENA" 
# shockdrivers$Region[shockdrivers$Country=="Saudi Arabia" ]<-"MENA" 
# shockdrivers$Region[shockdrivers$Country=="Turkey" ]<-"EuCA"
# shockdrivers$Region[shockdrivers$Country=="St. Pierre and Miquelon" ]<-"EuCA"
# 
# shockdrivers$Country<-as.factor(shockdrivers$Country)
# shockdrivers$Region<-as.factor(shockdrivers$Region)
# 
# 
# #Take out not shocks 13 in total
# shockdrivers <- shockdrivers[shockdrivers$Driver!="Not a shock",]
# shockdrivers <- shockdrivers[shockdrivers$Driver!="Not a shock ",]
# 
# 
# shockdrivers$Category <- as.character(shockdrivers$Category)
# shockdrivers$Category[shockdrivers$Driver=="Unknown driver to carp production decline"]<-"Unknown"
# shockdrivers$Category[shockdrivers$Driver=="Unknown"]<-"Unknown"
# 
# #Climate events
# shockdrivers$Category[shockdrivers$Category=="Climate/ Weather"] <- "Climate/weather events"
# shockdrivers$Category[shockdrivers$Category=="Climate/ Weather "] <- "Climate/weather events"
# shockdrivers$Category[shockdrivers$Category=="Climate/weather"] <- "Climate/weather events"
# shockdrivers$Category[shockdrivers$Category=="Climate/weather "] <- "Climate/weather events"
# shockdrivers$Category[shockdrivers$Category=="Climate/ weather "] <- "Climate/weather events"
# 
# #Climate/weather & geopolitical/economic
# shockdrivers$Category[shockdrivers$Category=="Economic and climate/weather "] <- "Climate/weather & geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Category=="Climate/weather & economic  " ] <- "Climate/weather & geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Category=="Geopolitical and climate/weather " ] <- "Climate/weather & geopolitical/economic events"
# 
# #Climate/weather and mismanagement
# shockdrivers$Category[shockdrivers$Category=="Climate/weather and mismanagement "] <- "Climate/weather events & mismanagement"
# shockdrivers$Category[shockdrivers$Category=="Climate/ weather and mismanagement "] <- "Climate/weather events & mismanagement"
# shockdrivers$Category[shockdrivers$Country=="Democratic People's Republic of Korea" & shockdrivers$Sector=="Crops" & shockdrivers$Year==1996] <- "Mismanagement"
# 
# 
# #Geopolitical/economic events
# shockdrivers$Category[shockdrivers$Category=="Geopolitical " ] <- "Geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Category=="Economic" ] <- "Geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Category=="Geopolitical"] <- "Geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Category=="Economic " ] <- "Geopolitical/economic events"
# 
# 
# 
# #Mismanagement
# shockdrivers$Category[shockdrivers$Category=="Mismanagement " ] <- "Mismanagement"
# shockdrivers$Category[shockdrivers$Category=="Mismanagment " ] <- "Mismanagement"
# shockdrivers$Category[shockdrivers$Category=="Mismanagment" ] <- "Mismanagement"
# shockdrivers$Category[shockdrivers$Category=="MIsmanagement " ] <- "Mismanagement"
# shockdrivers$Category[shockdrivers$Country=="Antigua and Barbuda" & shockdrivers$Sector=="Fisheries" & shockdrivers$Year==1981] <- "Mismanagement"
# shockdrivers$Category[shockdrivers$Category=="Overfishing and mismanagement"] <- "Mismanagement"
# shockdrivers$Category[shockdrivers$Category=="From Gehpart " ] <- "Mismanagement"
# 
# 
# #Mismanagement & policy change
# shockdrivers$Category[shockdrivers$Category=="Mismanagment and policy change " ] <- "Mismanagement & policy change"
# shockdrivers$Category[shockdrivers$Category=="Mismanagement and policy change "  ] <- "Mismanagement & policy change"
# shockdrivers$Category[shockdrivers$Category=="Mismanagement and policy change"  ] <- "Mismanagement & policy change"                               
# 
# 
# #policy change
# shockdrivers$Category[shockdrivers$Category=="Policy change "  ] <- "Policy change"
# 
# 
# #Mismanagement and geopolitical/economic events
# shockdrivers$Category[shockdrivers$Category=="Mismanagement and geopolitical "  ] <- "Mismanagement & geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Category=="MIsmanagement and geopolitical "  ] <- "Mismanagement & geopolitical/economic events"
# 
# #Other - disease, pulse fisheries, geological events
# shockdrivers$Category[shockdrivers$Category=="Biological " ] <- "Other"
# shockdrivers$Category[shockdrivers$Category=="Biological" ] <- "Other"
# shockdrivers$Category[shockdrivers$Category=="Geological " ] <- "Other"
# shockdrivers$Category[shockdrivers$Category=="Geological" ] <- "Other"
# 
# #missing
# shockdrivers$Category[shockdrivers$Country=="Sao Tome and Principe" & shockdrivers$Sector=="Livestock"] <- "Geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Country=="Albania"] <- "Geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Country=="Iraq" & shockdrivers$Sector=="Aquaculture"] <- "Geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Country=="Saint Lucia" & shockdrivers$Sector=="Aquaculture"] <- "Policy change"
# shockdrivers$Category[shockdrivers$Category==""]<-"Geopolitical/economic events"
# 
# unique(shockdrivers$Category)
# shockdrivers$Category <-as.factor(shockdrivers$Category)
# levels(shockdrivers$Category)
# 
# shockdrivers$Category<-factor(shockdrivers$Category,levels(shockdrivers$Category)[c(2,3,1, 4, 6, 5, 7, 9, 8, 10)])
# levels(shockdrivers$Category)
# 
# shockdrivers <-shockdrivers[shockdrivers$Sector!="",]
# shockdrivers$Sector <-as.character(shockdrivers$Sector)
# shockdrivers$Sector <- as.factor(shockdrivers$Sector)
# shockdrivers$Sector <- factor(shockdrivers$Sector, levels(shockdrivers$Sector)[c(2,4,3,1)])
# 
# 
# #update with Oceania
# 
# shockdrivers[shockdrivers$Region=="East Asia and Pacific",]
# 
# shockdrivers$Recovery2<-shockdrivers$Recovery
# shockdrivers$Year<-as.numeric(shockdrivers$Year)
# shockdrivers$Recovery2[is.na(shockdrivers$Recovery2)]<-2013-shockdrivers$Year[is.na(shockdrivers$Recovery2)]
# shockdrivers$Recovery2[shockdrivers$Recovery2==0]<-1
# levels(shockdrivers$Region)[levels(shockdrivers$Region)=="CaLA"]<-"LACa"
# 
# #Final touch ups from supplementary review of drivers
# shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Bermuda"]<-"Unknown"
# shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Comoros"]<-"Unknown"
# shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Democratic People's Republic of Korea"]<-"Climate/weather events & mismanagement"
# shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Guam"]<-"Unknown"
# shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Libya"]<-"Unknown"
# shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Saudi Arabia"]<-"Policy change"
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Belize"]<-"Unknown"
# #shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="China, Macao SAR"]<-"Other"
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Guam"]<-"Climate/weather & geopolitical/economic events"
# 
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Democratic People's Republic of Korea" & shockdrivers$Year==1997]<-"Climate/weather events & mismanagement"
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Greenland"]<-"Mismanagement & policy change"
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Malawi"]<-"Climate/weather & geopolitical/economic events"
# #shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Republic of Korea"]<-"Other"
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Sao Tome and Principe"]<-"Unknown"
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Sri Lanka" & shockdrivers$Year==1998]<-"Unknown"
# shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Timor-Leste"]<-"Climate/weather & geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Sector=="Fisheries" & shockdrivers$Country=="Solomon Islands"]<-"Mismanagement & geopolitical/economic events"
# shockdrivers$Category[shockdrivers$Sector=="Aquaculture" & shockdrivers$Country=="Jamaica"]<-"Unknown"
# shockdrivers$Category[shockdrivers$Sector=="Aquaculture" & shockdrivers$Country=="Saint Lucia"]<-"Unknown"
# 
# 
# 
# #Exclude shocks where not a shock - gradual decline before a big jump
# shockdrivers<-shockdrivers[!(shockdrivers$Sector=="Aquaculture" & shockdrivers$Country=="RÃ©union"),]
# shockdrivers<-shockdrivers[!(shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Somalia" & shockdrivers$Year==1994),]
# 
# #Rescale recovery times between 0 and 1 for chord plots
# 
# shockdrivers$Scaled.recovery<-NA
# shockdrivers$Scaled.recovery<-(shockdrivers$Recovery2-min(shockdrivers$Recovery2))/(max(shockdrivers$Recovery2)-min(shockdrivers$Recovery2))
# shockdrivers$Scaled.recovery[shockdrivers$Scaled.recovery==0]<-0.01
# 
# 
# 
# write.csv(shockdrivers, file = "Shocks and drivers tidy3.csv", row.names = F)



#updated shocks and drivers


N_Africa <- c("Algeria", "Egypt", "Libya", "Morocco", "Sudan", "Tunisia")
E_Africa <- c("Burundi", "Comoros", "Djibouti", "Eritrea", "Ethiopia", "Kenya", "Madagascar", "Malawi", "Mauritius", "Mozambique", "Rwanda", "Seychelles", "Somalia", "South Sudan", "Uganda","Tanzania", "Zambia", "Zimbabwe","United Republic of Tanzania" , "Tanzania, United Rep. of", "Zanzibar", "Réunion")
M_Africa <- c("Angola", "Cameroon", "Central African Republic", "Chad", "Congo", "Dem. Rep. Congo", "Equatorial Guinea", "Gabon", "Sao Tome and Principe", "St Helena", "Congo, Dem. Rep. of the", "Democratic Republic of the Congo" )
S_Africa <- c("Botswana", "Lesotho", "Namibia", "South Africa", "Swaziland")
W_Africa <- c("Benin", "Burkina Faso", "Cabo Verde", "Côte d'Ivoire", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Liberia", "Mali", "Mauritania", "Niger", "Nigeria", "Senegal", "Sierra Leone", "Togo", "Western Sahara")

#Asia

E_Asia <- c("China, mainland", "China, Hong Kong SAR", "China, Macao SAR",  "N. Korea", "Japan", "Mongolia", "Republic of Korea","Democratic People's Republic of Korea", "Korea, Dem. People's Rep", "Northern Mariana Is.", "China, Taiwan Province of")
SE_Asia <- c("Brunei Darussalam", "Cambodia", "Indonesia", "Lao People's Democratic Republic", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Timor-Leste", "Viet Nam")
S_Asia <- c("Afghanistan", "Bangladesh", "Bhutan", "India", "Iran (Islamic Republic of)", "Maldives", "Nepal", "Pakistan", "Sri Lanka")
W_Asia <- c("Armenia", "Bahrain", "Cyprus", "Iraq", "Israel", "Jordan", "Kuwait", "Lebanon", "Oman", "Palestine", "Qatar", "Saudi Arabia","Syrian Arab Republic", "Turkey", "United Arab Emirates" , "Yemen")

#Latin America/Caribbean

Caribbean <- c("Antigua and Barbuda", "Anguilla", "Aruba", "Bahamas", "Barbados", "British Virgin Islands",  "Cuba", "Cayman Islands", "Dominica", "Dominican Republic", "Grenada", "Guadeloupe", "Haiti", "Jamaica", "Martinique", "Mayotte", "Montserrat", "Netherlands Antilles", "Puerto Rico", "Saint Kitts and Nevis", "Saint Lucia", "St. Vin.&Gren.", "Trinidad and Tobago", "Turks and Caicos Is.", "US Virgin Islands", "Saint Vincent and the Grenadines", "Saint Vincent/Grenadines")

C_America <- c("Belize", "Costa Rica", "El Salvador", "Guatemala", "Honduras", "Mexico", "Nicaragua", "Panama")
S_America <- c("Argentina", "Bolivia (Plurinational State of)", "Brazil", "Chile", "Colombia", "Ecuador", "French Guiana", "Guyana", "Paraguay", "Peru", "Suriname", "Uruguay", "Venezuela","Venezuela (Bolivarian Republic of)", "Venezuela, Boliv Rep of", "Falkland Islands (Malvinas)")

#Oceania
Aus_NZ <- c("Australia", "New Zealand")
Melanesia <- c("Fiji",  "New Caledonia", "Papua New Guinea", "Solomon Islands", "Vanuatu", "Fiji, Republic of" )
Micronesia <- c("Guam", "Kiribati", "Marshall Islands", "Micronesia (Federated States of)", "Nauru", "Palau")
Polynesia <- c("American Samoa", "Cook Islands", "French Polynesia", "Niue", "Samoa", "Tokelau", "Tonga", "Tuvalu", "Wallis and Futuna Islands", "Pitcairn Islands")

#North AMerica
N_America <- c("Bermuda", "United States of America", "Canada", "Greenland", "St. Pierre and Miquelon")

#Europe
E_Europe <- c("Bulgaria", "Former Czechoslovakia", "Hungary", "Poland", "Romania", "Ukraine", "Former USSR")
N_Europe <- c("Denmark", "Finland", "Iceland", "Ireland", "Norway", "Sweden", "United Kingdom", "Faroe Islands", "Isle of Man" )
S_Europe <- c("Albania", "Andorra", "Croatia", "Greece", "Italy", "Malta", "Portugal", "Spain",  "Former Yugoslav SFR", "San Marino")
W_Europe <- c("Austria", "Belgium", "France", "Germany", "Luxembourg", "Netherlands", "Switzerland", "Liechtenstein" )

#sub region codes
N_Africa_codes <- countrycode(N_Africa, origin = "country.name", destination="iso3c", warn=T)
E_Africa_codes <- countrycode(E_Africa, origin = "country.name", destination="iso3c", warn=T )
M_Africa_codes <-  countrycode(M_Africa, origin = "country.name", destination="iso3c", warn=T) 
S_Africa_codes <- countrycode(S_Africa, origin = "country.name", destination="iso3c", warn=T)
W_Africa_codes <- countrycode(W_Africa, origin = "country.name", destination="iso3c", warn=T)

E_Asia_codes <-  countrycode(E_Asia, origin = "country.name", destination="iso3c", warn=T)
SE_Asia_codes <- countrycode(SE_Asia, origin = "country.name", destination="iso3c", warn=T)
S_Asia_codes <- countrycode(S_Asia, origin = "country.name", destination="iso3c", warn=T)
W_Asia_codes <-  countrycode(W_Asia, origin = "country.name", destination="iso3c", warn=T)

Caribbean_codes <- countrycode(Caribbean, origin = "country.name", destination="iso3c", warn=T)
Caribbean_codes[is.na(Caribbean_codes)] <- "VIN"
C_America_codes <- countrycode(C_America, origin = "country.name", destination="iso3c", warn=T)
S_America_codes <- countrycode(S_America, origin = "country.name", destination="iso3c", warn=T)
N_America_codes <- countrycode(N_America, origin = "country.name", destination="iso3c", warn=T)


Aus_NZ_codes <- countrycode(Aus_NZ, origin = "country.name", destination="iso3c", warn=T)
Melanesia_codes <- countrycode(Melanesia, origin = "country.name", destination="iso3c", warn=T) 
Micronesia_codes <- countrycode(Micronesia, origin = "country.name", destination="iso3c", warn=T)
Polynesia_codes <- countrycode(Polynesia, origin = "country.name", destination="iso3c", warn=T) 

E_Europe_codes <- countrycode(E_Europe, origin = "country.name", destination="iso3c", warn=T)
N_Europe_codes <-  countrycode(N_Europe, origin = "country.name", destination="iso3c", warn=T)
S_Europe_codes <- countrycode(S_Europe, origin = "country.name", destination="iso3c", warn=T)
S_Europe_codes[is.na(S_Europe_codes)] <- "BIH"
W_Europe_codes <- countrycode(W_Europe, origin = "country.name", destination="iso3c", warn=T)

sub_categories <- fread("subcategories.csv", header = T)

shockdrivers <- 
  fread("Shocks and drivers tidy3.csv", header=T) %>% 
  mutate(Country = case_when(Country %in% c("Democratic People's Republic of Korea", "Korea, Dem. People's Rep") ~ "N. Korea",
                             Country %in% c("Venezuela (Bolivarian Republic of)", "Venezuela, Boliv Rep of") ~ "Venezuela",
                             Country %in% c("Congo, Dem. Rep. of the", "Democratic Republic of the Congo") ~ "Dem. Rep. Congo",
                             Country %in% c("Fiji, Republic of" ) ~ "Fiji",
                             Country %in% c("Saint Vincent and the Grenadines", "Saint Vincent/Grenadines" ) ~ "St. Vin.&Gren.",
                             Country %in% c("United Republic of Tanzania" , "Tanzania, United Rep. of" ) ~ "Tanzania",
                             T ~ Country)) %>% 
  mutate(SubRegion = case_when(Country %in% N_Africa ~ "North Africa",
                               Country %in% M_Africa ~ "Central Africa",
                               Country %in% S_Africa ~ "Southern Africa",
                               Country %in% W_Africa ~ "West Africa",
                               Country %in% E_Africa ~ "East Africa",
                               #Country %in% Former_USSR ~ "Former USSR",
                               Country %in% E_Asia ~ "East Asia",
                               Country %in% SE_Asia ~ "SE Asia",
                               Country %in% S_Asia ~ "South Asia",
                               Country %in% W_Asia ~ "Western Asia",
                               Country %in% Caribbean ~ "Caribbean",
                               Country %in% C_America ~ "Central America",
                               Country %in% S_America ~ "South America",
                               Country %in% N_America ~ "North America",
                               Country %in% Aus_NZ ~ "Australia/NZ",
                               Country %in% Micronesia ~ "Micronesia",
                               Country %in% Melanesia ~ "Melanesia",
                               Country %in% Polynesia ~ "Polynesia",
                               Country %in% N_Europe ~ "Northern Europe",
                               Country %in% E_Europe ~ "Eastern Europe",
                               Country %in% S_Europe ~ "Southern Europe",
                               Country %in% W_Europe ~ "Western Europe")) %>% 
  mutate(Sub_Category = sub_categories$SubCategory)




shockcategories<-data.frame(table(shockdrivers$Category, shockdrivers$Sector))

shockcategories$Total[shockcategories$Var2=="Aquaculture"]<- sum(shockcategories$Freq[shockcategories$Var2=="Aquaculture"])
shockcategories$Total[shockcategories$Var2=="Crops"]<- sum(shockcategories$Freq[shockcategories$Var2=="Crops"])
shockcategories$Total[shockcategories$Var2=="Livestock"]<- sum(shockcategories$Freq[shockcategories$Var2=="Livestock"])
shockcategories$Total[shockcategories$Var2=="Fisheries"]<- sum(shockcategories$Freq[shockcategories$Var2=="Fisheries"])
shockcategories$Prop <- shockcategories$Freq/ shockcategories$Total

shockcategories$Var2 <- factor(shockcategories$Var2, levels(shockcategories$Var2)[c(2,4,3,1)])
shockcategories$Var1 <- factor(shockcategories$Var1, levels(shockcategories$Var1)[c(2,3,1,4,6,5,7,9,8,10)])

# 
# levels(shockdrivers$Category)

shockdrivers
```

#Figure 1 - MAPPING SHOCK RATES 

```{r}
#Get shock rates per region per sector

#SUBREGIONS

N_Africa <- c("Algeria", "Egypt", "Libya", "Morocco", "Sudan", "Tunisia")
E_Africa <- c("Burundi", "Comoros", "Djibouti", "Eritrea", "Ethiopia", "Kenya", "Madagascar", "Malawi", "Mauritius", "Mozambique", "Rwanda", "Seychelles", "Somalia", "South Sudan", "Uganda","Tanzania", "Zambia", "Zimbabwe","United Republic of Tanzania" , "Tanzania, United Rep. of", "Zanzibar", "Réunion")
M_Africa <- c("Angola", "Cameroon", "Central African Republic", "Chad", "Congo", "Dem. Rep. Congo", "Equatorial Guinea", "Gabon", "Sao Tome and Principe", "St Helena", "Congo, Dem. Rep. of the", "Democratic Republic of the Congo" )
S_Africa <- c("Botswana", "Lesotho", "Namibia", "South Africa", "Swaziland")
W_Africa <- c("Benin", "Burkina Faso", "Cabo Verde", "Côte d'Ivoire", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Liberia", "Mali", "Mauritania", "Niger", "Nigeria", "Senegal", "Sierra Leone", "Togo", "Western Sahara")

#Asia

E_Asia <- c("China, mainland", "China, Hong Kong SAR", "China, Macao SAR",  "N. Korea", "Japan", "Mongolia", "Republic of Korea","Democratic People's Republic of Korea", "Korea, Dem. People's Rep", "Northern Mariana Is.", "China, Taiwan Province of")
SE_Asia <- c("Brunei Darussalam", "Cambodia", "Indonesia", "Lao People's Democratic Republic", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Timor-Leste", "Viet Nam")
S_Asia <- c("Afghanistan", "Bangladesh", "Bhutan", "India", "Iran (Islamic Republic of)", "Maldives", "Nepal", "Pakistan", "Sri Lanka")
W_Asia <- c("Armenia", "Bahrain", "Cyprus", "Iraq", "Israel", "Jordan", "Kuwait", "Lebanon", "Oman", "Palestine", "Qatar", "Saudi Arabia","Syrian Arab Republic", "Turkey", "United Arab Emirates" , "Yemen")

#Latin America/Caribbean

Caribbean <- c("Antigua and Barbuda", "Anguilla", "Aruba", "Bahamas", "Barbados", "British Virgin Islands",  "Cuba", "Cayman Islands", "Dominica", "Dominican Republic", "Grenada", "Guadeloupe", "Haiti", "Jamaica", "Martinique", "Mayotte", "Montserrat", "Netherlands Antilles", "Puerto Rico", "Saint Kitts and Nevis", "Saint Lucia", "St. Vin.&Gren.", "Trinidad and Tobago", "Turks and Caicos Is.", "US Virgin Islands", "Saint Vincent and the Grenadines", "Saint Vincent/Grenadines")

C_America <- c("Belize", "Costa Rica", "El Salvador", "Guatemala", "Honduras", "Mexico", "Nicaragua", "Panama")
S_America <- c("Argentina", "Bolivia (Plurinational State of)", "Brazil", "Chile", "Colombia", "Ecuador", "French Guiana", "Guyana", "Paraguay", "Peru", "Suriname", "Uruguay", "Venezuela","Venezuela (Bolivarian Republic of)", "Venezuela, Boliv Rep of", "Falkland Islands (Malvinas)")

#Oceania
Aus_NZ <- c("Australia", "New Zealand")
Melanesia <- c("Fiji",  "New Caledonia", "Papua New Guinea", "Solomon Islands", "Vanuatu", "Fiji, Republic of" )
Micronesia <- c("Guam", "Kiribati", "Marshall Islands", "Micronesia (Federated States of)", "Nauru", "Palau")
Polynesia <- c("American Samoa", "Cook Islands", "French Polynesia", "Niue", "Samoa", "Tokelau", "Tonga", "Tuvalu", "Wallis and Futuna Islands", "Pitcairn Islands")

#North AMerica
N_America <- c("Bermuda", "United States of America", "Canada", "Greenland", "St. Pierre and Miquelon")

#Europe
E_Europe <- c("Bulgaria", "Former Czechoslovakia", "Hungary", "Poland", "Romania", "Ukraine", "Former USSR")
N_Europe <- c("Denmark", "Finland", "Iceland", "Ireland", "Norway", "Sweden", "United Kingdom", "Faroe Islands", "Isle of Man" )
S_Europe <- c("Albania", "Andorra", "Croatia", "Greece", "Italy", "Malta", "Portugal", "Spain",  "Former Yugoslav SFR", "San Marino")
W_Europe <- c("Austria", "Belgium", "France", "Germany", "Luxembourg", "Netherlands", "Switzerland", "Liechtenstein" )

#sub region codes
N_Africa_codes <- countrycode(N_Africa, origin = "country.name", destination="iso3c", warn=T)
E_Africa_codes <- countrycode(E_Africa, origin = "country.name", destination="iso3c", warn=T )
M_Africa_codes <-  countrycode(M_Africa, origin = "country.name", destination="iso3c", warn=T) 
S_Africa_codes <- countrycode(S_Africa, origin = "country.name", destination="iso3c", warn=T)
W_Africa_codes <- countrycode(W_Africa, origin = "country.name", destination="iso3c", warn=T)

E_Asia_codes <-  countrycode(E_Asia, origin = "country.name", destination="iso3c", warn=T)
SE_Asia_codes <- countrycode(SE_Asia, origin = "country.name", destination="iso3c", warn=T)
S_Asia_codes <- countrycode(S_Asia, origin = "country.name", destination="iso3c", warn=T)
W_Asia_codes <-  countrycode(W_Asia, origin = "country.name", destination="iso3c", warn=T)

Caribbean_codes <- countrycode(Caribbean, origin = "country.name", destination="iso3c", warn=T)
Caribbean_codes[is.na(Caribbean_codes)] <- "VIN"
C_America_codes <- countrycode(C_America, origin = "country.name", destination="iso3c", warn=T)
S_America_codes <- countrycode(S_America, origin = "country.name", destination="iso3c", warn=T)
N_America_codes <- countrycode(N_America, origin = "country.name", destination="iso3c", warn=T)


Aus_NZ_codes <- countrycode(Aus_NZ, origin = "country.name", destination="iso3c", warn=T)
Melanesia_codes <- countrycode(Melanesia, origin = "country.name", destination="iso3c", warn=T) 
Micronesia_codes <- countrycode(Micronesia, origin = "country.name", destination="iso3c", warn=T)
Polynesia_codes <- countrycode(Polynesia, origin = "country.name", destination="iso3c", warn=T) 

E_Europe_codes <- countrycode(E_Europe, origin = "country.name", destination="iso3c", warn=T)
N_Europe_codes <-  countrycode(N_Europe, origin = "country.name", destination="iso3c", warn=T)
S_Europe_codes <- countrycode(S_Europe, origin = "country.name", destination="iso3c", warn=T)
S_Europe_codes[is.na(S_Europe_codes)] <- "BIH"
W_Europe_codes <- countrycode(W_Europe, origin = "country.name", destination="iso3c", warn=T)



shockdrivers <- 
  fread("Shocks and drivers tidy3.csv", header=T) %>% 
  mutate(Country = case_when(Country %in% c("Democratic People's Republic of Korea", "Korea, Dem. People's Rep") ~ "N. Korea",
                             Country %in% c("Venezuela (Bolivarian Republic of)", "Venezuela, Boliv Rep of") ~ "Venezuela",
                             Country %in% c("Congo, Dem. Rep. of the", "Democratic Republic of the Congo") ~ "Dem. Rep. Congo",
                             Country %in% c("Fiji, Republic of" ) ~ "Fiji",
                             Country %in% c("Saint Vincent and the Grenadines", "Saint Vincent/Grenadines" ) ~ "St. Vin.&Gren.",
                             Country %in% c("United Republic of Tanzania" , "Tanzania, United Rep. of" ) ~ "Tanzania",
                             T ~ Country)) %>% 
  mutate(SubRegion = case_when(Country %in% N_Africa ~ "North Africa",
                               Country %in% M_Africa ~ "Central Africa",
                               Country %in% S_Africa ~ "Southern Africa",
                               Country %in% W_Africa ~ "West Africa",
                               Country %in% E_Africa ~ "East Africa",
                               #Country %in% Former_USSR ~ "Former USSR",
                               Country %in% E_Asia ~ "East Asia",
                               Country %in% SE_Asia ~ "SE Asia",
                               Country %in% S_Asia ~ "South Asia",
                               Country %in% W_Asia ~ "Western Asia",
                               Country %in% Caribbean ~ "Caribbean",
                               Country %in% C_America ~ "Central America",
                               Country %in% S_America ~ "South America",
                               Country %in% N_America ~ "North America",
                               Country %in% Aus_NZ ~ "Australia/NZ",
                               Country %in% Micronesia ~ "Micronesia",
                               Country %in% Melanesia ~ "Melanesia",
                               Country %in% Polynesia ~ "Polynesia",
                               Country %in% N_Europe ~ "Northern Europe",
                               Country %in% E_Europe ~ "Eastern Europe",
                               Country %in% S_Europe ~ "Southern Europe",
                               Country %in% W_Europe ~ "Western Europe"))




#Crops
Country<-levels(aggcrops$Country)
Codes<- countrycode(levels(aggcrops$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(aggcrops$Country), origin = "country.name", destination = "continent")
cropsSR<-cbind.data.frame(Country, Codes, Continent)
cropsSR$Continent <-as.character(cropsSR$Continent)


cropsSR$Continent[cropsSR$Code %in% N_Africa_codes]<-"North Africa"
cropsSR$Continent[cropsSR$Code %in% E_Africa_codes]<-"East Africa"
cropsSR$Continent[cropsSR$Code %in% W_Africa_codes]<-"West Africa"
cropsSR$Continent[cropsSR$Code %in% M_Africa_codes]<-"Central Africa"
cropsSR$Continent[cropsSR$Code %in% S_Africa_codes]<-"Southern Africa"
cropsSR$Continent[cropsSR$Code %in% W_Asia_codes]<-"Western Asia"
cropsSR$Continent[cropsSR$Code %in% S_Asia_codes]<-"South Asia"
cropsSR$Continent[cropsSR$Code %in% SE_Asia_codes]<-"SE Asia"
cropsSR$Continent[cropsSR$Code %in% E_Asia_codes]<-"East Asia"
cropsSR$Continent[cropsSR$Code %in% Caribbean_codes]<-"Caribbean"
cropsSR$Continent[cropsSR$Code %in% N_America_codes]<-"North America"
cropsSR$Continent[cropsSR$Code %in% C_America_codes]<-"Central America"
cropsSR$Continent[cropsSR$Code %in% S_America_codes]<-"South America"
cropsSR$Continent[cropsSR$Code %in% Aus_NZ_codes]<-"Australia/NZ"
cropsSR$Continent[cropsSR$Code %in% Melanesia_codes]<-"Melanesia"
cropsSR$Continent[cropsSR$Code %in% Micronesia_codes]<-"Micronesia"
cropsSR$Continent[cropsSR$Code %in% Polynesia_codes]<-"Polynesia"
cropsSR$Continent[cropsSR$Code %in% E_Europe_codes]<-"Eastern Europe"
cropsSR$Continent[cropsSR$Code %in% N_Europe_codes]<-"Northern Europe"
cropsSR$Continent[cropsSR$Code %in% W_Europe_codes]<-"Western Europe"
cropsSR$Continent[cropsSR$Code %in% S_Europe_codes]<-"Southern Europe"

cropsSR$Codes <- as.character(cropsSR$Codes)
cropsSR$Continent <- as.character(cropsSR$Continent)

cropsSR$Codes[cropsSR$Country=="Former Yugoslav SFR"]<-"BIH"
cropsSR$Codes[cropsSR$Country=="Former Czechoslovakia"]<-"CZE"
cropsSR$Continent[cropsSR$Country=="Former Czechoslovakia"]<-"Eastern Europe"
cropsSR$Continent[cropsSR$Country=="Former Yugoslav SFR"]<-"Southern Europe"



#calculate shock rates 

cropsSR$Rate[cropsSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="North America",])/ length(unique(aggcrops$Country[aggcrops$Continent=="North America"]))

cropsSR$Rate[cropsSR$Continent=="Central America"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Central America",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Central America"]))

cropsSR$Rate[cropsSR$Continent=="Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Caribbean",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Caribbean"]))

cropsSR$Rate[cropsSR$Continent=="South America"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="South America",])/ length(unique(aggcrops$Country[aggcrops$Continent=="South America"]))

cropsSR$Rate[cropsSR$Continent=="Northern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Northern Europe",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Northern Europe"]))

cropsSR$Rate[cropsSR$Continent=="Western Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Western Europe",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Western Europe"]))

cropsSR$Rate[cropsSR$Continent=="Southern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Southern Europe",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Southern Europe"]))

cropsSR$Rate[cropsSR$Continent=="Eastern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Eastern Europe",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Eastern Europe"]))

cropsSR$Rate[cropsSR$Continent=="North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="North Africa",])/ length(unique(aggcrops$Country[aggcrops$Continent=="North Africa"]))

cropsSR$Rate[cropsSR$Continent=="West Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="West Africa",])/ length(unique(aggcrops$Country[aggcrops$Continent=="West Africa"]))

cropsSR$Rate[cropsSR$Continent=="Central Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Central Africa",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Central Africa"]))

cropsSR$Rate[cropsSR$Continent=="Southern Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Southern Africa",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Southern Africa"]))

cropsSR$Rate[cropsSR$Continent=="East Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="East Africa",])/ length(unique(aggcrops$Country[aggcrops$Continent=="East Africa"]))

cropsSR$Rate[cropsSR$Continent=="Western Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Western Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Western Asia"]))

cropsSR$Rate[cropsSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="South Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="South Asia"]))

cropsSR$Rate[cropsSR$Continent=="SE Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="SE Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="SE Asia"]))

cropsSR$Rate[cropsSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="East Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="East Asia"]))

cropsSR$Rate[cropsSR$Continent=="Australia/NZ"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Australia/NZ",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Australia/NZ"]))

cropsSR$Rate[cropsSR$Continent=="Melanesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Melanesia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Melanesia"]))

cropsSR$Rate[cropsSR$Continent=="Micronesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Micronesia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Micronesia"]))

cropsSR$Rate[cropsSR$Continent=="Polynesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$SubRegion=="Polynesia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Polynesia"]))

















#Livestock rates 

Country<-levels(agglivestock$Country)
Code<- countrycode(levels(agglivestock$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(agglivestock$Country), origin = "country.name", destination = "continent")
livestockSR<-cbind.data.frame(Country, Code, Continent)
livestockSR$Continent <-as.character(livestockSR$Continent)
livestockSR$Code <- as.character(livestockSR$Code)



livestockSR$Continent[livestockSR$Code %in% N_Africa_codes]<-"North Africa"
livestockSR$Continent[livestockSR$Code %in% E_Africa_codes]<-"East Africa"
livestockSR$Continent[livestockSR$Code %in% W_Africa_codes]<-"West Africa"
livestockSR$Continent[livestockSR$Code %in% M_Africa_codes]<-"Central Africa"
livestockSR$Continent[livestockSR$Code %in% S_Africa_codes]<-"Southern Africa"
livestockSR$Continent[livestockSR$Code %in% W_Asia_codes]<-"Western Asia"
livestockSR$Continent[livestockSR$Code %in% S_Asia_codes]<-"South Asia"
livestockSR$Continent[livestockSR$Code %in% SE_Asia_codes]<-"SE Asia"
livestockSR$Continent[livestockSR$Code %in% E_Asia_codes]<-"East Asia"
livestockSR$Continent[livestockSR$Code %in% Caribbean_codes]<-"Caribbean"
livestockSR$Continent[livestockSR$Code %in% N_America_codes]<-"North America"
livestockSR$Continent[livestockSR$Code %in% C_America_codes]<-"Central America"
livestockSR$Continent[livestockSR$Code %in% S_America_codes]<-"South America"
livestockSR$Continent[livestockSR$Code %in% Aus_NZ_codes]<-"Australia/NZ"
livestockSR$Continent[livestockSR$Code %in% Melanesia_codes]<-"Melanesia"
livestockSR$Continent[livestockSR$Code %in% Micronesia_codes]<-"Micronesia"
livestockSR$Continent[livestockSR$Code %in% Polynesia_codes]<-"Polynesia"
livestockSR$Continent[livestockSR$Code %in% E_Europe_codes]<-"Eastern Europe"
livestockSR$Continent[livestockSR$Code %in% N_Europe_codes]<-"Northern Europe"
livestockSR$Continent[livestockSR$Code %in% W_Europe_codes]<-"Western Europe"
livestockSR$Continent[livestockSR$Code %in% S_Europe_codes]<-"Southern Europe"

# livestockSR$Codes <- as.character(livestockSR$Codes)
# livestockSR$Continent <- as.character(livestockSR$Continent)

livestockSR$Code[livestockSR$Country=="Former Yugoslav SFR"]<-"BIH"
livestockSR$Code[livestockSR$Country=="Former Czechoslovakia"]<-"CZE"
livestockSR$Continent[livestockSR$Country=="Former Czechoslovakia"]<-"Eastern Europe"
livestockSR$Continent[livestockSR$Country=="Former Yugoslav SFR"]<-"Southern Europe"



#calculate shock rates 

livestockSR$Rate[livestockSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="North America",])/ length(unique(agglivestock$Country[agglivestock$Continent=="North America"]))

livestockSR$Rate[livestockSR$Continent=="Central America"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Central America",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Central America"]))

livestockSR$Rate[livestockSR$Continent=="Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Caribbean",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Caribbean"]))

livestockSR$Rate[livestockSR$Continent=="South America"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="South America",])/ length(unique(agglivestock$Country[agglivestock$Continent=="South America"]))

livestockSR$Rate[livestockSR$Continent=="Northern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Northern Europe",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Northern Europe"]))

livestockSR$Rate[livestockSR$Continent=="Western Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Western Europe",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Western Europe"]))

livestockSR$Rate[livestockSR$Continent=="Southern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Southern Europe",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Southern Europe"]))

livestockSR$Rate[livestockSR$Continent=="Eastern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Eastern Europe",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Eastern Europe"]))

livestockSR$Rate[livestockSR$Continent=="North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="North Africa",])/ length(unique(agglivestock$Country[agglivestock$Continent=="North Africa"]))

livestockSR$Rate[livestockSR$Continent=="West Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="West Africa",])/ length(unique(agglivestock$Country[agglivestock$Continent=="West Africa"]))

livestockSR$Rate[livestockSR$Continent=="Central Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Central Africa",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Central Africa"]))

livestockSR$Rate[livestockSR$Continent=="Southern Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Southern Africa",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Southern Africa"]))

livestockSR$Rate[livestockSR$Continent=="East Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="East Africa",])/ length(unique(agglivestock$Country[agglivestock$Continent=="East Africa"]))

livestockSR$Rate[livestockSR$Continent=="Western Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Western Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Western Asia"]))

livestockSR$Rate[livestockSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="South Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="South Asia"]))

livestockSR$Rate[livestockSR$Continent=="SE Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="SE Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="SE Asia"]))

livestockSR$Rate[livestockSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="East Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="East Asia"]))

livestockSR$Rate[livestockSR$Continent=="Australia/NZ"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Australia/NZ",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Australia/NZ"]))

livestockSR$Rate[livestockSR$Continent=="Melanesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Melanesia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Melanesia"]))

livestockSR$Rate[livestockSR$Continent=="Micronesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Micronesia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Micronesia"]))

livestockSR$Rate[livestockSR$Continent=="Polynesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$SubRegion=="Polynesia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Polynesia"]))





#FISHERIES

Country<-levels(aggfisheries$Country)
Code<- countrycode(levels(aggfisheries$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(aggfisheries$Country), origin = "country.name", destination = "continent")
fisheriesSR <-cbind.data.frame(Country, Code, Continent)
fisheriesSR$Continent <-as.character(fisheriesSR$Continent)
fisheriesSR$Code <-as.character(fisheriesSR$Code)



fisheriesSR$Continent[fisheriesSR$Code %in% N_Africa_codes]<-"North Africa"
fisheriesSR$Continent[fisheriesSR$Code %in% E_Africa_codes]<-"East Africa"
fisheriesSR$Continent[fisheriesSR$Code %in% W_Africa_codes]<-"West Africa"
fisheriesSR$Continent[fisheriesSR$Code %in% M_Africa_codes]<-"Central Africa"
fisheriesSR$Continent[fisheriesSR$Code %in% S_Africa_codes]<-"Southern Africa"
fisheriesSR$Continent[fisheriesSR$Code %in% W_Asia_codes]<-"Western Asia"
fisheriesSR$Continent[fisheriesSR$Code %in% S_Asia_codes]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code %in% SE_Asia_codes]<-"SE Asia"
fisheriesSR$Continent[fisheriesSR$Code %in% E_Asia_codes]<-"East Asia"
fisheriesSR$Continent[fisheriesSR$Code %in% Caribbean_codes]<-"Caribbean"
fisheriesSR$Continent[fisheriesSR$Code %in% N_America_codes]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code %in% C_America_codes]<-"Central America"
fisheriesSR$Continent[fisheriesSR$Code %in% S_America_codes]<-"South America"
fisheriesSR$Continent[fisheriesSR$Code %in% Aus_NZ_codes]<-"Australia/NZ"
fisheriesSR$Continent[fisheriesSR$Code %in% Melanesia_codes]<-"Melanesia"
fisheriesSR$Continent[fisheriesSR$Code %in% Micronesia_codes]<-"Micronesia"
fisheriesSR$Continent[fisheriesSR$Code %in% Polynesia_codes]<-"Polynesia"
fisheriesSR$Continent[fisheriesSR$Code %in% E_Europe_codes]<-"Eastern Europe"
fisheriesSR$Continent[fisheriesSR$Code %in% N_Europe_codes]<-"Northern Europe"
fisheriesSR$Continent[fisheriesSR$Code %in% W_Europe_codes]<-"Western Europe"
fisheriesSR$Continent[fisheriesSR$Code %in% S_Europe_codes]<-"Southern Europe"

# livestockSR$Codes <- as.character(livestockSR$Codes)
# livestockSR$Continent <- as.character(livestockSR$Continent)

fisheriesSR$Code[fisheriesSR$Country=="Former Yugoslav SFR"]<-"BIH"
fisheriesSR$Code[fisheriesSR$Country=="Former Czechoslovakia"]<-"CZE"
fisheriesSR$Continent[fisheriesSR$Country=="Former Czechoslovakia"]<-"Eastern Europe"
fisheriesSR$Continent[fisheriesSR$Country=="Former Yugoslav SFR"]<-"Southern Europe"



#calculate shock rates 

fisheriesSR$Rate[fisheriesSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="North America",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="North America"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Central America"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Central America",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Central America"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Caribbean",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Caribbean"]))

fisheriesSR$Rate[fisheriesSR$Continent=="South America"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="South America",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="South America"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Northern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Northern Europe",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Northern Europe"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Western Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Western Europe",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Western Europe"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Southern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Southern Europe",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Southern Europe"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Eastern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Eastern Europe",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Eastern Europe"]))

fisheriesSR$Rate[fisheriesSR$Continent=="North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="North Africa",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="North Africa"]))

fisheriesSR$Rate[fisheriesSR$Continent=="West Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="West Africa",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="West Africa"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Central Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Central Africa",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Central Africa"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Southern Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Southern Africa",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Southern Africa"]))

fisheriesSR$Rate[fisheriesSR$Continent=="East Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="East Africa",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="East Africa"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Western Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Western Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Western Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="South Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="South Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="SE Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="SE Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="SE Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="East Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="East Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Australia/NZ"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Australia/NZ",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Australia/NZ"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Melanesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Melanesia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Melanesia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Micronesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Micronesia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Micronesia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Polynesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$SubRegion=="Polynesia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Polynesia"]))





#AQUACULTURE

Country<-levels(aggaqua$Country)
Country[124]<-"Reunion"
Code<- countrycode(Country, origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(Country, origin = "country.name", destination = "continent")
aquacultureSR <-cbind.data.frame(Country, Code, Continent)
aquacultureSR$Continent <-as.character(aquacultureSR$Continent)
aquacultureSR$Code <-as.character(aquacultureSR$Code)


aquacultureSR$Continent[aquacultureSR$Code %in% N_Africa_codes]<-"North Africa"
aquacultureSR$Continent[aquacultureSR$Code %in% E_Africa_codes]<-"East Africa"
aquacultureSR$Continent[aquacultureSR$Code %in% W_Africa_codes]<-"West Africa"
aquacultureSR$Continent[aquacultureSR$Code %in% M_Africa_codes]<-"Central Africa"
aquacultureSR$Continent[aquacultureSR$Code %in% S_Africa_codes]<-"Southern Africa"
aquacultureSR$Continent[aquacultureSR$Code %in% W_Asia_codes]<-"Western Asia"
aquacultureSR$Continent[aquacultureSR$Code %in% S_Asia_codes]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code %in% SE_Asia_codes]<-"SE Asia"
aquacultureSR$Continent[aquacultureSR$Code %in% E_Asia_codes]<-"East Asia"
aquacultureSR$Continent[aquacultureSR$Code %in% Caribbean_codes]<-"Caribbean"
aquacultureSR$Continent[aquacultureSR$Code %in% N_America_codes]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code %in% C_America_codes]<-"Central America"
aquacultureSR$Continent[aquacultureSR$Code %in% S_America_codes]<-"South America"
aquacultureSR$Continent[aquacultureSR$Code %in% Aus_NZ_codes]<-"Australia/NZ"
aquacultureSR$Continent[aquacultureSR$Code %in% Melanesia_codes]<-"Melanesia"
aquacultureSR$Continent[aquacultureSR$Code %in% Micronesia_codes]<-"Micronesia"
aquacultureSR$Continent[aquacultureSR$Code %in% Polynesia_codes]<-"Polynesia"
aquacultureSR$Continent[aquacultureSR$Code %in% E_Europe_codes]<-"Eastern Europe"
aquacultureSR$Continent[aquacultureSR$Code %in% N_Europe_codes]<-"Northern Europe"
aquacultureSR$Continent[aquacultureSR$Code %in% W_Europe_codes]<-"Western Europe"
aquacultureSR$Continent[aquacultureSR$Code %in% S_Europe_codes]<-"Southern Europe"

# livestockSR$Codes <- as.character(livestockSR$Codes)
# livestockSR$Continent <- as.character(livestockSR$Continent)

aquacultureSR$Code[aquacultureSR$Country=="Former Yugoslav SFR"]<-"BIH"
aquacultureSR$Code[aquacultureSR$Country=="Former Czechoslovakia"]<-"CZE"
aquacultureSR$Continent[aquacultureSR$Country=="Former Czechoslovakia"]<-"Eastern Europe"
aquacultureSR$Continent[aquacultureSR$Country=="Former Yugoslav SFR"]<-"Southern Europe"



#calculate shock rates 

aquacultureSR$Rate[aquacultureSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="North America",])/ length(unique(aggaqua$Country[aggaqua$Continent=="North America"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Central America"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Central America",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Central America"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Caribbean",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Caribbean"]))

aquacultureSR$Rate[aquacultureSR$Continent=="South America"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="South America",])/ length(unique(aggaqua$Country[aggaqua$Continent=="South America"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Northern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Northern Europe",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Northern Europe"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Western Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Western Europe",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Western Europe"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Southern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Southern Europe",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Southern Europe"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Eastern Europe"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Eastern Europe",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Eastern Europe"]))

aquacultureSR$Rate[aquacultureSR$Continent=="North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="North Africa",])/ length(unique(aggaqua$Country[aggaqua$Continent=="North Africa"]))

aquacultureSR$Rate[aquacultureSR$Continent=="West Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="West Africa",])/ length(unique(aggaqua$Country[aggaqua$Continent=="West Africa"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Central Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Central Africa",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Central Africa"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Southern Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Southern Africa",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Southern Africa"]))

aquacultureSR$Rate[aquacultureSR$Continent=="East Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="East Africa",])/ length(unique(aggaqua$Country[aggaqua$Continent=="East Africa"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Western Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Western Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Western Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="South Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="South Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="SE Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="SE Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="SE Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="East Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="East Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Australia/NZ"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Australia/NZ",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Australia/NZ"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Melanesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Melanesia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Melanesia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Micronesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Micronesia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Micronesia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Polynesia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$SubRegion=="Polynesia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Polynesia"]))









#Mapping

#JOIN TO SPATIAL DATA
bbox <- readOGR(dsn="ne_110m_graticules_all", layer="ne_110m_wgs84_bounding_box") 
bbox <- spTransform(bbox, CRS("+proj=moll"))  # reproject bounding box
bbox_df<- fortify(bbox) #, group="ISO_TER1"


#JOINING CROP AND COUNTRY DATA 
names(cropsSR)[names(cropsSR)=="Codes"]<-"iso_a3"
CRworld<-readOGR("ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
CRworld <- CRworld[!CRworld$iso_a3 %in% c("ATA"),] #remove antartica
CRworld<-spTransform(CRworld, CRS("+proj=moll"))
CRworld@data$id<-rownames(CRworld@data)
CRworld@data<-join(CRworld@data, cropsSR, by="iso_a3")
CRworld.df<-fortify(CRworld)
CRworld.df<-join(CRworld.df, CRworld@data, by="id")
head(CRworld.df)

#centroids for crops data
#centroids<-aggregate(cbind(long,lat)~id, data=CRworld.df, FUN=function(x) mean(range(x)))
#CRworld.df2<-merge(CRworld.df, centroids, by="id")


#JOIN LIVESTOCK DATA TO COUNTRY CENTROIDS
names(livestockSR)[names(livestockSR)=="Code"]<-"iso_a3" #create common variable
LSworld<-readOGR(dsn="ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
LSworld <- LSworld[!LSworld$iso_a3 %in% c("ATA"),] #remove antarctica
LSworld<-spTransform(LSworld, CRS("+proj=moll"))
LSworld@data$id<-rownames(LSworld@data)
LSworld@data<-join(LSworld@data, livestockSR, by="iso_a3")
LSworld.df<-fortify(LSworld)
LSworld.df<-join(LSworld.df, LSworld@data, by="id")
#head(LSworld.df) #it worked! 

#Use the centroids to plot
#centroids<-aggregate(cbind(long,lat)~id, data=LSworld.df, FUN=function(x) mean(range(x)))
#LSworld.df<-merge(LSworld.df, centroids, by="id")
#LSworld.df

#EEZ shapefile from marine regions - not great for robinson projection 

#EEZfish <- read_sf(dsn = "World_EEZ", layer = "eez")
#EEZfish <- as(EEZfish, "Spatial")
# <- EEZfish[!EEZfish$Territory1 %in% c("Antarctica"),]
#(EEZfish@data)[1:70,]
#names(fisheriestp)[names(fisheriestp)=="codes"]<-"ISO_Ter1" #create common variable
#EEZfish<-spTransform(EEZfish, CRS("+proj=robin"))
#EEZfish@data$id<-rownames(EEZfish@data)
#EEZfish@data<-join(EEZfish@data, fisheriestp, by="ISO_Ter1")
#EEZfish.df<-fortify(EEZfish)
#EEZfish.df<-join(EEZfish.df, EEZfish@data, by="id")
#head(EEZfish.df)
#EEZfish.df$PropMagnitude[is.na(EEZfish.df$PropMagnitude)] <- 0
#EEZfish.df$AbsMagnitude[is.na(EEZfish.df$AbsMagnitude)] <- 0
#head(EEZfish.df)

#aquaculture data
#EEZaqua<-read_sf(dsn = "World_EEZ", layer = "eez")
#EEZaqua<- as(EEZaqua, "Spatial")
#EEZaqua <- EEZaqua[!EEZaqua$Territory1 %in% c("Antarctica"),]
#names(aquaculturetp)[names(aquaculturetp)=="codes"]<-"ISO_Ter1"#create common variable
#EEZaqua<-spTransform(EEZaqua, CRS("+proj=robin"))
#EEZaqua@data$id<-rownames(EEZaqua@data)
#EEZaqua@data<-join(EEZaqua@data, aquaculturetp, by="ISO_Ter1")
#EEZaqua.df<-fortify(EEZaqua)
#EEZaqua.df<-join(EEZaqua.df, EEZaqua@data, by="id")
#head(EEZaqua.df)

##CREATE A SIMPLIED VERSION OF SHAPEFILE AND EXPORT TO RDS
#eezfname <- "eez.shp"
#eez <- read_sf(dsn = "World_EEZ", "eez")
## will want the recent update (14 August 2017)
#library(rmapshaper)
#eez_sim <- ms_simplify(eez)
#eez_sim <- as(eez_sim, "Spatial")
#saveRDS(eez_sim, "eez_simplified.rds")

## read in simplified copy - fisheries
eez_fish <- readRDS("eez_simplified.rds")
eez_fish <- eez_fish[!eez_fish$Territory1 %in% c("Antarctica"),]
eez_fish<-spTransform(eez_fish, CRS("+proj=moll"))
names(fisheriesSR)[names(fisheriesSR)=="Code"]<-"ISO_Ter1"
eez_fish@data$id<-rownames(eez_fish@data)
eez_fish@data<-join(eez_fish@data, fisheriesSR, by="ISO_Ter1")
eez_fish.df<-fortify(eez_fish)
eez_fish.df<-join(eez_fish.df, eez_fish@data, by="id")

#centroids<-aggregate(cbind(long,lat)~id, data=eez_fish.df, FUN=function(x) mean(range(x)))
#eez_fish.df2<-merge(eez_fish.df, centroids, by="id")

#aquaculture and EEZ simplified
eez_aqua<-readRDS("eez_simplified.rds")
eez_aqua <- eez_aqua[!eez_aqua$Territory1 %in% c("Antarctica"),]
eez_aqua<-spTransform(eez_aqua, CRS("+proj=moll"))
names(aquacultureSR)[names(aquacultureSR)=="Code"]<-"ISO_Ter1"
eez_aqua@data$id<-rownames(eez_aqua@data)
eez_aqua@data<-join(eez_aqua@data, aquacultureSR, by="ISO_Ter1")
eez_aqua.df<-fortify(eez_aqua)
eez_aqua.df<-join(eez_aqua.df, eez_aqua@data, by="id")
#head(eez_aqua.df)

#Use the centroids to plot
#centroids<-aggregate(cbind(long,lat)~id, data=eez_aqua.df, FUN=function(x) mean(range(x)))
#eez_aqua.df<-merge(eez_aqua.df, centroids, by="id")
#names(eez_aqua.df)

#PLOTTING
#control white space
#par(mar=c(0,0,0,0))

#ADJUSTING CROP RATE DISPLAY FOR AGGREGATED COUNTRIES

CRworld.df$Rate[CRworld.df$iso_a3=="GRL"]<- unique(cropsSR$Rate[cropsSR$Continent=="North America"])


CRworld.df$Rate[CRworld.df$iso_a3=="ARM"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="AZE"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="BLR"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="EST"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="GEO"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="KAZ"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="KGZ"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="LVA"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="LTU"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="MDA"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="TJK"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="TKM"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="UKR"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="UZB"]<-unique(cropsSR$Rate[cropsSR$Continent=="Eastern Europe"])

CRworld.df$Rate[CRworld.df$iso_a3=="SRB"]<-unique(cropsSR$Rate[cropsSR$Continent=="Southern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="MNE"]<-unique(cropsSR$Rate[cropsSR$Continent=="Southern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="HRV"]<-unique(cropsSR$Rate[cropsSR$Continent=="Southern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="MKD"]<-unique(cropsSR$Rate[cropsSR$Continent=="Southern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="SVN"]<-unique(cropsSR$Rate[cropsSR$Continent=="Southern Europe"])
CRworld.df$Rate[CRworld.df$iso_a3=="SVK"]<-unique(cropsSR$Rate[cropsSR$Continent=="Southern Europe"])

CRworld.df$Rate[CRworld.df$iso_a3=="SSD"]<-unique(cropsSR$Rate[cropsSR$Continent=="East Africa"])

#LIVESTOCK ADJUSTEDMENT FOR AGGREGATED COUNTRIES


LSworld.df$Rate[LSworld.df$iso_a3=="ARM"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="AZE"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="BLR"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="EST"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="GEO"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="LVA"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="LTU"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="MDA"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="UKR"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="UZB"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])

LSworld.df$Rate[LSworld.df$iso_a3=="KAZ"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="KGZ"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="TJK"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="TKM"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="UZB"]<-unique(livestockSR$Rate[livestockSR$Continent=="Eastern Europe"])

LSworld.df$Rate[LSworld.df$iso_a3=="SRB"]<-unique(livestockSR$Rate[livestockSR$Continent=="Southern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="MNE"]<-unique(livestockSR$Rate[livestockSR$Continent=="Southern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="HRV"]<-unique(livestockSR$Rate[livestockSR$Continent=="Southern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="MKD"]<-unique(livestockSR$Rate[livestockSR$Continent=="Southern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="SVN"]<-unique(livestockSR$Rate[livestockSR$Continent=="Southern Europe"])
LSworld.df$Rate[LSworld.df$iso_a3=="SVK"]<-unique(livestockSR$Rate[livestockSR$Continent=="Southern Europe"])

LSworld.df$Rate[LSworld.df$iso_a3=="SSD"]<-unique(livestockSR$Rate[livestockSR$Continent=="East Africa"])





#CROPS and AQUACULTURE

mcrops<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat,fill=Rate, group=group, map_id=id), colour=NA, size=0.2)+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = bquote(Shock~frequency))+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(6, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 0.5, title.position = "top"))+
  annotation_custom(cropimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)+
  annotate("text", x=-1e+07, y=-8e+6, label="Crops" )

#Aquaculture

mAqua<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id, fill=Rate), colour="NA", size=0.2)+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(aquaimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)+
  annotate("text", x=-0.8e+07, y=-8e+6, label="Aquaculture" )




#LIVESTOCK 
mLs<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat,fill=Rate, group=group, map_id=id), colour="NA", size=0.2)+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(cowimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)+
  annotate("text", x=-0.9e+07, y=-8e+6, label="Livestock" )




mfish<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, fill=Rate, group=group, map_id=id), colour="NA", size=0.2)+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "left",
        legend.direction = "vertical",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+
  annotation_custom(fishingimg, xmin = -2.65e+07, xmax = -0.3e+07, ymin = -10.1e+06, ymax = -4.5e+06)+
  annotate("text", x=-0.9e+07, y=-8e+6, label="Fisheries" )

# + 
#   guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0, title.position = "top"))

ratescombined<-ggarrange(mcrops, mLs, mfish, mAqua, ncol = 1, nrow = 4, labels = c("a", "b", "c", "d"), legend = "none", font.label = list(size=12)) # pair this with temporal trends
ggsave(filename = "Shock ratesmap column.tiff", device = "tiff", dpi=600, width=9, height = 20, units = "cm")

#ratescol<-ggarrange(mcrops, mLs, mfish, mAqua, ncol=1, nrow=4, labels=c("a", "c", "e", "g"), legend = "none")

ratelegend<-get_legend(mcrops)

ratescombined2<-ggarrange(ratescombined, ratelegend , nrow=2, ncol=1, heights = c(1,0.1),font.label = list(size=12))
ggsave(filename = "Shock ratesmap column2.tiff", device = "tiff", dpi=600, width=9, height = 20, units = "cm")

# ggsave(filename = "Shock rates only map.tiff", device = "tiff", dpi=600, width=18.3, height = 12.5, units = "cm")
# 
# ggsave(filename = "Shock rates only map.pdf", device = pdf, dpi=600, width=18.3, height = 12.5, units = "cm")

# ratedriver1<-ggarrange(ratescol, driverscol, nrow = 1, ncol=2)
# 
# ratedriver2<-ggarrange(ratedriver1, driverlegend, ncol=1, nrow = 2, heights =  c(1,0.15))
# 
# ggarrange(ratelegend, ratedriver2, ncol = 2, nrow = 1, widths = c(0.15,1))

# ggsave(filename="Figure 2 - Rates and drivers map.tiff", device = "tiff", dpi=600, width = 16, height = 17, units = "cm")
# 
# 
# 
# ggarrange(topmaps, bottommaps, ncol=1, nrow=2, align="hv", heights = c(1,0.8))
# 
# ggsave("Shock Magnitudes and Rates - with aggregates.pdf", device=pdf, dpi = 600, width = 230, height=190, units="mm", scale=1.8)



```

#Figure 1 - Shocks over time plot and Figure S2 - Shock diversity over time

```{r}

cols<-c("Climate/weather events"="#9e0142", "Climate/weather events & mismanagement" = "#d53e4f", "Climate/weather & geopolitical/economic events" = "#f46d43", "Geopolitical/economic events" = "#fdae61", "Mismanagement & geopolitical/economic events" = "#fee08b","Mismanagement" = "#e6f598",  "Mismanagement & policy change" = "#abdda4", "Policy change" = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")

#shockdrivers broken into sectors

cropdrivers <- shockdrivers[shockdrivers$Sector=="Crops",]
cropdriversovertime <- data.frame(table(cropdrivers$Year))

livestockdrivers <- shockdrivers[shockdrivers$Sector=="Livestock",]
livestockdriversovertime <- data.frame(table(livestockdrivers$Year))


fisheriesdrivers <- shockdrivers[shockdrivers$Sector=="Fisheries",]
fisheriesdriversovertime <- data.frame(table(fisheriesdrivers$Year))


aquaculturedrivers <- shockdrivers[shockdrivers$Sector=="Aquaculture",]
aquaculturedriversovertime <- data.frame(table(aquaculturedrivers$Year))







#CROP SHOCKS OVER TIME
cropshocks<-shocks2[shocks2$Sector=="Crops",]
cropsovertime <-data.frame(table(cropshocks$Year, cropshocks$BaseComp, cropshocks$Average, cropshocks$Span))

names(cropsovertime)[names(cropsovertime)=="Var1"] <-"Year"
names(cropsovertime)[names(cropsovertime)=="Var2"] <-"Duration"
names(cropsovertime)[names(cropsovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(cropsovertime)[names(cropsovertime)=="Var4"] <-"Span"


cropsovertime$Freq <- as.numeric(cropsovertime$Freq)
cropsovertime$Year <- as.numeric(levels(cropsovertime$Year))[cropsovertime$Year]

ggplot(data = cropsovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency")






#crop shocks with confidence

mins <- tapply(cropsovertime$Freq, INDEX = cropsovertime$Year, FUN = min)
maxs <- tapply(cropsovertime$Freq, INDEX = cropsovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(cropshocks$Year, interaction(cropshocks$Average, cropshocks$Span, cropshocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]


#add the correct amount from the selected model

names(cropdriversovertime)[names(cropdriversovertime)=="Freq"]<-"actual2"
names(cropdriversovertime)[names(cropdriversovertime)=="Var1"]<-"Year"
cropdriversovertime$Year <- as.numeric(levels(cropdriversovertime$Year))[cropdriversovertime$Year]

av.shocks <- join(av.shocks, cropdriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0

# av.shocks$actual <-cropdriversovertime$Freq[cropsovertime$Span==0.6 & cropsovertime$Average=="Median"& cropsovertime$Duration==7] 



#adjusted shock frequency for shock rate
av.shocks<-join(av.shocks, CropsN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$CropsN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$CropsN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$CropsN

#add decades
av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"


#add decadal trends
  
av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA



(p1<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  theme(panel.background = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        panel.grid = element_blank(),
        plot.margin = unit(c(0.5,0.2,0.5,0), "cm"),
        axis.title.x = element_blank())+
  scale_y_continuous(limits = c(0,0.07))+
  scale_x_continuous(limits = c(1964,2013))+
  labs(y=bquote(Shock~freq.))+
    annotation_custom(cropimg, xmin = 1964, xmax=1974, ymin = 0.045, ymax=0.065))

#Crop shocks by driver over time
driversandtime<- data.frame(table(cropdrivers$Year, cropdrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]

#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<-(sum*(log(sum)))*-1
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

# cropdriversovertime <- join(driversandtime, cropdriversovertime, by="Year", type="left")
# cropdriversovertime$Prop <- cropdriversovertime$Freq/ cropdriversovertime$actual2

(p2 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
    geom_line(aes(y=Index*5), linetype=2, colour="grey50", size=1)+
  scale_fill_manual(values=cols)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8), sec.axis = sec_axis(~./5, name = bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0,0,0), "cm"),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~no.), subtitle="Crops"))



#LIVESTOCK SHOCKS OVER TIME
livestockshocks<-shocks2[shocks2$Sector=="Livestock",]
livestockovertime <-data.frame(table(livestockshocks$Year, livestockshocks$BaseComp, livestockshocks$Average, livestockshocks$Span))

names(livestockovertime)[names(livestockovertime)=="Var1"] <-"Year"
names(livestockovertime)[names(livestockovertime)=="Var2"] <-"Duration"
names(livestockovertime)[names(livestockovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(livestockovertime)[names(livestockovertime)=="Var4"] <-"Span"


livestockovertime$Freq <- as.numeric(livestockovertime$Freq)
livestockovertime$Year <- as.numeric(levels(livestockovertime$Year))[livestockovertime$Year]

ggplot(data = livestockovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency")







#livestock shocks with confidence

mins <- tapply(livestockovertime$Freq, INDEX = livestockovertime$Year, FUN = min)
maxs <- tapply(livestockovertime$Freq, INDEX = livestockovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(livestockshocks$Year, interaction(livestockshocks$Average, livestockshocks$Span, livestockshocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]

#add the correct amount from the selected model

names(livestockdriversovertime)[names(livestockdriversovertime)=="Freq"]<-"actual2"
names(livestockdriversovertime)[names(livestockdriversovertime)=="Var1"]<-"Year"
livestockdriversovertime$Year <- as.numeric(levels(livestockdriversovertime$Year))[livestockdriversovertime$Year]

av.shocks <- join(av.shocks, livestockdriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0


# av.shocks$actual <-livestockovertime$Freq[livestockovertime$Span==0.6 & livestockovertime$Average=="Median"& livestockovertime$Duration==7] 

#adjusting shock frequency for shock rate

av.shocks<-join(av.shocks, LivestockN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$LivestockN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$LivestockN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$LivestockN


#add decades

av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"

#add decadal trends
  
av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA



(p3<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits = c(0,0.07))+
  scale_x_continuous(limits = c(1964,2014))+
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0.5,0.2,0.5,0), "cm"),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~freq.))+
    annotation_custom(cowimg, xmin = 1964, xmax=1974, ymin = 0.045, ymax=0.065))


#Livestock shocks by driver over time
driversandtime<- data.frame(table(livestockdrivers$Year, livestockdrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]


#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<- -(sum*(log(sum)))
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

# driversandtime
# 
# livestockdriversovertime <- join(driversandtime, livestockdriversovertime, by="Year", type="left")
# livestockdriversovertime$Prop <- livestockdriversovertime$Freq/ livestockdriversovertime$actual2

(p4 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols)+
  geom_line(aes(y=Index*5), linetype=2, colour="grey50", size=1)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8),sec.axis = sec_axis(~./5, name = bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~no.), subtitle="Livestock"))








#FISHERIES SHOCKS OVER TIME
fisheriesshocks<-shocks2[shocks2$Sector=="Fisheries",]
fisheriesovertime <-data.frame(table(fisheriesshocks$Year, fisheriesshocks$BaseComp, fisheriesshocks$Average, fisheriesshocks$Span))

names(fisheriesovertime)[names(fisheriesovertime)=="Var1"] <-"Year"
names(fisheriesovertime)[names(fisheriesovertime)=="Var2"] <-"Duration"
names(fisheriesovertime)[names(fisheriesovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(fisheriesovertime)[names(fisheriesovertime)=="Var4"] <-"Span"


fisheriesovertime$Freq <- as.numeric(fisheriesovertime$Freq)
fisheriesovertime$Year <- as.numeric(levels(fisheriesovertime$Year))[fisheriesovertime$Year]

(ggplot(data = fisheriesovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency"))






#fisheries shocks with confidence

mins <- tapply(fisheriesovertime$Freq, INDEX = fisheriesovertime$Year, FUN = min)
maxs <- tapply(fisheriesovertime$Freq, INDEX = fisheriesovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(fisheriesshocks$Year, interaction(fisheriesshocks$Average, fisheriesshocks$Span, fisheriesshocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]



#correct actual shock number for selected model

names(fisheriesdriversovertime)[names(fisheriesdriversovertime)=="Freq"]<-"actual2"
names(fisheriesdriversovertime)[names(fisheriesdriversovertime)=="Var1"]<-"Year"
fisheriesdriversovertime$Year <- as.numeric(levels(fisheriesdriversovertime$Year))[fisheriesdriversovertime$Year]

av.shocks <- join(av.shocks, fisheriesdriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0


# av.shocks$actual <-fisheriesovertime$Freq[fisheriesovertime$Span==0.6 & fisheriesovertime$Average=="Median"& fisheriesovertime$Duration==7] 

av.shocks<-join(av.shocks, FisheriesN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$FisheriesN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$FisheriesN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$FisheriesN


#add decades

av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"

#add decadal trends
  
av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA

av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA


(p5<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits=c(0, 0.07))+
  scale_x_continuous(limits = c(1964, 2014))+
  theme(panel.background = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0.5,0.2,0.5,0), "cm"),
        panel.grid = element_blank(),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~freq.))+
  annotation_custom(fishingimg, xmin = 1961, xmax=1978, ymin = 0.035, ymax=0.07))



#fisheries shocks by driver over time
driversandtime<- data.frame(table(fisheriesdrivers$Year, fisheriesdrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]

#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("196", drivers.div$Year)]<-"1960s"
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<- -(sum*(log(sum)))
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("196", driversandtime$Year)]<-"1960s"
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="1960s"]<-NA
driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

driversandtime

# fisheriesdriversovertime <- join(driversandtime, fisheriesdriversovertime, by="Year", type="left")
# fisheriesdriversovertime$Prop <- fisheriesdriversovertime$Freq/ fisheriesdriversovertime$actual2

(p6 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols)+
    geom_line(aes(y=Index*4), linetype=2, colour="grey50", size=1)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8),sec.axis = sec_axis(~./4, name =bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0.2,0,0), "cm"))+
  labs(X=bquote(bold(Year)), y=bquote(Shock~no.), subtitle="Fisheries"))



#AQUACULURE SHOCKS OVER TIME

aquashocks<-shocks2[shocks2$Sector=="Aquaculture",]
aquaovertime <-data.frame(table(aquashocks$Year, aquashocks$BaseComp, aquashocks$Average, aquashocks$Span))

names(aquaovertime)[names(aquaovertime)=="Var1"] <-"Year"
names(aquaovertime)[names(aquaovertime)=="Var2"] <-"Duration"
names(aquaovertime)[names(aquaovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(aquaovertime)[names(aquaovertime)=="Var4"] <-"Span"


aquaovertime$Freq <- as.numeric(aquaovertime$Freq)
aquaovertime$Year <- as.numeric(levels(aquaovertime$Year))[aquaovertime$Year]

(ggplot(data = aquaovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency"))







#aquaculture shocks with confidence

mins <- tapply(aquaovertime$Freq, INDEX = aquaovertime$Year, FUN = min)
maxs <- tapply(aquaovertime$Freq, INDEX = aquaovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(aquashocks$Year, interaction(aquashocks$Average, aquashocks$Span, aquashocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]


#Correct actual number with selected model
names(aquaculturedriversovertime)[names(aquaculturedriversovertime)=="Freq"]<-"actual2"
names(aquaculturedriversovertime)[names(aquaculturedriversovertime)=="Var1"]<-"Year"
aquaculturedriversovertime$Year <- as.numeric(levels(aquaculturedriversovertime$Year))[aquaculturedriversovertime$Year]

av.shocks <- join(av.shocks, aquaculturedriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0

# av.shocks$actual <-aquaovertime$Freq[aquaovertime$Span==0.6 & aquaovertime$Average=="Median"& aquaovertime$Duration==7] 

#adjust shock frequency for shock rate

av.shocks<-join(av.shocks, AquacultureN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$AquacultureN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$AquacultureN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$AquacultureN


#add decades

av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"

#add decadal trends

av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA





(p7<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits=c(0, 0.07))+
  scale_x_continuous(limits = c(1964, 2014))+
  theme(panel.background = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.x = element_text(size=12, face="bold", margin = margin(t=25)),
        plot.margin = unit(c(0.5,0.2,0.5,0), "cm"),
        panel.grid = element_blank())+
  labs(y=bquote(Shock~freq.))+
    annotation_custom(aquaimg, xmin = 1964, xmax=1974, ymin = 0.045, ymax=0.065))




#aquaculture shocks by driver over time
driversandtime<- data.frame(table(aquaculturedrivers$Year, aquaculturedrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]

#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("196", drivers.div$Year)]<-"1960s"
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<- -(sum*(log(sum)))
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("196", driversandtime$Year)]<-"1960s"
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

# driversandtime
# 
# aquaculturedriversovertime <- join(driversandtime, aquaculturedriversovertime, by="Year", type="left")
# aquaculturedriversovertime$Prop <- aquaculturedriversovertime$Freq/ aquaculturedriversovertime$actual2

# filler<-(data.frame(Year=c(1980:1983, 1985:1989), Driver=rep(NA,9), Freq=rep(0,9), Decade=rep("1980s",9), Index=rep(0,9)))
# filler2<-rbind.data.frame(driversandtime, filler)
# filler2<-filler2[order(filler2$Year),]
# filler2$Decade<-as.factor(filler2$Driver)
# levels(filler2$Driver)

(p8 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols)+
  geom_line(aes(x=Year, y=Index*4), linetype=2, colour="grey50", size=1)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8),sec.axis = sec_axis(~./4, name =bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "bottom",
        legend.text = element_text(size=9),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        legend.title = element_text(face="bold"))+
  labs(y=bquote(Shock~no.), x=bquote(bold(Year)),subtitle="Aquaculture")+
    guides(fill=guide_legend(nrow=4, byrow = T)))


#left<-ggarrange(p1, p3, p5, p7, ncol=1, nrow=4, labels = c("a", "c", "e", "g"), heights = c(1,1,1,1))

#right<-ggarrange(p2, p4, p6, p8, ncol=1, nrow=4, labels = c("b", "d", "f", "h"), common.legend = F, legend = "none", heights = c(1,1,1,1))


#ggarrange(ggarrange(left, right, align = "hv"), driverlegend, nrow=2, ncol=1, heights = c(1,0.15))


#ggsave(filename="Shock over time per sector and drivers.tiff", device="tiff", dpi=600, width=8.9, height=8, units="cm")


#Figure 1 

time_rates <- ggarrange(p1,p3,p5,p7, labels = c("e", "f", "g", "h"), nrow = 4, ncol=1, legend = "none", heights=c(1,1,1,1.35), font.label = list(size=12))
ggsave(filename = "Shock rates over time column.tiff", device = "tiff", dpi=600, width = 9, height=20, units = "cm")


ggarrange(ratescombined2, time_rates, nrow = 1, ncol=2)+
  ggsave("shocks rates spatial temporal.tiff", device = "tiff", dpi=600, width = 18, height=20, units="cm")+
  ggsave("shocks rates spatial temporal.pdf", device = "pdf", dpi=600, width = 18, height=20, units="cm")

#Supplementary Figure 2 - for object 'Causes' see Figure 2

modellegend <- Causes+guides(fill=guide_legend(title.position = "top", title.hjust = 0.5, ncol=2))
legend <- get_legend(modellegend)

ggarrange(ggarrange(p2,p4,p6,p8, labels = c("a", "b", "c","d"), nrow=2, ncol=2, font.label = list(size=12), legend = "none"), legend, nrow = 2, ncol=1, heights = c(1,0.2))+
  ggsave("Figure S2.tiff", device = "tiff", dpi=300, width = 18.3, height = 14, units="cm")


# 
# fig1<-ggarrange(p1, p3, p2,p4, p5,p7, p6,p8, labels=c("a","c","b","d","e", "g", "f", "h"), ncol=2, nrow=4, legend = "none", align = "hv" , font.label = list(size=12))
# 
# driverlegend<-get_legend(pie1)
# 
# fig1<-ggarrange(fig1, driverlegend, nrow=2, ncol=1, heights = c(1,0.15))
# 
# ggsave(filename = "Figure 1 - Shock rates over time.tiff", device = "tiff", dpi=600, width = 18, height=16, units = "cm")
# 
# ggsave(filename = "Figure 1 - Shock rates over time.pdf", device = pdf, dpi=600, width = 18, height=18, units = "cm")
# 

```


#Figure 2 - PLOTS FOR PROPORTIONAL CONTRIBUTION OF DRIVERS PER SECTOR

```{r}

cols <- c("Climate/weather events"="#9e0142", "Climate/weather events & mismanagement" = "#d53e4f", "Climate/weather & geopolitical/economic events" = "#f46d43", "Geopolitical/economic events" = "#fdae61", "Mismanagement & geopolitical/economic events" = "#fee08b","Mismanagement" = "#e6f598",  "Mismanagement & policy change" = "#abdda4", "Policy change" = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")

Causes<-ggplot(data=shockcategories, aes(x=Var2, y=Prop, fill=Var1))+geom_bar(stat="identity")+
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y=element_text(size=8, face="bold"),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        #panel.border = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text(size=8),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_blank(),
        legend.title = element_text(face="bold", size=8),
        plot.margin = unit(c(t=0,r=0,b=0,l=0), "cm"))+
  scale_fill_brewer(palette = "Spectral")+
  scale_y_continuous(limits = c(0, 1.06))+
  labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0, ncol = 1))+
  annotation_custom(cropimg, xmin = 0.5, xmax = 1.5, ymin = 1.009, ymax=1.1)+
  annotation_custom(cowimg, xmin = 1.5, xmax = 2.5, ymin = 1.009, ymax=1.1)+
  annotation_custom(fishingimg, xmin = 2.5, xmax = 3.5, ymin = 0.93, ymax=1.12)+
  annotation_custom(aquaimg, xmin = 3.5, xmax = 4.5, ymin = 1.009, ymax=1.1)


noleg<-ggarrange(Causes, nrow = 1, ncol = 1, legend = "none")

ggarrange(noleg, get_legend(Causes), nrow=2, ncol=1, heights = c(0.9, 0.4))+
ggsave("Drivers only.tiff", device="tiff", dpi=600, width=8.8, height=14, units = "cm")+
ggsave("Drivers only.pdf", device= "pdf", dpi=600, width=8.8, height=14, units = "cm")



# pie1<-ggplot(data=shockcategories[shockcategories$Var2=="Crops",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
#   theme_bw()+
#   coord_polar("y")+
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_blank(),
#         axis.ticks = element_blank(),
#         panel.grid = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom", 
#         legend.text = element_text(size=9),
#         legend.key.size = unit(0.3, "cm"),
#         legend.background = element_blank(),
#         legend.title = element_text(face="bold", size=10),
#         plot.margin = unit(c(t=0,r=0,b=0.5,l=-0.9), "cm"))+
#   scale_fill_manual(values=cols)+
#   #scale_y_continuous(limits = c(0, 1.06))+
#   labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))
# 
# driverlegend<-get_legend(pie1)

# pie2<-ggplot(data=shockcategories[shockcategories$Var2=="Livestock",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
#   theme_bw()+
#   coord_polar("y")+
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_blank(),
#         axis.ticks = element_blank(),
#         panel.grid = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom", 
#         legend.text = element_text(size=8),
#         legend.key.size = unit(0.3, "cm"),
#         legend.background = element_blank(),
#         legend.title = element_text(face="bold", size=8),
#         plot.margin = unit(c(t=0,r=0,b=0.5,l=-0.9), "cm"))+
#   scale_fill_manual(values=cols)+
#   #scale_y_continuous(limits = c(0, 1.06))+
#   labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))
# 
# pie3<-ggplot(data=shockcategories[shockcategories$Var2=="Fisheries",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
#   theme_bw()+
#   coord_polar("y")+
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_blank(),
#         axis.ticks = element_blank(),
#         panel.grid = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom", 
#         legend.text = element_text(size=8),
#         legend.key.size = unit(0.3, "cm"),
#         legend.background = element_blank(),
#         legend.title = element_text(face="bold", size=8),
#         plot.margin = unit(c(t=0,r=0,b=0.5,l=-0.9), "cm"))+
#   scale_fill_manual(values=cols)+
#   #scale_y_continuous(limits = c(0, 1.06))+
#   labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))
# 
# pie4<-ggplot(data=shockcategories[shockcategories$Var2=="Aquaculture",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
#   theme_bw()+
#   coord_polar("y")+
#   theme(axis.title.x = element_text(size=11, margin = unit(c(0.2,0,0,0), "cm")),
#         axis.text.x = element_blank(),
#         axis.ticks = element_blank(),
#         panel.grid = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom", 
#         legend.text = element_text(size=10),
#         legend.key.size = unit(0.3, "cm"),
#         legend.background = element_blank(),
#         legend.title = element_text(face="bold", size=10),
#         plot.margin = unit(c(t=0,r=0.5,b=1.2,l=-0.4), "cm"))+
#   scale_fill_manual(values=cols)+
#   #scale_y_continuous(limits = c(0, 1.06))+
#   labs(x="", y="", fill="Shock drivers")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))
# 
# pies<-ggarrange(pie1, pie2, pie3, pie4, legend = "none", nrow=4, ncol=1, heights = c(0.9,0.9,0.9,1.2), labels=c("a", "d", "g", "k"))
# #ggsave(filename = "shockdrivers by sector.pdf", device=pdf, dpi=600, width=10, height = 10)

```


#Figure 3 - Heat Map 

```{r}
# 
shockdrivers <- fread("Shocks and drivers tidy3.csv", header=T)

#Africa
N_Africa <- c("Algeria", "Egypt", "Libya", "Morocco", "Sudan", "Tunisia")
E_Africa <- c("Burundi", "Comoros", "Djibouti", "Eritrea", "Ethiopia", "Kenya", "Madagascar", "Malawi", "Mauritius", "Mozambique", "Rwanda", "Seychelles", "Somalia", "South Sudan", "Uganda","Tanzania", "Zambia", "Zimbabwe","United Republic of Tanzania" , "Tanzania, United Rep. of", "Zanzibar")
M_Africa <- c("Angola", "Cameroon", "Central African Republic", "Chad", "Congo", "Dem. Rep. Congo", "Equatorial Guinea", "Gabon", "Sao Tome and Principe", "St Helena", "Congo, Dem. Rep. of the", "Democratic Republic of the Congo" )
S_Africa <- c("Botswana", "Lesotho", "Namibia", "South Africa", "Swaziland")
W_Africa <- c("Benin", "Burkina Faso", "Cabo Verde", "Côte d'Ivoire", "Gambia", "Ghana", "Guinea", "Guinea-Bissau", "Liberia", "Mali", "Mauritania", "Niger", "Nigeria", "Senegal", "Sierra Leone", "Togo")

#Asia

E_Asia <- c("China, mainland", "China, Hong Kong SAR", "China, Macao SAR",  "N. Korea", "Japan", "Mongolia", "Republic of Korea","Democratic People's Republic of Korea", "Korea, Dem. People's Rep", "Northern Mariana Is.")
SE_Asia <- c("Brunei Darussalam", "Cambodia", "Indonesia", "Lao People's Democratic Republic", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Timor-Leste", "Viet Nam")
S_Asia <- c("Afghanistan", "Bangladesh", "Bhutan", "India", "Iran (Islamic Republic of)", "Maldives", "Nepal", "Pakistan", "Sri Lanka")
W_Asia <- c("Armenia", "Bahrain", "Cyprus", "Iraq", "Israel", "Jordan", "Kuwait", "Lebanon", "Oman", "Palestine", "Qatar", "Saudi Arabia","Syrian Arab Republic", "Turkey", "United Arab Emirates" , "Yemen")

#Latin America/Caribbean

Caribbean <- c("Antigua and Barbuda", "Anguilla", "Aruba", "Bahamas", "Barbados", "British Virgin Islands",  "Cuba", "Cayman Islands", "Dominica", "Dominican Republic", "Grenada", "Guadeloupe", "Haiti", "Jamaica", "Martinique", "Mayotte", "Montserrat", "Netherlands Antilles", "Puerto Rico", "Saint Kitts and Nevis", "Saint Lucia", "St. Vin.&Gren.", "Trinidad and Tobago", "Turks and Caicos Is.", "US Virgin Islands", "Saint Vincent and the Grenadines", "Saint Vincent/Grenadines")

C_America <- c("Belize", "Costa Rica", "El Salvador", "Guatemala", "Honduras", "Mexico", "Nicaragua", "Panama")
S_America <- c("Argentina", "Bolivia (Plurinational State of)", "Brazil", "Chile", "Colombia", "Ecuador", "French Guiana", "Guyana", "Paraguay", "Peru", "Suriname", "Uruguay", "Venezuela","Venezuela (Bolivarian Republic of)", "Venezuela, Boliv Rep of", "Falkland Islands (Malvinas)")

#Oceania
Aus_NZ <- c("Australia", "New Zealand")
Melanesia <- c("Fiji",  "New Caledonia", "Papua New Guinea", "Solomon Islands", "Vanuatu", "Fiji, Republic of" )
Micronesia <- c("Guam", "Kiribati", "Marshall Islands", "Micronesia (Federated States of)", "Nauru", "Palau")
Polynesia <- c("American Samoa", "Cook Islands", "French Polynesia", "Niue", "Samoa", "Tokelau", "Tonga", "Tuvalu", "Wallis and Futuna Islands", "Pitcairn Islands")

#North AMerica
N_America <- c("Bermuda", "United States of America", "Canada", "Greenland", "St. Pierre and Miquelon")

#Europe
E_Europe <- c("Bulgaria", "Former Czechoslovakia", "Hungary", "Poland", "Romania", "Ukraine", "Former USSR")
N_Europe <- c("Denmark", "Finland", "Iceland", "Ireland", "Norway", "Sweden", "United Kingdom", "Faroe Islands", "Isle of Man" )
S_Europe <- c("Albania", "Andorra", "Croatia", "Greece", "Italy", "Malta", "Portugal", "Spain",  "Former Yugoslav SFR", "San Marino")
W_Europe <- c("Austria", "Belgium", "France", "Germany", "Luxembourg", "Netherlands", "Switzerland" )



#arrange data

(synchrony <-
  shockdrivers %>%
    mutate(Country = case_when(Country %in% c("Democratic People's Republic of Korea", "Korea, Dem. People's Rep") ~ "N. Korea",
                             Country %in% c("Venezuela (Bolivarian Republic of)", "Venezuela, Boliv Rep of") ~ "Venezuela",
                             Country %in% c("Congo, Dem. Rep. of the", "Democratic Republic of the Congo") ~ "Dem. Rep. Congo",
                             Country %in% c("Fiji, Republic of" ) ~ "Fiji",
                             Country %in% c("Saint Vincent and the Grenadines", "Saint Vincent/Grenadines" ) ~ "St. Vin.&Gren.",
                             Country %in% c("United Republic of Tanzania" , "Tanzania, United Rep. of" ) ~ "Tanzania",
                             T ~ Country)) %>% 
    arrange(Country) %>% 
    mutate(Time = cut(Year, breaks=c(1967.5, 1972.5, 1977.5, 1982.5, 1987.5, 1992.5, 1997.5, 2002.5, 2007.5, 2013))) %>%
    count(Country, Sector, Time) %>%
    mutate(n=1) %>% 
    count(Country, Time) %>% 
    mutate(SubRegion = case_when(Country %in% N_Africa ~ "North Africa",
                               Country %in% M_Africa ~ "Central Africa",
                               Country %in% S_Africa ~ "Southern Africa",
                               Country %in% W_Africa ~ "West Africa",
                               Country %in% E_Africa ~ "East Africa",
                               #Country %in% Former_USSR ~ "Former USSR",
                               Country %in% E_Asia ~ "East Asia",
                               Country %in% SE_Asia ~ "SE Asia",
                               Country %in% S_Asia ~ "South Asia",
                               Country %in% W_Asia ~ "Western Asia",
                               Country %in% Caribbean ~ "Caribbean",
                               Country %in% C_America ~ "Central America",
                               Country %in% S_America ~ "South America",
                               Country %in% N_America ~ "North America",
                               Country %in% Aus_NZ ~ "Australia/NZ",
                               Country %in% Micronesia ~ "Micronesia",
                               Country %in% Melanesia ~ "Melanesia",
                               Country %in% Polynesia ~ "Polynesia",
                               Country %in% N_Europe ~ "Northern Europe",
                               Country %in% E_Europe ~ "Eastern Europe",
                               Country %in% S_Europe ~ "Southern Europe",
                               Country %in% W_Europe ~ "Western Europe") %>% 
           factor())%>% 
    mutate(SubRegion = factor(SubRegion, levels(SubRegion)[c(11,2,4,15,12,21,18,7,10,19,3,17,5,20,16,6,14,1,8,9,13)])) %>% 
    arrange(SubRegion))
 



#no of countries per region
Sregion_nos <- c()

for (i in 1:length(levels(synchrony$SubRegion))){
  Sregion_nos <- c(Sregion_nos, length(unique(synchrony$Country[synchrony$SubRegion==levels(synchrony$SubRegion)[i]])))
}
Sregion_nos2 <- cumsum(Sregion_nos)
Sregion_nos2 <- Sregion_nos2+0.5

mean(shockdrivers$Recovery2)



#Create y-axis list of countries/regions

edit_synchrony <- synchrony[!duplicated(synchrony$Country),]



# Region lists
region_list <- split(edit_synchrony$SubRegion, rleid(edit_synchrony$SubRegion))
region_list <- lapply(region_list, as.character)


# 
# flatten_regions <-
#   lapply(region_list, function(target_region){
#   #region <- target_region
#   selector <- ceiling(length(target_region)/2)+1
#   label <- target_region[1]
#   element <- gsub(label, "", target_region)
#   element[selector] <- label
#   return(element)
# })

flatten_regions <-as.list(c())

flatten_regions <-
  lapply(region_list, function(region){
  region_length <- length(region)
  pos <- ceiling(region_length/2)+1
  label <- region[1]
  element <- rep("", region_length) 
  element[pos] <- label
  return(element)
})

new_names <- as.vector(unlist(flatten_regions))


# for (i in 1:length(region_list)){
#   region <- region_list[[i]]
#   selector <- ceiling(length(region)/2)+1
#   label <- as.vector(region[selector])
#   element <- gsub(label, "", region)
#   element[selector] <- label
#   flatten_regions[[i]] <- element
# }

   



#heatmap

heat_map <- ggplot(data=synchrony, aes(x=Time, y=interaction(Country, SubRegion)))+
  geom_tile(aes(fill=cut(nn, breaks = 0:3, labels = 1:3)), colour=NA)+
  geom_hline(yintercept = Sregion_nos2,  alpha=0.15, linetype=2)+
  scale_fill_manual(drop=F, values = colorRampPalette(c("yellow", "red"))(3), na.value="grey90")+
  scale_x_discrete(labels=c("1968-72", "1973-77", "1978-82", "1983-87", "1988-92", "1993-97", "1998-2002", "2003-2007", "2008-2013"))+
  scale_y_discrete(labels=new_names)+
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.background = element_rect(fill="grey91"),
        legend.box.just = "center",
        legend.position = "bottom",
        axis.text.x = element_text(size=8, angle = 35, hjust =1 ),
        axis.text.y = element_text(size=8, face="bold"),
        #axis.ticks.y = element_line(colour = "grey75"),
        axis.ticks.y = element_blank(),
        axis.title = element_text(size=11),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.key.height = unit(0.01, "mm"),
        legend.key.width = unit(1, "cm"),
        plot.margin = unit(c(0.1,0.5,0,-0.2), "cm"))+
  guides(colour=F, fill = guide_legend(title.position = "bottom", title.hjust = 0.5))+
  labs(y="", x=bquote(bold(Year)), fill="No. of sectors w/ shocks")+
  
  ggsave("heatmap.tiff", device = "tiff", dpi=600, width=12, height=15, units = "cm")+
  ggsave("heatmap.pdf", device = "pdf", dpi=600, width=12, height=15, units = "cm")


double_countries <- unique(synchrony$Country[synchrony$nn>1])
double_regions <- data_frame(Region= unique(synchrony$SubRegion[synchrony$nn>1]), x=rep(0.5, length(unique(synchrony$SubRegion[synchrony$nn>1]))), y=c(3.2, 5.2, 6.2,7.2,8.2,11.2,12.2, 15.2, 17.2, 20.2,21.2, 22.2))


heat_map_country <- ggplot(data=synchrony %>% 
                             filter(Country %in% double_countries), aes(x=Time, y=interaction(Country, SubRegion)))+
  geom_tile(aes(fill=cut(nn, breaks = 0:3, labels = 1:3)), colour=NA)+
  geom_hline(yintercept = c(3.5, 5.5, 6.5,7.5,8.5,11.5,12.5, 15.5, 17.5, 20.5,21.5),  alpha=0.15, linetype=2)+
  scale_fill_manual(drop=F, values = colorRampPalette(c("yellow", "red"))(3), na.value="grey90")+
  scale_x_discrete(labels=c( "1978-82", "1983-87", "1988-92", "1993-97", "1998-2002", "2003-2007", "2008-2013"))+
  scale_y_discrete(labels=double_countries)+
  theme_bw()+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.background = element_rect(fill="grey91"),
        legend.box.just = "center",
        legend.position = "bottom",
        axis.text.x = element_text(size=8, angle = 35, hjust =1 ),
        axis.text.y = element_text(size=8, face="bold"),
        #axis.ticks.y = element_line(colour = "grey75"),
        axis.ticks.y = element_blank(),
        axis.title = element_text(size=11),
        legend.title = element_text(size=10),
        legend.text = element_text(size=10),
        legend.key.height = unit(0.01, "mm"),
        legend.key.width = unit(1, "cm"),
        plot.margin = unit(c(0.1,0.5,0,-0.2), "cm"))+
  guides(colour=F, fill = guide_legend(title.position = "bottom", title.hjust = 0.5))+
  labs(y="", x=bquote(bold(Year)), fill="No. of sectors")+
  geom_text(data = double_regions, aes(x=x, y=y, label=Region), size=1.75, colour="grey50", hjust=0)+
  
  ggsave("heatmap2.tiff", device = "tiff", dpi=600, width=12, height=15, units = "cm")+
  ggsave("heatmap2.pdf", device = "pdf", dpi=600, width=9, height=12, units = "cm")


legend <-  get_legend(heat_map)

ggarrange(ggarrange(heat_map, heat_map_country, labels=c("a","b"), nrow=1, ncol=2, legend = F), legend, nrow=2, ncol=1, heights = c(1,0.1), font.label = list(size=12)) +
  ggsave("heatmap3.tiff", device="tiff", dpi=600, width = 18, height=15, units="cm")+
  ggsave("heatmap3.pdf", device="pdf", dpi=600, width = 18, height=15, units="cm")


```


#Figure 4 - LAND_SEA SWITCHES OR SYNCHRONIES 


```{r}

legend <- ggplot()+
  scale_x_continuous(limits=c(0,0.5))+
  scale_y_continuous(limits=c(0.2,1))+
  theme(panel.background = element_rect(fill = "transparent", colour="transparent"),
        panel.border = element_rect(fill = "transparent", colour="transparent"),
        plot.background = element_rect(fill = "transparent", colour="transparent"),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank())+
  annotate("segment", x = 0.0, xend = 0.2, y = 0.9, yend = 0.9, colour="firebrick", size=0.8)+
  annotate("segment", x = 0.0, xend = 0.2, y = 0.7, yend = 0.7, colour="black", size=0.8)+
  annotate("segment", x = 0.0, xend = 0.2, y = 0.5, yend = 0.5, colour="dodgerblue", size=0.8)+
  annotate("segment", x = 0.0, xend = 0.2, y = 0.3, yend = 0.3, colour="grey50", size=0.8)+
  annotation_custom(cropimg, xmin = 0.3 ,xmax = 0.5, ymin = 0.8, ymax=1.1)+
  annotation_custom(cowimg, xmin = 0.3 ,xmax = 0.5, ymin = 0.65, ymax=0.8)+
  annotation_custom(fishingimg, xmin = 0.3 ,xmax = 0.5, ymin = 0.38, ymax=0.63)+
  annotation_custom(aquaimg, xmin = 0.3 ,xmax = 0.5, ymin = 0.2, ymax=0.36)+
  # annotate("text", x=0.2, y=0.9, label="Crop production", size=4.9, hjust=0)+
  # annotate("text", x=0.2, y=0.7, label="Livestock production", size=4.9, hjust=0)+
  # annotate("text", x=0.2, y=0.5, label="Fisheries landings", size=4.9, hjust=0)+
  # annotate("text", x=0.2, y=0.3, label="Aquaculture production", size=4.9, hjust=0)+
  ggsave("legend.png", device = "png", dpi=300, width=3, height = 4, units="cm", bg="transparent")


legend <- readPNG("legend.png")
legend <- rasterGrob(legend)


years <- 1961:2013

Dom<-crops[crops$Country=="Dominica" & crops$Item=="Fruit excl Melons,Total",]
Dom<-Dom[,c(4,6)]
Dom$Fisheries <-aggfisheries$Value[aggfisheries$Country=="Dominica"]
Dom$Year <- as.numeric(Dom$Year)







cols2<-c("Fisheries landings" ="dodgerblue", "Crop production"="firebrick", "Livestock production"="black", "Aquaculture production"="grey50")

p9<-ggplot(data = Dom, aes(x=Year))+
  #geom_point(aes(y=(Value-mean(Value))/sd(Value)), colour="firebrick")+
  geom_line(aes(y=(Value-mean(Value))/sd(Value),colour="Crop production"), size=0.7)+
  #geom_point(aes(y=((Fisheries-mean(Fisheries))/sd(Fisheries))), colour="dodgerblue")+
  geom_line(aes(y=((Fisheries-mean(Fisheries))/sd(Fisheries)), colour="Fisheries landings"), size=0.7)+
  scale_x_continuous(limits = c(1960, 1995))+
  scale_y_continuous(limits=c(-2.5, 3.2))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        legend.background = element_blank(),
        legend.position = c(0.27, 0.9), 
        legend.text = element_text(size = 8),
        axis.title = element_text(size=10))+
  #annotate("rect", xmin=1977, xmax=1985, ymin=-1.8, ymax=3, fill="grey", col=NA, alpha=0.2)+
  geom_vline(xintercept = 1979, lty=2)+
  geom_vline(xintercept = 1983, lty=2)+
  annotate("text", x = 1969, y = 1.8, label = "Hurricane David", size=2.7)+
  geom_segment(aes(x = 1976 , y = 1.8 , xend =1978.5 , yend = 1.8), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  #annotate("text", x = 1963, y = 3, label = "bold(Dominica)", size=3, parse=T)+
  annotate("text", x = 1970, y = -2, label = "Stock collapse", size=2.7)+
  geom_segment(aes(x = 1976 , y = -2 , xend =1982.5 , yend = -2), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  labs(y="Normalised production")+
  scale_colour_manual("", values=cols2)+
  guides(colour=F)+
  ggsave("Dominica production.tiff", device = "tiff",dpi = 600, width = 8.9, height = 6, units = "cm")
  
  #annotate("text", x = 1972, y = 1.2, label = "Hurricane David")+

  

  
  
afgfish<-aggfisheries[,c(1,2,6,7)]
afg<-cbind.data.frame(years, aggcrops$Value[aggcrops$Country=="Afghanistan"], agglivestock$Value[agglivestock$Country=="Afghanistan"], afgfish$Value[afgfish$Country=="Afghanistan"])

names(afg)[1]<-"Year"
names(afg)[2]<-"Crops"
names(afg)[3]<-"Livestock"
names(afg)[4]<-"Fisheries"
afg$Year <-as.numeric(afg$Year)

cols2<-c("Fisheries landings" ="dodgerblue", "Crop production"="firebrick", "Livestock production"="black", "Aquaculture production"=="grey50")

p10<-ggplot(data=afg, aes(x=Year))+
  geom_line(aes(y=(Crops-mean(Crops))/sd(Crops), colour="Crop production"), size=0.7)+
  geom_line(aes(y=(Livestock-mean(Livestock))/sd(Livestock), colour="Livestock production"), size=0.7)+
  geom_line(aes(y=(Fisheries-mean(Fisheries))/sd(Fisheries), colour="Fisheries landings"), size=0.7)+
  scale_x_continuous(limits=c(1980, 2013))+
  scale_y_continuous(limits=c(-2.5,3.5))+
  scale_colour_manual("", values = cols2)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        #axis.title.y = element_blank(),
        legend.position = c(0.27, 0.9), 
        legend.text = element_text(size = 8),
        legend.key.size =  unit(4, "mm"),
        legend.background = element_blank())+
  geom_vline(xintercept = 2000, lty=2)+
  labs(y=bquote(Normalised~production))+
  annotate("rect", xmin = 2000, xmax = 2002, fill="ivory3", colour=NA, ymin=-Inf, ymax=Inf, alpha=0.3)+
  #annotate("text", x = 1984, y = 3.2, label = "bold(Afghanistan)", size=3, parse=T)+
  annotate("text", x = 1991.5, y = -2.1, label = "Drought onset", size=2.7)+
  geom_segment(aes(x = 1997 , y = -2.1 , xend =1999.5 , yend = -2.1), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  guides(colour=F)+
  ggsave("Afghan production.tiff", device="tiff", dpi=600, width = 8.9, height = 6, units = "cm")


Kuwait <-  data_frame(Year = 1961:2013, Crops = aggcrops$Value[aggcrops$Country=="Kuwait"], Livestock = agglivestock$Value[agglivestock$Country=="Kuwait"], Fisheries = aggfisheries$Value[aggfisheries$Country=="Kuwait"])

p11 <- 
  ggplot(Kuwait, aes(x=Year))+
  geom_line(aes(y=(Crops-mean(Crops))/sd(Crops), colour="Crop production"), size=0.7)+
  geom_line(aes(y=(Livestock-mean(Livestock))/sd(Livestock), colour="Livestock production"), size=0.7)+
  geom_line(aes(y=(Fisheries-mean(Fisheries))/sd(Fisheries), colour="Fisheries landings"), size=0.7)+
  scale_x_continuous(limits=c(1960,2005))+
  scale_y_continuous()+
  scale_colour_manual("", values = cols2)+
  geom_vline(xintercept = 1991, lty=2)+
  labs(y=bquote(Normalised~production))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        legend.position = c(0.27, 0.9), 
        legend.text = element_text(size = 8),
        legend.key.size =  unit(4, "mm"),
        legend.background = element_blank(),
        axis.title = element_text(size=10))+
  annotate("text", x = 1981.5, y = -1.9, label = "1st Gulf War", size=2.7)+
  geom_segment(aes(x = 1987 , y = -1.9 , xend =1990.5 , yend = -1.9), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  annotation_custom(legend, xmin=1960, xmax = 1972.5, ymin=0.4, ymax = 3.3)+
  guides(colour=F)+
  ggsave("Kuwait production.tiff", device="tiff", dpi=600, width = 8.9, height = 6, units="cm")


cols2<-c("Fisheries landings" ="dodgerblue", "Crop production"="firebrick", "Livestock production"="black", "Aquaculture production"="grey50")

Ecuador <-  data_frame(Year = 1961:2013, Crops = aggcrops$Value[aggcrops$Country=="Ecuador"], Fisheries = aggfisheries$Value[aggfisheries$Country=="Ecuador"], Aquaculture = aggaqua$Value[aggaqua$Country=="Ecuador"])


p12 <- 
  ggplot(Ecuador, aes(x=Year))+
  geom_line(aes(y=(Crops-mean(Crops))/sd(Crops), colour="Crop production"), size=0.7)+
  geom_line(aes(y=(Fisheries-mean(Fisheries))/sd(Fisheries), colour="Fisheries landings"), size=0.7)+
  geom_line(aes(y=(Aquaculture-mean(Aquaculture))/sd(Aquaculture), colour="Aquaculture production"), size=0.7)+
  scale_x_continuous(limits=c(1980,2013))+
  scale_y_continuous()+
  scale_colour_manual("", values = cols2)+
  geom_vline(xintercept = 1998, lty=2)+
  geom_vline(xintercept = 2000, lty=2)+
  labs(y=bquote(Normalised~production))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        #axis.title.y = element_blank(),
        legend.position = c(0.27, 0.9), 
        legend.text = element_text(size = 8),
        legend.key.size =  unit(4, "mm"),
        legend.background = element_blank())+
  guides(colour=F)+
  annotate("text", x = 1991, y = 2.5, label = "ENSO event", size=2.7)+
  annotate("text", x = 2007.5, y = -0.85, label = "White-spot disease\noutbreak", size=2.7)+
  geom_segment(aes(x = 2004 , y = -1.1 , xend =2000.5 , yend = -1.1), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  geom_segment(aes(x = 1995 , y = 2.5 , xend =1997.7 , yend = 2.5), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  ggsave("Ecuador production.tiff", device="tiff", dpi=600, width = 8.9, height = 6, units="cm")




ggarrange(p11,p10, p9,p12, labels=c("a", "b", "c", "d"), ncol=2, nrow = 2, font.label = list(size=12))+
ggsave(filename = "Tradeoffs and synergies2.tiff", device = "tiff", dpi = 600, width=18, height=12, units = "cm")+
ggsave(filename = "Tradeoffs and synergies2.pdf", device = "pdf", dpi = 600, width=18, height=12, units = "cm")


```


#Calculations

```{r}
#Overall shock rates
#crops
nrow(shockdrivers[shockdrivers$Sector=="Crops",])/length(levels(aggcrops$Country))

(nrow(shockdrivers[shockdrivers$Sector=="Crops",])+nrow(shockdrivers[shockdrivers$Sector=="Livestock",]))/(length(levels(aggcrops$Country))+length(levels(agglivestock$Country)))

#livestock
nrow(shockdrivers[shockdrivers$Sector=="Livestock",])/length(levels(agglivestock$Country))

#fisheries
nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])/length(levels(aggfisheries$Country))

(nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])+nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",]))/(length(levels(aggfisheries$Country))+length(levels(aggaqua$Country)))

#aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])/length(levels(aggaqua$Country))


#aquaculture rates in LACa vs nezt nearest
unique(aquacultureSR$Rate[aquacultureSR$Continent=="South America"])/unique(aquacultureSR$Rate[aquacultureSR$Continent=="Central America"])

unique(aquacultureSR$Rate[aquacultureSR$Continent=="South America"])/0.09090909


unique(aquacultureSR$Rate)

#Livestock rates in South Asia vs next highest SSA 
unique(livestockSR$Rate[livestockSR$Continent=="South Asia"])/unique(livestockSR$Rate[livestockSR$Continent=="Africa"])

#crop rates in south asia compared to oceania
unique(cropsSR$Rate[cropsSR$Continent=="South Asia"])/unique(cropsSR$Rate[cropsSR$Continent=="Oceania"])

unique(fisheriesSR$Rate[fisheriesSR$Continent=="Europe and Central Asia"])/unique(fisheriesSR$Rate[fisheriesSR$Continent=="South Asia"])



nrow(shockdrivers)

mean(c(0.3031915,0.2722513))

mean(c(0.3118812,0.2227723))

#Contribution of climate to crop shocks
nrow(shockdrivers[shockdrivers$Sector=="Crops" & (shockdrivers$Category=="Climate/weather & geopolitical/economic events"| shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Crops",])




#Contribution of climate to livestock shocks
nrow(shockdrivers[shockdrivers$Sector=="Livestock" & (shockdrivers$Category=="Climate/weather & geopolitical/economic events"| shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Livestock",])

#Contribution of geopolitical to livestock shocks
nrow(shockdrivers[shockdrivers$Sector=="Livestock" & (shockdrivers$Category=="Climate/weather & geopolitical/economic events"| shockdrivers$Category=="Geopolitical/economic events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Livestock",])

nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Category=="Other",])/ nrow(shockdrivers[shockdrivers$Sector=="Livestock",])

##Contribution of overfishing to fisheries
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Mismanagement & geopolitical/economic events"| shockdrivers$Category=="Mismanagement & policy change"| shockdrivers$Category=="Mismanagement"| shockdrivers$Category=="Climate/weather events & mismanagement"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contribution to overfishing of policy change
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Policy change"| shockdrivers$Category=="Mismanagement & policy change"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contribution of geopolitical to fisheries
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Mismanagement & geopolitical/economic events"| shockdrivers$Category=="Geopolitical/economic events"| shockdrivers$Category=="Climate/weather & geopolitical/economic events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contibution of extreme events
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Climate/weather events & mismanagement"| shockdrivers$Category==""| shockdrivers$Category=="Climate/weather & geopolitical/economic events" | shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contibution of policy change
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Mismanagement & policy change"| shockdrivers$Category==""| shockdrivers$Category=="Policy change"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])


#contibution of extreme events to aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & (shockdrivers$Category=="Climate/weather events & mismanagement"| shockdrivers$Category==""| shockdrivers$Category=="Climate/weather & geopolitical/economic events" | shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])

#contibution of disease to aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & (shockdrivers$Category=="Other"),])/ nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])

#contribution of geopolitical to aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & (shockdrivers$Category=="Geopolitical/economic events"| shockdrivers$Category=="Mismanagement & geopolitical/economic events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])


ggplot(data=shockdrivers, aes(x=Category, y=log(AbsMagnitude)))+geom_boxplot()+geom_jitter(aes(size=Recovery, colour=Sector, alpha=0.5))

shockdrivers2 %>% 
  filter(Sector=="Crops") %>% 
  group_by(SubRegion, Category) %>% 
  count()



levels(shockdrivers$Category)

order(-cropssh$AbsMagnitude)

cropssh[c(38, 24, 4, 15, 53, 14, 25, 16, 48, 44, 26, 32, 13),]

mean(cropssh$AbsMagnitude[cropssh$Region=="East Asia and Pacific"])#1862453
mean(cropssh$AbsMagnitude[cropssh$Region=="SSA"])#2117651
mean(cropssh$AbsMagnitude[cropssh$Region=="MENA"])#1864970
mean(cropssh$AbsMagnitude[cropssh$Region=="LACa"])#395462.7
mean(cropssh$AbsMagnitude[cropssh$Region=="North America"])#1017
mean(cropssh$AbsMagnitude[cropssh$Region=="EuCA"])#2681218
mean(cropssh$AbsMagnitude[cropssh$Region=="South Asia"])#3118316


mean(livestocksh$AbsMagnitude[livestocksh$Region=="East Asia and Pacific"])#100295
mean(livestocksh$AbsMagnitude[livestocksh$Region=="SSA"])#90646
mean(livestocksh$AbsMagnitude[livestocksh$Region=="MENA"])#246161.5
mean(livestocksh$AbsMagnitude[livestocksh$Region=="LACa"])#360623.4
mean(livestocksh$AbsMagnitude[livestocksh$Region=="North America"])#1017
mean(livestocksh$AbsMagnitude[livestocksh$Region=="EuCA"])#1326228
mean(livestocksh$AbsMagnitude[livestocksh$Region=="South Asia"])#86147.6

mean(livestocksh$AbsMagnitude[livestocksh$Region=="EuCA"])/mean(livestocksh$AbsMagnitude[livestocksh$Region=="LACa"])

#shock rates in aquaculture 
aquacultureSR
0.4594595/ 0.2222222
0.3750000/0.2222222

mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="East Asia and Pacific"])#44213.24
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="SSA"])#278.025
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="MENA"])#939.5833
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="LACa"])#3916.003
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="North America"])#1017
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="EuCA"])#26710.83
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="South Asia"])#2179

# % of food production with unknown aquaculture shocks

#Austria 874 tonnes in 1990
874/sum(aggcrops$Value[aggcrops$Country=="Austria" & aggcrops$Year==1990],
agglivestock$Value[agglivestock$Country=="Austria" & agglivestock$Year==1990],
aggfisheries$Value[aggfisheries$Country=="Austria" & aggfisheries$Year==1990],
aggaqua$Value[aggaqua$Country=="Austria" & aggaqua$Year==1990])


#Bahrain 0.5 t in 2001 
0.5/sum(aggcrops$Value[aggcrops$Country=="Bahrain" & aggcrops$Year==2001],
agglivestock$Value[agglivestock$Country=="Bahrain" & agglivestock$Year==2001],
aggfisheries$Value[aggfisheries$Country=="Bahrain" & aggfisheries$Year==2001],
aggaqua$Value[aggaqua$Country=="Bahrain" & aggaqua$Year==2001])


#Burundi 2010 32.7 T 

32.7/sum(aggcrops$Value[aggcrops$Country=="Burundi" & aggcrops$Year==2010],
agglivestock$Value[agglivestock$Country=="Burundi" & agglivestock$Year==2010],
aggfisheries$Value[aggfisheries$Country=="Burundi" & aggfisheries$Year==2010],
aggaqua$Value[aggaqua$Country=="Burundi" & aggaqua$Year==2010])

#Guadeloupe 2005 9.6 T
9.6/sum(aggcrops$Value[aggcrops$Country=="Guadeloupe" & aggcrops$Year==2005],
agglivestock$Value[agglivestock$Country=="Guadeloupe" & agglivestock$Year==2005],
aggfisheries$Value[aggfisheries$Country=="Guadeloupe" & aggfisheries$Year==2005],
aggaqua$Value[aggaqua$Country=="Guadeloupe" & aggaqua$Year==2005])


#Guam 60.5T in 2003

60.5/sum(aggcrops$Value[aggcrops$Country=="Guam" & aggcrops$Year==2003],
agglivestock$Value[agglivestock$Country=="Guam" & agglivestock$Year==2003],
aggfisheries$Value[aggfisheries$Country=="Guam" & aggfisheries$Year==2003],
aggaqua$Value[aggaqua$Country=="Guam" & aggaqua$Year==2003])

#Guyana 2008 316 T 
316/sum(aggcrops$Value[aggcrops$Country=="Guyana" & aggcrops$Year==2008],
agglivestock$Value[agglivestock$Country=="Guyana" & agglivestock$Year==2008],
aggfisheries$Value[aggfisheries$Country=="Guyana" & aggfisheries$Year==2008],
aggaqua$Value[aggaqua$Country=="Guyana" & aggaqua$Year==2008])

#Guyana 2009 97.04 T
97.04/sum(aggcrops$Value[aggcrops$Country=="Guyana" & aggcrops$Year==2009],
agglivestock$Value[agglivestock$Country=="Guyana" & agglivestock$Year==2009],
aggfisheries$Value[aggfisheries$Country=="Guyana" & aggfisheries$Year==2009],
aggaqua$Value[aggaqua$Country=="Guyana" & aggaqua$Year==2009])

#Jamaica 2003 581T

581/sum(aggcrops$Value[aggcrops$Country=="Jamaica" & aggcrops$Year==2009],
agglivestock$Value[agglivestock$Country=="Jamaica" & agglivestock$Year==2009],
aggfisheries$Value[aggfisheries$Country=="Jamaica" & aggfisheries$Year==2009],
aggaqua$Value[aggaqua$Country=="Jamaica" & aggaqua$Year==2009])

#Jordan 2004 28T 
28/sum(aggcrops$Value[aggcrops$Country=="Jordan" & aggcrops$Year==2004],
agglivestock$Value[agglivestock$Country=="Jordan" & agglivestock$Year==2004],
aggfisheries$Value[aggfisheries$Country=="Jordan" & aggfisheries$Year==2004],
aggaqua$Value[aggaqua$Country=="Jordan" & aggaqua$Year==2004])

#Saint Lucia 2000 10T
10/sum(aggcrops$Value[aggcrops$Country=="Saint Lucia" & aggcrops$Year==2009],
agglivestock$Value[agglivestock$Country=="Saint Lucia" & agglivestock$Year==2009],
aggfisheries$Value[aggfisheries$Country=="Saint Lucia" & aggfisheries$Year==2009],
aggaqua$Value[aggaqua$Country=="Saint Lucia" & aggaqua$Year==2009])


# Singapore 524T 2007 
524/sum(aggcrops$Value[aggcrops$Country=="Singapore" & aggcrops$Year==2007],
agglivestock$Value[agglivestock$Country=="Singapore" & agglivestock$Year==2007],
aggfisheries$Value[aggfisheries$Country=="Singapore" & aggfisheries$Year==2007],
aggaqua$Value[aggaqua$Country=="Singapore" & aggaqua$Year==2007])

#South Africa 1318 T in 2001
1318/sum(aggcrops$Value[aggcrops$Country=="South Africa" & aggcrops$Year==2001],
agglivestock$Value[agglivestock$Country=="South Africa" & agglivestock$Year==2001],
aggfisheries$Value[aggfisheries$Country=="South Africa" & aggfisheries$Year==2001],
aggaqua$Value[aggaqua$Country=="South Africa" & aggaqua$Year==2001])


```




#Supplementary Figure 1 - Shock size and recovery
```{r}

#load data
shocks_df <- shockdrivers


#refine the Category names so they plot in a nicer way (with newlines and abbreviations)
shocks_df$Cat_key <- case_when(
  shocks_df$Category == "Climate/weather events" ~ "Clim.", 
  shocks_df$Category == "Climate/weather & geopolitical/economic events" ~ "Clim./Geo.Eco.", 
  shocks_df$Category == "Climate/weather events & mismanagement" ~ "Clim./Mismngt.", 
  shocks_df$Category == "Geopolitical/economic events" ~ "Geo.Eco.", 
  shocks_df$Category == "Mismanagement & geopolitical/economic events" ~ "Mismngt./Geo.Eco.", 
  shocks_df$Category == "Mismanagement" ~ "Mismngt.", 
  shocks_df$Category == "Mismanagement & policy change" ~ "Mismngt./Pol.Chng.", 
  shocks_df$Category == "Policy change" ~ "Pol.Chng.", 
  shocks_df$Category == "Other" ~ "Other", 
  shocks_df$Category == "Unknown" ~ "Unknown"
)
shocks_df$Cat_key <- factor(shocks_df$Cat_key, levels = c("Clim.", "Clim./Mismngt.", "Clim./Geo.Eco.", "Geo.Eco.","Mismngt./Geo.Eco.","Mismngt.", "Mismngt./Pol.Chng.","Pol.Chng.","Other","Unknown"))
shocks_df$Category <- factor(shocks_df$Category, levels = c(
  "Climate/weather events", "Climate/weather events & mismanagement", "Climate/weather & geopolitical/economic events", 
  "Geopolitical/economic events", "Mismanagement & geopolitical/economic events", "Mismanagement", "Mismanagement & policy change", "Policy change", "Other", "Unknown"
  )
  )

#refine the Region names so they plot in a nicer way (with newlines and abbreviations)
shocks_df$Reg_key <- case_when(
  shocks_df$Region == "North America" ~ "N. America", 
  shocks_df$Region == "LACa" ~ "L. America &\nCaribbean", 
  shocks_df$Region == "EuCA" ~ "Europe &\nC. Asia", 
  shocks_df$Region == "MENA" ~ "Middle East\n&N. Africa",
  shocks_df$Region == "SSA" ~ "Sub-Sah.\nAfrica", 
  shocks_df$Region == "Oceania" ~ "Oceania", 
  shocks_df$Region == "South Asia" ~ "S. Asia", 
  shocks_df$Region == "East Asia" ~ "E. Asia"
)
shocks_df$Reg_key <- factor(shocks_df$Reg_key, levels = c("N. America", "L. America &\nCaribbean","Europe &\nC. Asia", "Middle East\n&N. Africa", "Sub-Sah.\nAfrica", "S. Asia", "E. Asia", "Oceania"))

Category_cols <- cols<-c("Climate/weather events"="#9e0142", "Climate/weather events & mismanagement" = "#d53e4f", "Climate/weather & geopolitical/economic events" = "#f46d43", "Geopolitical/economic events" = "#fdae61", "Mismanagement & geopolitical/economic events" = "#fee08b","Mismanagement" = "#e6f598",  "Mismanagement & policy change" = "#abdda4", "Policy change" = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")
Cat_key_cols <- cols<-c("Clim."="#9e0142", "Clim./Mismngt." = "#d53e4f", "Clim./Geo.Eco." = "#f46d43", "Geo.Eco." = "#fdae61", "Mismngt./Geo.Eco." = "#fee08b","Mismngt." = "#e6f598",  "Mismngt./Pol.Chng." = "#abdda4", "Pol.Chng." = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")
# set region colours
Region_cols <- rep(c("grey90", "grey70"), 4) #RColorBrewer::brewer.pal(name = "Pastel2", n=8)
names(Region_cols) <- rev(c("N. America", "L. America &\nCaribbean","Europe &\nC. Asia", "Middle East\n&N. Africa", "Sub-Sah.\nAfrica", "S. Asia", "E. Asia", "Oceania"))
#combine category and region colours into a single names list of colours for use in the plot
target_cols <- c(Region_cols, Cat_key_cols)

#do each plot for each sector.
for(target_sector in unique(shocks_df$Sector)){
#for(target_sector in "Crops"){
  sector_shocks <- filter(shocks_df, Sector == target_sector)
  sector_shocks$AbsMagnitude <- sector_shocks$AbsMagnitude/1000000
  sector_shocks$Recovery_transparency <- case_when(
    sector_shocks$Recovery2 < 8 ~ 0.3, 
    sector_shocks$Recovery2 > 7 & sector_shocks$Recovery2 < 16 ~ 0.6,
    sector_shocks$Recovery2 > 15 ~ 0.9
  )
  figure_filename <- sprintf("C:/Users/rsc2/Documents/github/shocks/For submission/rich-cotrell-paper-%s.png", target_sector)
  #png(file=figure_filename, width=183/2, height=210/2,units="mm", res=100)
  figure_filename <- sprintf("C:/Users/rsc2/Documents/github/shocks/For submission/rich-cotrell-paper-%s.pdf", target_sector)
  pdf(file=figure_filename, width=(183*0.0393700787), height=(183*0.0393700787)) #convert mm to inches by mm*0.0393700787
  chordDiagram(
    x= sector_shocks[,c("Cat_key", "Reg_key", "AbsMagnitude")],
    annotationTrack = "grid", symmetric = TRUE, preAllocateTracks = 1.5,
    grid.col = target_cols, col = alpha.col(Cat_key_cols[sector_shocks$Cat_key], sector_shocks$Recovery_transparency), order = names(target_cols)
    )
  circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
      xlim = get.cell.meta.data("xlim")
      ylim = get.cell.meta.data("ylim")
      sector.name = get.cell.meta.data("sector.index")
      circos.text(mean(xlim), ylim[1] + 0.1, sector.name, facing = "clockwise", niceFacing = TRUE, cex=0.8)
      #circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "bending.outside", niceFacing = TRUE, adj = c(0, 0))
      circos.axis(h = "top", labels.cex = 0.8, major.tick.percentage = 0.2, sector.index = sector.name, track.index = 2)
    }, bg.border = NA)
  dev.off()
  
 # if(target_sector == "Crops"){
  #   png()
  #   plot(
  #     x=rep(1:length(Cat_key_cols), each=5), y=rep(1:length(Cat_key_cols), 5), 
  #     pch=19,
  #     col=plot3d::alpha.col(rep(Cat_key_cols, each=5), rep(seq(0.1,0.5, by=0.1), 5))
  # })
}#close for target_sector

#create legend
nx <- sort(unique(sector_shocks$Recovery_transparency))
ny <- rev(1:length(unique(shocks_df$Category)))
legend_dots <- data.frame(
  x = rep((1:length(nx)), length(ny) ), 
  y = rep(ny, each=length(nx)), 
  cols = alpha.col(rep(Cat_key_cols,each=length(nx)),  rep(nx, length(ny) )), 
  stringsAsFactors = FALSE
)
pdf(file="C:/Users/rsc2/Documents/github/shocks/For submission/rich-cotrell-paper-figure-legend.pdf", width=183*0.0393700787, height=70*0.0393700787)
  par(mar=c(0,0,0,0))
  plot(legend_dots$x, legend_dots$y, col=legend_dots$cols, pch=19, cex=3.8, xlim=c(0,17), ylim=c(0,12), xaxt='n', yaxt='n', ann=FALSE, bty="n")
  text(x = rep(7,length(levels(shocks_df$Cat_key))) , y=ny, labels=levels(shocks_df$Category), pos=4, cex=0.8)
  text(x = 1:length(nx), y=rep(12, length(nx)), labels=c("1-7", "8-15", ">15"), cex=0.8)
dev.off()





```


#Supplementary Figure 3 - Method figure

```{r}
(method1<-ggplot(data=agglivestock[agglivestock$Country=="Germany",], aes(x=Year, y=Value))+geom_point()+stat_smooth(method="loess", level=0, span=0.6, colour="dodgerblue")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=11))+
   labs(x="Year", y=bquote(Production~(tonnes~x10^7)))+
   scale_y_continuous(labels = seq(3, 5.5, by=0.5), breaks = seq(3e+07, 5.5e+07, by=0.5e+07))+
   scale_x_continuous(labels=seq(1960, 2015, by=10), breaks = seq(1960, 2015, by=10)))

fit<-loess(Value~Year, data = agglivestock[agglivestock$Country=="Germany",], span=0.6)
Resids<-data.frame(Residuals=resid(fit)[2:53], lag1=resid(fit)[1:52])

(method2<-ggplot(data=Resids, aes(x=Residuals, y=lag1))+geom_point()+
  stat_smooth(method="lm", level=0, colour="dodgerblue")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=11))+
    labs(x=bquote(Residuals~(tonnes~x10^6)), y=bquote(Residuals[t-1]~(tonnes~x10^6)))+
    scale_x_continuous(breaks = seq(-3e+06, 3e+06, by=1e+06), labels = seq(-3, 3, by=1))+
    scale_y_continuous(breaks = seq(-3e+06, 3e+06, by=1e+06), labels = seq(-3, 3, by=1)))

fit2<-lm(Resids$Residuals~Resids$lag1)
Resids$CooksD <- cooks.distance(fit2)

(method3<-ggplot(data=Resids, aes(x=1:52, y=CooksD))+geom_point()+geom_line()+
  geom_hline(yintercept = 0.3, colour="firebrick", lty=2)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=11))+
  labs(x="Index", y="Cook's Distance"))


ggpubr::ggarrange(method1, method2, method3, nrow = 3, ncol=1, align="h", labels=c("a", "b", "c"))

ggplot2::ggsave(filename = "Methods.pdf", device=pdf, dpi=600, height = 8, width=7, scale=1.3)
ggplot2::ggsave(filename = "Methods.tiff", device="tiff", dpi=600, height = 8, width=7, units="in", scale=1.1)

```


