---
title: "Shock Analysis Tidy"
author: "Richard Cottrell"
date: "27 December 2017"
output: html_document
---

###LIBRARIES

```{r}

library(plyr) # manipulation of data formatting
library(dplyr) # maniuplation of data formatting
library(sp) #spatial tool
library(spatial)
library(classInt)
#library(rworldmap) #if not using ggplot
library(RColorBrewer) #Color Brew Palettes
library(mapproj)
library(sf)#shapefile reading
library(ggalt)
library(ggplot2) #plotting
library(rgdal) 
library(ggmap)#creating ggmaps
library(devtools)
library(ggpubr) #for using the ggarrange function (displaying composite ggplots)
library(tidyr)#switching from wide to long format
library(zoo)# moving average functions 
library(countrycode) #adding countrycodes to data
library(colorspace) #adding colour palettes for plots
library(mgcv) #gams
library(car) # linear models
library(ggrepel) #ggrepel labels on point chart
library(fANCOVA) #loess span fit function 
library(forecast)
library(earlywarnings)
library(Kendall)
library(png)
library(grid) 
library(readr)
library(plot3D)
library(circlize)


```

## IMPORTING RAW PRODUCTION DATA 

```{r}

#CROP PRODUCTION DATA

cropsfull<-read.csv("Production_Crops_E_All_Data_(Norm).csv")
names(cropsfull)
crops<-cropsfull[,c(2, 4, 6, 8:11)]
head(crops)
rm(cropsfull)

#Assign country codes
crops$Codes<-countrycode(crops$Country, "country.name", "iso3c", warn=T)
summary(crops)

crops<-crops[!is.na(crops$Codes),]
summary(crops)

#select only totals and Production quantity
crops<-crops[grep("Total",crops$Item),]
crops<-crops[crops$Element=="Production",]
summary(crops)

table(crops$Country) #check that continents and no code countries have zero for value

#remove NA values from values column
crops<-crops[!is.na(crops$Value),]
summary(crops)

write.csv(crops, file = "croptotals.csv", row.names = F)

crops<-read.csv("croptotals.csv", header = T)

names(crops)
levels(crops$Country)

#create aggregate production for crops
years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(crops$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(crops$Value, crops$Country==levels(crops$Country)[i]& crops$Year==years[j]))))
  }
}

##Country and Year columns
Country<-rep(levels(crops$Country), 1, each=length(years))
Year<-rep(years, length(levels(crops$Country)))

##New data frame 
aggcrops<-cbind.data.frame(Country, Year, Total)


pdf(file="Crops - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(aggcrops$Country))){
  values<-subset(aggcrops$Total, aggcrops$Country==levels(aggcrops$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggcrops$Country)[i], pch=20, cex=0.75)
  }
dev.off()


#aggregate remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 36 countries removed for crops
# crops<- crops[crops$Country!="Armenia",]
# crops<- crops[crops$Country!="Azerbaijan",]
# crops<- crops[crops$Country!="Belarus",]
# crops<- crops[crops$Country!="Belgium",]
# crops<- crops[crops$Country!="Bosnia and Herzegovina",]
# crops<- crops[crops$Country!="Croatia",]
# crops<- crops[crops$Country!="Czech Republic",]
# crops<- crops[crops$Country!="Czechoslovakia",]
# crops<- crops[crops$Country!="Eritrea",]
# crops<- crops[crops$Country!="Estonia",]
# crops<- crops[crops$Country!="Ethiopia",]
# crops<- crops[crops$Country!="Ethiopia PDR",]
# crops<- crops[crops$Country!="Georgia",]
# crops<- crops[crops$Country!="Kazakhstan",]
# crops<- crops[crops$Country!="Kyrgyzstan",]
# crops<- crops[crops$Country!="Latvia",]
# crops<- crops[crops$Country!="Lithuania",]
# crops<- crops[crops$Country!="Luxembourg",]
# crops<- crops[crops$Country!="Micronesia (Federated States of)",]
# crops<- crops[crops$Country!="Montenegro",]
# crops<- crops[crops$Country!="Occupied Palestinian Territory",]
# crops<- crops[crops$Country!="Republic of Moldova",]
# crops<- crops[crops$Country!="Russian Federation",]
# crops<- crops[crops$Country!="Saint Pierre and Miquelon",]
# crops<- crops[crops$Country!="Serbia",]
# crops<- crops[crops$Country!="Slovakia",]
# crops<- crops[crops$Country!="Slovenia",]
# crops<- crops[crops$Country!="South Sudan",]
# crops<- crops[crops$Country!="Sudan",]
# crops<- crops[crops$Country!="Sudan (former)",]
# crops<- crops[crops$Country!="Tajikistan",]
# crops<- crops[crops$Country!="The former Yugoslav Republic of Macedonia",]
# crops<- crops[crops$Country!="Turkmenistan",]
# crops<- crops[crops$Country!="Ukraine",]
# crops<- crops[crops$Country!="USSR",]
# crops<- crops[crops$Country!="Uzbekistan",]

#INclude Soviet, Yugoslav, Sudanese as former states

#USSR
levels(crops$Country)[levels(crops$Country)=="Armenia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Azerbaijan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Belarus"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Estonia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Georgia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Kazakhstan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Latvia"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Lithuania"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Republic of Moldova"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Russian Federation"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Tajikistan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Turkmenistan"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Ukraine"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="USSR"] <- "Former USSR"
levels(crops$Country)[levels(crops$Country)=="Uzbekistan"] <- "Former USSR"


#Yugoslav states
levels(crops$Country)[levels(crops$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="The former Yugoslav Republic of Macedonia"] <- "Former Yugoslav SFR"
levels(crops$Country)[levels(crops$Country)=="Yugoslav SFR"] <- "Former Yugoslav SFR"



#Former Czechslovakia
levels(crops$Country)[levels(crops$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(crops$Country)[levels(crops$Country)=="Czech Republic"] <- "Former Czechoslovakia"
levels(crops$Country)[levels(crops$Country)=="Slovakia"] <- "Former Czechoslovakia"


#Former Sudan
levels(crops$Country)[levels(crops$Country)=="Sudan"] <- "Former Sudan"
levels(crops$Country)[levels(crops$Country)=="South Sudan"] <- "Former Sudan"
levels(crops$Country)[levels(crops$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(crops$Country)[levels(crops$Country)=="Eritrea"] <- "Former Ethiopia"
levels(crops$Country)[levels(crops$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(crops$Country)[levels(crops$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(crops$Country)[levels(crops$Country)=="Luxembourg"] <-"Belgium"

#remove partial data stes 
crops<- crops[crops$Country!="Occupied Palestinian Territory",]
crops<- crops[crops$Country!="Micronesia (Federated States of)",]
crops<- crops[crops$Country!="China",]


crops <- crops[crops$Year!=2014,]
crops<- crops[,c(1:7)]


write.csv(crops, file="Crop Production 1961-2013.csv", row.names = FALSE)





##LIVESTOCK DATA

livestockfull<-read.csv("Production_LivestockPrimary_E_All_Data_(Norm).csv")
names(livestockfull)
livestock<-livestockfull[,c(2, 4, 6, 8:11)]
head(livestock)
rm(livestockfull)

#add country codes
livestock$Codes<-countrycode(livestock$Country, "country.name", "iso3c", warn=T)
summary(livestock)

livestock<-livestock[!is.na(livestock$Codes),]
summary(livestock)

#only use total production
#levels(livestock$Item)[levels(livestock$Item)=="Meat indigenous, total"] <- "Meat indigenous, Total"

#reduce to totals and production
livestock<-livestock[grep("Total",livestock$Item),]
livestock<-livestock[livestock$Element=="Production",]

table(livestock$Country)
summary(livestock)

write.csv(livestock, file = "livestocktotals.csv", row.names = F)

livestock<-read.csv("livestocktotals.csv", header = T)

#aggregate production
names(livestock)

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(livestock$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(livestock$Value, livestock$Country==levels(livestock$Country)[i]& livestock$Year==years[j]))))
  }
}

##Country and Year columns
Country<-rep(levels(livestock$Country), 1, each=length(years))
Year<-rep(years, length(levels(livestock$Country)))

##New data frame 
agglivestock<-cbind.data.frame(Country, Year, Total)


pdf(file="Livestock - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(agglivestock$Country))){
  values<-subset(agglivestock$Total, agglivestock$Country==levels(agglivestock$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agglivestock$Country)[i], pch=20, cex=0.75)
  }
dev.off()


#remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 32 removed for livestock
# livestock<- livestock[livestock$Country!="Armenia",]
# livestock<- livestock[livestock$Country!="Azerbaijan",]
# livestock<- livestock[livestock$Country!="Belarus",]
# livestock<- livestock[livestock$Country!="Belgium",]
# livestock<- livestock[livestock$Country!="Bosnia and Herzegovina",]
# livestock<- livestock[livestock$Country!="Croatia",]
# livestock<- livestock[livestock$Country!="Czech Republic",]
# livestock<- livestock[livestock$Country!="Czechoslovakia",]
# livestock<- livestock[livestock$Country!="Eritrea",]
# livestock<- livestock[livestock$Country!="Estonia",]
# livestock<- livestock[livestock$Country!="Ethiopia",]
# livestock<- livestock[livestock$Country!="Ethiopia PDR",]
# livestock<- livestock[livestock$Country!="Georgia",]
# livestock<- livestock[livestock$Country!="Kazakhstan",]
# livestock<- livestock[livestock$Country!="Kyrgyzstan",]
# livestock<- livestock[livestock$Country!="Latvia",]
# livestock<- livestock[livestock$Country!="Lithuania",]
# livestock<- livestock[livestock$Country!="Luxembourg",]
# livestock<- livestock[livestock$Country!="Micronesia (Federated States of)",]
# livestock<- livestock[livestock$Country!="Montenegro",]
# livestock<- livestock[livestock$Country!="Occupied Palestinian Territory",]
# livestock<- livestock[livestock$Country!="Republic of Moldova",]
# livestock<- livestock[livestock$Country!="Russian Federation",]
# livestock<- livestock[livestock$Country!="Serbia",]
# livestock<- livestock[livestock$Country!="Slovakia",]
# livestock<- livestock[livestock$Country!="Slovenia",]
# livestock<- livestock[livestock$Country!="South Sudan",]
# livestock<- livestock[livestock$Country!="Tajikistan",]
# livestock<- livestock[livestock$Country!="The former Yugoslav Republic of Macedonia",]
# livestock<- livestock[livestock$Country!="Turkmenistan",]
# livestock<- livestock[livestock$Country!="Ukraine",]
# livestock<- livestock[livestock$Country!="USSR",]
# livestock<- livestock[livestock$Country!="Uzbekistan",]


#INclude Soviet, Yugoslav, Sudanese as former states

#USSR
levels(livestock$Country)[levels(livestock$Country)=="Armenia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Azerbaijan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Belarus"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Estonia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Georgia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Kazakhstan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Latvia"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Lithuania"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Republic of Moldova"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Russian Federation"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Tajikistan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Turkmenistan"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Ukraine"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="USSR"] <- "Former USSR"
levels(livestock$Country)[levels(livestock$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(livestock$Country)[levels(livestock$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="The former Yugoslav Republic of Macedonia"] <- "Former Yugoslav SFR"
levels(livestock$Country)[levels(livestock$Country)=="Yugoslav SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(livestock$Country)[levels(livestock$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(livestock$Country)[levels(livestock$Country)=="Czech Republic"] <- "Former Czechoslovakia"
levels(livestock$Country)[levels(livestock$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(livestock$Country)[levels(livestock$Country)=="Sudan"] <- "Former Sudan"
levels(livestock$Country)[levels(livestock$Country)=="South Sudan"] <- "Former Sudan"
levels(livestock$Country)[levels(livestock$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(livestock$Country)[levels(livestock$Country)=="Eritrea"] <- "Former Ethiopia"
levels(livestock$Country)[levels(livestock$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(livestock$Country)[levels(livestock$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(livestock$Country)[levels(livestock$Country)=="Luxembourg"] <-"Belgium"

#remove partial data stes 
livestock<- livestock[livestock$Country!="Occupied Palestinian Territory",]
livestock<- livestock[livestock$Country!="Micronesia (Federated States of)",]
livestock<- livestock[livestock$Country!="China",]

livestock <- livestock[livestock$Year!=2014,]
livestock <- livestock[, c(1:7)]

write.csv(livestock, file="Livestock Production 1961-2013.csv", row.names = FALSE)





##MARINE FISHERIES DATA

fisheries<-read.csv("Adjusted Fisheries landings.csv")
summary(fisheries)
levels(fisheries$CountryName)

#replace space in country name strings
for (i in 1:length(levels(fisheries$CountryName))){
  levels(fisheries$CountryName)[i]<-trimws(levels(fisheries$CountryName)[i], which="right")
}
levels(fisheries$CountryName)

#replace space in taxon name
for (i in 1:length(levels(fisheries$TaxonName))){
  levels(fisheries$TaxonName)[i]<-trimws(levels(fisheries$TaxonName)[i], which="right")
}
levels(fisheries$TaxonName)

#replace space in common name
for (i in 1:length(levels(fisheries$CommonName))){
  levels(fisheries$CommonName)[i]<-trimws(levels(fisheries$CommonName)[i], which="right")
}
levels(fisheries$CommonName)

#replace space in functional name
for (i in 1:length(levels(fisheries$FunctionalName))){
  levels(fisheries$FunctionalName)[i]<-trimws(levels(fisheries$FunctionalName)[i], which="right")
}
levels(fisheries$FunctionalName)


##replace space in ISSCAAPName
for (i in 1:length(levels(fisheries$ISSCAAPName))){
  levels(fisheries$ISSCAAPName)[i]<-trimws(levels(fisheries$ISSCAAPName)[i], which="right")
}
levels(fisheries$ISSCAAPName)

names(fisheries)
summary(fisheries)

#total landings
fisheries$Value <- fisheries$LSFT + fisheries$SSFT +fisheries$IUUT

#codes 
fisheries$Codes <- countrycode(fisheries$CountryName, origin = "country.name", destination = "iso3c", warn = T)


#Change a few of the names to correct the codes
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Amer Samoa"] <- "American Samoa"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Br Ind Oc Tr"] <- "British Indian Ocean Territory"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Br Virgin Is"] <- "British Virgin Islands"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Channel Is"] <- "Channel Islands"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Dominican Rp"] <- "Dominican Republic"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Fr Guiana"] <- "French Guiana"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Fr Polynesia"] <- "French Polynesia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="NethAntilles"] <- "Netherlands Antilles"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="St Pier Mq"] <- "Saint Pierre and Miquelon"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Untd Arab Em"] <- "United Arab Emirates"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="US Virgin Is"] <- "United States Virgin Islands"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="UK"] <- "United Kingdom"

#remove previous codes and repeat
fisheries <- fisheries[,(1:14)]
fisheries$Codes <- countrycode(fisheries$CountryName, origin = "country.name", destination = "iso3c", warn = T)

fisheries <- fisheries[!is.na(fisheries$Codes),]

write.csv(fisheries, file="fisheries - Watson adjusted landings 1950-2014 new.csv", row.names = F)

fisheries <- read.csv("fisheries - Watson adjusted landings 1950-2014 new.csv", header=T)



#aggregate production
names(fisheries)

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(fisheries$CountryName))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(fisheries$Value, fisheries$CountryName==levels(fisheries$CountryName)[i]& fisheries$Year==years[j]))))
  }
}

##Country and Year columns
Country<-rep(levels(fisheries$CountryName), 1, each=length(years))
Year<-rep(years, length(levels(fisheries$CountryName)))

##New data frame 
aggmarinefisheries<-cbind.data.frame(Country, Year, Total)


pdf(file="Marine fisheries - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(aggmarinefisheries$Country))){
  values<-subset(aggmarinefisheries$Total, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Landings (tonnes)", main=levels(aggmarinefisheries$Country)[i], pch=20, cex=0.75)
  }
dev.off()


# #remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 18 countries removed for marine fisheries
# 
# fisheries <- fisheries[fisheries$CountryName!="Bosnia Herzg",]
# fisheries <- fisheries[fisheries$CountryName!="Croatia",]
# fisheries <- fisheries[fisheries$CountryName!="Estonia",]
# fisheries <- fisheries[fisheries$CountryName!="Ethiopia",]
# fisheries <- fisheries[fisheries$CountryName!="Former USSR",]
# fisheries <- fisheries[fisheries$CountryName!="Georgia",]
# fisheries <- fisheries[fisheries$CountryName!="Gibraltar",]
# fisheries <- fisheries[fisheries$CountryName!="Latvia",]
# fisheries <- fisheries[fisheries$CountryName!="Lithuania",]
# fisheries <- fisheries[fisheries$CountryName!="Monaco",]
# fisheries <- fisheries[fisheries$CountryName!="Montenegro",]
# fisheries <- fisheries[fisheries$CountryName!="Norfolk I.",]
# fisheries <- fisheries[fisheries$CountryName!="Russian Fed",]
# fisheries <- fisheries[fisheries$CountryName!="Serbia",]
# fisheries <- fisheries[fisheries$CountryName!="Slovenia",]
# fisheries <- fisheries[fisheries$CountryName!="Timor Leste",]
# fisheries <- fisheries[fisheries$CountryName!="Tuvalu",]
# fisheries <- fisheries[fisheries$CountryName!="Ukraine",]
# fisheries <- fisheries[fisheries$CountryName!="Yugoslavia",]


#USSR
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Armenia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Azerbaijan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Belarus"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Estonia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Georgia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Kazakhstan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Kyrgyzstan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Latvia"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Lithuania"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Republic of Moldova"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Russian Fed"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Tajikistan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Turkmenistan"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Ukraine"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Former USSR"] <- "Former USSR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Bosnia Herzg"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Croatia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Montenegro"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Serbia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Slovenia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="The former Yugoslav Republic of Macedonia"] <- "Former Yugoslav SFR"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Yugoslavia"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Czech Republic"] <- "Former Czechoslovakia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Sudan"] <- "Former Sudan"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="South Sudan"] <- "Former Sudan"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Eritrea"] <- "Former Ethiopia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Ethiopia"] <- "Former Ethiopia"

levels(fisheries$CountryName)[levels(fisheries$CountryName)=="Luxembourg"] <-"Belgium"

#remove partial data stes 
fisheries <- fisheries[fisheries$CountryName!="Occupied Palestinian Territory",]
fisheries <- fisheries[fisheries$CountryName!="British Indian Ocean Territory",]
fisheries <- fisheries[fisheries$CountryName!="Micronesia (Federated States of)",]
fisheries <- fisheries[fisheries$CountryName!="Gibraltar",]
fisheries <- fisheries[fisheries$CountryName!="Norfolk I.",]
fisheries <- fisheries[fisheries$CountryName!="Monaco",]
fisheries <- fisheries[fisheries$CountryName!="Tuvalu",]

fisheries <-fisheries[!fisheries$Year<1961,]
fisheries <-fisheries[fisheries$Year!=2014,]
levels(fisheries$CountryName)

fisheries <- fisheries[,c(1:14)]


write.csv(fisheries, file="Marine fisheries Production 1950-2014.csv", row.names = FALSE)



#INLAND FISHERIES DATA

freshfish<-read.csv("freshwater fisheries - landing 1950 - 2013.csv")
summary(freshfish)

names(freshfish)
names(freshfish)[names(freshfish)=="Country..Country."]<-"Country"
names(freshfish)[names(freshfish)=="Species..ASFIS.species."]<-"Species"
names(freshfish)[names(freshfish)=="Fishing.area..FAO.major.fishing.area."]<-"Fishing.area"
names(freshfish)[names(freshfish)=="Measure..Measure."]<-"Measure"
names(freshfish)


freshfish1<-freshfish%>%
  gather(Year, Value, -c(Country, Species, Fishing.area, Measure))
head(freshfish1)

#Sort years out (remove Xs)
freshfish1$Year<-gsub('X','',freshfish1$Year)
head(freshfish1) #looks good
freshfish1$Year <- as.factor(freshfish1$Year)

#Sort the symbols in values out
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information
freshfish1$Value
freshfish1$Value[freshfish1$Value=="0 0"] <- 0.5
freshfish1$Value[freshfish1$Value=="-"] <- 0

#exclude unavailable data
freshfish1 <- freshfish1[freshfish1$Value!="...",]
freshfish1 <- freshfish1[freshfish1$Value!="",]

#Use estimates as data
freshfish1$Value <- gsub(' F', '', freshfish1$Value)
head(freshfish1)
freshfish1$Value <- as.numeric(freshfish1$Value)

freshfish1$Codes <- countrycode(freshfish1$Country, origin = "country.name", destination = "iso3c", warn=T)

#get rid of strange levels in variables
freshfish1 <- freshfish1[freshfish1$Country!="FAO. 2017. Fishery and Aquaculture Statistics. Global capture production 1950-2015 (FishstatJ). In: FAO Fisheries and Aquaculture Department [online]. Rome. Updated 2017. www.fao.org/fishery/statistics/software/fishstatj/en",]
freshfish1 <- freshfish1[freshfish1$Country!="Totals - Quantity (number)" ,]
freshfish1 <- freshfish1[freshfish1$Country!="Totals - Quantity (tonnes)" ,]

freshfish1 <- freshfish1[freshfish1$Measure!="",]

write.csv(freshfish1, "freshwater fisheries landings 1950 - 2015 tidy.csv", row.names = F)

freshfish <- read.csv("freshwater fisheries landings 1950 - 2015 tidy.csv", header = T)

#aggregate production

  years<-seq(1961, 2013, by=1)
  Total<-c()
  for (i in 1:length(levels(freshfish$Country))){
    for (j in 1:length(years)){
      Total<-c(Total, sum(as.numeric(subset(freshfish$Value, freshfish$Country==levels(freshfish$Country)[i]& freshfish$Year==years[j]))))
    }
  }
  
  ##Country and Year columns
  Country<-rep(levels(freshfish$Country), 1, each=length(years))
  Year<-rep(years, length(levels(freshfish$Country)))
  
  ##New data frame 
  aggfreshfisheries<-cbind.data.frame(Country, Year, Total)
  
  pdf(file="Inland fisheries - check print out.pdf", paper = "a4r")
  for (i in 1:length(levels(aggfreshfisheries$Country))){
    values<-subset(aggfreshfisheries$Total, aggfreshfisheries$Country==levels(aggfreshfisheries$Country)[i])
    plot(years, values, xlab="Year", ylab="Total Landings (tonnes)", main=levels(aggfreshfisheries$Country)[i], pch=20, cex=0.75)
    }
  dev.off()


#remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 44 countries removed for inland fisheries

# freshfish <- freshfish[freshfish$Country!="Armenia",]
# freshfish <- freshfish[freshfish$Country!="Aruba",]
# freshfish <- freshfish[freshfish$Country!="Azerbaijan",]
# freshfish <- freshfish[freshfish$Country!="Bahrain",]
# freshfish <- freshfish[freshfish$Country!="Belarus",]
# freshfish <- freshfish[freshfish$Country!="Belgium",]
# freshfish <- freshfish[freshfish$Country!="Bermuda",]
# freshfish <- freshfish[freshfish$Country!="Bosnia and Herzegovina",]
# freshfish <- freshfish[freshfish$Country!="Croatia",]
# freshfish <- freshfish[freshfish$Country!="Czechia",]
# freshfish <- freshfish[freshfish$Country!="Cyprus",]
# freshfish <- freshfish[freshfish$Country!="Czechia",]
# freshfish <- freshfish[freshfish$Country!="Czechoslovakia",]
# freshfish <- freshfish[freshfish$Country!="Eritrea",]
# freshfish <- freshfish[freshfish$Country!="Estonia",]
# freshfish <- freshfish[freshfish$Country!="Grenada",]
# freshfish <- freshfish[freshfish$Country!="Iceland",]
# freshfish <- freshfish[freshfish$Country!="Kazakhstan",]
# freshfish <- freshfish[freshfish$Country!="Kiribati",]
# freshfish <- freshfish[freshfish$Country!="Kyrgyzstan",]
# freshfish <- freshfish[freshfish$Country!="Latvia",]
# freshfish <- freshfish[freshfish$Country!="Libya",]
# freshfish <- freshfish[freshfish$Country!="Liechtenstein",]
# freshfish <- freshfish[freshfish$Country!="Lithuania",]
# freshfish <- freshfish[freshfish$Country!="Macedonia, Fmr Yug Rp of",]
# freshfish <- freshfish[freshfish$Country!="Micronesia, Fed.States of",]
# freshfish <- freshfish[freshfish$Country!="Moldova, Republic of",]
# freshfish <- freshfish[freshfish$Country!="Montenegro",]
# freshfish <- freshfish[freshfish$Country!="Palestine, Occupied Tr.",]
# freshfish <- freshfish[freshfish$Country!="Puerto Rico",]
# freshfish <- freshfish[freshfish$Country!="Russian Federation",]
# freshfish <- freshfish[freshfish$Country!="Saint Helena",]
# freshfish <- freshfish[freshfish$Country!="Serbia",]
# freshfish <- freshfish[freshfish$Country!="Serbia and Montenegro",]
# freshfish <- freshfish[freshfish$Country!="Slovakia",]
# freshfish <- freshfish[freshfish$Country!="Slovenia",]
# freshfish <- freshfish[freshfish$Country!="South Sudan",]
# freshfish <- freshfish[freshfish$Country!="Sudan",]
# freshfish <- freshfish[freshfish$Country!="Tajikistan",]
# freshfish <- freshfish[freshfish$Country!="Tonga",]
# freshfish <- freshfish[freshfish$Country!="Turkmenistan",]
# freshfish <- freshfish[freshfish$Country!="Ukraine",]
# freshfish <- freshfish[freshfish$Country!="Un. Sov. Soc. Rep.",]
# freshfish <- freshfish[freshfish$Country!="Uruguay",]
# freshfish <- freshfish[freshfish$Country!="Uzbekistan",]
# freshfish <- freshfish[freshfish$Country!="Yemen",]
# freshfish <- freshfish[freshfish$Country!="Yugoslavia SFR",]
  
#USSR
levels(freshfish$Country)[levels(freshfish$Country)=="Armenia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Azerbaijan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Belarus"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Estonia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Georgia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Kazakhstan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Latvia"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Lithuania"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Moldova, Republic of"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Russian Federation"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Tajikistan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Turkmenistan"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Ukraine"] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Un. Sov. Soc. Rep."] <- "Former USSR"
levels(freshfish$Country)[levels(freshfish$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(freshfish$Country)[levels(freshfish$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Macedonia, Fmr Yug Rp of"] <- "Former Yugoslav SFR"
levels(freshfish$Country)[levels(freshfish$Country)=="Yugoslavia SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(freshfish$Country)[levels(freshfish$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(freshfish$Country)[levels(freshfish$Country)=="Czechia"] <- "Former Czechoslovakia"
levels(freshfish$Country)[levels(freshfish$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(freshfish$Country)[levels(freshfish$Country)=="Sudan"] <- "Former Sudan"
levels(freshfish$Country)[levels(freshfish$Country)=="South Sudan"] <- "Former Sudan"
levels(freshfish$Country)[levels(freshfish$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(freshfish$Country)[levels(freshfish$Country)=="Eritrea"] <- "Former Ethiopia"
levels(freshfish$Country)[levels(freshfish$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(freshfish$Country)[levels(freshfish$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(freshfish$Country)[levels(freshfish$Country)=="Luxembourg"] <-"Belgium"

levels(freshfish$Country)[levels(freshfish$Country)=="Côte d'Ivoire"]<-"Cote d'Ivoire"
freshfish <- freshfish[freshfish$Country!="Saint Helena",]
freshfish <- freshfish[freshfish$Country!="French Southern Terr",]
freshfish <- freshfish[freshfish$Country!="Grenada",]
freshfish <- freshfish[freshfish$Country!="Iceland",]
freshfish <- freshfish[freshfish$Country!="Micronesia, Fed.States of",]
freshfish <- freshfish[freshfish$Country!="Norfolk Island",]
freshfish <- freshfish[freshfish$Country!="Palestine, Occupied Tr.",]
freshfish <- freshfish[freshfish$Country!="Puerto Rico",]
freshfish <- freshfish[freshfish$Country!="Tonga",]
freshfish <- freshfish[freshfish$Country!="Uruguay",]
freshfish <- freshfish[freshfish$Country!="Yemen",]
freshfish <- freshfish[freshfish$Country!="Channel Islands",]

freshfish <- freshfish[!freshfish$Year<1961,]
freshfish <- freshfish[!freshfish$Year>2013,]
freshfish <- freshfish[, c(1:6)]

write.csv(freshfish, file="Inland fisheries Production 1950-2014.csv", row.names = FALSE)



# AQUACULTURE PRODUCTION DATA

aquaculture<-read.csv("aquaculture 1950-2015 unfixed .csv")
levels(aquaculture$Land.Area)
summary(aquaculture)

#CHANGE column names  
names(aquaculture)
names(aquaculture)[names(aquaculture)=="Land.Area"]<-"Country"
names(aquaculture)[names(aquaculture)=="Ocean.Area"]<-"Waters"
inland<-aquaculture[aquaculture$Waters=="Inland waters",]
marine<-aquaculture[aquaculture$Waters=="Marine areas",]
  

#inland production

summary(inland)
inland$Codes<-countrycode(inland$Country, "country.name", "iso3c", warn=T)
inland$Codes[inland$Country=="RÃ©union"] <- "REU"
inland$Codes[inland$Country=="Serbia and Montenegro"] <- "BIH"

inland <- inland[!is.na(inland$Codes),]
summary(inland)

levels(inland$Country)
levels(inland$Waters)
levels(inland$Environment)
levels(inland$Species)

#only use fish crustaceans and molluscs

inland <- inland[inland$Species!="Aquatic plants",]
inland <- inland[inland$Species!="Miscellaneous aquatic animal products",]
inland <- inland[inland$Species!="Miscellaneous aquatic animals",]

write.csv(inland, "inland aquaculture 1950 -2015 tidy.csv", row.names = F)

inland <- read.csv("inland aquaculture 1950 -2015 tidy.csv", header=T)

#aggregate production

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(inland$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(inland$value, inland$Country==levels(inland$Country)[i] & inland$year==years[j]))))
  }
}


##Country and Year columns
Country<-rep(levels(inland$Country), 1, each=length(years))
Year<-rep(years, length(levels(inland$Country)))

##New data frame 
agginlandaqua<-cbind.data.frame(Country, Year, Total)

pdf(file="Inland aquaculture - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(agginlandaqua$Country))){
  values<-subset(agginlandaqua$Total, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agginlandaqua$Country)[i], pch=20, cex=0.75)
  }
dev.off()


# #remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 26 countries removed for inland aquaculture
# 
# inland <- inland[inland$Country!="Armenia",]
# inland <- inland[inland$Country!="Azerbaijan",]
# inland <- inland[inland$Country!="Belarus",]
# inland <- inland[inland$Country!="Bosnia and Herzegovina",]
# inland <- inland[inland$Country!="Botswana",]
# inland <- inland[inland$Country!="Croatia",]
# inland <- inland[inland$Country!="Czechia",]
# inland <- inland[inland$Country!="Czechoslovakia",]
# inland <- inland[inland$Country!="Estonia",]
# inland <- inland[inland$Country!="Ethiopia",]
# inland <- inland[inland$Country!="Georgia",]
# inland <- inland[inland$Country!="Kazakhstan",]
# inland <- inland[inland$Country!="Kyrgyzstan",]
# inland <- inland[inland$Country!="Latvia",]
# inland <- inland[inland$Country!="Lithuania",]
# inland <- inland[inland$Country!="Macedonia, Fmr Yug Rp of",]
# inland <- inland[inland$Country!="Moldova, Republic of",]
# inland <- inland[inland$Country!="Montenegro",]
# inland <- inland[inland$Country!="Palestine, Occupied Tr.",]
# inland <- inland[inland$Country!="Russian Federation",]
# inland <- inland[inland$Country!="Slovakia",]
# inland <- inland[inland$Country!="Slovenia",]
# inland <- inland[inland$Country!="Solomon Islands",]
# inland <- inland[inland$Country!="Tajikistan",]
# inland <- inland[inland$Country!="Timor???Leste",]
# inland <- inland[inland$Country!="Turkmenistan",]
# inland <- inland[inland$Country!="Ukraine",]
# inland <- inland[inland$Country!="Uzbekistan",]
# inland <- inland[inland$Country!="Yugoslavia SFR",]

#Former USSR
levels(inland$Country)[levels(inland$Country)=="Armenia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Azerbaijan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Belarus"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Estonia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Georgia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Kazakhstan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Latvia"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Lithuania"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Moldova, Republic of"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Russian Federation"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Tajikistan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Turkmenistan"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Ukraine"] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Un. Sov. Soc. Rep."] <- "Former USSR"
levels(inland$Country)[levels(inland$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(inland$Country)[levels(inland$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Macedonia, Fmr Yug Rp of"] <- "Former Yugoslav SFR"
levels(inland$Country)[levels(inland$Country)=="Yugoslavia SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(inland$Country)[levels(inland$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(inland$Country)[levels(inland$Country)=="Czechia"] <- "Former Czechoslovakia"
levels(inland$Country)[levels(inland$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(inland$Country)[levels(inland$Country)=="Sudan"] <- "Former Sudan"
levels(inland$Country)[levels(inland$Country)=="South Sudan"] <- "Former Sudan"
levels(inland$Country)[levels(inland$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(inland$Country)[levels(inland$Country)=="Eritrea"] <- "Former Ethiopia"
levels(inland$Country)[levels(inland$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(inland$Country)[levels(inland$Country)=="Ethiopia"] <- "Former Ethiopia"

levels(inland$Country)[levels(inland$Country)=="Luxembourg"] <-"Belgium"

inland <- inland[inland$Country!="Botswana",]
inland <- inland[inland$Country!="Micronesia, Fed.States of",]
inland <- inland[inland$Country!="Palestine, Occupied Tr.",]
inland <- inland[inland$Country!="Tuvalu",]
inland <- inland[inland$Country!="Solomon Islands",]
inland <- inland[inland$Country!="Marshall Islands",]
inland <- inland[inland$Country!="Timor???Leste",]
inland <- inland[inland$Country!="Ghana",]
inland <- inland[inland$Country!="Aruba",]
inland <- inland[inland$Country!="Bonaire/S.Eustatius/Saba",]
inland <- inland[inland$Country!="Falkland Is.(Malvinas)",]
inland <- inland[inland$Country!="Gambia",]
inland <- inland[inland$Country!="Nauru",]
inland <- inland[inland$Country!="Netherlands Antilles",]
inland <- inland[inland$Country!="Saint Kitts and Nevis",]
inland <- inland[inland$Country!="Turks and Caicos Is.",]
inland <- inland[inland$Country!="United Arab Emirates",]
inland <- inland[inland$Country!="Yemen",]

inland <- inland[!inland$year<1961,]
inland <- inland[!inland$year>2013,]
inland <- inland[,c(1:8)]


write.csv(inland, file="Inland aquaculture Production 1950-2014.csv", row.names = FALSE)

##marine production 

marine$Codes <- countrycode(marine$Country, origin = "country.name", destination = "iso3c", warn=T)
marine$Codes[marine$Country=="RÃ©union"] <- "REU"
marine$Codes[marine$Country=="Serbia and Montenegro"] <- "BIH"
marine <- marine[!is.na(marine$Codes),]

summary(marine)

write.csv(marine, "Marine aquaculture production 1950 -2013 tidy.csv", row.names = F)

marine <- read.csv("Marine aquaculture production 1950 -2013 tidy.csv", header=TRUE)

##aggregate production

years<-seq(1961, 2013, by=1)
Total<-c()
for (i in 1:length(levels(marine$Country))){
  for (j in 1:length(years)){
    Total<-c(Total, sum(as.numeric(subset(marine$value, marine$Country==levels(marine$Country)[i] & marine$year==years[j]))))
  }
}


Country<-rep(levels(marine$Country), 1, each=length(years))
Year<-rep(years, length(levels(marine$Country)))
aggmarineaqua<-cbind.data.frame(Country, Year, Total)



pdf(file="Marine aquaculture - check print out.pdf", paper = "a4r")
for (i in 1:length(levels(aggmarineaqua$Country))){
  values<-subset(aggmarineaqua$Total, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggmarineaqua$Country)[i], pch=20, cex=0.75)
  }
dev.off()

#remove partial data sets i.e. countries that have been created/dissolved or report differently within study period OR is a reduction from an estimate (0.5) - 10 countries removed for marine aquaculture


# marine <- marine[marine$Country!="Bosnia and Herzegovina",]
# marine <- marine[marine$Country!="Eritrea",]
# marine <- marine[marine$Country!="Estonia",]
# marine <- marine[marine$Country!="Georgia",]
# marine <- marine[marine$Country!="Ghana",] #zeroes for whole time series
# marine <- marine[marine$Country!="Marshall Islands",]
# marine <- marine[marine$Country!="Micronesia, Fed.States of",]
# marine <- marine[marine$Country!="Montenegro",]
# marine <- marine[marine$Country!="Palestine, Occupied Tr.",]
# marine <- marine[marine$Country!="Russian Federation",]
# marine <- marine[marine$Country!="Tuvalu",]
# marine <- marine[marine$Country!="Ukraine",]
# marine <- marine[marine$Country!="Yugoslavia SFR",]

#USSR

levels(marine$Country)[levels(marine$Country)=="Armenia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Azerbaijan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Belarus"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Estonia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Georgia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Kazakhstan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Kyrgyzstan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Latvia"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Lithuania"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Moldova, Republic of"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Russian Federation"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Tajikistan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Turkmenistan"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Ukraine"] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Un. Sov. Soc. Rep."] <- "Former USSR"
levels(marine$Country)[levels(marine$Country)=="Uzbekistan"] <- "Former USSR"

#Yugoslav states
levels(marine$Country)[levels(marine$Country)=="Bosnia and Herzegovina"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Croatia"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Montenegro"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Serbia"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Serbia and Montenegro"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Slovenia"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Macedonia, Fmr Yug Rp of"] <- "Former Yugoslav SFR"
levels(marine$Country)[levels(marine$Country)=="Yugoslavia SFR"] <- "Former Yugoslav SFR"


#Former Czechslovakia
levels(marine$Country)[levels(marine$Country)=="Czechoslovakia"] <- "Former Czechoslovakia"
levels(marine$Country)[levels(marine$Country)=="Czechia"] <- "Former Czechoslovakia"
levels(marine$Country)[levels(marine$Country)=="Slovakia"] <- "Former Czechoslovakia"

#Former Sudan
levels(marine$Country)[levels(marine$Country)=="Sudan"] <- "Former Sudan"
levels(marine$Country)[levels(marine$Country)=="South Sudan"] <- "Former Sudan"
levels(marine$Country)[levels(marine$Country)=="Sudan (former)"] <- "Former Sudan"

#Former Ethiopia
levels(marine$Country)[levels(marine$Country)=="Eritrea"] <- "Former Ethiopia"
levels(marine$Country)[levels(marine$Country)=="Ethiopia PDR"] <- "Former Ethiopia"
levels(marine$Country)[levels(marine$Country)=="Ethiopia"] <- "Former Ethiopia"


levels(marine$Country)[levels(marine$Country)=="Luxembourg"] <-"Belgium"

marine <- marine[marine$Country!="Botswana",]
marine <- marine[marine$Country!="Micronesia, Fed.States of",]
marine <- marine[marine$Country!="Palestine, Occupied Tr.",]
marine <- marine[marine$Country!="Tuvalu",]
marine <- marine[marine$Country!="Solomon Islands",]
marine <- marine[marine$Country!="Marshall Islands",]
marine <- marine[marine$Country!="Timor???Leste",]
marine <- marine[marine$Country!="Ghana",]
marine <- marine[marine$Country!="Aruba",]
marine <- marine[marine$Country!="Bonaire/S.Eustatius/Saba",]
marine <- marine[marine$Country!="Falkland Is.(Malvinas)",]
marine <- marine[marine$Country!="Gambia",]
marine <- marine[marine$Country!="Nauru",]
marine <- marine[marine$Country!="Netherlands Antilles",]
marine <- marine[marine$Country!="Saint Kitts and Nevis",]
marine <- marine[marine$Country!="Turks and Caicos Is.",]
marine <- marine[marine$Country!="United Arab Emirates",]
marine <- marine[marine$Country!="Yemen",]

marine <- marine[!marine$year<1961,]
marine <- marine[!marine$year>2013,]

marine <- marine[,c(1:8)]

write.csv(marine, "Marine aquaculture production 1950 -2015.csv", row.names=F)


ls
```
## AGGREGATE PRODUCTION DATA 

```{r}
crops<-read.csv("Crop Production 1961-2013.csv", header=T)
aggcrops <- stats::aggregate(crops$Value~crops$Year+crops$Country, FUN=sum, drop=FALSE)
names(aggcrops)[names(aggcrops)=="crops$Year"] <- "Year"
names(aggcrops)[names(aggcrops)=="crops$Country"] <- "Country"
names(aggcrops)[names(aggcrops)=="crops$Value"] <- "Value"


livestock <- read.csv("Livestock Production 1961-2013.csv", header=T)
agglivestock <- stats::aggregate(livestock$Value~livestock$Year+livestock$Country, FUN=sum, drop=FALSE)
names(agglivestock)[names(agglivestock)=="livestock$Year"] <- "Year"
names(agglivestock)[names(agglivestock)=="livestock$Country"] <- "Country"
names(agglivestock)[names(agglivestock)=="livestock$Value"] <- "Value"

marinefisheries <- read.csv("Marine fisheries Production 1950-2014.csv", header = T)
aggmarinefisheries <-aggregate(marinefisheries$Value~marinefisheries$Year+marinefisheries$Country, FUN=sum, drop=FALSE)
names(aggmarinefisheries)[names(aggmarinefisheries)=="marinefisheries$Year"] <- "Year"
names(aggmarinefisheries)[names(aggmarinefisheries)=="marinefisheries$Country"] <- "Country"
names(aggmarinefisheries)[names(aggmarinefisheries)=="marinefisheries$Value"] <- "Value"

inlandfisheries<- read.csv("Inland fisheries Production 1950-2014.csv", header = T)
agginlandfisheries <-aggregate(inlandfisheries$Value~inlandfisheries$Year+inlandfisheries$Country, FUN=sum, drop=FALSE)
names(agginlandfisheries)[names(agginlandfisheries)=="inlandfisheries$Year"] <- "Year"
names(agginlandfisheries)[names(agginlandfisheries)=="inlandfisheries$Country"] <- "Country"
names(agginlandfisheries)[names(agginlandfisheries)=="inlandfisheries$Value"] <- "Value"

inlandaqua<- read.csv("Inland aquaculture Production 1950-2014.csv", header=T)
agginlandaqua <- aggregate(inlandaqua$value~inlandaqua$year+inlandaqua$Country, FUN=sum, drop=FALSE)
names(agginlandaqua)[names(agginlandaqua)=="inlandaqua$year"] <- "Year"
names(agginlandaqua)[names(agginlandaqua)=="inlandaqua$Country"] <- "Country"
names(agginlandaqua)[names(agginlandaqua)=="inlandaqua$value"] <- "Value"

marineaqua <- read.csv("Marine aquaculture production 1950 -2015.csv", header=T)
aggmarineaqua <- aggregate(marineaqua$value~marineaqua$year+marineaqua$Country, FUN=sum, drop=FALSE)
names(aggmarineaqua)[names(aggmarineaqua)=="marineaqua$year"] <- "Year"
names(aggmarineaqua)[names(aggmarineaqua)=="marineaqua$Country"] <- "Country"
names(aggmarineaqua)[names(aggmarineaqua)=="marineaqua$value"] <- "Value"

#Number of countries per sector
length(levels(aggcrops$Country)) #188
length(levels(agglivestock$Country)) #191
length(levels(agginlandfisheries$Country)) #196
length(levels(agginlandaqua$Country)) #160
length(levels(aggmarinefisheries$Country)) #174
length(levels(aggmarineaqua$Country)) #125



#aggregate inland and marine production for both aquaculture and fisheries
#fisheries
aggmarinefisheries2<-aggmarinefisheries
names(aggmarinefisheries2)[names(aggmarinefisheries2)=="Value"]<-"Marine"
aggmarinefisheries2$Codes <-countrycode(aggmarinefisheries2$Country, origin = "country.name", destination="iso3c", warn=T)
aggmarinefisheries2$Codes[aggmarinefisheries2$Country=="Former Yugoslav SFR"]<-"BIH"

agginlandfisheries2<-agginlandfisheries
names(agginlandfisheries2)[names(agginlandfisheries2)=="Value"]<-"Inland"
agginlandfisheries2$Codes<-countrycode(agginlandfisheries2$Country, origin = "country.name", destination = "iso3c", warn=T)
agginlandfisheries2$Codes[agginlandfisheries2$Country=="Former Yugoslav SFR"]<-"BIH"


aggfisheries <- plyr::join(x=agginlandfisheries2, y=aggmarinefisheries2, by=c("Codes", "Year"), type="full")
aggfisheries$Marine[is.na(aggfisheries$Marine)]<-0
aggfisheries$Inland[is.na(aggfisheries$Inland)]<-0
aggfisheries$Value<-aggfisheries$Inland+aggfisheries$Marine

write.csv(aggfisheries,file = "aggfisheries.csv", row.names=F)
aggfisheries <- read.csv("aggfisheries.csv", header=T)

levels(aggfisheries$Country)

#aquaculture
aggmarineaqua2<-aggmarineaqua
names(aggmarineaqua2)[names(aggmarineaqua2)=="Value"]<-"Marine"
aggmarineaqua2$Codes <-countrycode(aggmarineaqua2$Country, origin="country.name", destination="iso3c", warn=T)
aggmarineaqua2$Codes[aggmarineaqua2$Country=="Former Yugoslav SFR"]<-"BIH"
aggmarineaqua2$Codes[aggmarineaqua2$Country=="RÃ©union"]<-"REU"

agginlandaqua2<-agginlandaqua
names(agginlandaqua2)[names(agginlandaqua2)=="Value"]<-"Inland"
agginlandaqua2$Codes <-countrycode(agginlandaqua2$Country, origin="country.name", destination="iso3c", warn=T)
agginlandaqua2$Codes[agginlandaqua2$Country=="Former Yugoslav SFR"]<-"BIH"
agginlandaqua2$Codes[agginlandaqua2$Country=="RÃ©union"]<-"REU"

aggaqua <- plyr::join(x=agginlandaqua2, y=aggmarineaqua2, by=c("Codes", "Year"), type="full")
aggaqua$Marine[is.na(aggaqua$Marine)]<-0
aggaqua$Inland[is.na(aggaqua$Inland)]<-0
aggaqua$Value<-aggaqua$Inland+aggaqua$Marine

write.csv(aggaqua,file = "aggaqua.csv", row.names=F)
aggaqua <- read.csv("aggaqua.csv", header=T)

##no of countries producing in each sector by year

years<-seq(1961, 2013, by=1)


zeroes <- function(x){
  length(x[x>0])
  
}

(CropsN<-as.numeric(tapply(aggcrops$Value, aggcrops$Year, FUN = zeroes)))
CropsN<-cbind.data.frame(years, CropsN)
names(CropsN)[names(CropsN)=="years"]<-"Year"

LivestockN <- as.numeric(tapply(agglivestock$Value, agglivestock$Year, FUN= zeroes))
LivestockN<-cbind.data.frame(years, LivestockN)
names(LivestockN)[names(LivestockN)=="years"] <- "Year"

FisheriesN <- as.numeric(tapply(aggfisheries$Value, aggfisheries$Year, FUN=zeroes))
FisheriesN<-cbind.data.frame(years, FisheriesN)
names(FisheriesN)[names(FisheriesN)=="years"] <- "Year"


AquacultureN <- as.numeric(tapply(aggaqua$Value, aggaqua$Year, FUN = zeroes))
(AquacultureN <-cbind.data.frame(years, AquacultureN))
names(AquacultureN)[names(AquacultureN)=="years"] <- "Year"



```

#ADD GEOGRAPHICAL REGIONS TO AGGREGATED PRODUCTION DATA

```{r}

#Main continents for crops
aggcrops$Continent <- countrycode(aggcrops$Country, origin = "country.name", destination = "continent", warn = T)


#World bank regions for crops

#SubSaharan Africa
aggcrops$Continent[aggcrops$Continent=="Africa"]<-"SSA"

#MENA
aggcrops$Continent[aggcrops$Country=="Algeria"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Bahrain"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Djibouti"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Egypt"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Iraq"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Iran (Islamic Republic of)"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Israel"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Jordan"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Kuwait"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Lebanon"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Libya"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Malta"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Morocco"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Oman"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Qatar"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Syrian Arab Republic"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Saudi Arabia"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Tunisia"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="United Arab Emirates"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="West Bank and Gaza"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Yemen"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Former Sudan"]<-"MENA"
aggcrops$Continent[aggcrops$Country=="Former Ethiopia"]<-"MENA"

#Caribbean and Latin America
aggcrops$Continent[aggcrops$Continent=="Americas"]<-"LACa"

#North America
aggcrops$Continent[aggcrops$Country=="United States of America"]<-"North America"
aggcrops$Continent[aggcrops$Country=="Canada"]<-"North America"
aggcrops$Continent[aggcrops$Country=="Bermuda"]<-"North America"


#Europe and Central Asia

aggcrops$Continent[aggcrops$Country=="Cyprus"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Azerbaijan"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Greenland"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Kazakhstan"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Kyrgyzstan"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Tajikistan"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Turkmenistan"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Uzbekistan"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Turkey"]<-"EuCA"
aggcrops$Continent[aggcrops$Continent=="Europe"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Former USSR"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Former Czechoslovakia"]<-"EuCA"
aggcrops$Continent[aggcrops$Country=="Former Yugoslav SFR"]<-"EuCA"



#South Asia
aggcrops$Continent[aggcrops$Country=="Afghanistan"]<-"South Asia"
aggcrops$Continent[aggcrops$Country=="Bangladesh"]<-"South Asia"
aggcrops$Continent[aggcrops$Country=="Bhutan"]<-"South Asia"

aggcrops$Continent[aggcrops$Country=="India"]<-"South Asia"
aggcrops$Continent[aggcrops$Country=="Maldives"]<-"South Asia"
aggcrops$Continent[aggcrops$Country=="Nepal"]<-"South Asia"
aggcrops$Continent[aggcrops$Country=="Pakistan"]<-"South Asia"
aggcrops$Continent[aggcrops$Country=="Sri Lanka"]<-"South Asia"

#East Asia 
aggcrops$Continent[aggcrops$Continent=="Asia"]<-"East Asia"
#aggcrops$Continent[aggcrops$Continent=="Oceania"]<-"East Asia and Pacific"


#Main continents for livestock
agglivestock$Continent <- countrycode(agglivestock$Country, origin = "country.name", destination = "continent", warn = T)

#World bank regions for livestock

#SubSaharan Africa
agglivestock$Continent[agglivestock$Continent=="Africa"]<-"SSA"

#MENA
agglivestock$Continent[agglivestock$Country=="Algeria"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Bahrain"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Djibouti"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Egypt"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Iran (Islamic Republic of)"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Iraq"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Israel"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Jordan"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Kuwait"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Lebanon"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Libya"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Malta"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Morocco"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Oman"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Qatar"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Syrian Arab Republic"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Saudi Arabia"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Tunisia"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="United Arab Emirates"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="West Bank and Gaza"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Yemen"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Former Sudan"]<-"MENA"
agglivestock$Continent[agglivestock$Country=="Former Ethiopia"]<-"MENA"

#Caribbean and Latin America
agglivestock$Continent[agglivestock$Continent=="Americas"]<-"LACa"

#North America
agglivestock$Continent[agglivestock$Country=="United States of America"]<-"North America"
agglivestock$Continent[agglivestock$Country=="Canada"]<-"North America"
agglivestock$Continent[agglivestock$Country=="Bermuda"]<-"North America"
agglivestock$Continent[agglivestock$Country=="Greenland"]<-"North America"


#Europe and Central Asia
agglivestock$Continent[agglivestock$Country=="Azerbaijan"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Cyprus"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Kazakhstan"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Kyrgyzstan"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Tajikistan"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Turkmenistan"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Turkey"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Uzbekistan"]<-"EuCA"
agglivestock$Continent[agglivestock$Continent=="Europe"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Former USSR"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Former Czechoslovakia"]<-"EuCA"
agglivestock$Continent[agglivestock$Country=="Former Yugoslav SFR"]<-"EuCA"

#South Asia
agglivestock$Continent[agglivestock$Country=="Afghanistan"]<-"South Asia"
agglivestock$Continent[agglivestock$Country=="Bangladesh"]<-"South Asia"
agglivestock$Continent[agglivestock$Country=="Bhutan"]<-"South Asia"
agglivestock$Continent[agglivestock$Country=="India"]<-"South Asia"
agglivestock$Continent[agglivestock$Country=="Maldives"]<-"South Asia"
agglivestock$Continent[agglivestock$Country=="Nepal"]<-"South Asia"
agglivestock$Continent[agglivestock$Country=="Pakistan"]<-"South Asia"
agglivestock$Continent[agglivestock$Country=="Sri Lanka"]<-"South Asia"

#East Asia Pacific
agglivestock$Continent[agglivestock$Continent=="Asia"]<-"East Asia"
#agglivestock$Continent[agglivestock$Continent=="Oceania"]<-"East Asia and Pacific"

unique(agglivestock$Country[agglivestock$Continent=="East Asia"])

#Main continents -total fisheries

aggfisheries$Continent <- countrycode(aggfisheries$Country, origin = "country.name", destination = "continent", warn = T)
aggfisheries$Continent[aggfisheries$Country=="British Indian Ocean Territory"]<-"Asia"


#SubSaharan Africa
aggfisheries$Continent[aggfisheries$Continent=="Africa"]<-"SSA"

#MENA
aggfisheries$Continent[aggfisheries$Country=="Algeria"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Bahrain"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Djibouti"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Egypt"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Iran (Islamic Rep. of)"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Iraq"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Israel"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Jordan"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Kuwait"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Lebanon"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Libya"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Malta"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Morocco"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Oman"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Qatar"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Syrian Arab Republic"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Saudi Arabia"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Tunisia"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="United Arab Emirates"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="West Bank and Gaza"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Yemen"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Former Sudan"]<-"MENA"
aggfisheries$Continent[aggfisheries$Country=="Former Ethiopia"]<-"MENA"


#Caribbean and Latin America
aggfisheries$Continent[aggfisheries$Continent=="Americas"]<-"LACa"

#North America
aggfisheries$Continent[aggfisheries$Country=="United States of America"]<-"North America"
aggfisheries$Continent[aggfisheries$Country=="Canada"]<-"North America"
aggfisheries$Continent[aggfisheries$Country=="Bermuda"]<-"North America"
aggfisheries$Continent[aggfisheries$Country=="Greenland"]<-"North America"


#Europe and Central Asia
aggfisheries$Continent[aggfisheries$Country=="Azerbaijan"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Cyprus"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Kazakhstan"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Kyrgyzstan"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Tajikistan"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Turkmenistan"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Turkey"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Uzbekistan"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Continent=="Europe"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Former USSR"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Former Czechoslovakia"]<-"EuCA"
aggfisheries$Continent[aggfisheries$Country=="Former Yugoslav SFR"]<-"EuCA"

#South Asia
aggfisheries$Continent[aggfisheries$Country=="Afghanistan"]<-"South Asia"
aggfisheries$Continent[aggfisheries$Country=="Bangladesh"]<-"South Asia"
aggfisheries$Continent[aggfisheries$Country=="Bhutan"]<-"South Asia"
aggfisheries$Continent[aggfisheries$Country=="India"]<-"South Asia"
aggfisheries$Continent[aggfisheries$Country=="Maldives"]<-"South Asia"
aggfisheries$Continent[aggfisheries$Country=="Nepal"]<-"South Asia"
aggfisheries$Continent[aggfisheries$Country=="Pakistan"]<-"South Asia"
aggfisheries$Continent[aggfisheries$Country=="Sri Lanka"]<-"South Asia"

#East Asia Pacific
aggfisheries$Continent[aggfisheries$Continent=="Asia"]<-"East Asia"
#aggfisheries$Continent[aggfisheries$Continent=="Oceania"]<-"East Asia and Pacific"



# #Main continents - inland fisheries
# agginlandfisheries$Continent <- countrycode(agginlandfisheries$Country, origin = "country.name", destination = "continent", warn = T)
# agginlandfisheries$Continent[agginlandaqua$Country=="British Indian Ocean Territory"]<-"Asia"
# 
# 
# 
# #SubSaharan Africa
# agginlandfisheries$Continent[agginlandfisheries$Continent=="Africa"]<-"SSA"
# 
# #MENA
# agginlandfisheries$Continent[agginlandfisheries$Country=="Algeria"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Bahrain"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Djibouti"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Eygpt"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Iran"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Iraq"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Israel"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Jordan"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Kuwait"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Lebanon"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Libya"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Malta"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Morocco"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Oman"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Qatar"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Syria"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Tunisia"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="United Arab Emirates"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="West Bank and Gaza"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Yemen"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Ethiopia"]<-"MENA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Sudan"]<-"MENA"
# 
# #Caribbean and Latin America
# agginlandfisheries$Continent[agginlandfisheries$Continent=="Americas"]<-"LACa"
# 
# #North America
# agginlandfisheries$Continent[agginlandfisheries$Country=="United States of America"]<-"North America"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Canada"]<-"North America"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Bermuda"]<-"North America"
# 
# 
# #Europe and Central Asia
# agginlandfisheries$Continent[agginlandfisheries$Country=="Azerbaijan"]<-"EuCA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Greenland"]<-"EuCA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Kazakhstan"]<-"EuCA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Kyrgyzstan"]<-"EuCA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Tajikistan"]<-"EuCA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Turkmenistan"]<-"EuCA"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Uzbekistan"]<-"EuCA"
# agginlandfisheries$Continent[agginlandfisheries$Continent=="Europe"]<-"EuCA"
# 
# #South Asia
# agginlandfisheries$Continent[agginlandfisheries$Country=="Afghanistan"]<-"South Asia"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Bangladesh"]<-"South Asia"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Bhutan"]<-"South Asia"
# agginlandfisheries$Continent[agginlandfisheries$Country=="India"]<-"South Asia"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Maldives"]<-"South Asia"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Nepal"]<-"South Asia"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Pakistan"]<-"South Asia"
# agginlandfisheries$Continent[agginlandfisheries$Country=="Sri Lanka"]<-"South Asia"
# 
# #East Asia Pacific
# agginlandfisheries$Continent[agginlandfisheries$Continent=="Asia"]<-"East Asia and Pacific"
# agginlandfisheries$Continent[agginlandfisheries$Continent=="Oceania"]<-"East Asia and Pacific"
# 
# 
# 
# 
# 
# 
# 
# 
# 
# #Main continents - marine fisheries
# aggmarinefisheries$Continent <- countrycode(aggmarinefisheries$Country, origin = "country.name", destination = "continent", warn = T)
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="British Indian Ocean Territory"]<-"Asia"
# 
# 
# #SubSaharan Africa
# aggmarinefisheries$Continent[aggmarinefisheries$Continent=="Africa"]<-"SSA"
# 
# #MENA
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Algeria"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Bahrain"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Djibouti"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Eygpt"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Iran"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Iraq"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Israel"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Jordan"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Kuwait"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Lebanon"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Libya"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Malta"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Morocco"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Oman"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Qatar"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Syria"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Tunisia"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="United Arab Emirates"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="West Bank and Gaza"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Yemen"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Ethiopia"]<-"MENA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Sudan"]<-"MENA"
# 
# #Caribbean and Latin America
# aggmarinefisheries$Continent[aggmarinefisheries$Continent=="Americas"]<-"LACa"
# 
# #North America
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="United States of America"]<-"North America"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Canada"]<-"North America"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Bermuda"]<-"North America"
# 
# 
# #Europe and Central Asia
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Azerbaijan"]<-"EuCA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Greenland"]<-"EuCA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Kazakhstan"]<-"EuCA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Kyrgyzstan"]<-"EuCA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Tajikistan"]<-"EuCA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Turkmenistan"]<-"EuCA"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Uzbekistan"]<-"EuCA"
# aggmarinefisheries$Continent[aggmarinefisheries$Continent=="Europe"]<-"EuCA"
# 
# #South Asia
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Afghanistan"]<-"South Asia"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Bangladesh"]<-"South Asia"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Bhutan"]<-"South Asia"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="India"]<-"South Asia"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Maldives"]<-"South Asia"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Nepal"]<-"South Asia"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Pakistan"]<-"South Asia"
# aggmarinefisheries$Continent[aggmarinefisheries$Country=="Sri Lanka"]<-"South Asia"
# 
# #East Asia Pacific
# aggmarinefisheries$Continent[aggmarinefisheries$Continent=="Asia"]<-"East Asia and Pacific"
# aggmarinefisheries$Continent[aggmarinefisheries$Continent=="Oceania"]<-"East Asia and Pacific"


#main continents - total aquaculture
aggaqua$Continent <- countrycode(aggaqua$Country, origin = "country.name", destination = "continent", warn = T)
aggaqua$Continent[aggaqua$Country=="RÃ©union"]<-"Africa"


#SubSaharan Africa
aggaqua$Continent[aggaqua$Continent=="Africa"]<-"SSA"
aggaqua$Continent[aggaqua$Country=="Zanzibar"]<-"SSA"

#MENA
aggaqua$Continent[aggaqua$Country=="Algeria"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Bahrain"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Djibouti"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Egypt"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Iran (Islamic Rep. of)"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Iraq"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Israel"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Jordan"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Kuwait"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Lebanon"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Libya"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Malta"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Morocco"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Oman"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Qatar"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Syrian Arab Republic"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Saudi Arabia"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Tunisia"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="United Arab Emirates"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="West Bank and Gaza"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Yemen"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Former Ethiopia"]<-"MENA"
aggaqua$Continent[aggaqua$Country=="Former Sudan"]<-"MENA"

#Caribbean and Latin America
aggaqua$Continent[aggaqua$Continent=="Americas"]<-"LACa"

#North America
aggaqua$Continent[aggaqua$Country=="United States of America"]<-"North America"
aggaqua$Continent[aggaqua$Country=="Canada"]<-"North America"
aggaqua$Continent[aggaqua$Country=="Bermuda"]<-"North America"
aggaqua$Continent[aggaqua$Country=="Greenland"]<-"North America"
aggaqua$Continent[aggaqua$Country=="St. Pierre and Miquelon"]<-"North America"



#Europe and Central Asia
aggaqua$Continent[aggaqua$Country=="Azerbaijan"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Cyprus"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Kazakhstan"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Kyrgyzstan"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Tajikistan"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Turkmenistan"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Turkey"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Uzbekistan"]<-"EuCA"
aggaqua$Continent[aggaqua$Continent=="Europe"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Former USSR"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Former Czechoslovakia"]<-"EuCA"
aggaqua$Continent[aggaqua$Country=="Former Yugoslav SFR"]<-"EuCA"

#South Asia
aggaqua$Continent[aggaqua$Country=="Afghanistan"]<-"South Asia"
aggaqua$Continent[aggaqua$Country=="Bangladesh"]<-"South Asia"
aggaqua$Continent[aggaqua$Country=="Bhutan"]<-"South Asia"
aggaqua$Continent[aggaqua$Country=="India"]<-"South Asia"
aggaqua$Continent[aggaqua$Country=="Maldives"]<-"South Asia"
aggaqua$Continent[aggaqua$Country=="Nepal"]<-"South Asia"
aggaqua$Continent[aggaqua$Country=="Pakistan"]<-"South Asia"
aggaqua$Continent[aggaqua$Country=="Sri Lanka"]<-"South Asia"

#East Asia Pacific
aggaqua$Continent[aggaqua$Continent=="Asia"]<-"East Asia"
#aggaqua$Continent[aggaqua$Continent=="Oceania"]<-"East Asia and Pacific"



unique(aggaqua$Country[aggaqua$Continent=="North America"])








# #Main continents - inland aquaculture
# agginlandaqua$Continent <- countrycode(agginlandaqua$Country, origin = "country.name", destination = "continent", warn = T)
# agginlandaqua$Continent[agginlandaqua$Country=="RÃ©union"]<-"Africa"
# 
# 
# #SubSaharan Africa
# agginlandaqua$Continent[agginlandaqua$Continent=="Africa"]<-"SSA"
# 
# #MENA
# agginlandaqua$Continent[agginlandaqua$Country=="Algeria"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Bahrain"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Djibouti"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Eygpt"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Iran"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Iraq"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Israel"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Jordan"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Kuwait"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Lebanon"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Libya"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Malta"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Morocco"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Oman"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Qatar"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Syria"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Tunisia"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="United Arab Emirates"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="West Bank and Gaza"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Yemen"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Ethiopia"]<-"MENA"
# agginlandaqua$Continent[agginlandaqua$Country=="Sudan"]<-"MENA"
# 
# #Caribbean and Latin America
# agginlandaqua$Continent[agginlandaqua$Continent=="Americas"]<-"LACa"
# 
# #North America
# agginlandaqua$Continent[agginlandaqua$Country=="United States of America"]<-"North America"
# agginlandaqua$Continent[agginlandaqua$Country=="Canada"]<-"North America"
# agginlandaqua$Continent[agginlandaqua$Country=="Bermuda"]<-"North America"
# 
# 
# #Europe and Central Asia
# agginlandaqua$Continent[agginlandaqua$Country=="Azerbaijan"]<-"EuCA"
# agginlandaqua$Continent[agginlandaqua$Country=="Greenland"]<-"EuCA"
# agginlandaqua$Continent[agginlandaqua$Country=="Kazakhstan"]<-"EuCA"
# agginlandaqua$Continent[agginlandaqua$Country=="Kyrgyzstan"]<-"EuCA"
# agginlandaqua$Continent[agginlandaqua$Country=="Tajikistan"]<-"EuCA"
# agginlandaqua$Continent[agginlandaqua$Country=="Turkmenistan"]<-"EuCA"
# agginlandaqua$Continent[agginlandaqua$Country=="Uzbekistan"]<-"EuCA"
# agginlandaqua$Continent[agginlandaqua$Continent=="Europe"]<-"EuCA"
# 
# #South Asia
# agginlandaqua$Continent[agginlandaqua$Country=="Afghanistan"]<-"South Asia"
# agginlandaqua$Continent[agginlandaqua$Country=="Bangladesh"]<-"South Asia"
# agginlandaqua$Continent[agginlandaqua$Country=="Bhutan"]<-"South Asia"
# agginlandaqua$Continent[agginlandaqua$Country=="India"]<-"South Asia"
# agginlandaqua$Continent[agginlandaqua$Country=="Maldives"]<-"South Asia"
# agginlandaqua$Continent[agginlandaqua$Country=="Nepal"]<-"South Asia"
# agginlandaqua$Continent[agginlandaqua$Country=="Pakistan"]<-"South Asia"
# agginlandaqua$Continent[agginlandaqua$Country=="Sri Lanka"]<-"South Asia"
# 
# #East Asia Pacific
# agginlandaqua$Continent[agginlandaqua$Continent=="Asia"]<-"East Asia and Pacific"
# agginlandaqua$Continent[agginlandaqua$Continent=="Oceania"]<-"East Asia and Pacific"
# 
# 
# 
# 
# 
# 
# 
# #Main continents - marine aquaculture
# aggmarineaqua$Continent <- countrycode(aggmarineaqua$Country, origin = "country.name", destination = "continent", warn = T)
# aggmarineaqua$Continent[aggmarineaqua$Country=="RÃ©union"]<-"Africa"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Zanzibar"]<-"Africa"
# 
# 
# #SubSaharan Africa
# aggmarineaqua$Continent[aggmarineaqua$Continent=="Africa"]<-"SSA"
# 
# #MENA
# aggmarineaqua$Continent[aggmarineaqua$Country=="Algeria"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Bahrain"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Djibouti"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Eygpt"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Iran"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Iraq"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Israel"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Jordan"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Kuwait"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Lebanon"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Libya"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Malta"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Morocco"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Oman"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Qatar"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Syria"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Tunisia"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="United Arab Emirates"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="West Bank and Gaza"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Yemen"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Ethiopia"]<-"MENA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Sudan"]<-"MENA"
# 
# #Caribbean and Latin America
# aggmarineaqua$Continent[aggmarineaqua$Continent=="Americas"]<-"LACa"
# 
# #North America
# aggmarineaqua$Continent[aggmarineaqua$Country=="United States of America"]<-"North America"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Canada"]<-"North America"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Bermuda"]<-"North America"
# 
# 
# #Europe and Central Asia
# aggmarineaqua$Continent[aggmarineaqua$Country=="Azerbaijan"]<-"EuCA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Greenland"]<-"EuCA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Kazakhstan"]<-"EuCA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Kyrgyzstan"]<-"EuCA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Tajikistan"]<-"EuCA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Turkmenistan"]<-"EuCA"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Uzbekistan"]<-"EuCA"
# aggmarineaqua$Continent[aggmarineaqua$Continent=="Europe"]<-"EuCA"
# 
# #South Asia
# aggmarineaqua$Continent[aggmarineaqua$Country=="Afghanistan"]<-"South Asia"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Bangladesh"]<-"South Asia"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Bhutan"]<-"South Asia"
# aggmarineaqua$Continent[aggmarineaqua$Country=="India"]<-"South Asia"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Maldives"]<-"South Asia"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Nepal"]<-"South Asia"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Pakistan"]<-"South Asia"
# aggmarineaqua$Continent[aggmarineaqua$Country=="Sri Lanka"]<-"South Asia"
# 
# #East Asia Pacific
# aggmarineaqua$Continent[aggmarineaqua$Continent=="Asia"]<-"East Asia and Pacific"
# aggmarineaqua$Continent[aggmarineaqua$Continent=="Oceania"]<-"East Asia and Pacific"

rm(marinefisheries, marineaqua, inlandaqua, inlandfisheries, agginlandaqua, agginlandaqua2, agginlandfisheries, agginlandfisheries2, aggmarineaqua, aggmarineaqua2, aggmarinefisheries, aggmarinefisheries2)


```
#Method figure

```{r}
(method1<-ggplot(data=agglivestock[agglivestock$Country=="Germany",], aes(x=Year, y=Value))+geom_point()+stat_smooth(method="loess", level=0, span=0.6, colour="dodgerblue")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=11))+
   labs(x="Year", y=bquote(Production~(tonnes~x10^7)))+
   scale_y_continuous(labels = seq(3, 5.5, by=0.5), breaks = seq(3e+07, 5.5e+07, by=0.5e+07))+
   scale_x_continuous(labels=seq(1960, 2015, by=10), breaks = seq(1960, 2015, by=10)))

fit<-loess(Value~Year, data = agglivestock[agglivestock$Country=="Germany",], span=0.6)
Resids<-data.frame(Residuals=resid(fit)[2:53], lag1=resid(fit)[1:52])

(method2<-ggplot(data=Resids, aes(x=Residuals, y=lag1))+geom_point()+
  stat_smooth(method="lm", level=0, colour="dodgerblue")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=11))+
    labs(x=bquote(Residuals~(tonnes~x10^6)), y=bquote(Residuals[t-1]~(tonnes~x10^6)))+
    scale_x_continuous(breaks = seq(-3e+06, 3e+06, by=1e+06), labels = seq(-3, 3, by=1))+
    scale_y_continuous(breaks = seq(-3e+06, 3e+06, by=1e+06), labels = seq(-3, 3, by=1)))

fit2<-lm(Resids$Residuals~Resids$lag1)
Resids$CooksD <- cooks.distance(fit2)

(method3<-ggplot(data=Resids, aes(x=1:52, y=CooksD))+geom_point()+geom_line()+
  geom_hline(yintercept = 0.3, colour="firebrick", lty=2)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=11))+
  labs(x="Index", y="Cook's Distance"))


ggpubr::ggarrange(method1, method2, method3, nrow = 3, ncol=1, align="h", labels=c("a", "b", "c"))

ggplot2::ggsave(filename = "Methods.pdf", device=pdf, dpi=600, height = 8, width=7, scale=1.3)
ggplot2::ggsave(filename = "Methods.tiff", device="tiff", dpi=600, height = 8, width=7, units="in", scale=1.1)

```

#SENSITIVITY ANALYSES - Cooks Distance 
```{r}
#Crops

D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(D, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsNormal"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsSpan"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsDuration"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggcrops$Country))){
    Valscountry<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggcrops)
    
    #Cooks distance method 
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "CropsAv"












#Livestock

D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockNormal"



D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockSpan"



D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockDuration"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(agglivestock$Country))){
    Valscountry<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=agglivestock)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
      }  
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "LivestockAv"






#Fisheries

D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesNormal"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesSpan"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesDuration"




D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggfisheries$Country))){
    Valscountry<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggfisheries)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "FisheriesAv"









# #Marine fisheries
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     Valscountry<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=aggmarinefisheries)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Marine fisheries"
# 
# 
# #Inland fisheries
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     Valscountry<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=agginlandfisheries)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Inland fisheries"





#Aquaculture
D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureNormal"






D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.3, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureSpan"






D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>2){
        Prodaverage <- median(Valscountry[s],  Valscountry[s-1], Valscountry[s-2])#, Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureDuration"






D<-seq(0.05,1, by=0.05) #cooks distance vector
shocks<-c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value

for (d in D){
  shocks<-c()
  for (i in 1:length(levels(aggaqua$Country))){
    Valscountry<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(Valscountry ~ years, span=0.6, data=aggaqua)
    mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    Seq<-seq(1,52, by=1)
    for (s in Seq){
      if (cooks.distance(mod.err)[s]>d & s>6){
        Prodaverage <- mean(Valscountry[s],  Valscountry[s-1], Valscountry[s-2], Valscountry[s-3], Valscountry[s-4], Valscountry[s-5], Valscountry[s-6])
        Magnitude<-Prodaverage-Valscountry[s+1]
        if (Magnitude >0){
          shocks<-c(shocks,1)
        }
        
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
}
(sumofshocksacrossD) 

Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "AquacultureAv"





# #Marine aquaculture
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     Valscountry<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=aggmarineaqua)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Marine aquaculture"
# 
# 
# #Inland aquaculture
# 
# D<-seq(0.05,1, by=0.05) #cooks distance vector
# shocks<-c() #vector carrying tally of residuals over specified Cook's D
# sumofshocksacrossD<-c() #sum of shocks vector per cooks distance value
# 
# for (d in D){
#   shocks<-c()
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     Valscountry<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(Valscountry ~ years, span=0.6, data=agginlandaqua)
#     mod.err<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     Seq<-seq(1,52, by=1)
#     for (s in Seq){
#       if (cooks.distance(mod.err)[s]>d){
#         shocks<-c(shocks,1)
#       }
#     }
#   }
#   sumofshocksacrossD <-c(sumofshocksacrossD, sum(shocks))
# }
# (sumofshocksacrossD) 
# 
# Shocks.df <- cbind.data.frame(Shocks.df, sumofshocksacrossD)
# names(Shocks.df)[names(Shocks.df)=="sumofshocksacrossD"] <- "Inland aquaculture"

Cooks<-rep(Shocks.df$D,16)
Sector<-rep(c("Crops", "Livestock", "Fisheries", "Aquaculture"),1, each=80)
Change<-rep(c("Selected Model", "Span=0.3","3 year baseline", "Average=Mean" ), 4, each=20)
Shock.freq<- c(Shocks.df$CropsNormal, Shocks.df$CropsSpan, Shocks.df$CropsDuration, Shocks.df$CropsAv, Shocks.df$LivestockNormal, Shocks.df$LivestockSpan, Shocks.df$LivestockDuration, Shocks.df$LivestockAv, Shocks.df$FisheriesNormal, Shocks.df$FisheriesSpan, Shocks.df$FisheriesDuration, Shocks.df$FisheriesAv, Shocks.df$AquacultureNormal, Shocks.df$AquacultureSpan, Shocks.df$AquacultureDuration, Shocks.df$AquacultureAv)

Sens.Anal<-cbind.data.frame(Cooks, Sector, Change, Shock.freq)
Sens.Anal$Change<-factor(Sens.Anal$Change, levels(Sens.Anal$Change)[c(3,4,1,2)])

#Plot sensitivity analysis
p1<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Crops",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Crops", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

p2<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Livestock",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Livestock", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

p3<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Fisheries",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Fisheries", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

p4<-ggplot(data=Sens.Anal[Sens.Anal$Sector=="Aquaculture",], aes(x=Cooks, y=Shock.freq))+geom_line(aes(colour=Change), size=1)+
  labs(x="Cook's Distance threshold", y="No. of shocks detected", title = "Aquaculture", colour="")+
  theme_classic()+
  theme(panel.grid = element_blank(),
        plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
  scale_y_continuous(limits=c(0,550))+
  geom_vline(xintercept = 0.3, lty=2, colour="red")

# p2<-ggplot(data=Shocks.df, aes(x=D, y=CropsSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="No. of shocks detected")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p3<-ggplot(data=Shocks.df, aes(x=D, y=CropsDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="No. of shocks detected")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p4<-ggplot(data=Shocks.df, aes(x=D, y=CropsAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="No. of shocks detected")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# cropplot<-ggarrange(p1,p2,p3,p4, ncol=1, nrow = 4, align = "h")
# 
# 
# 
# 
# 
# p5<-ggplot(data=Shocks.df, aes(x=D, y=LivestockNormal))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "Livestock")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p6<-ggplot(data=Shocks.df, aes(x=D, y=LivestockSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p7<-ggplot(data=Shocks.df, aes(x=D, y=LivestockDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p8<-ggplot(data=Shocks.df, aes(x=D, y=LivestockAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# livestockplots<-ggarrange(p5, p6, p7, p8, ncol=1, nrow = 4, align="h")
# 
# 
# p9<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesNormal))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "Fisheries")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p10<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p11<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p12<-ggplot(data=Shocks.df, aes(x=D, y=FisheriesAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# fishplots<- ggarrange(p9, p10, p11, p12, nrow=4, ncol=1, align = "h")
# 
# 
# 
# p13<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureNormal))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "Aquaculture")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p14<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureSpan))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# p15<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureDuration))+geom_bar(stat = "identity")+
#   labs(x="", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p16<-ggplot(data=Shocks.df, aes(x=D, y=AquacultureAv))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold", y="", title = "")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0, 550))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# aquaplots<- ggarrange(p13, p14, p15, p16, nrow=4, ncol=1, align = "h")
# 
# toprow<-ggarrange(p1,p5,p9,p13, nrow=1,ncol = 4, align="v")
# toprow<-annotate_figure(toprow, left =text_grob("Selected Model", vjust = 0.5, color="black"))
# 
# secondrow<-ggarrange(p2,p6,p10,p14, nrow=1,ncol = 4, align="v")
# secondrow<-annotate_figure(secondrow, left =text_grob("Model span=0.3", vjust = 0.5, color="black"))
# 
# thirdrow<-ggarrange(p3,p7,p11,p15, nrow=1,ncol = 4, align="v")
# thirdrow<-annotate_figure(thirdrow, left =text_grob("Baseline = 3 yrs", vjust = 0.5, color="black"))
# 
# bottomrow<-ggarrange(p4,p8,p12,p16, nrow=1,ncol = 4, align="v")
# bottomrow<-annotate_figure(bottomrow, left =text_grob("Average = Mean", vjust = 0.5, color="black"))
# 
grid<-ggarrange(p1, p2, p3, p4, ncol=2, nrow = 2, align = "hv")

ggsave(filename = "Cooksdistance sensitivity.tiff", dpi = 600, device="tiff", width = 10, height=7)

# 
# p3<-ggplot(data=Shocks.df, aes(x=D, y=`Marine fisheries`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Marine fisheries")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p4<-ggplot(data=Shocks.df, aes(x=D, y=`Inland fisheries`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Inland fisheries")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p5<-ggplot(data=Shocks.df, aes(x=D, y=`Marine aquaculture`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Marine aquaculture")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")
# 
# 
# p6<-ggplot(data=Shocks.df, aes(x=D, y=`Inland aquaculture`))+geom_bar(stat = "identity")+
#   labs(x="Cooks distance threshold (D)", y="No. of shocks detected", title = "Inland aquaculture")+
#   theme_classic()+
#   theme(panel.grid = element_blank(),
#         plot.title = element_text(hjust = 0.5, vjust = -0.75, face="bold"))+
#   scale_y_continuous(limits=c(0,1200))+
#   geom_vline(xintercept = 0.3, lty=2, colour="red")





ggsave("Sensitivity Analyses.tiff", device = "tiff", dpi = 600, width=140, height = 100, units="mm", scale=1.5)


```
#SENSITIVITY ANALYSES AROUND OTHER PARAMETERS

Parameters checked = 

- mean or median time span for shock to drop from
- duration of previous average (3,5,7,9 years)
- LOESS span (0, 0.25, 0.33, 0.5, 0.66, 0.75, 1, 1.5, 2)

```{r}
# AICC FUNCTION FOR LOESS MODELS
aicc.loess <- function(x) {
    # compute AIC_C for a LOESS fit, from:
    #
    # Hurvich, C.M., Simonoff, J.S., and Tsai, C. L. 1998. Smoothing
    # parameter selection in nonparametric regression using an improved
    # Akaike Information Criterion. Journal of the Royal Statistical
    # Society B 60: 271-293.
    #
    # @param fit        loess fit
    # @return           'aicc' value
    stopifnot(inherits(x, 'loess'))
    # parameters
    n <- x$n
    trace <- x$trace.hat
    sigma2 <- sum(resid(fit) ^ 2) / (n - 1)
    return(log(sigma2) + 1 + (2 * (trace + 1)) / (n - trace - 2))
}

## METHOD WITH MANUAL ALTERATIONS TO MODEL SPAN

shocks <- data.frame() 

years <- seq(1961,2013,by=1)
span <-c(0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8)

for (s in 1:length(span)){
  #CROPS
  #3 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
  
   #Identify the Shock
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
  

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
        PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   
  
  #5 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


#7 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k])) # ,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  # 9 year median
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #3 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   

#5 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   


#7 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   

# 9 year mean
  for (i in 1:length(levels(aggcrops$Country))){
    values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Crops"
        SubSector<-"Crops" 
        Country<-levels(aggcrops$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }   












#LIVESTOCK

#3 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year median
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #3 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year mean
  for (i in 1:length(levels(agglivestock$Country))){
    values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Livestock"
        SubSector<-"Livestock" 
        Country<-levels(agglivestock$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }








#FISHERIES

#3 year median
  
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year median
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year median
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year median
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #3 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  #5 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  
  #7 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
  
  # 9 year mean
  for (i in 1:length(levels(aggfisheries$Country))){
    values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
    
     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]
  
    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Fisheries"
        #SubSector<-"Marine fisheries" 
        Country<-levels(aggfisheries$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }



# #MARINE FISHERIES
# 
# #3 year median
#   
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(aggmarinefisheries$Country))){
#     values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Marine fisheries" 
#         Country<-levels(aggmarinefisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# #INLAND FISHERIES
# 
# 
# #3 year median
#     for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(agginlandfisheries$Country))){
#     values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Fisheries"
#         SubSector<-"Inland fisheries" 
#         Country<-levels(agginlandfisheries$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6], values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }



  
  
  
  
  
  
#AQUACULTURE

#3 year median
    for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 3
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  #5 year median
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 5
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #7 year median
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 7
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  # 9 year median
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Median"
        BaseComp<- 9
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k],values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #3 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>2]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 3
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  #5 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>4]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 5
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }


  #7 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>6]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 7
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k]))#,values[shockInd-7],values[shockInd-8]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }

  # 9 year mean
  for (i in 1:length(levels(aggaqua$Country))){
    values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
    fit<-loess(values ~ years, span=span[s])
    errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])

     #Identify the Shock
    shockInd<-which(as.vector(cooks.distance(errors)>0.3))
    shockInd<-shockInd[shockInd>8]

    if (length(shockInd)>0){
      for (k in 1:length(shockInd)){
        Fit <- aicc.loess(fit)
        Span <- span[s]
        Average<-"Mean"
        BaseComp<- 9
        Sector<-"Aquaculture"
        #SubSector<-"Inland aquaculture"
        Country<-levels(aggaqua$Country)[i]
        Year<-years[shockInd+1][k]
        fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k], values[shockInd-6][k], values[shockInd-7][k],values[shockInd-8][k]))
        AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
        PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
        Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
        data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector,  Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }









# #INLAND AQUACULTURE
# 
# #3 year median
#     for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(agginlandaqua$Country))){
#     values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Inland aquaculture" 
#         Country<-levels(agginlandaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6], values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# 
# 
# 
# 
# 
# 
# #MARINE AQUACULTURE
# 
# #3 year median
#     for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year median
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year median
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year median
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Median"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6],values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #3 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>2]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 3
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k]))#, values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   #5 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>4]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 5
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))#, values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   
#   #7 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>6]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 7
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6]))#,values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
#   
#   # 9 year mean
#   for (i in 1:length(levels(aggmarineaqua$Country))){
#     values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#     fit<-loess(values ~ years, span=span[s])
#     errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#     
#      #Identify the Shock
#     shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#     shockInd<-shockInd[shockInd>8]
#   
#     if (length(shockInd)>0){
#       for (k in 1:length(shockInd)){
#         Fit <- aicc.loess(fit)
#         Span <- span[s]
#         Average<-"Mean"
#         BaseComp<- 9
#         Sector<-"Aquaculture"
#         SubSector<-"Marine aquaculture" 
#         Country<-levels(aggmarineaqua$Country)[i]
#         Year<-years[shockInd+1][k]
#         fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4], values[shockInd-5], values[shockInd-6], values[shockInd-7],values[shockInd-8]))
#         AbsMagnitude<-fiveyearmean-values[shockInd+1][k]
#         PropMagnitude <-1-((values[shockInd+1][k])/fiveyearmean)
#         Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#         data<-cbind.data.frame(Fit, Span, Average, BaseComp, Sector, SubSector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
}

shocks<-shocks[shocks$AbsMagnitude>0,]
summary(shocks)

shocks$Span <- as.factor(shocks$Span)
# levels(shocks$Span)[levels(shocks$Span)=="0.333333333333333" ] <-"0.33"
# levels(shocks$Span)[levels(shocks$Span)=="0.666666666666667" ] <-"0.67"


#Rank fit of span by country, and subsector so largest values get highest rank (using alpha for ggplot) 
shocks2 <- shocks %>%
  group_by(Sector, Country) %>%
  mutate(Rank=rank(desc(Fit), ties.method="min"))

shocks2 <- shocks2[,c(11, 1:10)]
shocks2 <- shocks2[order(shocks2$Country, shocks2$Sector, shocks2$Span),]

shocks2 <-as.data.frame(shocks2)

# #Need to scale ranks for each country-subsector combination to make comparable
# 
# Scaled <- c()
# 
# for (i in 1:length(levels(shocks2$Country))){
#   for (k in 1:length(levels(shocks2$SubSector))){
#     Ranks <- shocks2$Rank[shocks2$Country==levels(shocks2$Country)[i] & shocks2$SubSector==levels(shocks2$SubSector)[k]]
#     Scaled <- c(Scaled, ((Ranks-min(Ranks))/(max(Ranks)-min(Ranks))))
#   }
# }
# 
# shocks2 <- cbind.data.frame(Scaled, shocks2)


shocksovertime <-data.frame(table(shocks2$Year, shocks2$BaseComp, shocks2$Average, shocks2$Span))
names(shocksovertime)[names(shocksovertime)=="Var1"] <-"Year"
names(shocksovertime)[names(shocksovertime)=="Var2"] <-"Duration"
names(shocksovertime)[names(shocksovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(shocksovertime)[names(shocksovertime)=="Var4"] <-"Span"


shocksovertime$Freq <- as.numeric(shocksovertime$Freq)
shocksovertime$Year <- as.numeric(levels(shocksovertime$Year))[shocksovertime$Year]

#cbbPalette <- c("#000000",  "#009E73", "#0072B2", "#D55E00") #colorblind palette

#plot for all lines 
ggplot(data = shocksovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line(alpha=0.3)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency")

ggsave(filename = "Sensitivity analysis - all ensemble lines with aqua.pdf", device = pdf, dpi=600, width=7, height=5)

#ggsave(filename = "Sensitivity analysis - all ensemble lines wo aqua.pdf", device = pdf, dpi=600, width=7, height=5)

#PLOT WITH CONFIDENCE INTERVALS

#minimum and maximum of all ensembles
mins <- tapply(shocksovertime$Freq, INDEX = shocksovertime$Year, FUN = min)
maxs <- tapply(shocksovertime$Freq, INDEX = shocksovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(shocks$Year, interaction(shocks$Average, shocks$Span, shocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = median))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]

#which model minimises the Sum of squares

SSResids <- function(x){
  model <- lm(x~av.shocks$Freq)
  SSR <-sum(residuals(model)^2)
  return(SSR)
}


order(tapply(X = shocksovertime$Freq, INDEX= interaction(shocksovertime$Duration, shocksovertime$Average,shocksovertime$Span), FUN = SSResids))

(tapply(X = shocksovertime$Freq, INDEX= interaction(shocksovertime$Duration, shocksovertime$Average,shocksovertime$Span), FUN = SSResids))[35]
                  
av.shocks$actual <-shocksovertime$Freq[shocksovertime$Span==0.6 & shocksovertime$Average=="Median"& shocksovertime$Duration==7] 

TotalN<-(CropsN$CropsN+LivestockN$LivestockN+FisheriesN$FisheriesN+AquacultureN$AquacultureN)

av.shocks$N<-TotalN[4:53]
av.shocks$Rate<-av.shocks$actual/av.shocks$N
av.shocks$min.Rate<-av.shocks$mins/av.shocks$N
av.shocks$max.Rate<-av.shocks$maxs/av.shocks$N

#all sectors model selection plot - FREQUENCY ONLY
FreqShocks<-ggplot(data=av.shocks, aes(x=Year, y=Freq))+
  geom_ribbon(aes(ymin=mins, ymax=maxs), fill="grey")+
  geom_line(colour="grey10", size=0.5, linetype=2)+
  geom_line(aes(y=actual), colour="Red")+
  theme_bw()+
  theme(panel.background = element_blank(),
        panel.grid = element_blank())+
  labs(x=bquote(bold(Year)), y=bquote(bold(Shock~frequency)))


ggsave(filename = "Sensitivity analysis - total freq with confidence.tiff", device = "tiff", dpi=600, width=6, height=4)

#ggsave(filename = "Sensitivity analysis - total freq with confidence wo aqua.tiff", device = "tiff", dpi=600, width=6, height=4)

RateShocks<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=min.Rate, ymax=max.Rate), fill="grey")+
  geom_line(aes(y=Rate), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits = c(0,0.05))+
  theme(panel.background = element_blank(),
        panel.grid = element_blank())+
  labs(x=bquote(bold(Year)), y=bquote(bold(Shock~rate)))

ggsave(filename = "Sensitivity analysis - total rate with confidence.tiff", device = "tiff", dpi=600, width=6, height=4)

#ggsave(filename = "Sensitivity analysis - total rate with confidence wo aquaculture.tiff", device = "tiff", dpi=600, width=6, height=4)


```

#Conduct analyses with 7 year median/ LOESS span =0.6

#Crop analysis
```{r}

#CROP SHOCKS

years<-seq(1961, 2013, by=1)
shocks<-data.frame()


pdf(file="LOESS Shock Analysis 2 - crops.pdf")
for (i in 1:length(levels(aggcrops$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(aggcrops$Value, aggcrops$Country==levels(aggcrops$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggcrops$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Crops"
      Country<-levels(aggcrops$Country)[i]
      Region <- aggcrops$Continent[aggcrops$Country==levels(aggcrops$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)


```

#livestock analysis

```{r}
#LIVESTOCK SHOCKS

pdf(file="LOESS Shock Analysis 2 - livestock.pdf")
for (i in 1:length(levels(agglivestock$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(agglivestock$Value, agglivestock$Country==levels(agglivestock$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agglivestock$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Livestock"
      Country<-levels(agglivestock$Country)[i]
      Region <- agglivestock$Continent[agglivestock$Country==levels(agglivestock$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector,  Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)


 
```

#fisheries analysis

```{r}
#FISHERIES SHOCKS

pdf(file="LOESS Shock Analysis 2 - fisheries.pdf")
for (i in 1:length(levels(aggfisheries$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(aggfisheries$Value, aggfisheries$Country==levels(aggfisheries$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggfisheries$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Fisheries"
      Country<-levels(aggfisheries$Country)[i]
      Region <- aggfisheries$Continent[aggfisheries$Country==levels(aggfisheries$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)


```

#aquaculture analysis

```{r}
#TOTAL AQUACULTURE SHOCKS

pdf(file="LOESS Shock Analysis 2 - aquaculture.pdf")
for (i in 1:length(levels(aggaqua$Country))){
  op<-par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values<-subset(aggaqua$Value, aggaqua$Country==levels(aggaqua$Country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggaqua$Country)[i], pch=20, cex=0.75)
  fit<-loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
  plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
  abline(errors)
  
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector<-"Aquaculture"
      Country<-levels(aggaqua$Country)[i]
      Region <- aggaqua$Continent[aggaqua$Country==levels(aggaqua$Country)[i]][1]
      Year<-years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k], values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data<-cbind.data.frame(Sector,  Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks<-rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)

shocks<-shocks[shocks$AbsMagnitude>0,]

shocks$Codes <- countrycode(shocks$Country, origin = "country.name", destination = "iso3c", warn=T )
shocks$Codes[shocks$Country=="Réunion"] <- "REU"
shocks$Codes[shocks$Country=="Former Yugoslav SFR"] <- "BIH"

write.csv(x= shocks, file = "Shocks.write.copy.csv", row.names = F)
```

#DISAGGREGATED FISHERIES ANALYSIS

```{r}
#DISAGGREGATED FISHERIES SECTORS


# #INLAND FISHERIES SHOCKS
# 
# pdf(file="LOESS Shock Analysis 2 - inland fisheries.pdf")
# for (i in 1:length(levels(agginlandfisheries$Country))){
#   op<-par(mfrow=c(3, 1))
#   
#   #Production plot with model fit
#   values<-subset(agginlandfisheries$Value, agginlandfisheries$Country==levels(agginlandfisheries$Country)[i])
#   plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agginlandfisheries$Country)[i], pch=20, cex=0.75)
#   fit<-loess(values ~ years, span=0.6)
#   lines(years, predict(fit))
#   
#   #regress residuals against lag-1 residuals
#   errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#   plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
#   abline(errors)
#   
#   #plot cooks distance and identify outliers in residual regression
#   plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
#   abline(h=0.3, lty=2, col="red", lwd=2)
#   par(op)
#   
#   #Identify the Shock
#   shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#   shockInd<-shockInd[shockInd>4]
#   
#   
# 
#   if (length(shockInd)>0){
#     for (k in 1:length(shockInd)){
#       Sector<-"Fisheries"
#       SubSector<-"Inland fisheries" 
#       Country<-levels(agginlandfisheries$Country)[i]
#       Region <- agginlandfisheries$Continent[agginlandfisheries$Country==levels(agginlandfisheries$Country)[i]][1]
#       Year<-years[shockInd+1][k]
#       fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))
#       AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
#       PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
#       Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#       data<-cbind.data.frame(Sector, SubSector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# dev.off()
# summary(shocks)
# 
# 
# 
# 
# 
# 
# #MARINE FISHERIES SHOCKS
# 
# pdf(file="LOESS Shock Analysis 2 - marine fisheries.pdf")
# for (i in 1:length(levels(aggmarinefisheries$Country))){
#   op<-par(mfrow=c(3, 1))
#   
#   #Production plot with model fit
#   values<-subset(aggmarinefisheries$Value, aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i])
#   plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggmarinefisheries$Country)[i], pch=20, cex=0.75)
#   fit<-loess(values ~ years, span=0.6)
#   lines(years, predict(fit))
#   
#   #regress residuals against lag-1 residuals
#   errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#   plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
#   abline(errors)
#   
#   #plot cooks distance and identify outliers in residual regression
#   plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
#   abline(h=0.3, lty=2, col="red", lwd=2)
#   par(op)
#   
#   #Identify the Shock
#   shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#   shockInd<-shockInd[shockInd>4]
#   
#   
# 
#   if (length(shockInd)>0){
#     for (k in 1:length(shockInd)){
#       Sector<-"Fisheries"
#       SubSector<-"Marine fisheries" 
#       Country<-levels(aggmarinefisheries$Country)[i]
#       Region <- aggmarinefisheries$Continent[aggmarinefisheries$Country==levels(aggmarinefisheries$Country)[i]][1]
#       Year<-years[shockInd+1][k]
#       fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))
#       AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
#       PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
#       Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#       data<-cbind.data.frame(Sector, SubSector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# dev.off()
# summary(shocks)



```

#DISAGGREGATED AQUACULTURE ANALYSIS

```{r}
# #DISAGGREGATED AQUAUCULTURE SHOCKS
# 
# 
# pdf(file="LOESS Shock Analysis 2 -  inland aquaculture.pdf")
# for (i in 1:length(levels(agginlandaqua$Country))){
#   op<-par(mfrow=c(3, 1))
#   
#   #Production plot with model fit
#   values<-subset(agginlandaqua$Value, agginlandaqua$Country==levels(agginlandaqua$Country)[i])
#   plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(agginlandaqua$Country)[i], pch=20, cex=0.75)
#   fit<-loess(values ~ years, span=0.6)
#   lines(years, predict(fit))
#   
#   #regress residuals against lag-1 residuals
#   errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#   plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
#   abline(errors)
#   
#   #plot cooks distance and identify outliers in residual regression
#   plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
#   abline(h=0.3, lty=2, col="red", lwd=2)
#   par(op)
#   
#   #Identify the Shock
#   shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#   shockInd<-shockInd[shockInd>4]
#   
#   
# 
#   if (length(shockInd)>0){
#     for (k in 1:length(shockInd)){
#       Sector<-"Aquaculture"
#       SubSector<-"Inland aquaculture" 
#       Country<-levels(agginlandaqua$Country)[i]
#       Region <- agginlandaqua$Continent[agginlandaqua$Country==levels(agginlandaqua$Country)[i]][1]
#       Year<-years[shockInd+1][k]
#       fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))
#       AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
#       PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
#       Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#       data<-cbind.data.frame(Sector, SubSector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# dev.off()
# summary(shocks)
# 
# 
# 
# 
# 
# 
# #MARINE AQUACULTURE SHOCKS
# 
# pdf(file="LOESS Shock Analysis 2 - marine aquaculture.pdf")
# for (i in 1:length(levels(aggmarineaqua$Country))){
#   op<-par(mfrow=c(3, 1))
#   
#   #Production plot with model fit
#   values<-subset(aggmarineaqua$Value, aggmarineaqua$Country==levels(aggmarineaqua$Country)[i])
#   plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=levels(aggmarineaqua$Country)[i], pch=20, cex=0.75)
#   fit<-loess(values ~ years, span=0.6)
#   lines(years, predict(fit))
#   
#   #regress residuals against lag-1 residuals
#   errors<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
#   plot(resid(fit)[2:53], resid(fit)[1:52], pch=20, main="", xlab=expression(bold("Residuals")[(italic ("t"))]),ylab=expression(bold("Residuals")[(italic("t -1"))]))
#   abline(errors)
#   
#   #plot cooks distance and identify outliers in residual regression
#   plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
#   abline(h=0.3, lty=2, col="red", lwd=2)
#   par(op)
#   
#   #Identify the Shock
#   shockInd<-which(as.vector(cooks.distance(errors)>0.3))
#   shockInd<-shockInd[shockInd>4]
#   
#   
# 
#   if (length(shockInd)>0){
#     for (k in 1:length(shockInd)){
#       Sector<-"Aquaculture"
#       SubSector<-"Marine aquaculture" 
#       Country<-levels(aggmarineaqua$Country)[i]
#       Region <- aggmarineaqua$Continent[aggmarineaqua$Country==levels(aggmarineaqua$Country)[i]][1]
#       Year<-years[shockInd+1][k]
#       fiveyearmean<-mean(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3], values[shockInd-4]))
#       AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
#       PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
#       Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
#       data<-cbind.data.frame(Sector, SubSector, Country, Region, Year, PropMagnitude, AbsMagnitude, Recovery)
#       shocks<-rbind(shocks, data)
#       }
#     }
#   }
# dev.off()
# summary(shocks)


shocks<-shocks[shocks$AbsMagnitude>0,]

write.csv(x= shocks, file = "Shocks.write.copy.csv", row.names = F)



```


##Sector wise symbols

```{r}
cropimg<-readPNG("crops.png")
cropimg<-rasterGrob(cropimg, interpolate = T)

cowimg<-readPNG("cow.png")
cowimg<-rasterGrob(cowimg, interpolate = T)

fishingimg<-readPNG("fishingboat.png")
fishingimg<-rasterGrob(fishingimg, interpolate = T)

# fishimg<-readPNG("tuna1.png")
# fishimg<-rasterGrob(fishimg, interpolate = T)

aquaimg<-readPNG("Aquapen.png")
aquaimg<-rasterGrob(aquaimg, interpolate = T)

```


#Import shocks with drivers and tidy
```{r}

shockdrivers <- read.csv("shocksanddrivers2.csv", header=T)
shockdrivers <- shockdrivers[,1:11]
names(shockdrivers)[11]<-"Category"
shockdrivers$Country<-as.character(shockdrivers$Country)
shockdrivers$Region<-as.character(shockdrivers$Region)

#shockdrivers<-shockdrivers[shockdrivers$Country!="Haiti",]
#Replacements<-countrycode(shockdrivers$Country[shockdrivers$Region=="East Asia and Pacific"], origin = "country.name", destination = "continent", warn = T)

#shockdrivers$Region[shockdrivers$Region=="East Asia and Pacific"]<-Replacements
shockdrivers$Region[shockdrivers$Region=="Asia"]<-"East Asia"
shockdrivers$Region[shockdrivers$Country=="Iran (Islamic Republic of)"]<-"MENA"
shockdrivers$Region[shockdrivers$Country=="Syrian Arab Republic" ]<-"MENA" 
shockdrivers$Region[shockdrivers$Country=="Saudi Arabia" ]<-"MENA" 
shockdrivers$Region[shockdrivers$Country=="Turkey" ]<-"EuCA"
shockdrivers$Region[shockdrivers$Country=="St. Pierre and Miquelon" ]<-"EuCA"

shockdrivers$Country<-as.factor(shockdrivers$Country)
shockdrivers$Region<-as.factor(shockdrivers$Region)


#Take out not shocks 13 in total
shockdrivers <- shockdrivers[shockdrivers$Driver!="Not a shock",]
shockdrivers <- shockdrivers[shockdrivers$Driver!="Not a shock ",]


shockdrivers$Category <- as.character(shockdrivers$Category)
shockdrivers$Category[shockdrivers$Driver=="Unknown driver to carp production decline"]<-"Unknown"
shockdrivers$Category[shockdrivers$Driver=="Unknown"]<-"Unknown"

#Climate events
shockdrivers$Category[shockdrivers$Category=="Climate/ Weather"] <- "Climate/weather events"
shockdrivers$Category[shockdrivers$Category=="Climate/ Weather "] <- "Climate/weather events"
shockdrivers$Category[shockdrivers$Category=="Climate/weather"] <- "Climate/weather events"
shockdrivers$Category[shockdrivers$Category=="Climate/weather "] <- "Climate/weather events"
shockdrivers$Category[shockdrivers$Category=="Climate/ weather "] <- "Climate/weather events"

#Climate/weather & geopolitical/economic
shockdrivers$Category[shockdrivers$Category=="Economic and climate/weather "] <- "Climate/weather & geopolitical/economic events"
shockdrivers$Category[shockdrivers$Category=="Climate/weather & economic  " ] <- "Climate/weather & geopolitical/economic events"
shockdrivers$Category[shockdrivers$Category=="Geopolitical and climate/weather " ] <- "Climate/weather & geopolitical/economic events"

#Climate/weather and mismanagement
shockdrivers$Category[shockdrivers$Category=="Climate/weather and mismanagement "] <- "Climate/weather events & mismanagement"
shockdrivers$Category[shockdrivers$Category=="Climate/ weather and mismanagement "] <- "Climate/weather events & mismanagement"
shockdrivers$Category[shockdrivers$Country=="Democratic People's Republic of Korea" & shockdrivers$Sector=="Crops" & shockdrivers$Year==1996] <- "Mismanagement"


#Geopolitical/economic events
shockdrivers$Category[shockdrivers$Category=="Geopolitical " ] <- "Geopolitical/economic events"
shockdrivers$Category[shockdrivers$Category=="Economic" ] <- "Geopolitical/economic events"
shockdrivers$Category[shockdrivers$Category=="Geopolitical"] <- "Geopolitical/economic events"
shockdrivers$Category[shockdrivers$Category=="Economic " ] <- "Geopolitical/economic events"



#Mismanagement
shockdrivers$Category[shockdrivers$Category=="Mismanagement " ] <- "Mismanagement"
shockdrivers$Category[shockdrivers$Category=="Mismanagment " ] <- "Mismanagement"
shockdrivers$Category[shockdrivers$Category=="Mismanagment" ] <- "Mismanagement"
shockdrivers$Category[shockdrivers$Category=="MIsmanagement " ] <- "Mismanagement"
shockdrivers$Category[shockdrivers$Country=="Antigua and Barbuda" & shockdrivers$Sector=="Fisheries" & shockdrivers$Year==1981] <- "Mismanagement"
shockdrivers$Category[shockdrivers$Category=="Overfishing and mismanagement"] <- "Mismanagement"
shockdrivers$Category[shockdrivers$Category=="From Gehpart " ] <- "Mismanagement"


#Mismanagement & policy change
shockdrivers$Category[shockdrivers$Category=="Mismanagment and policy change " ] <- "Mismanagement & policy change"
shockdrivers$Category[shockdrivers$Category=="Mismanagement and policy change "  ] <- "Mismanagement & policy change"
shockdrivers$Category[shockdrivers$Category=="Mismanagement and policy change"  ] <- "Mismanagement & policy change"                               


#policy change
shockdrivers$Category[shockdrivers$Category=="Policy change "  ] <- "Policy change"


#Mismanagement and geopolitical/economic events
shockdrivers$Category[shockdrivers$Category=="Mismanagement and geopolitical "  ] <- "Mismanagement & geopolitical/economic events"
shockdrivers$Category[shockdrivers$Category=="MIsmanagement and geopolitical "  ] <- "Mismanagement & geopolitical/economic events"

#Other - disease, pulse fisheries, geological events
shockdrivers$Category[shockdrivers$Category=="Biological " ] <- "Other"
shockdrivers$Category[shockdrivers$Category=="Biological" ] <- "Other"
shockdrivers$Category[shockdrivers$Category=="Geological " ] <- "Other"
shockdrivers$Category[shockdrivers$Category=="Geological" ] <- "Other"

#missing
shockdrivers$Category[shockdrivers$Country=="Sao Tome and Principe" & shockdrivers$Sector=="Livestock"] <- "Geopolitical/economic events"
shockdrivers$Category[shockdrivers$Country=="Albania"] <- "Geopolitical/economic events"
shockdrivers$Category[shockdrivers$Country=="Iraq" & shockdrivers$Sector=="Aquaculture"] <- "Geopolitical/economic events"
shockdrivers$Category[shockdrivers$Country=="Saint Lucia" & shockdrivers$Sector=="Aquaculture"] <- "Policy change"
shockdrivers$Category[shockdrivers$Category==""]<-"Geopolitical/economic events"

unique(shockdrivers$Category)
shockdrivers$Category <-as.factor(shockdrivers$Category)
levels(shockdrivers$Category)

shockdrivers$Category<-factor(shockdrivers$Category,levels(shockdrivers$Category)[c(2,3,1, 4, 6, 5, 7, 9, 8, 10)])
levels(shockdrivers$Category)

shockdrivers <-shockdrivers[shockdrivers$Sector!="",]
shockdrivers$Sector <-as.character(shockdrivers$Sector)
shockdrivers$Sector <- as.factor(shockdrivers$Sector)
shockdrivers$Sector <- factor(shockdrivers$Sector, levels(shockdrivers$Sector)[c(2,4,3,1)])


#update with Oceania

shockdrivers[shockdrivers$Region=="East Asia and Pacific",]

shockdrivers$Recovery2<-shockdrivers$Recovery
shockdrivers$Year<-as.numeric(shockdrivers$Year)
shockdrivers$Recovery2[is.na(shockdrivers$Recovery2)]<-2013-shockdrivers$Year[is.na(shockdrivers$Recovery2)]
shockdrivers$Recovery2[shockdrivers$Recovery2==0]<-1
levels(shockdrivers$Region)[levels(shockdrivers$Region)=="CaLA"]<-"LACa"

#Final touch ups from supplementary review of drivers
shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Bermuda"]<-"Unknown"
shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Comoros"]<-"Unknown"
shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Democratic People's Republic of Korea"]<-"Climate/weather events & mismanagement"
shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Guam"]<-"Unknown"
shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Libya"]<-"Unknown"
shockdrivers$Category[shockdrivers$Sector=="Crops" & shockdrivers$Country=="Saudi Arabia"]<-"Policy change"
shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Belize"]<-"Unknown"
#shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="China, Macao SAR"]<-"Other"
shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Guam"]<-"Climate/weather & geopolitical/economic events"

shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Democratic People's Republic of Korea" & shockdrivers$Year==1997]<-"Climate/weather events & mismanagement"
shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Greenland"]<-"Mismanagement & policy change"
shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Malawi"]<-"Climate/weather & geopolitical/economic events"
#shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Republic of Korea"]<-"Other"
shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Sao Tome and Principe"]<-"Unknown"
shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Sri Lanka" & shockdrivers$Year==1998]<-"Unknown"
shockdrivers$Category[shockdrivers$Sector=="Livestock" & shockdrivers$Country=="Timor-Leste"]<-"Climate/weather & geopolitical/economic events"
shockdrivers$Category[shockdrivers$Sector=="Fisheries" & shockdrivers$Country=="Solomon Islands"]<-"Mismanagement & geopolitical/economic events"
shockdrivers$Category[shockdrivers$Sector=="Aquaculture" & shockdrivers$Country=="Jamaica"]<-"Unknown"
shockdrivers$Category[shockdrivers$Sector=="Aquaculture" & shockdrivers$Country=="Saint Lucia"]<-"Unknown"



#Exclude reunion aquaculture shock (not a shock - gradual decline before a big jump)
shockdrivers<-shockdrivers[!(shockdrivers$Sector=="Aquaculture" & shockdrivers$Country=="RÃ©union"),]

#Rescale recovery times between 0 and 1 for chord plots

shockdrivers$Scaled.recovery<-NA
shockdrivers$Scaled.recovery<-(shockdrivers$Recovery2-min(shockdrivers$Recovery2))/(max(shockdrivers$Recovery2)-min(shockdrivers$Recovery2))
shockdrivers$Scaled.recovery[shockdrivers$Scaled.recovery==0]<-0.01



write.csv(shockdrivers, file = "Shocks and drivers tidy2.csv", row.names = F)

shockcategories<-data.frame(table(shockdrivers$Category, shockdrivers$Sector))

shockcategories$Total[shockcategories$Var2=="Aquaculture"]<- sum(shockcategories$Freq[shockcategories$Var2=="Aquaculture"])
shockcategories$Total[shockcategories$Var2=="Crops"]<- sum(shockcategories$Freq[shockcategories$Var2=="Crops"])
shockcategories$Total[shockcategories$Var2=="Livestock"]<- sum(shockcategories$Freq[shockcategories$Var2=="Livestock"])
shockcategories$Total[shockcategories$Var2=="Fisheries"]<- sum(shockcategories$Freq[shockcategories$Var2=="Fisheries"])
shockcategories$Prop <- shockcategories$Freq/ shockcategories$Total

levels(shockdrivers$Category)


```


#Figure 1 - MAPPING SHOCK RATES 

```{r}
#Get shock rates per region per sector

Country<-levels(aggcrops$Country)
Codes<- countrycode(levels(aggcrops$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(aggcrops$Country), origin = "country.name", destination = "continent")
cropsSR<-cbind.data.frame(Country, Codes, Continent)
cropsSR$Continent <-as.character(cropsSR$Continent)


cropsSR$Continent[cropsSR$Code=="BHR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="IRN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="IRQ"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="SAU"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="ARE"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="KWT"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="QAT"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="LBN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="JOR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="DZA"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="LBY"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="SYR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="EGY"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="MAR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="TUN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="DZA"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="ISR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="JOR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="MLT"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="MAR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="PSE"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="OMN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="SYR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="ARE"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
cropsSR$Continent[cropsSR$Code=="BMU"]<-"North America"
cropsSR$Continent[cropsSR$Code=="GRL"]<-"North America"
cropsSR$Continent[cropsSR$Code=="USA"]<-"North America"
cropsSR$Continent[cropsSR$Code=="CAN"]<-"North America"
cropsSR$Continent[cropsSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
cropsSR$Continent[cropsSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
cropsSR$Continent[cropsSR$Continent=="Europe"]<-"Europe and Central Asia"
cropsSR$Continent[cropsSR$Code=="CYP"]<-"Europe and Central Asia"
cropsSR$Continent[cropsSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
cropsSR$Continent[cropsSR$Code=="BTN"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="AFG"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="IND"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="LKA"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="MDV"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="BGD"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="PAK"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="NPL"]<-"South Asia"

#East Asia
cropsSR$Continent[cropsSR$Continent=="Asia"]<-"East Asia"
cropsSR$Codes <-as.character(cropsSR$Codes)
cropsSR$Codes[cropsSR$Country=="Former Yugoslav SFR"]<-"BIH"
cropsSR$Codes[cropsSR$Country=="Former Czechoslovakia"]<-"CZE"
cropsSR$Continent[cropsSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
cropsSR$Continent[cropsSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"




#crops
cropsSR$Rate[cropsSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="South Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="South Asia"]))

cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="EuCA",])/ length(unique(aggcrops$Country[aggcrops$Continent=="EuCA"]))

cropsSR$Rate[cropsSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="MENA",])/ length(unique(aggcrops$Country[aggcrops$Continent=="MENA"]))


cropsSR$Rate[cropsSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="East Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="East Asia"]))

cropsSR$Rate[cropsSR$Continent=="Oceania"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="Oceania",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Oceania"]))

cropsSR$Rate[cropsSR$Continent=="Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="SSA",])/ length(unique(aggcrops$Country[aggcrops$Continent=="SSA"]))

cropsSR$Rate[cropsSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="LACa",])/ length(unique(aggcrops$Country[aggcrops$Continent=="LACa"]))

cropsSR$Rate[cropsSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Crops" & shockdrivers$Region=="North America",])/ length(unique(aggcrops$Country[aggcrops$Continent=="North America"]))


#Livestock rates 

Country<-levels(agglivestock$Country)
Code<- countrycode(levels(agglivestock$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(agglivestock$Country), origin = "country.name", destination = "continent")
livestockSR<-cbind.data.frame(Country, Code, Continent)
livestockSR$Continent <-as.character(livestockSR$Continent)
livestockSR$Code <- as.character(livestockSR$Code)


livestockSR$Continent[livestockSR$Code=="BHR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="IRN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="IRQ"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="SAU"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="ARE"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="KWT"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="QAT"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="LBN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="JOR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="DZA"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="LBY"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="SYR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="EGY"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="MAR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="TUN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="DZA"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="ISR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="JOR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="MLT"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="MAR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="PSE"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="OMN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="SYR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="ARE"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
livestockSR$Continent[livestockSR$Code=="BMU"]<-"North America"
livestockSR$Continent[livestockSR$Code=="GRL"]<-"North America"
livestockSR$Continent[livestockSR$Code=="USA"]<-"North America"
livestockSR$Continent[livestockSR$Code=="CAN"]<-"North America"
livestockSR$Continent[livestockSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
livestockSR$Continent[livestockSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
livestockSR$Continent[livestockSR$Continent=="Europe"]<-"Europe and Central Asia"
livestockSR$Continent[livestockSR$Code=="CYP"]<-"Europe and Central Asia"
livestockSR$Continent[livestockSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
livestockSR$Continent[livestockSR$Code=="BTN"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="AFG"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="IND"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="LKA"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="MDV"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="BGD"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="PAK"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="NPL"]<-"South Asia"

#East Asia and Pacific
livestockSR$Continent[livestockSR$Continent=="Asia"]<-"East Asia"

livestockSR$Code[livestockSR$Country=="Former Yugoslav SFR"]<-"BIH"
livestockSR$Code[livestockSR$Country=="Former Czechoslovakia"]<-"CZE"
livestockSR$Continent[livestockSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
livestockSR$Continent[livestockSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"


#Rates
livestockSR$Rate[livestockSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="South Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="South Asia"]))

livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="EuCA",])/ length(unique(agglivestock$Country[agglivestock$Continent=="EuCA"]))

livestockSR$Rate[livestockSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="MENA",])/ length(unique(agglivestock$Country[agglivestock$Continent=="MENA"]))

livestockSR$Rate[livestockSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="East Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="East Asia"]))

livestockSR$Rate[livestockSR$Continent=="Oceania"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="Oceania",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Oceania"]))

livestockSR$Rate[livestockSR$Continent=="Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="SSA",])/ length(unique(agglivestock$Country[agglivestock$Continent=="SSA"]))

livestockSR$Rate[livestockSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="LACa",])/ length(unique(agglivestock$Country[agglivestock$Continent=="LACa"]))

livestockSR$Rate[livestockSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="North America",])/ length(unique(agglivestock$Country[agglivestock$Continent=="North America"]))


#FISHERIES

Country<-levels(aggfisheries$Country)
Code<- countrycode(levels(aggfisheries$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(aggfisheries$Country), origin = "country.name", destination = "continent")
fisheriesSR <-cbind.data.frame(Country, Code, Continent)
fisheriesSR$Continent <-as.character(fisheriesSR$Continent)
fisheriesSR$Code <-as.character(fisheriesSR$Code)


fisheriesSR$Continent[fisheriesSR$Code=="BHR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="IRN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="IRQ"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="SAU"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="ARE"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="KWT"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="QAT"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="LBN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="JOR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="DZA"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="LBY"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="SYR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="EGY"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="MAR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="TUN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="DZA"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="ISR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="JOR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="MLT"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="MAR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="PSE"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="OMN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="SYR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="ARE"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
fisheriesSR$Continent[fisheriesSR$Code=="BMU"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="GRL"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="USA"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="CAN"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
fisheriesSR$Continent[fisheriesSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
fisheriesSR$Continent[fisheriesSR$Continent=="Europe"]<-"Europe and Central Asia"
fisheriesSR$Continent[fisheriesSR$Code=="CYP"]<-"Europe and Central Asia"
fisheriesSR$Continent[fisheriesSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
fisheriesSR$Continent[fisheriesSR$Code=="BTN"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="AFG"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="IND"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="LKA"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="MDV"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="BGD"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="PAK"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="NPL"]<-"South Asia"

#East Asia and Pacific
fisheriesSR$Continent[fisheriesSR$Continent=="Asia"]<-"East Asia"

fisheriesSR$Code[fisheriesSR$Country=="Former Yugoslav SFR"]<-"BIH"
fisheriesSR$Code[fisheriesSR$Country=="Former Czechoslovakia"]<-"CZE"
fisheriesSR$Continent[fisheriesSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
fisheriesSR$Continent[fisheriesSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"

#Rates

fisheriesSR$Rate[fisheriesSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="South Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="South Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="EuCA",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="EuCA"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="MENA",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="MENA"]))

fisheriesSR$Rate[fisheriesSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="East Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="East Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Oceania"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="Oceania",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Oceania"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="SSA",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="SSA"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="LACa",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="LACa"]))

fisheriesSR$Rate[fisheriesSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="North America",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="North America"]))

#AQUACULTURE

Country<-levels(aggaqua$Country)
Country[124]<-"Reunion"
Code<- countrycode(Country, origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(Country, origin = "country.name", destination = "continent")
aquacultureSR <-cbind.data.frame(Country, Code, Continent)
aquacultureSR$Continent <-as.character(aquacultureSR$Continent)
aquacultureSR$Code <-as.character(aquacultureSR$Code)



aquacultureSR$Continent[aquacultureSR$Code=="BHR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="IRN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="IRQ"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="SAU"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="ARE"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="KWT"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="QAT"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="LBN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="JOR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="DZA"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="LBY"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="SYR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="EGY"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="MAR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="TUN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="DZA"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="ISR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="JOR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="MLT"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="MAR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="PSE"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="OMN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="SYR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="ARE"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
aquacultureSR$Continent[aquacultureSR$Code=="BMU"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="GRL"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="USA"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="CAN"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
aquacultureSR$Continent[aquacultureSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
aquacultureSR$Continent[aquacultureSR$Continent=="Europe"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Code=="CYP"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
aquacultureSR$Continent[aquacultureSR$Code=="BTN"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="AFG"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="IND"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="LKA"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="MDV"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="BGD"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="PAK"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="NPL"]<-"South Asia"

#East Asia and Pacific
aquacultureSR$Continent[aquacultureSR$Continent=="Asia"]<-"East Asia"

aquacultureSR$Code[aquacultureSR$Country=="Former Yugoslav SFR"]<-"BIH"
aquacultureSR$Code[aquacultureSR$Country=="Former Czechoslovakia"]<-"CZE"
aquacultureSR$Continent[aquacultureSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Country=="Zanzibar"]<-"Africa"


#Rates 

aquacultureSR$Rate[aquacultureSR$Continent=="South Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="South Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="South Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="EuCA",])/ length(unique(aggaqua$Country[aggaqua$Continent=="EuCA"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="MENA",])/ length(unique(aggaqua$Country[aggaqua$Continent=="MENA"]))

aquacultureSR$Rate[aquacultureSR$Continent=="East Asia"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="East Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="East Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Oceania"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="Oceania",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Oceania"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Africa"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="SSA",])/ length(unique(aggaqua$Country[aggaqua$Continent=="SSA"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="LACa",])/ length(unique(aggaqua$Country[aggaqua$Continent=="LACa"]))

aquacultureSR$Rate[aquacultureSR$Continent=="North America"]<- nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="North America",])/ length(unique(aggaqua$Country[aggaqua$Continent=="North America"]))


#Mapping

#JOIN TO SPATIAL DATA
bbox <- readOGR(dsn="ne_110m_graticules_all", layer="ne_110m_wgs84_bounding_box") 
bbox <- spTransform(bbox, CRS("+proj=moll"))  # reproject bounding box
bbox_df<- fortify(bbox) #, group="ISO_TER1"


#JOINING CROP AND COUNTRY DATA 
names(cropsSR)[names(cropsSR)=="Codes"]<-"iso_a3"
CRworld<-readOGR("ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
CRworld <- CRworld[!CRworld$iso_a3 %in% c("ATA"),] #remove antartica
CRworld<-spTransform(CRworld, CRS("+proj=moll"))
CRworld@data$id<-rownames(CRworld@data)
CRworld@data<-join(CRworld@data, cropsSR, by="iso_a3")
CRworld.df<-fortify(CRworld)
CRworld.df<-join(CRworld.df, CRworld@data, by="id")
head(CRworld.df)

#centroids for crops data
#centroids<-aggregate(cbind(long,lat)~id, data=CRworld.df, FUN=function(x) mean(range(x)))
#CRworld.df2<-merge(CRworld.df, centroids, by="id")


#JOIN LIVESTOCK DATA TO COUNTRY CENTROIDS
names(livestockSR)[names(livestockSR)=="Code"]<-"iso_a3" #create common variable
LSworld<-readOGR(dsn="ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
LSworld <- LSworld[!LSworld$iso_a3 %in% c("ATA"),] #remove antarctica
LSworld<-spTransform(LSworld, CRS("+proj=moll"))
LSworld@data$id<-rownames(LSworld@data)
LSworld@data<-join(LSworld@data, livestockSR, by="iso_a3")
LSworld.df<-fortify(LSworld)
LSworld.df<-join(LSworld.df, LSworld@data, by="id")
#head(LSworld.df) #it worked! 

#Use the centroids to plot
#centroids<-aggregate(cbind(long,lat)~id, data=LSworld.df, FUN=function(x) mean(range(x)))
#LSworld.df<-merge(LSworld.df, centroids, by="id")
#LSworld.df

#EEZ shapefile from marine regions - not great for robinson projection 

#EEZfish <- read_sf(dsn = "World_EEZ", layer = "eez")
#EEZfish <- as(EEZfish, "Spatial")
# <- EEZfish[!EEZfish$Territory1 %in% c("Antarctica"),]
#(EEZfish@data)[1:70,]
#names(fisheriestp)[names(fisheriestp)=="codes"]<-"ISO_Ter1" #create common variable
#EEZfish<-spTransform(EEZfish, CRS("+proj=robin"))
#EEZfish@data$id<-rownames(EEZfish@data)
#EEZfish@data<-join(EEZfish@data, fisheriestp, by="ISO_Ter1")
#EEZfish.df<-fortify(EEZfish)
#EEZfish.df<-join(EEZfish.df, EEZfish@data, by="id")
#head(EEZfish.df)
#EEZfish.df$PropMagnitude[is.na(EEZfish.df$PropMagnitude)] <- 0
#EEZfish.df$AbsMagnitude[is.na(EEZfish.df$AbsMagnitude)] <- 0
#head(EEZfish.df)

#aquaculture data
#EEZaqua<-read_sf(dsn = "World_EEZ", layer = "eez")
#EEZaqua<- as(EEZaqua, "Spatial")
#EEZaqua <- EEZaqua[!EEZaqua$Territory1 %in% c("Antarctica"),]
#names(aquaculturetp)[names(aquaculturetp)=="codes"]<-"ISO_Ter1"#create common variable
#EEZaqua<-spTransform(EEZaqua, CRS("+proj=robin"))
#EEZaqua@data$id<-rownames(EEZaqua@data)
#EEZaqua@data<-join(EEZaqua@data, aquaculturetp, by="ISO_Ter1")
#EEZaqua.df<-fortify(EEZaqua)
#EEZaqua.df<-join(EEZaqua.df, EEZaqua@data, by="id")
#head(EEZaqua.df)

##CREATE A SIMPLIED VERSION OF SHAPEFILE AND EXPORT TO RDS
#eezfname <- "eez.shp"
#eez <- read_sf(dsn = "World_EEZ", "eez")
## will want the recent update (14 August 2017)
#library(rmapshaper)
#eez_sim <- ms_simplify(eez)
#eez_sim <- as(eez_sim, "Spatial")
#saveRDS(eez_sim, "eez_simplified.rds")

## read in simplified copy - fisheries
eez_fish <- readRDS("eez_simplified.rds")
eez_fish <- eez_fish[!eez_fish$Territory1 %in% c("Antarctica"),]
eez_fish<-spTransform(eez_fish, CRS("+proj=moll"))
names(fisheriesSR)[names(fisheriesSR)=="Code"]<-"ISO_Ter1"
eez_fish@data$id<-rownames(eez_fish@data)
eez_fish@data<-join(eez_fish@data, fisheriesSR, by="ISO_Ter1")
eez_fish.df<-fortify(eez_fish)
eez_fish.df<-join(eez_fish.df, eez_fish@data, by="id")

#centroids<-aggregate(cbind(long,lat)~id, data=eez_fish.df, FUN=function(x) mean(range(x)))
#eez_fish.df2<-merge(eez_fish.df, centroids, by="id")

#aquaculture and EEZ simplified
eez_aqua<-readRDS("eez_simplified.rds")
eez_aqua <- eez_aqua[!eez_aqua$Territory1 %in% c("Antarctica"),]
eez_aqua<-spTransform(eez_aqua, CRS("+proj=moll"))
names(aquacultureSR)[names(aquacultureSR)=="Code"]<-"ISO_Ter1"
eez_aqua@data$id<-rownames(eez_aqua@data)
eez_aqua@data<-join(eez_aqua@data, aquacultureSR, by="ISO_Ter1")
eez_aqua.df<-fortify(eez_aqua)
eez_aqua.df<-join(eez_aqua.df, eez_aqua@data, by="id")
#head(eez_aqua.df)

#Use the centroids to plot
#centroids<-aggregate(cbind(long,lat)~id, data=eez_aqua.df, FUN=function(x) mean(range(x)))
#eez_aqua.df<-merge(eez_aqua.df, centroids, by="id")
#names(eez_aqua.df)

#PLOTTING
#control white space
#par(mar=c(0,0,0,0))

#ADJUSTING CROP RATE DISPLAY FOR AGGREGATED COUNTRIES

CRworld.df$Rate[CRworld.df$iso_a3=="GRL"]<-unique(cropsSR$Rate[cropsSR$Continent=="North America"])


CRworld.df$Rate[CRworld.df$iso_a3=="ARM"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="AZE"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="BLR"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="EST"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="GEO"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="KAZ"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="KGZ"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="LVA"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="LTU"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="MDA"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="TJK"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="TKM"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="UKR"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="UZB"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])

CRworld.df$Rate[CRworld.df$iso_a3=="SRB"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="MNE"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="HRV"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="MKD"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="SVN"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])
CRworld.df$Rate[CRworld.df$iso_a3=="SVK"]<-unique(cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"])

CRworld.df$Rate[CRworld.df$iso_a3=="SSD"]<-unique(cropsSR$Rate[cropsSR$Continent=="Africa"])

#LIVESTOCK ADJUSTEDMENT FOR AGGREGATED COUNTRIES


LSworld.df$Rate[LSworld.df$iso_a3=="ARM"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="AZE"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="BLR"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="EST"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="GEO"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="KAZ"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="KGZ"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="LVA"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="LTU"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="MDA"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="TJK"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="TKM"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="UKR"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="UZB"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])

LSworld.df$Rate[LSworld.df$iso_a3=="SRB"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="MNE"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="HRV"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="MKD"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="SVN"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])
LSworld.df$Rate[LSworld.df$iso_a3=="SVK"]<-unique(livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"])

LSworld.df$Rate[LSworld.df$iso_a3=="SSD"]<-unique(livestockSR$Rate[livestockSR$Continent=="Africa"])





#CROPS and AQUACULTURE

mcrops<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat,fill=Rate, group=group, map_id=id), colour=NA, size=0.2)+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = bquote(Shock~frequency))+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(6, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 0.5, title.position = "top"))+
  annotation_custom(cropimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)+
  annotate("text", x=-1e+07, y=-8e+6, label="Crops" )

#Aquaculture

mAqua<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id, fill=Rate), colour="NA", size=0.2)+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(aquaimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)+
  annotate("text", x=-0.8e+07, y=-8e+6, label="Aquaculture" )




#LIVESTOCK 
mLs<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat,fill=Rate, group=group, map_id=id), colour="NA", size=0.2)+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(cowimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)+
  annotate("text", x=-0.9e+07, y=-8e+6, label="Livestock" )




mfish<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, fill=Rate, group=group, map_id=id), colour="NA", size=0.2)+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="ivory", mid = "khaki", midpoint = 0.15, high="firebrick4", na.value = "aliceblue" ,limits=c(0,0.7))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "left",
        legend.direction = "vertical",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+
  annotation_custom(fishingimg, xmin = -2.65e+07, xmax = -0.3e+07, ymin = -10.1e+06, ymax = -4.5e+06)+
  annotate("text", x=-0.9e+07, y=-8e+6, label="Fisheries" )

# + 
#   guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0, title.position = "top"))

ratescombined<-ggarrange(mcrops, mLs, mfish, mAqua, ncol = 2, nrow = 2, labels = c("a", "b", "c", "d"), legend = "none")


#ratescol<-ggarrange(mcrops, mLs, mfish, mAqua, ncol=1, nrow=4, labels=c("a", "c", "e", "g"), legend = "none")

ratelegend<-get_legend(mcrops)

ratescombined2<-ggarrange(ratescombined, ratelegend, nrow=2, ncol=1, heights = c(1,0.1))

ggsave(filename = "Shock rates only map.tiff", device = "tiff", dpi=600, width=18.3, height = 12.5, units = "cm")

ggsave(filename = "Shock rates only map.pdf", device = pdf, dpi=600, width=18.3, height = 12.5, units = "cm")

# ratedriver1<-ggarrange(ratescol, driverscol, nrow = 1, ncol=2)
# 
# ratedriver2<-ggarrange(ratedriver1, driverlegend, ncol=1, nrow = 2, heights =  c(1,0.15))
# 
# ggarrange(ratelegend, ratedriver2, ncol = 2, nrow = 1, widths = c(0.15,1))

# ggsave(filename="Figure 2 - Rates and drivers map.tiff", device = "tiff", dpi=600, width = 16, height = 17, units = "cm")
# 
# 
# 
# ggarrange(topmaps, bottommaps, ncol=1, nrow=2, align="hv", heights = c(1,0.8))
# 
# ggsave("Shock Magnitudes and Rates - with aggregates.pdf", device=pdf, dpi = 600, width = 230, height=190, units="mm", scale=1.8)



```


#Figure 2 - PLOTS FOR PROPORTIONAL CONTRIBUTION OF DRIVERS PER SECTOR

```{r}

cols<-c("Climate/weather events"="#9e0142", "Climate/weather events & mismanagement" = "#d53e4f", "Climate/weather & geopolitical/economic events" = "#f46d43", "Geopolitical/economic events" = "#fdae61", "Mismanagement & geopolitical/economic events" = "#fee08b","Mismanagement" = "#e6f598",  "Mismanagement & policy change" = "#abdda4", "Policy change" = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")

Causes<-ggplot(data=shockcategories, aes(x=Var2, y=Prop, fill=Var1))+geom_bar(stat="identity")+
  theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y=element_text(size=8, face="bold"),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        #panel.border = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text(size=8),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_blank(),
        legend.title = element_text(face="bold", size=8),
        plot.margin = unit(c(t=0,r=0,b=0,l=0), "cm"))+
  scale_fill_brewer(palette = "Spectral")+
  scale_y_continuous(limits = c(0, 1.06))+
  labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0, ncol = 1))


noleg<-ggarrange(Causes, nrow = 1, ncol = 1, legend = "none")

ggarrange(noleg, get_legend(Causes), nrow=2, ncol=1, heights = c(0.9, 0.4))

ggsave(filename="Drivers only.tiff", device="tiff", dpi=600, width=8.9, height=14, units = "cm")
ggsave(filename="Drivers only.pdf", device= pdf, dpi=600, width=8.9, height=14, units = "cm")



pie1<-ggplot(data=shockcategories[shockcategories$Var2=="Crops",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
  theme_bw()+
  coord_polar("y")+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        legend.position = "bottom", 
        legend.text = element_text(size=9),
        legend.key.size = unit(0.3, "cm"),
        legend.background = element_blank(),
        legend.title = element_text(face="bold", size=10),
        plot.margin = unit(c(t=0,r=0,b=0.5,l=-0.9), "cm"))+
  scale_fill_manual(values=cols)+
  #scale_y_continuous(limits = c(0, 1.06))+
  labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))

driverlegend<-get_legend(pie1)

# pie2<-ggplot(data=shockcategories[shockcategories$Var2=="Livestock",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
#   theme_bw()+
#   coord_polar("y")+
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_blank(),
#         axis.ticks = element_blank(),
#         panel.grid = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom", 
#         legend.text = element_text(size=8),
#         legend.key.size = unit(0.3, "cm"),
#         legend.background = element_blank(),
#         legend.title = element_text(face="bold", size=8),
#         plot.margin = unit(c(t=0,r=0,b=0.5,l=-0.9), "cm"))+
#   scale_fill_manual(values=cols)+
#   #scale_y_continuous(limits = c(0, 1.06))+
#   labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))
# 
# pie3<-ggplot(data=shockcategories[shockcategories$Var2=="Fisheries",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
#   theme_bw()+
#   coord_polar("y")+
#   theme(axis.title.x = element_blank(),
#         axis.text.x = element_blank(),
#         axis.ticks = element_blank(),
#         panel.grid = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom", 
#         legend.text = element_text(size=8),
#         legend.key.size = unit(0.3, "cm"),
#         legend.background = element_blank(),
#         legend.title = element_text(face="bold", size=8),
#         plot.margin = unit(c(t=0,r=0,b=0.5,l=-0.9), "cm"))+
#   scale_fill_manual(values=cols)+
#   #scale_y_continuous(limits = c(0, 1.06))+
#   labs(x="", y=bquote(Prop.~of~shocks), fill="Driver of shock")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))
# 
# pie4<-ggplot(data=shockcategories[shockcategories$Var2=="Aquaculture",], aes(x="", y=Prop, fill=Var1))+geom_bar(stat="identity")+
#   theme_bw()+
#   coord_polar("y")+
#   theme(axis.title.x = element_text(size=11, margin = unit(c(0.2,0,0,0), "cm")),
#         axis.text.x = element_blank(),
#         axis.ticks = element_blank(),
#         panel.grid = element_blank(),
#         panel.border = element_blank(),
#         legend.position = "bottom", 
#         legend.text = element_text(size=10),
#         legend.key.size = unit(0.3, "cm"),
#         legend.background = element_blank(),
#         legend.title = element_text(face="bold", size=10),
#         plot.margin = unit(c(t=0,r=0.5,b=1.2,l=-0.4), "cm"))+
#   scale_fill_manual(values=cols)+
#   #scale_y_continuous(limits = c(0, 1.06))+
#   labs(x="", y="", fill="Shock drivers")+guides(fill=guide_legend(title.position = "top", title.hjust =0.5, ncol = 2))
# 
# pies<-ggarrange(pie1, pie2, pie3, pie4, legend = "none", nrow=4, ncol=1, heights = c(0.9,0.9,0.9,1.2), labels=c("a", "d", "g", "k"))
# #ggsave(filename = "shockdrivers by sector.pdf", device=pdf, dpi=600, width=10, height = 10)

```

#Figure S2 PLOT FOR SHOCKS DID NOT RECOVER

```{r}

Norecovery<-data.frame(table(is.na(shockdrivers$Recovery)==T, shockdrivers$Region, shockdrivers$Sector))
names(Norecovery)[1]<- "NoRecover"
names(Norecovery)[2]<- "Region"
names(Norecovery)[3]<- "Sector"

levels(Norecovery$Region)

Tots<-c()

for (i in 1:length(levels(Norecovery$Sector))){
  for (r in 1:length(levels(Norecovery$Region))){
    Tots<-c(Tots, sum(Norecovery$Freq[Norecovery$Sector==levels(Norecovery$Sector)[i] & Norecovery$Region==levels(Norecovery$Region)[r]]))
  }
}

Norecovery$Total<-rep(Tots, 1, each=2)
Norecovery$Prop<-Norecovery$Freq/Norecovery$Total

levels(Norecovery$NoRecover)[levels(Norecovery$NoRecover)=="FALSE"]<-"Recovered"
levels(Norecovery$NoRecover)[levels(Norecovery$NoRecover)=="TRUE"]<-"Did not recover"

ggplot(data = Norecovery, aes(x=Region, y=Prop, fill=NoRecover))+geom_bar(stat="identity")+facet_wrap(~Sector)+
  theme_bw()+
  scale_fill_manual(values = c("dodgerblue2","grey70" ))+
  theme(panel.grid = element_blank(), 
        legend.title = element_blank(),
        axis.text = element_text(size=11),
        axis.title = element_text(size=11),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 11))+
  labs(y=bquote(Proportion~of~shocks))


ggsave("Recovered vs. norecoverd.tiff", device = "tiff", dpi=600, width = 18.3, height = 18, units = "cm")
```

#Figure 3 - Shock size and recovery
```{r}

#load data
shocks_df <- shockdrivers


#refine the Category names so they plot in a nicer way (with newlines and abbreviations)
shocks_df$Cat_key <- case_when(
  shocks_df$Category == "Climate/weather events" ~ "Clim.", 
  shocks_df$Category == "Climate/weather & geopolitical/economic events" ~ "Clim./Geo.Eco.", 
  shocks_df$Category == "Climate/weather events & mismanagement" ~ "Clim./Mismngt.", 
  shocks_df$Category == "Geopolitical/economic events" ~ "Geo.Eco.", 
  shocks_df$Category == "Mismanagement & geopolitical/economic events" ~ "Mismngt./Geo.Eco.", 
  shocks_df$Category == "Mismanagement" ~ "Mismngt.", 
  shocks_df$Category == "Mismanagement & policy change" ~ "Mismngt./Pol.Chng.", 
  shocks_df$Category == "Policy change" ~ "Pol.Chng.", 
  shocks_df$Category == "Other" ~ "Other", 
  shocks_df$Category == "Unknown" ~ "Unknown"
)
shocks_df$Cat_key <- factor(shocks_df$Cat_key, levels = c("Clim.", "Clim./Mismngt.", "Clim./Geo.Eco.", "Geo.Eco.","Mismngt./Geo.Eco.","Mismngt.", "Mismngt./Pol.Chng.","Pol.Chng.","Other","Unknown"))
shocks_df$Category <- factor(shocks_df$Category, levels = c(
  "Climate/weather events", "Climate/weather events & mismanagement", "Climate/weather & geopolitical/economic events", 
  "Geopolitical/economic events", "Mismanagement & geopolitical/economic events", "Mismanagement", "Mismanagement & policy change", "Policy change", "Other", "Unknown"
  )
  )

#refine the Region names so they plot in a nicer way (with newlines and abbreviations)
shocks_df$Reg_key <- case_when(
  shocks_df$Region == "North America" ~ "N. America", 
  shocks_df$Region == "LACa" ~ "L. America &\nCaribbean", 
  shocks_df$Region == "EuCA" ~ "Europe &\nC. Asia", 
  shocks_df$Region == "MENA" ~ "Middle East\n&N. Africa",
  shocks_df$Region == "SSA" ~ "Sub-Sah.\nAfrica", 
  shocks_df$Region == "Oceania" ~ "Oceania", 
  shocks_df$Region == "South Asia" ~ "S. Asia", 
  shocks_df$Region == "East Asia" ~ "E. Asia"
)
shocks_df$Reg_key <- factor(shocks_df$Reg_key, levels = c("N. America", "L. America &\nCaribbean","Europe &\nC. Asia", "Middle East\n&N. Africa", "Sub-Sah.\nAfrica", "S. Asia", "E. Asia", "Oceania"))

Category_cols <- cols<-c("Climate/weather events"="#9e0142", "Climate/weather events & mismanagement" = "#d53e4f", "Climate/weather & geopolitical/economic events" = "#f46d43", "Geopolitical/economic events" = "#fdae61", "Mismanagement & geopolitical/economic events" = "#fee08b","Mismanagement" = "#e6f598",  "Mismanagement & policy change" = "#abdda4", "Policy change" = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")
Cat_key_cols <- cols<-c("Clim."="#9e0142", "Clim./Mismngt." = "#d53e4f", "Clim./Geo.Eco." = "#f46d43", "Geo.Eco." = "#fdae61", "Mismngt./Geo.Eco." = "#fee08b","Mismngt." = "#e6f598",  "Mismngt./Pol.Chng." = "#abdda4", "Pol.Chng." = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")
# set region colours
Region_cols <- rep(c("grey90", "grey70"), 4) #RColorBrewer::brewer.pal(name = "Pastel2", n=8)
names(Region_cols) <- rev(c("N. America", "L. America &\nCaribbean","Europe &\nC. Asia", "Middle East\n&N. Africa", "Sub-Sah.\nAfrica", "S. Asia", "E. Asia", "Oceania"))
#combine category and region colours into a single names list of colours for use in the plot
target_cols <- c(Region_cols, Cat_key_cols)

#do each plot for each sector.
for(target_sector in unique(shocks_df$Sector)){
#for(target_sector in "Crops"){
  sector_shocks <- filter(shocks_df, Sector == target_sector)
  sector_shocks$AbsMagnitude <- sector_shocks$AbsMagnitude/1000000
  sector_shocks$Recovery_transparency <- case_when(
    sector_shocks$Recovery2 < 8 ~ 0.3, 
    sector_shocks$Recovery2 > 7 & sector_shocks$Recovery2 < 16 ~ 0.6,
    sector_shocks$Recovery2 > 15 ~ 0.9
  )
  figure_filename <- sprintf("C:/Users/rsc2/Documents/github/shocks/For submission/rich-cotrell-paper-%s.png", target_sector)
  #png(file=figure_filename, width=183/2, height=210/2,units="mm", res=100)
  figure_filename <- sprintf("C:/Users/rsc2/Documents/github/shocks/For submission/rich-cotrell-paper-%s.pdf", target_sector)
  pdf(file=figure_filename, width=(183*0.0393700787), height=(183*0.0393700787)) #convert mm to inches by mm*0.0393700787
  chordDiagram(
    x= sector_shocks[,c("Cat_key", "Reg_key", "AbsMagnitude")],
    annotationTrack = "grid", symmetric = TRUE, preAllocateTracks = 1.5,
    grid.col = target_cols, col = alpha.col(Cat_key_cols[sector_shocks$Cat_key], sector_shocks$Recovery_transparency), order = names(target_cols)
    )
  circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
      xlim = get.cell.meta.data("xlim")
      ylim = get.cell.meta.data("ylim")
      sector.name = get.cell.meta.data("sector.index")
      circos.text(mean(xlim), ylim[1] + 0.1, sector.name, facing = "clockwise", niceFacing = TRUE, cex=0.8)
      #circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "bending.outside", niceFacing = TRUE, adj = c(0, 0))
      circos.axis(h = "top", labels.cex = 0.8, major.tick.percentage = 0.2, sector.index = sector.name, track.index = 2)
    }, bg.border = NA)
  dev.off()
  
 # if(target_sector == "Crops"){
  #   png()
  #   plot(
  #     x=rep(1:length(Cat_key_cols), each=5), y=rep(1:length(Cat_key_cols), 5), 
  #     pch=19,
  #     col=plot3d::alpha.col(rep(Cat_key_cols, each=5), rep(seq(0.1,0.5, by=0.1), 5))
  # })
}#close for target_sector

#create legend
nx <- sort(unique(sector_shocks$Recovery_transparency))
ny <- rev(1:length(unique(shocks_df$Category)))
legend_dots <- data.frame(
  x = rep((1:length(nx)), length(ny) ), 
  y = rep(ny, each=length(nx)), 
  cols = alpha.col(rep(Cat_key_cols,each=length(nx)),  rep(nx, length(ny) )), 
  stringsAsFactors = FALSE
)
pdf(file="C:/Users/rsc2/Documents/github/shocks/For submission/rich-cotrell-paper-figure-legend.pdf", width=183*0.0393700787, height=70*0.0393700787)
  par(mar=c(0,0,0,0))
  plot(legend_dots$x, legend_dots$y, col=legend_dots$cols, pch=19, cex=3.8, xlim=c(0,17), ylim=c(0,12), xaxt='n', yaxt='n', ann=FALSE, bty="n")
  text(x = rep(7,length(levels(shocks_df$Cat_key))) , y=ny, labels=levels(shocks_df$Category), pos=4, cex=0.8)
  text(x = 1:length(nx), y=rep(12, length(nx)), labels=c("1-7", "8-15", ">15"), cex=0.8)
dev.off()





```


##Figure 3 B - SHOCK SIZE AND RECOVERY PLOTS
```{r}
cols<-c("Climate/weather events"="#9e0142", "Climate/weather events & mismanagement" = "#d53e4f", "Climate/weather & geopolitical/economic events" = "#f46d43", "Geopolitical/economic events" = "#fdae61", "Mismanagement & geopolitical/economic events" = "#fee08b","Mismanagement" = "#e6f598",  "Mismanagement & policy change" = "#abdda4", "Policy change" = "#66c2a5", "Other" = "#3288bd", "Unknown"= "#5e4fa2")


#change order of Regions
levels(shockdrivers$Region)
shockdrivers$Country<-as.character(shockdrivers$Country)
shockdrivers$Country[shockdrivers$Codes=="PRK"]<-"DPRK"
shockdrivers$Country<-as.factor(shockdrivers$Country)



#MAX SHOCK SIZES
maxshockscrops<-shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops"]),]

maxshockslivestock<-shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock"]),]

maxshocksfisheries<-shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries"]),]

maxshocksaqua<-shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture"]),]

#MAX RECOVERY TIMES

maxreccrops<-shockdrivers[shockdrivers$Sector=="Crops",]
maxreccrops<-maxreccrops[maxreccrops$Recovery2==max(maxreccrops$Recovery2),]

maxreclivestock<-shockdrivers[shockdrivers$Sector=="Livestock",]
maxreclivestock<-maxreclivestock[maxreclivestock$Recovery2==max(maxreclivestock$Recovery2),]

maxrecfisheries<-shockdrivers[shockdrivers$Sector=="Fisheries",]
maxrecfisheries<-maxrecfisheries[maxrecfisheries$Recovery2==max(maxrecfisheries$Recovery2),]

maxrecaqua<-shockdrivers[shockdrivers$Sector=="Aquaculture",]
maxrecaqua<-maxrecaqua[maxrecaqua$Recovery2==max(maxrecaqua$Recovery2),]


size1<-ggplot(data = shockdrivers[shockdrivers$Sector=="Crops",], aes(x=Region, y=log(AbsMagnitude)))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  scale_x_discrete(drop=FALSE)+
  scale_y_continuous(limits = c(0,19))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y =   element_text(size=8),
        plot.margin = unit(c(0.2,0.2,0,0), "cm"))+
  labs(y="log(Shock size (T))")+
  geom_text(data = maxshockscrops, mapping = aes(x=Region, y= log(AbsMagnitude), label = Country), size=3, position = position_nudge(y = 2), hjust="inward")

size2<-ggplot(data = shockdrivers[shockdrivers$Sector=="Livestock",], aes(x=Region, y=log(AbsMagnitude)))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  theme_bw()+
  scale_x_discrete(drop=FALSE)+
  scale_y_continuous(limits = c(0,19))+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        axis.ticks.x = element_blank(),
        axis.text.y =  element_text(size=8),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        axis.text.x = element_blank())+
  labs(y="log(Shock size (T))")+
  geom_text(data = maxshockslivestock, mapping = aes(x=Region, y= log(AbsMagnitude), label = Country), size=3, position = position_nudge(y = 2), hjust="inward")

size3<-ggplot(data = shockdrivers[shockdrivers$Sector=="Fisheries",], aes(x=Region, y=log(AbsMagnitude)))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  scale_y_continuous(limits = c(0,19))+
  theme_bw()+
  scale_x_discrete(drop=FALSE)+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y =  element_text(size=8),
        plot.margin = unit(c(0,0.2,0,0), "cm"))+
  labs(y="log(Shock size (T))")+
  geom_text(data = maxshocksfisheries, mapping = aes(x=Region, y= log(AbsMagnitude), label = Country), size=3, position = position_nudge(y = 2), hjust="inward")

size4<-ggplot(data = shockdrivers[shockdrivers$Sector=="Aquaculture",], aes(x=Region, y=log(AbsMagnitude)))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  scale_x_discrete(drop=FALSE)+
  scale_y_continuous(limits = c(0,19))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.title.y = element_text(size=8),
        axis.text.y =   element_text(size=8),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        axis.text.x = element_text(angle=45, size=8, hjust=1, margin=unit(c(0.1,0,0,0), "cm")))+
  labs(y="log(Shock size (T))",x="")+
  geom_text(data = maxshocksaqua, mapping = aes(x=Region, y= log(AbsMagnitude), label = Country), size=3, position = position_nudge(y = 2), hjust="inward")


# Sizes<-ggarrange(size1, size2, size3, size4, legend = "none", nrow=4, ncol=1, heights=c(1,1,1,1.6), labels = c("b", "e", "i", "l"))
# 
# ggsave(filename = "Magnitude.test.tiff", device="tiff", dpi=300, width=7, height = 18, units = "cm")


Rec1<-ggplot(data = shockdrivers[shockdrivers$Sector=="Crops",], aes(x=Region, y=Recovery2))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  scale_y_continuous(limits = c(0,48))+
  scale_x_discrete(drop=FALSE)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y =   element_text(size=8),
        plot.margin = unit(c(0.2,0,0,0.2), "cm"))+
  labs(y="Recovery time (years)")+
  geom_text(data = maxreccrops, mapping = aes(x=Region, y= Recovery2, label = Country), size=3, position = position_nudge(y = 6), hjust="inward")

Rec2<-ggplot(data = shockdrivers[shockdrivers$Sector=="Livestock",], aes(x=Region, y=Recovery2))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  theme_bw()+
  scale_x_discrete(drop=FALSE)+
  scale_y_continuous(limits = c(0,48))+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        axis.ticks.x = element_blank(),
        axis.text.y =  element_text(size=8),
        plot.margin = unit(c(0,0,0,0.2), "cm"),
        axis.text.x = element_blank())+
  labs(y="Recovery time (years)")+
  geom_text(data = maxreclivestock, mapping = aes(x=Region, y= Recovery2, label = Country), size=3, position = position_nudge(y = 6), hjust="inward")

Rec3<-ggplot(data = shockdrivers[shockdrivers$Sector=="Fisheries",], aes(x=Region, y=Recovery2))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  theme_bw()+
  scale_x_discrete(drop=FALSE)+
  scale_y_continuous(limits = c(0,48))+
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size=8),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y =  element_text(size=8),
        plot.margin = unit(c(0,0,0,0.2), "cm"))+
  labs(y="Recovery time (years)")+
  geom_text(data = maxrecfisheries, mapping = aes(x=Region, y= Recovery2, label = Country), size=3, position = position_nudge(y = 6), hjust="inward")

Rec4<-ggplot(data = shockdrivers[shockdrivers$Sector=="Aquaculture",], aes(x=Region, y=Recovery2))+geom_boxplot(outlier.alpha = 0)+
  geom_jitter(aes(colour=Category), size=1.8, alpha=0.8, width=0.2)+
  scale_color_manual(values=cols)+
  scale_x_discrete(drop=FALSE)+
  scale_y_continuous(limits = c(0,48))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.title.y = element_text(size=8),
        axis.text.y =   element_text(size=8),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(0,0,0,0.2), "cm"),
        axis.text.x = element_text(angle=45, size=8, hjust=1, margin=unit(c(0.1,0,0,0), "cm")))+
  labs(y="Recovery time (years)", x="")+
  geom_text(data = maxrecaqua, mapping = aes(x=Region, y= Recovery2, label = Country), size=3, position = position_nudge(y = 6), hjust="inward")


# Recovery<-ggarrange(Rec1, Rec2, Rec3, Rec4, legend = "none", nrow=4, ncol=1, heights = c(1,1,1,1.6), labels = c("c", "f", "j", "m"))
# 
# ggsave(filename = "Recovery.test.tiff", device="tiff", dpi=300, width=7, height = 18, units = "cm")
# 
# 
# allnl<-ggarrange(pies, Sizes, Recovery, ncol=3, nrow=1, legend = "none", widths = c(0.6,1,1))
# 
# ggsave(filename = "Drivers.test.tiff", device="tiff", dpi=600, width=18, height = 18, units="cm")

#WITH PIE CHARTS

# #Rows
# row1<-ggarrange(pie1, size1, Rec1, nrow = 1, ncol=3, labels = c("a","b", "c"), legend = "none", widths = c(0.6,1,1), font.label = list(size=10))
# row2<-ggarrange(pie2, size2, Rec2, nrow = 1, ncol=3, labels = c("d","e", "f"), legend = "none", widths = c(0.6,1,1), font.label = list(size=10))
# row3<-ggarrange(pie3, size3, Rec3, nrow = 1, ncol=3, labels = c("h","i", "j"), legend = "none", widths = c(0.6,1,1), font.label = list(size=10))
# row4<-ggarrange(pie4, size4, Rec4, nrow = 1, ncol=3, labels = c("k","l", "m"), legend = "none", widths = c(0.6,1,1), font.label = list(size=10))
# 
# allnl<-ggarrange(row1, row2, row3, row4, nrow = 4, ncol = 1, legend = "none", heights = c(1,1, 1,1.6))
# 
# ggsave("drivers combined.test.tiff", device = "tiff", dpi = 600, width = 18.3, height = 18, units = "cm")
# 
driverlegend<-get_legend(pie1)
# 
# ggarrange(allnl, driverlegend, nrow=2, ncol=1, heights = c(1,0.15))
# 
# ggsave(filename = "Drivers.tiff", device="tiff", dpi=600, width=18.3, height=20, units="cm")


#WITHOUT PIE CHARTS

# row1<-ggarrange(size1, Rec1, nrow = 1, ncol=2, labels = c("a","b"), legend = "none", font.label = list(size=10))
# row2<-ggarrange( size2, Rec2, nrow = 1, ncol=2, labels = c("c","d"), legend = "none", font.label = list(size=10))
# row3<-ggarrange( size3, Rec3, nrow = 1, ncol=2, labels = c("e","f"), legend = "none",  font.label = list(size=10))
# row4<-ggarrange(size4, Rec4, nrow = 1, ncol=2, labels = c("g","h"), legend = "none",  font.label = list(size=10))

col1<-ggarrange(size1, size2, size3, size4, nrow = 4, ncol=1, labels = c("a","c", "e", "g"), legend = "none", font.label = list(size=10), heights = c(1,1,1,1.5))

col1<-annotate_figure(col1, top =text_grob("Shock sizes", vjust = 0.5, color="black"))

col2<-ggarrange(Rec1, Rec2, Rec3, Rec4, nrow = 4, ncol=1, labels = c("b","d", "f", "h"), legend = "none", font.label = list(size=10), heights = c(1,1,1,1.5))
col2<-annotate_figure(col2, top =text_grob("Recovery times", vjust = 0.5, color="black"))

ggsave(filename = "Magnitude.test.tiff", device="tiff", dpi=300, width=7, height = 18, units = "cm")
ggsave(filename = "Recovery.test.tiff", device="tiff", dpi=300, width=7, height = 18, units = "cm")


allnl<-ggarrange(col1, col2, nrow = 1, ncol = 2, legend = "none", widths =c(1,1))

ggsave("drivers combined.test2.tiff", device = "tiff", dpi = 600, width = 17.3, height = 20, units = "cm")

driverlegend<-get_legend(pie1)

combosize<-ggarrange(allnl, driverlegend, nrow=2, ncol=1, heights = c(1,0.15), widths = c(1,1.2))


ggsave(filename = "Drivers2.tiff", device="tiff", dpi=600, width=16.5, height=20, units="cm")

```



#Figure 4 - Shocks over time plot

```{r}

#shockdrivers broken into sectors

cropdrivers <- shockdrivers[shockdrivers$Sector=="Crops",]
cropdriversovertime <- data.frame(table(cropdrivers$Year))

livestockdrivers <- shockdrivers[shockdrivers$Sector=="Livestock",]
livestockdriversovertime <- data.frame(table(livestockdrivers$Year))


fisheriesdrivers <- shockdrivers[shockdrivers$Sector=="Fisheries",]
fisheriesdriversovertime <- data.frame(table(fisheriesdrivers$Year))


aquaculturedrivers <- shockdrivers[shockdrivers$Sector=="Aquaculture",]
aquaculturedriversovertime <- data.frame(table(aquaculturedrivers$Year))







#CROP SHOCKS OVER TIME
cropshocks<-shocks2[shocks2$Sector=="Crops",]
cropsovertime <-data.frame(table(cropshocks$Year, cropshocks$BaseComp, cropshocks$Average, cropshocks$Span))

names(cropsovertime)[names(cropsovertime)=="Var1"] <-"Year"
names(cropsovertime)[names(cropsovertime)=="Var2"] <-"Duration"
names(cropsovertime)[names(cropsovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(cropsovertime)[names(cropsovertime)=="Var4"] <-"Span"


cropsovertime$Freq <- as.numeric(cropsovertime$Freq)
cropsovertime$Year <- as.numeric(levels(cropsovertime$Year))[cropsovertime$Year]

ggplot(data = cropsovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency")






#crop shocks with confidence

mins <- tapply(cropsovertime$Freq, INDEX = cropsovertime$Year, FUN = min)
maxs <- tapply(cropsovertime$Freq, INDEX = cropsovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(cropshocks$Year, interaction(cropshocks$Average, cropshocks$Span, cropshocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]


#add the correct amount from the selected model

names(cropdriversovertime)[names(cropdriversovertime)=="Freq"]<-"actual2"
names(cropdriversovertime)[names(cropdriversovertime)=="Var1"]<-"Year"
cropdriversovertime$Year <- as.numeric(levels(cropdriversovertime$Year))[cropdriversovertime$Year]

av.shocks <- join(av.shocks, cropdriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0

# av.shocks$actual <-cropdriversovertime$Freq[cropsovertime$Span==0.6 & cropsovertime$Average=="Median"& cropsovertime$Duration==7] 



#adjusted shock frequency for shock rate
av.shocks<-join(av.shocks, CropsN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$CropsN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$CropsN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$CropsN

#add decades
av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"


#add decadal trends
  
av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA



(p1<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  theme(panel.background = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        panel.grid = element_blank(),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        axis.title.x = element_blank())+
  scale_y_continuous(limits = c(0,0.07))+
  scale_x_continuous(limits = c(1964,2013))+
  labs(y=bquote(Shock~freq.))+
    annotation_custom(cropimg, xmin = 1964, xmax=1974, ymin = 0.035, ymax=0.065))

#Crop shocks by driver over time
driversandtime<- data.frame(table(cropdrivers$Year, cropdrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]

#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<-(sum*(log(sum)))*-1
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

# cropdriversovertime <- join(driversandtime, cropdriversovertime, by="Year", type="left")
# cropdriversovertime$Prop <- cropdriversovertime$Freq/ cropdriversovertime$actual2

(p2 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
    geom_line(aes(y=Index*5), linetype=2, colour="grey50", size=1)+
  scale_fill_manual(values=cols)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8), sec.axis = sec_axis(~./5, name = bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0,0,0), "cm"),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~no.)))



#LIVESTOCK SHOCKS OVER TIME
livestockshocks<-shocks2[shocks2$Sector=="Livestock",]
livestockovertime <-data.frame(table(livestockshocks$Year, livestockshocks$BaseComp, livestockshocks$Average, livestockshocks$Span))

names(livestockovertime)[names(livestockovertime)=="Var1"] <-"Year"
names(livestockovertime)[names(livestockovertime)=="Var2"] <-"Duration"
names(livestockovertime)[names(livestockovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(livestockovertime)[names(livestockovertime)=="Var4"] <-"Span"


livestockovertime$Freq <- as.numeric(livestockovertime$Freq)
livestockovertime$Year <- as.numeric(levels(livestockovertime$Year))[livestockovertime$Year]

ggplot(data = livestockovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency")







#livestock shocks with confidence

mins <- tapply(livestockovertime$Freq, INDEX = livestockovertime$Year, FUN = min)
maxs <- tapply(livestockovertime$Freq, INDEX = livestockovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(livestockshocks$Year, interaction(livestockshocks$Average, livestockshocks$Span, livestockshocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]

#add the correct amount from the selected model

names(livestockdriversovertime)[names(livestockdriversovertime)=="Freq"]<-"actual2"
names(livestockdriversovertime)[names(livestockdriversovertime)=="Var1"]<-"Year"
livestockdriversovertime$Year <- as.numeric(levels(livestockdriversovertime$Year))[livestockdriversovertime$Year]

av.shocks <- join(av.shocks, livestockdriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0


# av.shocks$actual <-livestockovertime$Freq[livestockovertime$Span==0.6 & livestockovertime$Average=="Median"& livestockovertime$Duration==7] 

#adjusting shock frequency for shock rate

av.shocks<-join(av.shocks, LivestockN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$LivestockN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$LivestockN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$LivestockN


#add decades

av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"

#add decadal trends
  
av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA



(p3<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits = c(0,0.07))+
  scale_x_continuous(limits = c(1964,2014))+
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0,0,0), "cm"),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~freq.))+
    annotation_custom(cowimg, xmin = 1964, xmax=1974, ymin = 0.035, ymax=0.065))


#Livestock shocks by driver over time
driversandtime<- data.frame(table(livestockdrivers$Year, livestockdrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]


#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<- -(sum*(log(sum)))
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

# driversandtime
# 
# livestockdriversovertime <- join(driversandtime, livestockdriversovertime, by="Year", type="left")
# livestockdriversovertime$Prop <- livestockdriversovertime$Freq/ livestockdriversovertime$actual2

(p4 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols)+
  geom_line(aes(y=Index*5), linetype=2, colour="grey50", size=1)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8),sec.axis = sec_axis(~./5, name = bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~no.)))








#FISHERIES SHOCKS OVER TIME
fisheriesshocks<-shocks2[shocks2$Sector=="Fisheries",]
fisheriesovertime <-data.frame(table(fisheriesshocks$Year, fisheriesshocks$BaseComp, fisheriesshocks$Average, fisheriesshocks$Span))

names(fisheriesovertime)[names(fisheriesovertime)=="Var1"] <-"Year"
names(fisheriesovertime)[names(fisheriesovertime)=="Var2"] <-"Duration"
names(fisheriesovertime)[names(fisheriesovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(fisheriesovertime)[names(fisheriesovertime)=="Var4"] <-"Span"


fisheriesovertime$Freq <- as.numeric(fisheriesovertime$Freq)
fisheriesovertime$Year <- as.numeric(levels(fisheriesovertime$Year))[fisheriesovertime$Year]

(ggplot(data = fisheriesovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency"))






#fisheries shocks with confidence

mins <- tapply(fisheriesovertime$Freq, INDEX = fisheriesovertime$Year, FUN = min)
maxs <- tapply(fisheriesovertime$Freq, INDEX = fisheriesovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(fisheriesshocks$Year, interaction(fisheriesshocks$Average, fisheriesshocks$Span, fisheriesshocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]



#correct actual shock number for selected model

names(fisheriesdriversovertime)[names(fisheriesdriversovertime)=="Freq"]<-"actual2"
names(fisheriesdriversovertime)[names(fisheriesdriversovertime)=="Var1"]<-"Year"
fisheriesdriversovertime$Year <- as.numeric(levels(fisheriesdriversovertime$Year))[fisheriesdriversovertime$Year]

av.shocks <- join(av.shocks, fisheriesdriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0


# av.shocks$actual <-fisheriesovertime$Freq[fisheriesovertime$Span==0.6 & fisheriesovertime$Average=="Median"& fisheriesovertime$Duration==7] 

av.shocks<-join(av.shocks, FisheriesN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$FisheriesN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$FisheriesN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$FisheriesN


#add decades

av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"

#add decadal trends
  
av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA

av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA


(p5<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits=c(0, 0.07))+
  scale_x_continuous(limits = c(1964, 2014))+
  theme(panel.background = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0,0,0), "cm"),
        panel.grid = element_blank(),
        axis.title.x = element_blank())+
  labs(y=bquote(Shock~freq.))+
  annotation_custom(fishingimg, xmin = 1961, xmax=1978, ymin = 0.025, ymax=0.07))



#fisheries shocks by driver over time
driversandtime<- data.frame(table(fisheriesdrivers$Year, fisheriesdrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]

#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("196", drivers.div$Year)]<-"1960s"
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<- -(sum*(log(sum)))
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("196", driversandtime$Year)]<-"1960s"
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="1960s"]<-NA
driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

driversandtime

# fisheriesdriversovertime <- join(driversandtime, fisheriesdriversovertime, by="Year", type="left")
# fisheriesdriversovertime$Prop <- fisheriesdriversovertime$Freq/ fisheriesdriversovertime$actual2

(p6 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols)+
    geom_line(aes(y=Index*4), linetype=2, colour="grey50", size=1)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8),sec.axis = sec_axis(~./4, name =bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        plot.margin = unit(c(0,0.2,0,0), "cm"))+
  labs(X=bquote(bold(Year)), y=bquote(Shock~no.)))



#AQUACULURE SHOCKS OVER TIME

aquashocks<-shocks2[shocks2$Sector=="Aquaculture",]
aquaovertime <-data.frame(table(aquashocks$Year, aquashocks$BaseComp, aquashocks$Average, aquashocks$Span))

names(aquaovertime)[names(aquaovertime)=="Var1"] <-"Year"
names(aquaovertime)[names(aquaovertime)=="Var2"] <-"Duration"
names(aquaovertime)[names(aquaovertime)=="Var3"] <-"Average"
#names(shocksovertime)[names(shocksovertime)=="Var5"] <-"Rank"
names(aquaovertime)[names(aquaovertime)=="Var4"] <-"Span"


aquaovertime$Freq <- as.numeric(aquaovertime$Freq)
aquaovertime$Year <- as.numeric(levels(aquaovertime$Year))[aquaovertime$Year]

(ggplot(data = aquaovertime, aes(x=Year, y=Freq, group=interaction(Average, Span, Duration)))+
  geom_line()+
  theme_bw()+
  theme(panel.grid = element_blank(),
        panel.background = element_blank())+
  labs(y="Shock frequency"))







#aquaculture shocks with confidence

mins <- tapply(aquaovertime$Freq, INDEX = aquaovertime$Year, FUN = min)
maxs <- tapply(aquaovertime$Freq, INDEX = aquaovertime$Year, FUN = max)

#median for across all ensembles
rejigged<- data.frame(table(aquashocks$Year, interaction(aquashocks$Average, aquashocks$Span, aquashocks$BaseComp)))

names(rejigged)[names(rejigged)=="Var1"] <-"Year"
names(rejigged)[names(rejigged)=="Var2"] <-"Combo"

rejigged2 <-(tapply(X = rejigged$Freq, INDEX = rejigged$Year, FUN = mean))

medianshocks <- data.frame(Year=names(rejigged2), Freq=rejigged2)

class(medianshocks$Year)

av.shocks <- cbind.data.frame(medianshocks, mins, maxs)
av.shocks$Freq <-as.numeric(av.shocks$Freq)
av.shocks$mins <- as.numeric(av.shocks$mins)
av.shocks$maxs <-as.numeric(av.shocks$maxs)
av.shocks$Year <- as.numeric(levels(av.shocks$Year))[av.shocks$Year]


#Correct actual number with selected model
names(aquaculturedriversovertime)[names(aquaculturedriversovertime)=="Freq"]<-"actual2"
names(aquaculturedriversovertime)[names(aquaculturedriversovertime)=="Var1"]<-"Year"
aquaculturedriversovertime$Year <- as.numeric(levels(aquaculturedriversovertime$Year))[aquaculturedriversovertime$Year]

av.shocks <- join(av.shocks, aquaculturedriversovertime, by="Year", type="left")
av.shocks$actual2[is.na(av.shocks$actual2)]<-0

# av.shocks$actual <-aquaovertime$Freq[aquaovertime$Span==0.6 & aquaovertime$Average=="Median"& aquaovertime$Duration==7] 

#adjust shock frequency for shock rate

av.shocks<-join(av.shocks, AquacultureN, by="Year", type="left")
av.shocks$mins.adj <-av.shocks$mins/av.shocks$AquacultureN
av.shocks$maxs.adj <-av.shocks$maxs/av.shocks$AquacultureN
av.shocks$actual.adj <-av.shocks$actual2/av.shocks$AquacultureN


#add decades

av.shocks$decade<-NA
av.shocks$decade[grep("196", av.shocks$Year)]<-"1960s"
av.shocks$decade[grep("197", av.shocks$Year)]<-"1970s"
av.shocks$decade[grep("198", av.shocks$Year)]<-"1980s"
av.shocks$decade[grep("199", av.shocks$Year)]<-"1990s"
av.shocks$decade[grep("200", av.shocks$Year)]<-"2000s"
av.shocks$decade[grep("201", av.shocks$Year)]<-"2010s"

#add decadal trends

av.shocks$mins.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1960s"])
av.shocks$mins.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1970s"])
av.shocks$mins.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1980s"])
av.shocks$mins.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="1990s"])
av.shocks$mins.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2000s"])
#av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$mins.adj[av.shocks$decade=="2010s"])
av.shocks$mins.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$maxs.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1960s"])
av.shocks$maxs.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1970s"])
av.shocks$maxs.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1980s"])
av.shocks$maxs.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="1990s"])
av.shocks$maxs.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2000s"])
#av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$maxs.adj[av.shocks$decade=="2010s"])
av.shocks$maxs.decadal[av.shocks$decade=="2010s"]<-NA


av.shocks$actual.decadal[av.shocks$decade=="1960s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1960s"])
av.shocks$actual.decadal[av.shocks$decade=="1970s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1970s"])
av.shocks$actual.decadal[av.shocks$decade=="1980s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1980s"])
av.shocks$actual.decadal[av.shocks$decade=="1990s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="1990s"])
av.shocks$actual.decadal[av.shocks$decade=="2000s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2000s"])
#av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-mean(av.shocks$actual.adj[av.shocks$decade=="2010s"])
av.shocks$actual.decadal[av.shocks$decade=="2010s"]<-NA





(p7<-ggplot(data=av.shocks, aes(x=Year))+
  geom_ribbon(aes(ymin=mins.decadal, ymax=maxs.decadal), fill="grey50")+
  geom_ribbon(aes(ymin=mins.adj, ymax=maxs.adj), fill="grey")+
  geom_line(aes(y=actual.decadal), linetype=2)+
  geom_line(aes(y=actual.adj), colour="Red")+
  theme_bw()+
  scale_y_continuous(limits=c(0, 0.07))+
  scale_x_continuous(limits = c(1964, 2014))+
  theme(panel.background = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        axis.title.x = element_blank(),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        panel.grid = element_blank())+
  labs(y=bquote(Shock~freq.))+
    annotation_custom(aquaimg, xmin = 1964, xmax=1974, ymin = 0.035, ymax=0.065))




#aquaculture shocks by driver over time
driversandtime<- data.frame(table(aquaculturedrivers$Year, aquaculturedrivers$Category))
names(driversandtime)[names(driversandtime)=="Var1"] <-"Year"
names(driversandtime)[names(driversandtime)=="Var2"] <-"Driver"
driversandtime$Freq <-as.numeric(driversandtime$Freq)
driversandtime$Year <- as.numeric(levels(driversandtime$Year))[driversandtime$Year]

#diversity index work
driversandtime<-driversandtime[order(driversandtime$Year),]
drivers.div<-driversandtime[driversandtime$Freq!=0,]
drivers.div$Driver<-as.character(drivers.div$Driver)
drivers.div<-drivers.div[drivers.div$Driver!="Unknown",]
drivers.div$Driver <-as.factor(drivers.div$Driver)
drivers.div$decade<-NA
drivers.div$decade[grep("196", drivers.div$Year)]<-"1960s"
drivers.div$decade[grep("197", drivers.div$Year)]<-"1970s"
drivers.div$decade[grep("198", drivers.div$Year)]<-"1980s"
drivers.div$decade[grep("199", drivers.div$Year)]<-"1990s"
drivers.div$decade[grep("200", drivers.div$Year)]<-"2000s"
drivers.div$decade[grep("201", drivers.div$Year)]<-"2010s"
drivers.div$decade<-as.factor(drivers.div$decade)

#Calculate diversity indices for each decade - Shannon-Weiner
div.ind<-matrix(NA, nrow = length(levels(drivers.div$decade)), ncol=length(levels(drivers.div$Driver)))

for (d in 1:length(levels(drivers.div$decade))){
  for (c in 1:length(levels(drivers.div$Driver))){
    sum<-sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d] & drivers.div$Driver==levels(drivers.div$Driver)[c]])/ (sum(drivers.div$Freq[drivers.div$decade==levels(drivers.div$decade)[d]]))
    div.ind[d,c]<- -(sum*(log(sum)))
  }
}

div.ind[is.nan(div.ind)]<-0
colnames(div.ind)<-levels(drivers.div$Driver)
rownames(div.ind)<-levels(drivers.div$Year)
index.res<- cbind.data.frame(levels(drivers.div$decade), rowSums(div.ind))
names(index.res)[1]<-"Decade"
names(index.res)[2]<-"Index"

driversandtime$Decade<-NA
driversandtime$Decade[grep("196", driversandtime$Year)]<-"1960s"
driversandtime$Decade[grep("197", driversandtime$Year)]<-"1970s"
driversandtime$Decade[grep("198", driversandtime$Year)]<-"1980s"
driversandtime$Decade[grep("199", driversandtime$Year)]<-"1990s"
driversandtime$Decade[grep("200", driversandtime$Year)]<-"2000s"
driversandtime$Decade[grep("201", driversandtime$Year)]<-"2010s"
driversandtime<-join(driversandtime, index.res, by="Decade", type="left")

driversandtime$Index[driversandtime$Decade=="2010s"]<-NA

# driversandtime
# 
# aquaculturedriversovertime <- join(driversandtime, aquaculturedriversovertime, by="Year", type="left")
# aquaculturedriversovertime$Prop <- aquaculturedriversovertime$Freq/ aquaculturedriversovertime$actual2

# filler<-(data.frame(Year=c(1980:1983, 1985:1989), Driver=rep(NA,9), Freq=rep(0,9), Decade=rep("1980s",9), Index=rep(0,9)))
# filler2<-rbind.data.frame(driversandtime, filler)
# filler2<-filler2[order(filler2$Year),]
# filler2$Decade<-as.factor(filler2$Driver)
# levels(filler2$Driver)

(p8 <-ggplot(data=driversandtime, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols)+
  geom_line(aes(x=Year, y=Index*4), linetype=2, colour="grey50", size=1)+
  theme_bw()+
  scale_x_continuous(limits = c(1964, 2014))+
  scale_y_continuous(limits = c(0, 8),sec.axis = sec_axis(~./4, name =bquote(Shannon~Index~(H))))+
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8),
        legend.key.width = unit(0.5, "cm"),
        legend.position = "bottom",
        legend.text = element_text(size=9),
        plot.margin = unit(c(0,0.2,0,0), "cm"),
        legend.title = element_text(face="bold"))+
  labs(y=bquote(Shock~no.), x=bquote(bold(Year)))+
    guides(fill=guide_legend(nrow=4, byrow = T)))


#left<-ggarrange(p1, p3, p5, p7, ncol=1, nrow=4, labels = c("a", "c", "e", "g"), heights = c(1,1,1,1))

#right<-ggarrange(p2, p4, p6, p8, ncol=1, nrow=4, labels = c("b", "d", "f", "h"), common.legend = F, legend = "none", heights = c(1,1,1,1))


#ggarrange(ggarrange(left, right, align = "hv"), driverlegend, nrow=2, ncol=1, heights = c(1,0.15))


#ggsave(filename="Shock over time per sector and drivers.tiff", device="tiff", dpi=600, width=8.9, height=8, units="cm")


#Figure 1 

fig1<-ggarrange(p1, p3, p2,p4, p5,p7, p6,p8, labels=c("a","c","b","d","e", "g", "f", "h"), ncol=2, nrow=4, legend = "none", align = "hv" , font.label = list(size=12))

driverlegend<-get_legend(pie1)

fig1<-ggarrange(fig1, driverlegend, nrow=2, ncol=1, heights = c(1,0.15))

ggsave(filename = "Figure 1 - Shock rates over time.tiff", device = "tiff", dpi=600, width = 18, height=16, units = "cm")

ggsave(filename = "Figure 1 - Shock rates over time.pdf", device = pdf, dpi=600, width = 18, height=18, units = "cm")


```



#Figure 5 - LAND_SEA SWITCHES OR SYNCHRONIES 


```{r}
Dom<-crops[crops$Country=="Dominica" & crops$Item=="Fruit excl Melons,Total",]
Dom<-Dom[,c(4,6)]
Dom$Fisheries <-aggfisheries$Value[aggfisheries$Country=="Dominica"]
Dom$Year <- as.numeric(Dom$Year)


cols<-c("Fisheries landings" ="dodgerblue", "Fruit production"="firebrick")

p9<-ggplot(data = Dom, aes(x=Year))+
  #geom_point(aes(y=(Value-mean(Value))/sd(Value)), colour="firebrick")+
  geom_line(aes(y=(Value-mean(Value))/sd(Value)), size=0.7,colour="firebrick")+
  #geom_point(aes(y=((Fisheries-mean(Fisheries))/sd(Fisheries))), colour="dodgerblue")+
  geom_line(aes(y=((Fisheries-mean(Fisheries))/sd(Fisheries))), size=0.7, colour="dodgerblue")+
  scale_x_continuous(limits = c(1960, 1995))+
  scale_y_continuous(limits=c(-2.5, 3.2))+
  theme_bw()+
  theme(panel.grid = element_blank(),
        legend.background = element_blank(),
        legend.position = c(0.27, 0.9), 
        legend.text = element_text(size = 8),
        axis.title = element_text(size=10))+
  #annotate("rect", xmin=1977, xmax=1985, ymin=-1.8, ymax=3, fill="grey", col=NA, alpha=0.2)+
  geom_vline(xintercept = 1979, lty=2)+
  geom_vline(xintercept = 1983, lty=2)+
  annotate("text", x = 1969, y = 1.8, label = "Hurricane David", size=2.7)+
  geom_segment(aes(x = 1976 , y = 1.8 , xend =1978.5 , yend = 1.8), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  annotate("text", x = 1970, y = -2, label = "Stock collapse", size=2.7)+
  geom_segment(aes(x = 1976 , y = -2 , xend =1982.5 , yend = -2), size=0.5, arrow = arrow(length = unit(0.2, "cm")))+
  labs(y="")#+
  scale_colour_manual("", values=cols)
  
  #annotate("text", x = 1972, y = 1.2, label = "Hurricane David")+
  
afgfish<-aggfisheries[,c(1,2,6,7)]
afg<-cbind.data.frame(years, aggcrops$Value[aggcrops$Country=="Afghanistan"], agglivestock$Value[agglivestock$Country=="Afghanistan"], afgfish$Value[afgfish$Country=="Afghanistan"])

names(afg)[1]<-"Year"
names(afg)[2]<-"Crops"
names(afg)[3]<-"Livestock"
names(afg)[4]<-"Fisheries"
afg$Year <-as.numeric(afg$Year)

cols2<-c("Fisheries landings" ="dodgerblue", "Crop production"="firebrick", "Livestock production"="grey50")

p10<-ggplot(data=afg, aes(x=Year))+
  geom_line(aes(y=(Crops-mean(Crops))/sd(Crops), colour="Crop production"), size=0.7)+
  geom_line(aes(y=(Livestock-mean(Livestock))/sd(Livestock), colour="Livestock production"), size=0.7)+
  geom_line(aes(y=(Fisheries-mean(Fisheries))/sd(Fisheries), colour="Fisheries landings"), size=0.7)+
  scale_x_continuous(limits=c(1980, 2013))+
  scale_y_continuous(limits=c(-2.5,3.5))+
  scale_colour_manual("", values = cols2)+
  theme_bw()+
  theme(panel.grid = element_blank(),
        legend.position = c(0.27, 0.9), 
        legend.text = element_text(size = 8),
        legend.key.size =  unit(4, "mm"),
        legend.background = element_blank())+
  geom_vline(xintercept = 2000, lty=2)+
  labs(y=bquote(Normalised~production))+
  annotate("rect", xmin = 2000, xmax = 2002, fill="ivory3", colour=NA, ymin=-Inf, ymax=Inf, alpha=0.3)+
  annotate("text", x = 1991.5, y = -2.1, label = "Drought onset", size=2.7)+
  geom_segment(aes(x = 1997 , y = -2.1 , xend =1999.5 , yend = -2.1), size=0.5, arrow = arrow(length = unit(0.2, "cm")))

ggarrange(p10,p9, labels=c("a", "b"), ncol=2, nrow = 1)
ggsave(filename = "Tradeoffs and synergies2.tiff", device = "tiff", dpi = 600, width=18, height=6, units = "cm")

ggsave(filename = "Tradeoffs and synergies2.pdf", device = pdf, dpi = 600, width=18, height=6, units = "cm")



library(ggplot2)
```


#Shock  calculations

```{r}
#Overall shock rates
#crops
nrow(shockdrivers[shockdrivers$Sector=="Crops",])/length(levels(aggcrops$Country))

#livestock
nrow(shockdrivers[shockdrivers$Sector=="Livestock",])/length(levels(agglivestock$Country))

#fisheries
nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])/length(levels(aggfisheries$Country))

#aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])/length(levels(aggfisheries$Country))


#aquaculture rates in LACa vs nezt nearest
unique(aquacultureSR$Rate[aquacultureSR$Continent=="Latin America and Caribbean"])/unique(aquacultureSR$Rate[aquacultureSR$Continent=="South Asia"])

#Livestock rates in South Asia vs next highest SSA 
unique(livestockSR$Rate[livestockSR$Continent=="South Asia"])/unique(livestockSR$Rate[livestockSR$Continent=="Africa"])

#crop rates in south asia compared to oceania
unique(cropsSR$Rate[cropsSR$Continent=="South Asia"])/unique(cropsSR$Rate[cropsSR$Continent=="Oceania"])

unique(fisheriesSR$Rate[fisheriesSR$Continent=="Europe and Central Asia"])/unique(fisheriesSR$Rate[fisheriesSR$Continent=="South Asia"])



nrow(shockdrivers)

mean(c(0.3031915,0.2722513))

mean(c(0.3118812,0.2227723))

#Contribution of climate to crop shocks
nrow(shockdrivers[shockdrivers$Sector=="Crops" & (shockdrivers$Category=="Climate/weather & geopolitical/economic events"| shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Crops",])




#Contribution of climate to livestock shocks
nrow(shockdrivers[shockdrivers$Sector=="Livestock" & (shockdrivers$Category=="Climate/weather & geopolitical/economic events"| shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Livestock",])

#Contribution of geopolitical to livestock shocks
nrow(shockdrivers[shockdrivers$Sector=="Livestock" & (shockdrivers$Category=="Climate/weather & geopolitical/economic events"| shockdrivers$Category=="Geopolitical/economic events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Livestock",])

##Contribution of overfishing to fisheries
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Mismanagement & geopolitical/economic events"| shockdrivers$Category=="Mismanagement & policy change"| shockdrivers$Category=="Mismanagement"| shockdrivers$Category=="Climate/weather events & mismanagement"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contribution to overfishing of policy change
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Policy change"| shockdrivers$Category=="Mismanagement & policy change"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contribution of geopolitical to fisheries
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Mismanagement & geopolitical/economic events"| shockdrivers$Category=="Geopolitical/economic events"| shockdrivers$Category=="Climate/weather & geopolitical/economic events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contibution of extreme events
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Climate/weather events & mismanagement"| shockdrivers$Category==""| shockdrivers$Category=="Climate/weather & geopolitical/economic events" | shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])

#contibution of policy change
nrow(shockdrivers[shockdrivers$Sector=="Fisheries" & (shockdrivers$Category=="Mismanagement & policy change"| shockdrivers$Category==""| shockdrivers$Category=="Policy change"),])/ nrow(shockdrivers[shockdrivers$Sector=="Fisheries",])


#contibution of extreme events to aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & (shockdrivers$Category=="Climate/weather events & mismanagement"| shockdrivers$Category==""| shockdrivers$Category=="Climate/weather & geopolitical/economic events" | shockdrivers$Category=="Climate/weather events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])

#contibution of disease to aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & (shockdrivers$Category=="Other"),])/ nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])

#contribution of geopolitical to aquaculture
nrow(shockdrivers[shockdrivers$Sector=="Aquaculture" & (shockdrivers$Category=="Geopolitical/economic events"| shockdrivers$Category=="Mismanagement & geopolitical/economic events"),])/ nrow(shockdrivers[shockdrivers$Sector=="Aquaculture",])


ggplot(data=shockdrivers, aes(x=Category, y=log(AbsMagnitude)))+geom_boxplot()+geom_jitter(aes(size=Recovery, colour=Sector, alpha=0.5))





levels(shockdrivers$Category)

order(-cropssh$AbsMagnitude)

cropssh[c(38, 24, 4, 15, 53, 14, 25, 16, 48, 44, 26, 32, 13),]

mean(cropssh$AbsMagnitude[cropssh$Region=="East Asia and Pacific"])#1862453
mean(cropssh$AbsMagnitude[cropssh$Region=="SSA"])#2117651
mean(cropssh$AbsMagnitude[cropssh$Region=="MENA"])#1864970
mean(cropssh$AbsMagnitude[cropssh$Region=="LACa"])#395462.7
mean(cropssh$AbsMagnitude[cropssh$Region=="North America"])#1017
mean(cropssh$AbsMagnitude[cropssh$Region=="EuCA"])#2681218
mean(cropssh$AbsMagnitude[cropssh$Region=="South Asia"])#3118316


mean(livestocksh$AbsMagnitude[livestocksh$Region=="East Asia and Pacific"])#100295
mean(livestocksh$AbsMagnitude[livestocksh$Region=="SSA"])#90646
mean(livestocksh$AbsMagnitude[livestocksh$Region=="MENA"])#246161.5
mean(livestocksh$AbsMagnitude[livestocksh$Region=="LACa"])#360623.4
mean(livestocksh$AbsMagnitude[livestocksh$Region=="North America"])#1017
mean(livestocksh$AbsMagnitude[livestocksh$Region=="EuCA"])#1326228
mean(livestocksh$AbsMagnitude[livestocksh$Region=="South Asia"])#86147.6

mean(livestocksh$AbsMagnitude[livestocksh$Region=="EuCA"])/mean(livestocksh$AbsMagnitude[livestocksh$Region=="LACa"])

#shock rates in aquaculture 
aquacultureSR
0.4594595/ 0.2222222
0.3750000/0.2222222

mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="East Asia and Pacific"])#44213.24
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="SSA"])#278.025
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="MENA"])#939.5833
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="LACa"])#3916.003
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="North America"])#1017
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="EuCA"])#26710.83
mean(aquaculturesh$AbsMagnitude[aquaculturesh$Region=="South Asia"])#2179

# % of food production with unknown aquaculture shocks

#Austria 874 tonnes in 1990
874/sum(aggcrops$Value[aggcrops$Country=="Austria" & aggcrops$Year==1990],
agglivestock$Value[agglivestock$Country=="Austria" & agglivestock$Year==1990],
aggfisheries$Value[aggfisheries$Country=="Austria" & aggfisheries$Year==1990],
aggaqua$Value[aggaqua$Country=="Austria" & aggaqua$Year==1990])


#Bahrain 0.5 t in 2001 
0.5/sum(aggcrops$Value[aggcrops$Country=="Bahrain" & aggcrops$Year==2001],
agglivestock$Value[agglivestock$Country=="Bahrain" & agglivestock$Year==2001],
aggfisheries$Value[aggfisheries$Country=="Bahrain" & aggfisheries$Year==2001],
aggaqua$Value[aggaqua$Country=="Bahrain" & aggaqua$Year==2001])


#Burundi 2010 32.7 T 

32.7/sum(aggcrops$Value[aggcrops$Country=="Burundi" & aggcrops$Year==2010],
agglivestock$Value[agglivestock$Country=="Burundi" & agglivestock$Year==2010],
aggfisheries$Value[aggfisheries$Country=="Burundi" & aggfisheries$Year==2010],
aggaqua$Value[aggaqua$Country=="Burundi" & aggaqua$Year==2010])

#Guadeloupe 2005 9.6 T
9.6/sum(aggcrops$Value[aggcrops$Country=="Guadeloupe" & aggcrops$Year==2005],
agglivestock$Value[agglivestock$Country=="Guadeloupe" & agglivestock$Year==2005],
aggfisheries$Value[aggfisheries$Country=="Guadeloupe" & aggfisheries$Year==2005],
aggaqua$Value[aggaqua$Country=="Guadeloupe" & aggaqua$Year==2005])


#Guam 60.5T in 2003

60.5/sum(aggcrops$Value[aggcrops$Country=="Guam" & aggcrops$Year==2003],
agglivestock$Value[agglivestock$Country=="Guam" & agglivestock$Year==2003],
aggfisheries$Value[aggfisheries$Country=="Guam" & aggfisheries$Year==2003],
aggaqua$Value[aggaqua$Country=="Guam" & aggaqua$Year==2003])

#Guyana 2008 316 T 
316/sum(aggcrops$Value[aggcrops$Country=="Guyana" & aggcrops$Year==2008],
agglivestock$Value[agglivestock$Country=="Guyana" & agglivestock$Year==2008],
aggfisheries$Value[aggfisheries$Country=="Guyana" & aggfisheries$Year==2008],
aggaqua$Value[aggaqua$Country=="Guyana" & aggaqua$Year==2008])

#Guyana 2009 97.04 T
97.04/sum(aggcrops$Value[aggcrops$Country=="Guyana" & aggcrops$Year==2009],
agglivestock$Value[agglivestock$Country=="Guyana" & agglivestock$Year==2009],
aggfisheries$Value[aggfisheries$Country=="Guyana" & aggfisheries$Year==2009],
aggaqua$Value[aggaqua$Country=="Guyana" & aggaqua$Year==2009])

#Jamaica 2003 581T

581/sum(aggcrops$Value[aggcrops$Country=="Jamaica" & aggcrops$Year==2009],
agglivestock$Value[agglivestock$Country=="Jamaica" & agglivestock$Year==2009],
aggfisheries$Value[aggfisheries$Country=="Jamaica" & aggfisheries$Year==2009],
aggaqua$Value[aggaqua$Country=="Jamaica" & aggaqua$Year==2009])

#Jordan 2004 28T 
28/sum(aggcrops$Value[aggcrops$Country=="Jordan" & aggcrops$Year==2004],
agglivestock$Value[agglivestock$Country=="Jordan" & agglivestock$Year==2004],
aggfisheries$Value[aggfisheries$Country=="Jordan" & aggfisheries$Year==2004],
aggaqua$Value[aggaqua$Country=="Jordan" & aggaqua$Year==2004])

#Saint Lucia 2000 10T
10/sum(aggcrops$Value[aggcrops$Country=="Saint Lucia" & aggcrops$Year==2009],
agglivestock$Value[agglivestock$Country=="Saint Lucia" & agglivestock$Year==2009],
aggfisheries$Value[aggfisheries$Country=="Saint Lucia" & aggfisheries$Year==2009],
aggaqua$Value[aggaqua$Country=="Saint Lucia" & aggaqua$Year==2009])


# Singapore 524T 2007 
524/sum(aggcrops$Value[aggcrops$Country=="Singapore" & aggcrops$Year==2007],
agglivestock$Value[agglivestock$Country=="Singapore" & agglivestock$Year==2007],
aggfisheries$Value[aggfisheries$Country=="Singapore" & aggfisheries$Year==2007],
aggaqua$Value[aggaqua$Country=="Singapore" & aggaqua$Year==2007])

#South Africa 1318 T in 2001
1318/sum(aggcrops$Value[aggcrops$Country=="South Africa" & aggcrops$Year==2001],
agglivestock$Value[agglivestock$Country=="South Africa" & agglivestock$Year==2001],
aggfisheries$Value[aggfisheries$Country=="South Africa" & aggfisheries$Year==2001],
aggaqua$Value[aggaqua$Country=="South Africa" & aggaqua$Year==2001])


```



#Table S1 - CODE FOR SUPPLEMENTARY MATERIAL
```{r}

values<-aggcrops$Value[aggcrops$Country=="Norway"]
fit<-auto.arima(values, stationary = F, seasonal=F, approximation=F, ic="aicc", stepwise = F, allowdrift = F)
fit$coef
getarima(values)


getAnywhere(arima.string)

getarima<- function (x){ 
  fit<-auto.arima(x, stationary = F, seasonal=F, approximation=F, ic="aicc", stepwise = F, allowdrift = F, max.p = 5, max.q = 5, max.d = 2)
  order <- fit$arma[c(1, 6, 2, 3, 7, 4, 5)]
  result <- (paste("ARIMA(", order[1], ",", order[2], ",", order[3], 
    ")", sep = ""))
  return(result)
}


arima.fit<-function(x){
  fit<-auto.arima(x, stationary = F, seasonal=F, approximation=F, ic="aicc", stepwise = F, allowdrift = F, max.p = 1, max.q = 1, max.d = 1)
  return(round(fit$coef, digits = 1))
    
}


AC<-(tapply(aggcrops$Value, aggcrops$Country, FUN = getarima))
dim(AC)<-NULL
ACcrops<-data.frame(table(data.frame(Model=AC)))
names(ACcrops)[2]<-"Crops"


AC<-(tapply(agglivestock$Value, agglivestock$Country, FUN = getarima))
dim(AC)<-NULL
AClivestock<-data.frame(table(data.frame(Model=AC)))
names(AClivestock)[2]<-"Livestock"


AC<-(tapply(aggfisheries$Value, aggfisheries$Country, FUN = getarima))
dim(AC)<-NULL
ACfisheries<-data.frame(table(data.frame(Model=AC)))
names(ACfisheries)[2]<-"Fisheries"


AC<-(tapply(aggaqua$Value, aggaqua$Country, FUN = getarima))
dim(AC)<-NULL
ACaqua<-data.frame(table(data.frame(Model=AC)))
names(ACaqua)[2]<-"Aquaculture"



ACag<-join(ACcrops, AClivestock, by="Var1", type="full")
ACag<-join(ACag, ACfisheries, by="Var1", type="full")
ACtotal<-join(ACag, ACaqua , by="Var1", type="full")
ACtotal$Crops[is.na(ACtotal$Crops)]<-0
ACtotal$Livestock[is.na(ACtotal$Livestock)]<-0
ACtotal$Fisheries[is.na(ACtotal$Fisheries)]<-0
ACtotal$Aquaculture[is.na(ACtotal$Aquaculture)]<-0
ACtotal$Total <-(ACtotal$Crops+ACtotal$Livestock+ACtotal$Fisheries+ACtotal$Aquaculture)

sum(ACtotal$Total) 194/743

write.csv(ACtotal, file = "ARIMA paramterisation.csv", row.names = F)


sds<-seq(0.1, 1, by=0.1)
mag <- seq(0, 6, by=0.5)

length(sds)



matrix<-c()

for (m in mag){
  accuracy<-c()
  for (s in sds){
    tally<-c()
    for (i in 1:1000){
      innovs <- rnorm(n=52, sd=s)
      innovs[25] <- innovs[25]-m
      shocksim <- arima.sim(n=52, list(order = c(0,1,0)), innov = innovs)
      fit<-loess(shocksim~years, span=0.6)
      regress<-lm(resid(fit)[2:53]~ resid(fit)[1:52])
      if (as.vector(cooks.distance(regress))[25]>0.3){
        tally<-c(tally,1)
        accuracyint<-length(tally)/1000
      }
    }
    accuracy<-c(accuracy, accuracyint)
  }
matrix<-rbind(matrix, accuracy)
}
 
sensitivity <-data.frame(matrix)
names(sensitivity)<-sds
sensitivity$`Magnitude/SD`<-mag
sensitivity<-sensitivity[,c(11, 1:10)]

write.csv(sensitivity, file = "Sensitivity.csv", row.names = F)


innovs <- rnorm(n=52, sd=0.1)
innovs[25] <- innovs[25]
shocksim <- arima.sim(n=52, list(order = c(0,1,0)), innov = innovs)
fit<-loess(shocksim~years, span=0.6)
plot(shocksim)
lines(fit)


#DRIVERS OVER TIME

driversandtimetotal<- data.frame(table(shockdrivers$Year, shockdrivers$Category))
names(driversandtimetotal)[names(driversandtimetotal)=="Var1"] <-"Year"
names(driversandtimetotal)[names(driversandtimetotal)=="Var2"] <-"Driver"                         
driversandtimetotal$Freq <-as.numeric(driversandtimetotal$Freq)
driversandtimetotal$Year <- as.numeric(levels(driversandtimetotal$Year))[driversandtimetotal$Year]

ggplot(data=driversandtimetotal, aes(x=Year, y=Freq, fill=Driver))+
  geom_bar(stat="identity")+
  scale_fill_manual(values=cols)+
  theme_bw()+
  theme(panel.grid = element_blank(), 
        axis.title.x = element_blank(),
        legend.position = "bottom")+
  labs(y=bquote(bold(Frequency)))+
  guides(fill=guide_legend(ncol = 2))

ggsave(filename = "total drivers overtime.tiff", device="tiff", dpi = 600, height=6, width=6)



  

```


#Unused code - Composite exposure index

```{r}

#CROPS

exp.crops<-cbind.data.frame(unique(cropsSR$Continent), unique(cropsSR$Rate))
names(exp.crops)[1]<-"Continent"
names(exp.crops)[2]<-"SR"
exp.crops$Norm.SR <-((exp.crops$SR-mean(exp.crops$SR))/ sd(exp.crops$SR))

exp.crops$Mean.SS<-c(mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="LACa"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="North America"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops" & shockdrivers$Region=="East Asia"]))

exp.crops$Norm.SS<-((exp.crops$Mean.SS-mean(exp.crops$Mean.SS))/sd(exp.crops$Mean.SS))


exp.crops$Mean.Rec<-c(mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="LACa"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="North America"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Crops" & shockdrivers$Region=="East Asia"]))

exp.crops$Norm.Rec<-((exp.crops$Mean.Rec-mean(exp.crops$Mean.Rec))/sd(exp.crops$Mean.Rec))
exp.crops$Comp.Exp<-exp.crops$Norm.SR+exp.crops$Norm.SS+exp.crops$Norm.Rec


##LIVESTOCK

exp.Livestock<-cbind.data.frame(unique(livestockSR$Continent), unique(livestockSR$Rate))
names(exp.Livestock)[1]<-"Continent"
names(exp.Livestock)[2]<-"SR"
exp.Livestock$Norm.SR <-((exp.Livestock$SR-mean(exp.Livestock$SR))/ sd(exp.Livestock$SR))

exp.Livestock$Mean.SS<-c(mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="LACa"]),
0,#mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="North America"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="East Asia"]))

exp.Livestock$Norm.SS<-((exp.Livestock$Mean.SS-mean(exp.Livestock$Mean.SS))/sd(exp.Livestock$Mean.SS))


exp.Livestock$Mean.Rec<-c(mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="LACa"]),
0,#mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="North America"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Livestock" & shockdrivers$Region=="East Asia"]))

exp.Livestock$Norm.Rec<-((exp.Livestock$Mean.Rec-mean(exp.Livestock$Mean.Rec))/sd(exp.Livestock$Mean.Rec))
exp.Livestock$Comp.Exp<-exp.Livestock$Norm.SR+exp.Livestock$Norm.SS+exp.Livestock$Norm.Rec


#FISHERIES


exp.Fisheries<-cbind.data.frame(unique(fisheriesSR$Continent), unique(fisheriesSR$Rate))
names(exp.Fisheries)[1]<-"Continent"
names(exp.Fisheries)[2]<-"SR"
exp.Fisheries$Norm.SR <-((exp.Fisheries$SR-mean(exp.Fisheries$SR))/ sd(exp.Fisheries$SR))

exp.Fisheries$Mean.SS<-c(mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="LACa"]),
0,#mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="North America"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="East Asia"]))

exp.Fisheries$Norm.SS<-((exp.Fisheries$Mean.SS-mean(exp.Fisheries$Mean.SS))/sd(exp.Fisheries$Mean.SS))



exp.Fisheries$Mean.Rec<-c(mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="LACa"]),
0,#mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="North America"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Fisheries" & shockdrivers$Region=="East Asia"]))

exp.Fisheries$Norm.Rec<-((exp.Fisheries$Mean.Rec-mean(exp.Fisheries$Mean.Rec))/sd(exp.Fisheries$Mean.Rec))
exp.Fisheries$Comp.Exp<-exp.Fisheries$Norm.SR+exp.Fisheries$Norm.SS+exp.Fisheries$Norm.Rec


#AQUACULTRE


exp.Aquaculture<-cbind.data.frame(unique(aquacultureSR$Continent), unique(aquacultureSR$Rate))
names(exp.Aquaculture)[1]<-"Continent"
names(exp.Aquaculture)[2]<-"SR"
exp.Aquaculture$Norm.SR <-((exp.Aquaculture$SR-mean(exp.Aquaculture$SR))/ sd(exp.Aquaculture$SR))

exp.Aquaculture$Mean.SS<-c(mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="LACa"]),
0,#mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="North America"]),
mean(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="East Asia"]))

exp.Aquaculture$Norm.SS<-((exp.Aquaculture$Mean.SS-mean(exp.Aquaculture$Mean.SS))/sd(exp.Aquaculture$Mean.SS))



exp.Aquaculture$Mean.Rec<-c(mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="South Asia"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="EuCA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="MENA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="Oceania"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="SSA"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="LACa"]),
0,#mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="North America"]),
mean(shockdrivers$Recovery2[shockdrivers$Sector=="Aquaculture" & shockdrivers$Region=="East Asia"]))

exp.Aquaculture$Norm.Rec<-((exp.Aquaculture$Mean.Rec-mean(exp.Aquaculture$Mean.Rec))/sd(exp.Aquaculture$Mean.Rec))
exp.Aquaculture$Comp.Exp<-exp.Aquaculture$Norm.SR+exp.Aquaculture$Norm.SS+exp.Aquaculture$Norm.Rec


total.exp<-cbind.data.frame(exp.crops$Continent, exp.crops$Comp.Exp, exp.Livestock$Comp.Exp, exp.Fisheries$Comp.Exp, exp.Aquaculture$Comp.Exp)

total.exp$total<-(total.exp$`exp.crops$Comp.Exp`+ total.exp$`exp.Livestock$Comp.Exp`+ total.exp$`exp.Fisheries$Comp.Exp`+ total.exp$`exp.Aquaculture$Comp.Exp`)

#join exposure data to spatial polygons

CRworld.df<-join(CRworld.df, exp.crops, by="Continent")
LSworld.df<-join(LSworld.df, exp.Livestock, by="Continent")
eez_fish.df<-join(eez_fish.df, exp.Fisheries, by="Continent")
eez_aqua.df<-join(eez_aqua.df, exp.Aquaculture, by="Continent")

#ADJUSTING CROP RATE DISPLAY FOR AGGREGATED COUNTRIES

CRworld.df$Comp.Exp[CRworld.df$iso_a3=="GRL"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="North America"])


CRworld.df$Comp.Exp[CRworld.df$iso_a3=="ARM"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="AZE"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="BLR"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="EST"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="GEO"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="KAZ"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="KGZ"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="LVA"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="LTU"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="MDA"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="TJK"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="TKM"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="UKR"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="UZB"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])

CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SRB"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="MNE"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="HRV"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="MKD"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SVN"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SVK"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])

CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SSD"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Africa"])

#LIVESTOCK ADJUSTEDMENT FOR AGGREGATED COUNTRIES


LSworld.df$Comp.Exp[LSworld.df$iso_a3=="ARM"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="AZE"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="BLR"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="EST"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="GEO"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="KAZ"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="KGZ"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="LVA"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="LTU"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="MDA"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="TJK"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="TKM"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="UKR"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="UZB"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])

LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SRB"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="MNE"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="HRV"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="MKD"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SVN"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SVK"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])

LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SSD"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Africa"])


#MAPS of EXPOSURE
exposure.crops<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat,fill=Comp.Exp, group=group, map_id=id), colour=NA, size=0.2)+
  scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = bquote(Total~exposure~index))+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(6, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(cropimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)

#Aquaculture

exposure.Aqua<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id, fill=Comp.Exp), colour="NA", size=0.2)+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(aquaimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)




#LIVESTOCK 
exposure.LS<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat,fill=Comp.Exp, group=group, map_id=id), colour="NA", size=0.2)+
 scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(cowimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)




exposure.fish<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, fill=Comp.Exp, group=group, map_id=id), colour="NA", size=0.2)+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "left",
        legend.direction = "vertical",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+
  annotation_custom(fishingimg, xmin = -2.65e+07, xmax = -0.3e+07, ymin = -10.1e+06, ymax = -4.5e+06)

exposures<- ggarrange(exposure.crops, exposure.LS, exposure.fish, exposure.Aqua, ncol=2, nrow=2, labels=c("a", "b", "c", "d"), legend = "none")

indexlegend<-get_legend(exposure.crops)

ggarrange(exposures, indexlegend, nrow = 2, ncol=1, heights = c(1,0.1))

#######  NEEED TO ADJUST LEGEND TO INCORPORATE A COMMON RANGE ACROSS SECTORS


ggsave(filename = "Total exposure with USSR.tiff", device = "tiff", dpi = 600, width = 18, height = 12.5, units="cm")


```

##Unusued code - Composite exposure indices excluding the fall of communism

```{r}

#take out USSR and communism shocks - 15 shocks
shockdrivers2<-shockdrivers
shockdrivers2$Codes<-as.character(shockdrivers2$Codes)
shockdrivers2$Country<-as.character(shockdrivers2$Country)
shockdrivers2$Country[shockdrivers2$Country=="RÃ©union"]<-"Reunion"
shockdrivers2$Codes[shockdrivers2$Country=="Reunion"]<-"REU"
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="ALB" & shockdrivers2$Sector=="Crops"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="CUB" & shockdrivers2$Sector=="Crops"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="BGR" & shockdrivers2$Sector=="Livestock"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="PRK" & shockdrivers2$Sector=="Livestock" ),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="CSK" & shockdrivers2$Sector=="Livestock"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="DEU" & shockdrivers2$Sector=="Livestock"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="HUN" & shockdrivers2$Sector=="Livestock"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="ALB" & shockdrivers2$Sector=="Fisheries"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="RUS" & shockdrivers2$Sector=="Fisheries"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="HUN" & shockdrivers2$Sector=="Fisheries"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="ROU" & shockdrivers2$Sector=="Fisheries"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="ALB" & shockdrivers2$Sector=="Aquaculture"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="HUN" & shockdrivers2$Sector=="Aquaculture"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="PRK" & shockdrivers2$Sector=="Aquaculture"),]
shockdrivers2<-shockdrivers2[!(shockdrivers2$Codes=="POL" & shockdrivers2$Sector=="Aquaculture"),]


#redo shock rates

Country<-levels(aggcrops$Country)
Codes<- countrycode(levels(aggcrops$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(aggcrops$Country), origin = "country.name", destination = "continent")
cropsSR<-cbind.data.frame(Country, Codes, Continent)
cropsSR$Continent <-as.character(cropsSR$Continent)


cropsSR$Continent[cropsSR$Code=="BHR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="IRN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="IRQ"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="SAU"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="ARE"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="KWT"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="QAT"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="LBN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="JOR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="DZA"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="LBY"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="SYR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="EGY"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="MAR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="TUN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="DZA"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="ISR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="JOR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="MLT"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="MAR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="PSE"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="OMN"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="SYR"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="ARE"]<-"Middle East and North Africa"
cropsSR$Continent[cropsSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
cropsSR$Continent[cropsSR$Code=="BMU"]<-"North America"
cropsSR$Continent[cropsSR$Code=="GRL"]<-"North America"
cropsSR$Continent[cropsSR$Code=="USA"]<-"North America"
cropsSR$Continent[cropsSR$Code=="CAN"]<-"North America"
cropsSR$Continent[cropsSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
cropsSR$Continent[cropsSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
cropsSR$Continent[cropsSR$Continent=="Europe"]<-"Europe and Central Asia"
cropsSR$Continent[cropsSR$Code=="CYP"]<-"Europe and Central Asia"
cropsSR$Continent[cropsSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
cropsSR$Continent[cropsSR$Code=="BTN"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="AFG"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="IND"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="LKA"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="MDV"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="BGD"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="PAK"]<-"South Asia"
cropsSR$Continent[cropsSR$Code=="NPL"]<-"South Asia"

#East Asia
cropsSR$Continent[cropsSR$Continent=="Asia"]<-"East Asia"
cropsSR$Codes <-as.character(cropsSR$Codes)
cropsSR$Codes[cropsSR$Country=="Former Yugoslav SFR"]<-"BIH"
cropsSR$Codes[cropsSR$Country=="Former Czechoslovakia"]<-"CZE"
cropsSR$Continent[cropsSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
cropsSR$Continent[cropsSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"




#crops
cropsSR$Rate[cropsSR$Continent=="South Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="South Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="South Asia"]))

cropsSR$Rate[cropsSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="EuCA",])/ length(unique(aggcrops$Country[aggcrops$Continent=="EuCA"]))

cropsSR$Rate[cropsSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="MENA",])/ length(unique(aggcrops$Country[aggcrops$Continent=="MENA"]))


cropsSR$Rate[cropsSR$Continent=="East Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="East Asia",])/ length(unique(aggcrops$Country[aggcrops$Continent=="East Asia"]))

cropsSR$Rate[cropsSR$Continent=="Oceania"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="Oceania",])/ length(unique(aggcrops$Country[aggcrops$Continent=="Oceania"]))

cropsSR$Rate[cropsSR$Continent=="Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="SSA",])/ length(unique(aggcrops$Country[aggcrops$Continent=="SSA"]))

cropsSR$Rate[cropsSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="LACa",])/ length(unique(aggcrops$Country[aggcrops$Continent=="LACa"]))

cropsSR$Rate[cropsSR$Continent=="North America"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="North America",])/ length(unique(aggcrops$Country[aggcrops$Continent=="North America"]))

#Livestock rates 

Country<-levels(agglivestock$Country)
Code<- countrycode(levels(agglivestock$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(agglivestock$Country), origin = "country.name", destination = "continent")
livestockSR<-cbind.data.frame(Country, Code, Continent)
livestockSR$Continent <-as.character(livestockSR$Continent)
livestockSR$Code <- as.character(livestockSR$Code)


livestockSR$Continent[livestockSR$Code=="BHR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="IRN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="IRQ"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="SAU"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="ARE"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="KWT"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="QAT"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="LBN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="JOR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="DZA"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="LBY"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="SYR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="EGY"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="MAR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="TUN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="DZA"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="ISR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="JOR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="MLT"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="MAR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="PSE"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="OMN"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="SYR"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="ARE"]<-"Middle East and North Africa"
livestockSR$Continent[livestockSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
livestockSR$Continent[livestockSR$Code=="BMU"]<-"North America"
livestockSR$Continent[livestockSR$Code=="GRL"]<-"North America"
livestockSR$Continent[livestockSR$Code=="USA"]<-"North America"
livestockSR$Continent[livestockSR$Code=="CAN"]<-"North America"
livestockSR$Continent[livestockSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
livestockSR$Continent[livestockSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
livestockSR$Continent[livestockSR$Continent=="Europe"]<-"Europe and Central Asia"
livestockSR$Continent[livestockSR$Code=="CYP"]<-"Europe and Central Asia"
livestockSR$Continent[livestockSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
livestockSR$Continent[livestockSR$Code=="BTN"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="AFG"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="IND"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="LKA"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="MDV"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="BGD"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="PAK"]<-"South Asia"
livestockSR$Continent[livestockSR$Code=="NPL"]<-"South Asia"

#East Asia and Pacific
livestockSR$Continent[livestockSR$Continent=="Asia"]<-"East Asia"

livestockSR$Code[livestockSR$Country=="Former Yugoslav SFR"]<-"BIH"
livestockSR$Code[livestockSR$Country=="Former Czechoslovakia"]<-"CZE"
livestockSR$Continent[livestockSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
livestockSR$Continent[livestockSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"


#Rates
livestockSR$Rate[livestockSR$Continent=="South Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="South Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="South Asia"]))

livestockSR$Rate[livestockSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="EuCA",])/ length(unique(agglivestock$Country[agglivestock$Continent=="EuCA"]))

livestockSR$Rate[livestockSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="MENA",])/ length(unique(agglivestock$Country[agglivestock$Continent=="MENA"]))

livestockSR$Rate[livestockSR$Continent=="East Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="East Asia",])/ length(unique(agglivestock$Country[agglivestock$Continent=="East Asia"]))

livestockSR$Rate[livestockSR$Continent=="Oceania"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="Oceania",])/ length(unique(agglivestock$Country[agglivestock$Continent=="Oceania"]))

livestockSR$Rate[livestockSR$Continent=="Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="SSA",])/ length(unique(agglivestock$Country[agglivestock$Continent=="SSA"]))

livestockSR$Rate[livestockSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="LACa",])/ length(unique(agglivestock$Country[agglivestock$Continent=="LACa"]))

livestockSR$Rate[livestockSR$Continent=="North America"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="North America",])/ length(unique(agglivestock$Country[agglivestock$Continent=="North America"]))


#FISHERIES

Country<-levels(aggfisheries$Country)
Code<- countrycode(levels(aggfisheries$Country), origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(levels(aggfisheries$Country), origin = "country.name", destination = "continent")
fisheriesSR <-cbind.data.frame(Country, Code, Continent)
fisheriesSR$Continent <-as.character(fisheriesSR$Continent)
fisheriesSR$Code <-as.character(fisheriesSR$Code)


fisheriesSR$Continent[fisheriesSR$Code=="BHR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="IRN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="IRQ"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="SAU"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="ARE"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="KWT"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="QAT"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="LBN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="JOR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="DZA"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="LBY"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="SYR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="EGY"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="MAR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="TUN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="DZA"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="ISR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="JOR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="MLT"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="MAR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="PSE"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="OMN"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="SYR"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="ARE"]<-"Middle East and North Africa"
fisheriesSR$Continent[fisheriesSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
fisheriesSR$Continent[fisheriesSR$Code=="BMU"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="GRL"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="USA"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="CAN"]<-"North America"
fisheriesSR$Continent[fisheriesSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
fisheriesSR$Continent[fisheriesSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
fisheriesSR$Continent[fisheriesSR$Continent=="Europe"]<-"Europe and Central Asia"
fisheriesSR$Continent[fisheriesSR$Code=="CYP"]<-"Europe and Central Asia"
fisheriesSR$Continent[fisheriesSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
fisheriesSR$Continent[fisheriesSR$Code=="BTN"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="AFG"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="IND"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="LKA"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="MDV"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="BGD"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="PAK"]<-"South Asia"
fisheriesSR$Continent[fisheriesSR$Code=="NPL"]<-"South Asia"

#East Asia and Pacific
fisheriesSR$Continent[fisheriesSR$Continent=="Asia"]<-"East Asia"

fisheriesSR$Code[fisheriesSR$Country=="Former Yugoslav SFR"]<-"BIH"
fisheriesSR$Code[fisheriesSR$Country=="Former Czechoslovakia"]<-"CZE"
fisheriesSR$Continent[fisheriesSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
fisheriesSR$Continent[fisheriesSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"

#Rates

fisheriesSR$Rate[fisheriesSR$Continent=="South Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="South Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="South Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="EuCA",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="EuCA"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="MENA",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="MENA"]))

fisheriesSR$Rate[fisheriesSR$Continent=="East Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="East Asia",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="East Asia"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Oceania"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="Oceania",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="Oceania"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="SSA",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="SSA"]))

fisheriesSR$Rate[fisheriesSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="LACa",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="LACa"]))

fisheriesSR$Rate[fisheriesSR$Continent=="North America"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="North America",])/ length(unique(aggfisheries$Country[aggfisheries$Continent=="North America"]))

#AQUACULTURE

Country<-levels(aggaqua$Country)
Country[124]<-"Reunion"
Code<- countrycode(Country, origin = "country.name", destination = "iso3c", warn=T)
Continent<- countrycode(Country, origin = "country.name", destination = "continent")
aquacultureSR <-cbind.data.frame(Country, Code, Continent)
aquacultureSR$Continent <-as.character(aquacultureSR$Continent)
aquacultureSR$Code <-as.character(aquacultureSR$Code)
aquacultureSR$



aquacultureSR$Continent[aquacultureSR$Code=="BHR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="IRN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="IRQ"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="SAU"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="ARE"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="KWT"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="QAT"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="LBN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="JOR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="DZA"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="LBY"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="SYR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="EGY"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="MAR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="TUN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="DZA"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="ISR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="JOR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="MLT"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="MAR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="PSE"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="OMN"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="SYR"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="ARE"]<-"Middle East and North Africa"
aquacultureSR$Continent[aquacultureSR$Code=="YEM"]<-"Middle East and North Africa"

#North America
aquacultureSR$Continent[aquacultureSR$Code=="BMU"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="GRL"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="USA"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="CAN"]<-"North America"
aquacultureSR$Continent[aquacultureSR$Code=="SPM"]<-"North America"


#Latin America and Caribbean
aquacultureSR$Continent[aquacultureSR$Continent=="Americas"]<-"Latin America and Caribbean"


#Europe and Central Asia
aquacultureSR$Continent[aquacultureSR$Continent=="Europe"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Code=="CYP"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Code=="TUR"]<-"Europe and Central Asia"


#South Asia
aquacultureSR$Continent[aquacultureSR$Code=="BTN"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="AFG"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="IND"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="LKA"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="MDV"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="BGD"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="PAK"]<-"South Asia"
aquacultureSR$Continent[aquacultureSR$Code=="NPL"]<-"South Asia"

#East Asia and Pacific
aquacultureSR$Continent[aquacultureSR$Continent=="Asia"]<-"East Asia"

aquacultureSR$Code[aquacultureSR$Country=="Former Yugoslav SFR"]<-"BIH"
aquacultureSR$Code[aquacultureSR$Country=="Former Czechoslovakia"]<-"CZE"
aquacultureSR$Continent[aquacultureSR$Country=="Former Czechoslovakia"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Country=="Former Yugoslav SFR"]<-"Europe and Central Asia"
aquacultureSR$Continent[aquacultureSR$Country=="Zanzibar"]<-"Africa"


#Rates 

aquacultureSR$Rate[aquacultureSR$Continent=="South Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="South Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="South Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Europe and Central Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="EuCA",])/ length(unique(aggaqua$Country[aggaqua$Continent=="EuCA"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Middle East and North Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="MENA",])/ length(unique(aggaqua$Country[aggaqua$Continent=="MENA"]))

aquacultureSR$Rate[aquacultureSR$Continent=="East Asia"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="East Asia",])/ length(unique(aggaqua$Country[aggaqua$Continent=="East Asia"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Oceania"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="Oceania",])/ length(unique(aggaqua$Country[aggaqua$Continent=="Oceania"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Africa"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="SSA",])/ length(unique(aggaqua$Country[aggaqua$Continent=="SSA"]))

aquacultureSR$Rate[aquacultureSR$Continent=="Latin America and Caribbean"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="LACa",])/ length(unique(aggaqua$Country[aggaqua$Continent=="LACa"]))

aquacultureSR$Rate[aquacultureSR$Continent=="North America"]<- nrow(shockdrivers2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="North America",])/ length(unique(aggaqua$Country[aggaqua$Continent=="North America"]))




## Redo shock exposure indices

exp.crops<-cbind.data.frame(unique(cropsSR$Continent), unique(cropsSR$Rate))
names(exp.crops)[1]<-"Continent"
names(exp.crops)[2]<-"SR"
exp.crops$Norm.SR <-((exp.crops$SR-mean(exp.crops$SR))/ sd(exp.crops$SR))

exp.crops$Mean.SS<-c(mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="LACa"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="East Asia"]))

exp.crops$Norm.SS<-((exp.crops$Mean.SS-mean(exp.crops$Mean.SS))/sd(exp.crops$Mean.SS))


exp.crops$Mean.Rec<-c(mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="LACa"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Crops" & shockdrivers2$Region=="East Asia"]))

exp.crops$Norm.Rec<-((exp.crops$Mean.Rec-mean(exp.crops$Mean.Rec))/sd(exp.crops$Mean.Rec))
exp.crops$Comp.Exp<-exp.crops$Norm.SR+exp.crops$Norm.SS+exp.crops$Norm.Rec


##LIVESTOCK

exp.Livestock<-cbind.data.frame(unique(livestockSR$Continent), unique(livestockSR$Rate))
names(exp.Livestock)[1]<-"Continent"
names(exp.Livestock)[2]<-"SR"
exp.Livestock$Norm.SR <-((exp.Livestock$SR-mean(exp.Livestock$SR))/ sd(exp.Livestock$SR))

exp.Livestock$Mean.SS<-c(mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="LACa"]),
0,#mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="East Asia"]))

exp.Livestock$Norm.SS<-((exp.Livestock$Mean.SS-mean(exp.Livestock$Mean.SS))/sd(exp.Livestock$Mean.SS))


exp.Livestock$Mean.Rec<-c(mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="LACa"]),
0,#mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Livestock" & shockdrivers2$Region=="East Asia"]))

exp.Livestock$Norm.Rec<-((exp.Livestock$Mean.Rec-mean(exp.Livestock$Mean.Rec))/sd(exp.Livestock$Mean.Rec))
exp.Livestock$Comp.Exp<-exp.Livestock$Norm.SR+exp.Livestock$Norm.SS+exp.Livestock$Norm.Rec


#FISHERIES


exp.Fisheries<-cbind.data.frame(unique(fisheriesSR$Continent), unique(fisheriesSR$Rate))
names(exp.Fisheries)[1]<-"Continent"
names(exp.Fisheries)[2]<-"SR"
exp.Fisheries$Norm.SR <-((exp.Fisheries$SR-mean(exp.Fisheries$SR))/ sd(exp.Fisheries$SR))

exp.Fisheries$Mean.SS<-c(mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="LACa"]),
0,#mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="East Asia"]))

exp.Fisheries$Norm.SS<-((exp.Fisheries$Mean.SS-mean(exp.Fisheries$Mean.SS))/sd(exp.Fisheries$Mean.SS))



exp.Fisheries$Mean.Rec<-c(mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="LACa"]),
0,#mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Fisheries" & shockdrivers2$Region=="East Asia"]))

exp.Fisheries$Norm.Rec<-((exp.Fisheries$Mean.Rec-mean(exp.Fisheries$Mean.Rec))/sd(exp.Fisheries$Mean.Rec))
exp.Fisheries$Comp.Exp<-exp.Fisheries$Norm.SR+exp.Fisheries$Norm.SS+exp.Fisheries$Norm.Rec


#AQUACULTRE


exp.Aquaculture<-cbind.data.frame(unique(aquacultureSR$Continent), unique(aquacultureSR$Rate))
names(exp.Aquaculture)[1]<-"Continent"
names(exp.Aquaculture)[2]<-"SR"
exp.Aquaculture$Norm.SR <-((exp.Aquaculture$SR-mean(exp.Aquaculture$SR))/ sd(exp.Aquaculture$SR))

exp.Aquaculture$Mean.SS<-c(mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="LACa"]),
0,#mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$AbsMagnitude[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="East Asia"]))

exp.Aquaculture$Norm.SS<-((exp.Aquaculture$Mean.SS-mean(exp.Aquaculture$Mean.SS))/sd(exp.Aquaculture$Mean.SS))



exp.Aquaculture$Mean.Rec<-c(mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="South Asia"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="EuCA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="MENA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="Oceania"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="SSA"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="LACa"]),
0,#mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="North America"]),
mean(shockdrivers2$Recovery2[shockdrivers2$Sector=="Aquaculture" & shockdrivers2$Region=="East Asia"]))

exp.Aquaculture$Norm.Rec<-((exp.Aquaculture$Mean.Rec-mean(exp.Aquaculture$Mean.Rec))/sd(exp.Aquaculture$Mean.Rec))
exp.Aquaculture$Comp.Exp<-exp.Aquaculture$Norm.SR+exp.Aquaculture$Norm.SS+exp.Aquaculture$Norm.Rec


#load spatial data frames

bbox <- readOGR(dsn="ne_110m_graticules_all", layer="ne_110m_wgs84_bounding_box") 
bbox <- spTransform(bbox, CRS("+proj=robin"))  # reproject bounding box
bbox_df<- fortify(bbox) #, group="ISO_TER1"


#JOINING CROP AND COUNTRY DATA 
names(cropsSR)[names(cropsSR)=="Codes"]<-"iso_a3"
CRworld<-readOGR("ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
CRworld <- CRworld[!CRworld$iso_a3 %in% c("ATA"),] #remove antartica
CRworld<-spTransform(CRworld, CRS("+proj=robin"))
CRworld@data$id<-rownames(CRworld@data)
CRworld@data<-join(CRworld@data, cropsSR, by="iso_a3")
CRworld.df<-fortify(CRworld)
CRworld.df<-join(CRworld.df, CRworld@data, by="id")
head(CRworld.df)


#JOIN LIVESTOCK DATA TO COUNTRY CENTROIDS
names(livestockSR)[names(livestockSR)=="Code"]<-"iso_a3" #create common variable
LSworld<-readOGR(dsn="ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
LSworld <- LSworld[!LSworld$iso_a3 %in% c("ATA"),] #remove antarctica
LSworld<-spTransform(LSworld, CRS("+proj=robin"))
LSworld@data$id<-rownames(LSworld@data)
LSworld@data<-join(LSworld@data, livestockSR, by="iso_a3")
LSworld.df<-fortify(LSworld)
LSworld.df<-join(LSworld.df, LSworld@data, by="id")


## read in simplified copy - fisheries
eez_fish <- readRDS("eez_simplified.rds")
eez_fish <- eez_fish[!eez_fish$Territory1 %in% c("Antarctica"),]
eez_fish<-spTransform(eez_fish, CRS("+proj=robin"))
names(fisheriesSR)[names(fisheriesSR)=="Code"]<-"ISO_Ter1"
eez_fish@data$id<-rownames(eez_fish@data)
eez_fish@data<-join(eez_fish@data, fisheriesSR, by="ISO_Ter1")
eez_fish.df<-fortify(eez_fish)
eez_fish.df<-join(eez_fish.df, eez_fish@data, by="id")


#aquaculture and EEZ simplified
eez_aqua<-readRDS("eez_simplified.rds")
eez_aqua <- eez_aqua[!eez_aqua$Territory1 %in% c("Antarctica"),]
eez_aqua<-spTransform(eez_aqua, CRS("+proj=robin"))
names(aquacultureSR)[names(aquacultureSR)=="Code"]<-"ISO_Ter1"
eez_aqua@data$id<-rownames(eez_aqua@data)
eez_aqua@data<-join(eez_aqua@data, aquacultureSR, by="ISO_Ter1")
eez_aqua.df<-fortify(eez_aqua)
eez_aqua.df<-join(eez_aqua.df, eez_aqua@data, by="id")


## Join Exposure data to spatial data frames

#join exposure data to spatial polygons

CRworld.df<-join(CRworld.df, exp.crops, by="Continent")
LSworld.df<-join(LSworld.df, exp.Livestock, by="Continent")
eez_fish.df<-join(eez_fish.df, exp.Fisheries, by="Continent")
eez_aqua.df<-join(eez_aqua.df, exp.Aquaculture, by="Continent")

#ADJUSTING CROP RATE DISPLAY FOR AGGREGATED COUNTRIES

CRworld.df$Comp.Exp[CRworld.df$iso_a3=="GRL"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="North America"])


CRworld.df$Comp.Exp[CRworld.df$iso_a3=="ARM"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="AZE"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="BLR"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="EST"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="GEO"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="KAZ"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="KGZ"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="LVA"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="LTU"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="MDA"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="TJK"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="TKM"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="UKR"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="UZB"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])

CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SRB"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="MNE"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="HRV"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="MKD"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SVN"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])
CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SVK"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Europe and Central Asia"])

CRworld.df$Comp.Exp[CRworld.df$iso_a3=="SSD"]<-unique(exp.crops$Comp.Exp[exp.crops$Continent=="Africa"])

#LIVESTOCK ADJUSTEDMENT FOR AGGREGATED COUNTRIES


LSworld.df$Comp.Exp[LSworld.df$iso_a3=="ARM"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="AZE"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="BLR"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="EST"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="GEO"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="KAZ"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="KGZ"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="LVA"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="LTU"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="MDA"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="TJK"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="TKM"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="UKR"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="UZB"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])

LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SRB"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="MNE"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="HRV"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="MKD"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SVN"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])
LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SVK"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Europe and Central Asia"])

LSworld.df$Comp.Exp[LSworld.df$iso_a3=="SSD"]<-unique(exp.Livestock$Comp.Exp[exp.Livestock$Continent=="Africa"])


#MAPS of EXPOSURE
exposure.crops<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat,fill=Comp.Exp, group=group, map_id=id), colour=NA, size=0.2)+
  scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = bquote(Total~exposure~index))+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(6, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(cropimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)

#Aquaculture

exposure.Aqua<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id, fill=Comp.Exp), colour="NA", size=0.2)+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = 0, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(aquaimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)




#LIVESTOCK 
exposure.LS<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, group=group, map_id=id), colour="NA", size=0.2, fill="aliceblue")+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat,fill=Comp.Exp, group=group, map_id=id), colour="NA", size=0.2)+
 scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))+
  annotation_custom(cowimg, xmin = -2.2e+07, xmax = -0.9e+07, ymin = -8.5e+06, ymax = -5.8e+06)




exposure.fish<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, fill=Comp.Exp, group=group, map_id=id), colour="NA", size=0.2)+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat, group=group, map_id=id), colour=NA, size=0.2, fill="grey85")+
  scale_fill_gradient2(low="grey90", mid = "grey60",  high="dodgerblue3", na.value = "aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-20, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold", vjust = -10, size=10),
        legend.position = "left",
        legend.direction = "vertical",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Shock rate")+
  annotation_custom(fishingimg, xmin = -2.65e+07, xmax = -0.3e+07, ymin = -10.1e+06, ymax = -4.5e+06)

exposures<- ggarrange(exposure.crops, exposure.LS, exposure.fish, exposure.Aqua, ncol=2, nrow=2, labels=c("a", "b", "c", "d"), legend = "none")

indexlegend<-get_legend(exposure.crops)

ggarrange(exposures, indexlegend, nrow = 2, ncol=1, heights = c(1,0.1))

#######  NEEED TO ADJUST LEGEND TO INCORPORATE A COMMON RANGE ACROSS SECTORS


ggsave(filename = "Total exposure without USSR.tiff", device = "tiff", dpi = 600, width = 18, height = 12.5, units="cm")

sum(length(levels(aggcrops$Country)),
length(levels(agglivestock$Country)),
length(levels(aggfisheries$Country)),
length(levels(aggaqua$Country)))


total.exp<-cbind.data.frame(exp.crops$Continent, exp.crops$Comp.Exp, exp.Livestock$Comp.Exp, exp.Fisheries$Comp.Exp, exp.Aquaculture$Comp.Exp)

total.exp$total<-(total.exp$`exp.crops$Comp.Exp`+ total.exp$`exp.Livestock$Comp.Exp`+ total.exp$`exp.Fisheries$Comp.Exp`+ total.exp$`exp.Aquaculture$Comp.Exp`)

total.exp$undernourishment<-c(14.9, mean(c(8.3, 2.5)), 9, 6.4, 21.3, mean(c(18,5)), 2.5, mean(c(9.2,10.2)))

ggplot(data = total.exp, aes(x=total, y=undernourishment))+geom_point()

```



#Unused code - ADD FOOD SUPPLY DATA

```{r}

cropsupply<-read.csv("FoodSupply_Crops_E_All_Data_(Norm).csv", header = T)

cropsupply<-cropsupply[cropsupply$Element=="Food supply quantity (tonnes)",]
summary(cropsupply)

levels(cropsupply$Item)

#Crop supply

cropsupply<-cropsupply[cropsupply$Item!="Cereals - Excluding Beer" | cropsupply$Item!="Fruits - Excluding Wine"| cropsupply$Item!="Oilcrops"|cropsupply$Item!= "Pulses"|cropsupply$Item!="Starchy Roots" |cropsupply$Item!="Vegetables"|cropsupply$Item!="Beer"|cropsupply$Item!="Alcoholic Beverages"|cropsupply$Item!="Beverages, Alcoholic"|cropsupply$Item!="Beverages, Fermented"|cropsupply$Item!="Wine",]
cropsupply$Item<-as.character(cropsupply$Item)
cropsupply$Item<-as.factor(cropsupply$Item)

cropsupply<-cropsupply[cropsupply$Country!="China",]

cropsupply.agg<-stats::aggregate(cropsupply$Value~cropsupply$Year+cropsupply$Country, FUN=sum, drop=FALSE)
names(cropsupply.agg)[1]<-"Year"
names(cropsupply.agg)[2]<-"Country"
names(cropsupply.agg)[3]<-"Crop.Supply"
cropsupply.agg$Codes<-countrycode(cropsupply.agg$Country, origin = "country.name", destination = "iso3c", warn = T)

cropsupply.agg<-cropsupply.agg[!is.na(cropsupply.agg$Codes),]

shockdriverssupply<-join(shockdrivers, cropsupply.agg, by=c("Codes", "Year"), type="left", match="first")
shockdriverssupply<-shockdriverssupply[,c(1:11, 13)]
names(shockdriverssupply)[12]<-"Crop.Supply"





#meat and fish supply

MFsupply<-read.csv("FoodSupply_LivestockFish_E_All_Data_(Norm).csv", header=T)

MFsupply<-MFsupply[MFsupply$Element=="Food supply quantity (tonnes)",]

levels(MFsupply$Item)

MFsupply<-rbind(MFsupply[MFsupply$Item=="Bovine Meat",],  MFsupply[MFsupply$Item=="Meat, Other",], MFsupply[MFsupply$Item=="Milk - Excluding Butter",], MFsupply[MFsupply$Item=="Mutton & Goat Meat`",], MFsupply[MFsupply$Item=="Pigmeat",], MFsupply[MFsupply$Item=="Poultry Meat",], MFsupply[MFsupply$Item=="Aquatic Animals, Others",],
MFsupply[MFsupply$Item=="Cephalopods",],
MFsupply[MFsupply$Item=="Crustaceans",],
MFsupply[MFsupply$Item=="Demersal Fish",],
MFsupply[MFsupply$Item=="Freshwater Fish",],
MFsupply[MFsupply$Item=="Marine Fish, Other",],
MFsupply[MFsupply$Item=="Molluscs, Other",],
MFsupply[MFsupply$Item=="Pelagic Fish",],
MFsupply[MFsupply$Item=="Fish, Seafood",])

MFsupply.agg<-stats::aggregate(MFsupply$Value~MFsupply$Year+MFsupply$Country, FUN=sum, drop=FALSE)
names(MFsupply.agg)[1]<-"Year"
names(MFsupply.agg)[2]<-"Country"
names(MFsupply.agg)[3]<-"MF.supply"

MFsupply.agg$Codes<-countrycode(MFsupply.agg$Country, origin = "country.name", destination = "iso3c", warn = T)

MFsupply.agg<-MFsupply.agg[!is.na(MFsupply.agg$Codes),]

shockdriverssupply<-join(shockdriverssupply, MFsupply.agg, by=c("Codes", "Year"), type="left", match="first")
shockdriverssupply<-shockdriverssupply[,c(1:12,14)]

shockdriverssupply$Tot.Supply<-shockdriverssupply$Crop.Supply+shockdriverssupply$MF.supply
shockdriverssupply$Prop.Total<-shockdriverssupply$AbsMagnitude/shockdriverssupply$Tot.Supply

shockdriverssupply<-shockdriverssupply[shockdriverssupply$Country!="Former Czechoslovakia",]
shockdriverssupply<-shockdriverssupply[shockdriverssupply$Country!="Former USSR",]
shockdriverssupply<-shockdriverssupply[shockdriverssupply$Tot.Supply!=0,]
shockdriverssupply<-shockdriverssupply[!is.na(shockdriverssupply$Country),]







median((shockdriverssupply$Prop.Total[shockdriverssupply$Region=="East Asia and Pacific"& shockdriverssupply$Sector=="Crops"][!is.na(shockdriverssupply$Prop.Total[shockdriverssupply$Region=="East Asia and Pacific"& shockdriverssupply$Sector=="Crops"])])) 


```

# Old code - Magnitude and recovery time plot

```{r}

shockdrivers$Recovery[is.na(shockdrivers$Recovery)]<-2013-shockdrivers$Year[is.na(shockdrivers$Recovery)]
shockdrivers$Recovery[shockdrivers$Recovery==0]<-1
shockdrivers$Country<-as.character(shockdrivers$Country)
shockdrivers$Country[shockdrivers$Codes=="PRK"]<-"DPRK"
shockdrivers$Country<-as.factor(shockdrivers$Country)


maxshocks<-rbind(shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Crops"]),],shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Livestock"]),],shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Fisheries"]),],shockdrivers[shockdrivers$AbsMagnitude==max(shockdrivers$AbsMagnitude[shockdrivers$Sector=="Aquaculture"]),])

Sens<-ggplot(data=shockdrivers, aes(x=Sector, y=log(AbsMagnitude)))+geom_boxplot(outlier.alpha = 0)+geom_jitter(aes(colour=Category, size=Recovery) , width=0.3, alpha=0.5)+theme_bw()+
  theme(panel.grid = element_blank(), 
        legend.position = "right", 
        legend.text = element_text(size=8),
        legend.title = element_text(size=8, face="bold"),
        axis.text = element_text(size=8),
        axis.title = element_text(size=9))+
  scale_color_manual(values = cols)+
  scale_y_continuous(limits = c(-1,19))+
  geom_text_repel(data = maxshocks, mapping = aes(x=Sector, y= log(AbsMagnitude), label = Country), point.padding = 0.2, force=0.2, segment.colour = NA, max.iter = 3e3, size=3, nudge_y = 0.1)+
  guides(colour = F,
         size = guide_legend( direction = "vertical", title.position="top", title.hjust = 0, ncol=1))+
  labs(y=bquote(log(Magnitude)), x="", size=expression("Recovery time \n(years)"), colour=bquote(Driver))
  
ggsave(filename = "MagnitudesvsRecovery.tiff", device = "tiff", dpi=600, width=18, height = 12, units="cm")

driverlegend<-get_legend(Causes)
sizelegend<-get_legend(Sens)
plot<-ggarrange(Causes,Sens, common.legend = F, legend = "none", labels = c("a", "b"))
plot2<-ggarrange(plot, sizelegend , ncol = 2, nrow = 1, widths = c(1,0.15))
plot3<-ggarrange(plot2, driverlegend, ncol = 1, nrow = 2, heights = c(1,0.3))

ggsave(filename = "Shock drivers and recovery.tiff", device = "tiff", dpi = 600, width = 16, height=10, units = "cm")

```



#Old code - MAPPING SHOCK MAGNITUDES and DRIVERS

```{r}

#Sector wise data
shockdrivers$Region[shockdrivers$Codes=="SYR"]<-"MENA"
shockdrivers$Region[shockdrivers$Codes=="IRN"]<-"MENA"

cropssh<-subset(shockdrivers, shockdrivers$Sector=="Crops")
livestocksh<-subset(shockdrivers, shockdrivers$Sector=="Livestock")
fisheriessh<-subset(shockdrivers, shockdrivers$Sector=="Fisheries")
aquaculturesh<-subset(shockdrivers, shockdrivers$Sector=="Aquaculture")

#Relative magnitudes
cropssh$relmagnitude <- cropssh$AbsMagnitude/min(cropssh$AbsMagnitude)
livestocksh$relmagnitude <- livestocksh$AbsMagnitude/min(livestocksh$AbsMagnitude)
fisheriessh$relmagnitude <- fisheriessh$AbsMagnitude/min(fisheriessh$AbsMagnitude)
aquaculturesh$relmagnitude <- aquaculturesh$AbsMagnitude/min(aquaculturesh$AbsMagnitude)


##SHAPE FILES

#BOUNDINGBOX
bbox <- readOGR(dsn="ne_110m_graticules_all", layer="ne_110m_wgs84_bounding_box") 
bbox <- spTransform(bbox, CRS("+proj=robin"))  # reproject bounding box
bbox_df<- fortify(bbox) #, group="ISO_TER1"


#JOINING CROP AND COUNTRY DATA 
names(cropssh)[names(cropssh)=="Codes"]<-"iso_a3"
CRworld<-readOGR("ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
CRworld <- CRworld[!CRworld$iso_a3 %in% c("ATA"),] #remove antartica
CRworld<-spTransform(CRworld, CRS("+proj=robin"))
CRworld@data$id<-rownames(CRworld@data)
CRworld@data<-join(CRworld@data, cropssh, by="iso_a3")
CRworld.df<-fortify(CRworld)
CRworld.df<-join(CRworld.df, CRworld@data, by="id")
head(CRworld.df)

#centroids for crops data
#centroids<-aggregate(cbind(long,lat)~id, data=CRworld.df, FUN=function(x) mean(range(x)))
#CRworld.df2<-merge(CRworld.df, centroids, by="id")


#JOIN LIVESTOCK DATA TO COUNTRY CENTROIDS
names(livestocksh)[names(livestocksh)=="Codes"]<-"iso_a3" #create common variable
LSworld<-readOGR(dsn="ne_110m_admin_0_countries", layer="ne_110m_admin_0_countries")
LSworld <- LSworld[!LSworld$iso_a3 %in% c("ATA"),] #remove antarctica
LSworld<-spTransform(LSworld, CRS("+proj=robin"))
LSworld@data$id<-rownames(LSworld@data)
LSworld@data<-join(LSworld@data, livestocksh, by="iso_a3")
LSworld.df<-fortify(LSworld)
LSworld.df<-join(LSworld.df, LSworld@data, by="id")
#head(LSworld.df) #it worked! 

#Use the centroids to plot
#centroids<-aggregate(cbind(long,lat)~id, data=LSworld.df, FUN=function(x) mean(range(x)))
#LSworld.df<-merge(LSworld.df, centroids, by="id")
#LSworld.df

#EEZ shapefile from marine regions - not great for robinson projection 

#EEZfish <- read_sf(dsn = "World_EEZ", layer = "eez")
#EEZfish <- as(EEZfish, "Spatial")
# <- EEZfish[!EEZfish$Territory1 %in% c("Antarctica"),]
#(EEZfish@data)[1:70,]
#names(fisheriestp)[names(fisheriestp)=="codes"]<-"ISO_Ter1" #create common variable
#EEZfish<-spTransform(EEZfish, CRS("+proj=robin"))
#EEZfish@data$id<-rownames(EEZfish@data)
#EEZfish@data<-join(EEZfish@data, fisheriestp, by="ISO_Ter1")
#EEZfish.df<-fortify(EEZfish)
#EEZfish.df<-join(EEZfish.df, EEZfish@data, by="id")
#head(EEZfish.df)
#EEZfish.df$PropMagnitude[is.na(EEZfish.df$PropMagnitude)] <- 0
#EEZfish.df$AbsMagnitude[is.na(EEZfish.df$AbsMagnitude)] <- 0
#head(EEZfish.df)

#aquaculture data
#EEZaqua<-read_sf(dsn = "World_EEZ", layer = "eez")
#EEZaqua<- as(EEZaqua, "Spatial")
#EEZaqua <- EEZaqua[!EEZaqua$Territory1 %in% c("Antarctica"),]
#names(aquaculturetp)[names(aquaculturetp)=="codes"]<-"ISO_Ter1"#create common variable
#EEZaqua<-spTransform(EEZaqua, CRS("+proj=robin"))
#EEZaqua@data$id<-rownames(EEZaqua@data)
#EEZaqua@data<-join(EEZaqua@data, aquaculturetp, by="ISO_Ter1")
#EEZaqua.df<-fortify(EEZaqua)
#EEZaqua.df<-join(EEZaqua.df, EEZaqua@data, by="id")
#head(EEZaqua.df)

##CREATE A SIMPLIED VERSION OF SHAPEFILE AND EXPORT TO RDS
#eezfname <- "eez.shp"
#eez <- read_sf(dsn = "World_EEZ", "eez")
## will want the recent update (14 August 2017)
#library(rmapshaper)
#eez_sim <- ms_simplify(eez)
#eez_sim <- as(eez_sim, "Spatial")
#saveRDS(eez_sim, "eez_simplified.rds")

## read in simplified copy - fisheries
eez_fish <- readRDS("eez_simplified.rds")
eez_fish <- eez_fish[!eez_fish$Territory1 %in% c("Antarctica"),]
eez_fish<-spTransform(eez_fish, CRS("+proj=robin"))
names(fisheriessh)[names(fisheriessh)=="Codes"]<-"ISO_Ter1"
eez_fish@data$id<-rownames(eez_fish@data)
eez_fish@data<-join(eez_fish@data, fisheriessh, by="ISO_Ter1")
eez_fish.df<-fortify(eez_fish)
eez_fish.df<-join(eez_fish.df, eez_fish@data, by="id")

#centroids<-aggregate(cbind(long,lat)~id, data=eez_fish.df, FUN=function(x) mean(range(x)))
#eez_fish.df2<-merge(eez_fish.df, centroids, by="id")

#aquaculture and EEZ simplified
eez_aqua<-readRDS("eez_simplified.rds")
eez_aqua <- eez_aqua[!eez_aqua$Territory1 %in% c("Antarctica"),]
eez_aqua<-spTransform(eez_aqua, CRS("+proj=robin"))
names(aquaculturesh)[names(aquaculturesh)=="Codes"]<-"ISO_Ter1"
eez_aqua@data$id<-rownames(eez_aqua@data)
eez_aqua@data<-join(eez_aqua@data, aquaculturesh, by="ISO_Ter1")
eez_aqua.df<-fortify(eez_aqua)
eez_aqua.df<-join(eez_aqua.df, eez_aqua@data, by="id")
#head(eez_aqua.df)

#Use the centroids to plot
#centroids<-aggregate(cbind(long,lat)~id, data=eez_aqua.df, FUN=function(x) mean(range(x)))
#eez_aqua.df<-merge(eez_aqua.df, centroids, by="id")
#names(eez_aqua.df)

#PLOTTING
#control white space
#par(mar=c(0,0,0,0))





#CROPS AND AQUACULTURE MAPS
(m1<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat, fill=(relmagnitude), group=group, map_id=id), colour="grey70", size=0.1)+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat,fill=(relmagnitude), group=group, map_id=id), colour="gray25", size=0.1)+
  scale_fill_gradient(low="khaki", high="firebrick4", na.value = "ivory3", labels=c(0, 5, 10, 15, 20, 25))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold"),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-1,0), "cm"))+
  labs(fill = expression(paste("Relative shock magnitude (x",10^5, ")")))+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top")))


#LIVESTOCK AND FISHERIES Maps
m2<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, fill=(relmagnitude), group=group, map_id=id), colour="grey70", size=0.1)+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat,fill=(relmagnitude), group=group, map_id=id), colour="gray25", size=0.1)+
  scale_fill_gradient(low="khaki", high="firebrick4", na.value = "ivory3", labels=c(0, 5, 10, 15, 20, 25))+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold"),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-1,0), "cm"))+
  labs(fill = expression(paste("Relative shock magnitude (x",10^5, ")")))+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top"))
  

bottom <- ggarrange(m1,m2, labels=c("c","d"), nrow=1, ncol=2, common.legend = T, legend = "bottom",  align="hv")

ggsave(filename = "Shock Magnitudes.tiff", device = "tiff", dpi = 600, width = 140, height = 60, units = "mm")

ggsave(filename = "Shock Magnitudes.pdf", device = pdf, dpi = 600, width = 140, height = 60, units = "mm")



#Drivers - crops and aqua

levels(eez_aqua.df$Category)
levels(CRworld.df$Category)

cols<-c(terrain_hcl(9, h = c(250, 40), c = 96, l = c(65, 90)),"grey70")

cols<-c("Climate/weather events"="#48A1FF", "Climate/weather & geopolitical/economic events" = "#00BCF4", "Climate/weather events & mismanagement" = "#00CED8", "Geopolitical/economic events" = "#00D9B1", "Mismanagement" = "#00DE81", "Mismanagement & geopolitical/economic events" = "#81DF45", "Mismanagement & policy change" = "#CBDC00", "Policy change" = "#FFD52A", "Other" = "#FFCD7C", "Unknown"= "grey60")

#Map drivers

#crops
(m3<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat,  group=group, map_id=id), fill="aliceblue", colour="grey70", size=0.2)+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat,fill=(Category), group=group, map_id=id), colour="gray25", size=0.2)+
  scale_fill_manual(values=cols, na.value="aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold"),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Driver"))#+ 
  #guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top")))

(m6<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_aqua.df, map=eez_aqua.df, aes(x=long, y=lat, fill=Category, group=group, map_id=id), colour="grey70", size=0.2)+
  geom_map(data=CRworld.df, map=CRworld.df, aes(x=long, y=lat, group=group, map_id=id), fill="aliceblue", colour="gray25", size=0.2)+
  scale_fill_manual(values=cols, na.value="aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold"),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Driver"))#+ 
  #guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top")))



(m4<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, group=group, map_id=id), fill="aliceblue", colour="grey70", size=0.2)+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat,fill=(Category), group=group, map_id=id), colour="gray25", size=0.2)+
  scale_fill_manual(values=cols, na.value="aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold"),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Driver")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top")))  
  

(m5<-ggplot(data=bbox_df, aes(long,lat, group=group)) +geom_polygon(fill="aliceblue")+ 
  geom_map(data=eez_fish.df, map=eez_fish.df, aes(x=long, y=lat, group=group, map_id=id, fill=Category),  colour="grey70", size=0.2)+
  geom_map(data=LSworld.df, map=LSworld.df, aes(x=long, y=lat, group=group, map_id=id), fill="aliceblue", colour="gray25", size=0.2)+
  scale_fill_manual(values=cols, na.value="aliceblue")+
  theme_bw()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        panel.grid = element_blank(), 
        axis.ticks = element_blank(), 
        panel.border = element_blank(),
        legend.box.spacing = unit(-18, "mm"), 
        plot.title = element_text(hjust = 0.5, face="bold"),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.title = element_text(size=8),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.text.align = 0,
        plot.margin=unit(c(0,0,-0.1,0), "cm"))+
  labs(fill = "Driver")+ 
  guides(fill= guide_colorbar(ticks = F,  barwidth = unit(5, "cm"), barheight = unit(2, "mm"), title.hjust = 0.5, title.vjust = 1, title.position = "top")))  


# driversspatial<-ggarrange(m5,m6, labels=c("c", "d"), nrow = 1, ncol=2, legend = "none", align = "hv")  
# 
# drivercombine<-ggarrange(plot2, driversspatial, nrow = 2, ncol=1, align = "h", heights = c(1,0.75))
# 
# ggarrange(drivercombine, driverlegend, ncol = 1, nrow=2, heights = c(1,0.15))

driverscol<-ggarrange(m3, m4, m5, m6, labels=c("b","d","f","h"), ncol=1, nrow=4, legend = "none")

ggsave(filename = "Shock drivers recovery and map.tiff", device = "tiff", dpi=600, width=18, height = 15, units = "cm")
  
```
